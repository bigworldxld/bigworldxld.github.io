<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Mysql真题, blogs,互联网,测试,大数据,生活,记录">
    <meta name="description" content="MySQL面试真题统计薪水最高员工货拉拉EMPLOYEE表里包含着所有货拉拉的员工信息，每个员工有自己的工号、姓名、薪水、和部门ID货拉拉DEPARTMENT表里包含着货拉拉所有的部门现在需要统计出货拉拉每个部门薪水最高的员工（包含depa">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Mysql真题 | 读序</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.1">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="读序" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">读序</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">

      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/archives">
          
          <i class="fas fa-hourglass-half" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>时轴</span>
        </a>
      </li>
      
      <li>
        <a href="/pdf">
          
          <i class="fas fa-file-pdf" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>PDF</span>
        </a>
      </li>
      
      <li>
        <a href="/sql">
          
          <i class="fas fa-database" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>SQL</span>
        </a>
      </li>
      
      <li>
        <a href="/desktop">
          
          <i class="fas fa-desktop" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Desktop</span>
        </a>
      </li>
      
      <li>
        <a href="/duxu-dailylife">
          
          <i class="fas fa-pen" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>blog</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/books" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Medias</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/musics">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>musics</span>
        </a>
      </li>
      
      <li>
        <a href="/books">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>books</span>
        </a>
      </li>
      
      <li>
        <a href="/videos">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>videos</span>
        </a>
      </li>
      
      <li>
        <a href="/galleries">
          
          <i class="fas fa-image" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>galleries</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">读序</div>
        <div class="logo-desc">
            
            我们每一个人都因为生存而充满焦虑，我们真实的存在被不真实的存在所笼罩。而实际上，真正的我们并不会受到不真实存在的威胁。
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-archive"></i>
			
			归档
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/archives " style="margin-left:50px">
				  
				   <i class="fa fas fa-hourglass-half" style="position: absolute;left:28px" ></i>
			      
		          <span>时轴</span>
                  </a>
                </li>
              
                <li>

                  <a href="/pdf " style="margin-left:50px">
				  
				   <i class="fa fas fa-file-pdf" style="position: absolute;left:28px" ></i>
			      
		          <span>PDF</span>
                  </a>
                </li>
              
                <li>

                  <a href="/sql " style="margin-left:50px">
				  
				   <i class="fa fas fa-database" style="position: absolute;left:28px" ></i>
			      
		          <span>SQL</span>
                  </a>
                </li>
              
                <li>

                  <a href="/desktop " style="margin-left:50px">
				  
				   <i class="fa fas fa-desktop" style="position: absolute;left:28px" ></i>
			      
		          <span>Desktop</span>
                  </a>
                </li>
              
                <li>

                  <a href="/duxu-dailylife " style="margin-left:50px">
				  
				   <i class="fa fas fa-pen" style="position: absolute;left:28px" ></i>
			      
		          <span>blog</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Medias
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/musics " style="margin-left:50px">
				  
				   <i class="fa fas fa-music" style="position: absolute;left:28px" ></i>
			      
		          <span>musics</span>
                  </a>
                </li>
              
                <li>

                  <a href="/books " style="margin-left:50px">
				  
				   <i class="fa fas fa-book" style="position: absolute;left:28px" ></i>
			      
		          <span>books</span>
                  </a>
                </li>
              
                <li>

                  <a href="/videos " style="margin-left:50px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:28px" ></i>
			      
		          <span>videos</span>
                  </a>
                </li>
              
                <li>

                  <a href="/galleries " style="margin-left:50px">
				  
				   <i class="fa fas fa-image" style="position: absolute;left:28px" ></i>
			      
		          <span>galleries</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/bigworldxld/bigworldxld.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/bigworldxld/bigworldxld.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请使用开启大门的钥匙')).toString(CryptoJS.enc.Hex)) {
                alert('密钥错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/images/mysql.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Mysql真题</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/SQL/">
                                <span class="chip bg-color">SQL</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/database/" class="post-category">
                                database
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-06-12
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    16.9k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    70 分
                </div>
                

                
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
				

            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="MySQL面试真题"><a href="#MySQL面试真题" class="headerlink" title="MySQL面试真题"></a><strong>MySQL面试真题</strong></h1><h2 id="统计薪水最高员工"><a href="#统计薪水最高员工" class="headerlink" title="统计薪水最高员工"></a>统计薪水最高员工</h2><p>货拉拉EMPLOYEE表里包含着所有货拉拉的员工信息，每个员工有自己的工号、姓名、薪水、和部门ID<br><img src="https://cdn.kesci.com/upload/image/rau1u8vc8e.png" alt="Image Name"><br>货拉拉DEPARTMENT表里包含着货拉拉所有的部门<br><img src="https://cdn.kesci.com/upload/image/rau1tq4b1h.png" alt="Image Name"><br>现在需要统计出货拉拉每个部门薪水最高的员工（包含department/name/salary字段）</p>
<pre class=" language-mysql"><code class="language-mysql">select
    d.department,
    a.name,
    a.salary
from
    (select
    *,
    max(salary) over (partition by departmentID) as "部门薪水最高"
    from
        employee) a
    join department d
        on a.departmentID=d.id
where a.salary=a.部门薪水最高
</code></pre>
<h2 id="统计每个顾客每天总登录时长"><a href="#统计每个顾客每天总登录时长" class="headerlink" title="统计每个顾客每天总登录时长"></a>统计每个顾客每天总登录时长</h2><p>某游戏数据后台设有“登录日志”和“登出日志”两张表。<br>游戏开服前两天（2022-08-13至2022-08-14）的角色登录和登出日志如下：</p>
<p>“登录日志”记录各玩家的登录时间和登录时的角色等级。<br><img src="https://cdn.kesci.com/upload/image/rbnrhckcty.png" alt="Image Name"></p>
<p>“登出日志”记录各玩家的登出时间和登出时的角色等级。<br><img src="https://cdn.kesci.com/upload/image/rbnrhuhccj.png" alt="Image Name"></p>
<p>其中，“角色id”字段唯一识别玩家。</p>
<p>一天中，玩家可以多次登录登出游戏，请使用SQL分析出以下业务问题：</p>
<p>分析开服首日（2022-08-13），游戏的DAU（日活跃玩家数）和次日留存率（次日仍登录的活跃玩家数/当日活跃玩家总数）</p>
<pre class=" language-mysql"><code class="language-mysql">select count(*) as DAU,
    sum(case when t1.首日玩家=t2.次日玩家 then 1 else 0 end)/count(*) as "次日留存率"
from
(select distinct d.角色id as '首日玩家'
from 登录日志 d
where d.日期='2022-08-13') t1
left join
(select distinct d.角色id as '次日玩家'
form 登录日志 d
where d.日期='2022-08-14') t2
on t1.首日玩家=t2.次日玩家
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/rboavi6whr.png" alt="Image Name"></p>
<p>case搜索函数只返回第一个符合条件的值，剩下的case部分将会被自动忽略。</p>
<p>玩家在开服首日（2022-08-13）等级分布情况，即每个等级停留的角色数。（如玩家没有登出日志，则使用登录日志的等级信息。）</p>
<pre class=" language-mysql"><code class="language-mysql">select
    角色等级,
    count(角色id) as '角色数'
from
    (select
        *,
        row_number() over (partition by 角色id
    order by 
        c.登出时间 desc) as time_rank
    from
        登出日志 c
    where
        c.日期='2022-08-13'
        ) t1

where
    time_rank=1
group by
    角色等级
order by 
    角色等级;
</code></pre>
<p><strong>ROW_NUMBER() OVER (ORDER BY xlh DESC)</strong> </p>
<p>简单的说row_number()从1开始，为每一条分组记录返回一个数字，这里的ROW_NUMBER() OVER (ORDER BY xlh DESC) 是先把xlh列降序，再为降序以后的没条xlh记录返回一个序号。</p>
<p><strong>row_number() OVER (PARTITION BY COL1 ORDER BY COL2)</strong> </p>
<p> 表示根据COL1分组，在分组内部根据 COL2排序，而此函数计算的值就表示每组内部排序后的顺序编号（组内连续的唯一的)</p>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/rbobbl2lnh.png" alt="Image Name"></p>
<p>请根据玩家登录登出的时间，统计各玩家每天总在线时长情况（如玩家登录后没有对应的登出日志，可以使用当天23:59:59作为登出时间）</p>
<p>IFNULL(expr1,expr2)用法：</p>
<p>假如expr1不为NULL，则 IFNULL() 的返回值为expr1; 否则其返回值为 expr2</p>
<p>NULLIF(expr1,expr2)用法</p>
<p>  如果expr1 = expr2 成立，那么返回值为NULL，否则返回值为expr1。这和CASE  WHEN expr1 = expr2 THEN NULL ELSE  expr1 END相同。  </p>
<p>timestampdiff（unit，begin，end）</p>
<p>​    begin和end可以为DATE或<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=DATETIME&amp;spm=1001.2101.3001.7020">DATETIME</a>类型，并且可允许参数为混合类型.</p>
<pre class=" language-mysql"><code class="language-mysql">with t1 as(
select *,row_number() over (partition by d.日期，d.角色id order by 登陆时间) as "log_rank"
from 登录日志 d
),
t2 as(
select *,row_number()over(partition by c.日期 ,c.角色id order by c.登出时间) as "out_rank"
from 登出日志 c
),
t3 as(
select t1.日期,t1.角色id,t1.登陆时间，ifnull(t2.登出时间,concat('t1.日期',' 23:59:59')) as "登出时间"
from t1 left join t2
on t1.log_rank=t2.out_rank
and t1.角色id=t2.角色id
and t1.日期=t2.日期
)，
t4 as (
select 日期,角色id,timestampdiff(second,登录时间,登出时间)/60 as "每次在线时长_min"
from t3
)
select 日期,角色id,round(sum(每次在线时长_min),2) as "各玩家每天总在线时长_min"
from t4
group by 日期,角色id
order by 日期,角色id;
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/rbnrkkdl9i.png" alt="Image Name"></p>
<p>请根据玩家登录登出的时间，统计在开服首日各玩家在线时长分布。<br>如玩家登录后没有对应的登出日志，可以使用当天23:59:59作为登出时间。<br>区分在线时间段：0-30min，30min-1h，1-2h，2-3h，3-5h，5h以上；区间为左闭右开。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> <span class="token number">d</span><span class="token punctuation">.</span>日期<span class="token punctuation">,</span><span class="token number">d</span><span class="token punctuation">.</span>角色id <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">d</span><span class="token punctuation">.</span>登录时间<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">"log_rank"</span>
<span class="token keyword">from</span> 登录日志 <span class="token number">d</span> 
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t2 <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> <span class="token number">c</span><span class="token punctuation">.</span>日期 <span class="token punctuation">,</span><span class="token number">c</span><span class="token punctuation">.</span>角色id <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">c</span><span class="token punctuation">.</span>登出时间<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">"out_rank"</span>
<span class="token keyword">from</span> 登出日志 <span class="token number">c</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t3 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> t1<span class="token punctuation">.</span>日期<span class="token punctuation">,</span>t1<span class="token punctuation">.</span>角色id<span class="token punctuation">,</span>t1<span class="token punctuation">.</span>登录时间<span class="token punctuation">,</span>ifnull<span class="token punctuation">(</span>t2<span class="token punctuation">.</span>登出时间<span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token string">'t1.日期'</span><span class="token punctuation">,</span><span class="token string">'23:59:59'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">"登出时间"</span>
<span class="token keyword">from</span> t1 <span class="token keyword">left</span> <span class="token keyword">join</span> t2
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>log_rank<span class="token operator">=</span>t2<span class="token punctuation">.</span>out_rank
<span class="token operator">and</span> t1<span class="token punctuation">.</span>角色id<span class="token operator">=</span>t2<span class="token punctuation">.</span>角色id
<span class="token operator">and</span> t1<span class="token punctuation">.</span>日期<span class="token operator">=</span>t2<span class="token punctuation">.</span>日期            
<span class="token punctuation">)</span>，
t4 <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> 日期，角色id<span class="token punctuation">,</span>timestampdiff<span class="token punctuation">(</span>second<span class="token punctuation">,</span>登陆时间，登出时间<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">60</span> <span class="token keyword">as</span> <span class="token string">"每次在线时长_min"</span>
<span class="token keyword">from</span> t3    
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t5 <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> 角色id<span class="token punctuation">,</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>每次在线时长_min<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">"各玩家首日总在线时长_min"</span>
<span class="token keyword">from</span> t4
<span class="token keyword">where</span> <span class="token keyword">by</span> 角色id
<span class="token keyword">order</span> <span class="token keyword">by</span> 角色id    
<span class="token punctuation">)</span>
t6 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">case</span> <span class="token keyword">when</span> 各玩玩家首日总在线时长_min<span class="token operator">>=</span><span class="token number">0</span> <span class="token operator">and</span> 各玩家首日总在线时长_min<span class="token operator">&lt;</span><span class="token number">30</span> <span class="token keyword">then</span> <span class="token string">'0-30min'</span>
<span class="token keyword">when</span> 各玩家首日总在线时长_min <span class="token operator">>=</span><span class="token number">30</span> <span class="token operator">and</span> 各玩家首日总在线时长_min <span class="token operator">&lt;</span><span class="token number">60</span> <span class="token keyword">then</span> <span class="token string">'30min-1h'</span>
<span class="token keyword">when</span> 各玩家首日总在线时长_min <span class="token operator">>=</span><span class="token number">60</span> <span class="token operator">and</span> 各玩家首日总在线时长_min <span class="token operator">&lt;</span><span class="token number">120</span> <span class="token keyword">then</span> <span class="token string">'1-2h'</span>
<span class="token keyword">when</span> 各玩家首日总在线时长_min <span class="token operator">>=</span><span class="token number">120</span> <span class="token operator">and</span> 各玩家首日总在线时长_min <span class="token operator">&lt;</span><span class="token number">180</span> <span class="token keyword">then</span> <span class="token string">'2-3h'</span>
<span class="token keyword">when</span> 各玩家首日总在线时长_min <span class="token operator">>=</span><span class="token number">180</span> <span class="token operator">and</span> 各玩家首日总在线时长_min <span class="token operator">&lt;</span><span class="token number">300</span> <span class="token keyword">then</span> <span class="token string">'3-5h'</span>
<span class="token keyword">else</span> <span class="token string">'5h以上'</span> <span class="token keyword">end</span>
<span class="token punctuation">)</span>
<span class="token keyword">select</span>
t6 <span class="token keyword">as</span> <span class="token string">"时间分布"</span>，
<span class="token function">count</span><span class="token punctuation">(</span>角色id<span class="token punctuation">)</span> <span class="token keyword">as</span> 玩家人数
<span class="token keyword">from</span> t5
<span class="token keyword">group</span> <span class="token keyword">by</span> t6
<span class="token keyword">order</span> <span class="token keyword">by</span> field<span class="token punctuation">(</span>时间分布<span class="token punctuation">,</span><span class="token string">'0-30min'</span><span class="token punctuation">,</span><span class="token string">'30min-1h'</span><span class="token punctuation">,</span><span class="token string">'1-2h'</span><span class="token punctuation">,</span><span class="token string">'2-3h'</span><span class="token punctuation">,</span><span class="token string">'3-5h'</span><span class="token punctuation">)</span>
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/rbrvfvb92n.png" alt="Image Name"></p>
<h2 id="查询入职以来的薪水涨幅"><a href="#查询入职以来的薪水涨幅" class="headerlink" title="查询入职以来的薪水涨幅"></a>查询入职以来的薪水涨幅</h2><p>“雇员表“中记录了员工的信息。<br><img src="https://cdn.kesci.com/upload/image/raku50uk0j.png" alt="Image Name"><br>“员工薪水表“中记录了对应员工发放的薪水。两表通过“雇员编号”关联。<br><img src="https://cdn.kesci.com/upload/image/raku5abi2v.png" alt="Image Name"></p>
<p>查找当前所有雇员入职以来的薪水涨幅，给出雇员编号以及其对应的薪水涨幅，并按照薪水涨幅进行升序。（注：薪水表中结束日期为2004-01-01的才是当前员工，否则是已离职员工）</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> 雇员编号<span class="token punctuation">,</span>
薪水 <span class="token keyword">AS</span> 当前工资
<span class="token keyword">FROM</span> 员工薪水表
<span class="token keyword">WHERE</span> 结束日期<span class="token operator">=</span><span class="token string">'2004-01-01'</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t2 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> 雇员编号<span class="token punctuation">,</span>薪水 <span class="token keyword">AS</span> 入职工资
<span class="token keyword">FROM</span> 员工薪水表
<span class="token keyword">JOIN</span> 雇员表 
<span class="token keyword">USING</span><span class="token punctuation">(</span>雇员编号<span class="token punctuation">)</span>
<span class="token keyword">WHERE</span> 起始日期<span class="token operator">=</span>雇用日期
<span class="token punctuation">)</span>
<span class="token keyword">select</span> 雇员编号<span class="token punctuation">,</span>当前工资<span class="token operator">-</span>入职工资 <span class="token keyword">as</span> 薪水涨幅
<span class="token keyword">from</span> t1
<span class="token keyword">left</span> <span class="token keyword">join</span> t2
useing<span class="token punctuation">(</span>雇员编号<span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> 薪水涨幅 <span class="token keyword">desc</span>
</code></pre>
<p>WITH AS短语，也叫做子查询部分（subquery factoring），是用来定义一个SQL片断，该SQL片断会被整个SQL语句所用到。这个语句算是公用表表达式（CTE）</p>
<p>有一张“课程销售订单表”，包含4个字段：用户id、下单日期、下单id、学科。</p>
<p><img src="https://cdn.kesci.com/upload/image/rakehufcb2.png" alt="Image Name"><br><strong>问题：查询每个用户第一个订单的记录，如果同时下单了包含多个课程的订单，则按照“语文、数学、英语”顺序排序。</strong></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 用户id <span class="token keyword">order</span> <span class="token keyword">by</span> 下单日期<span class="token punctuation">)</span> <span class="token keyword">as</span> rank
<span class="token keyword">from</span> 课程销售订单表
<span class="token punctuation">)</span>
selet <span class="token operator">*</span>
<span class="token keyword">from</span> t1
<span class="token keyword">where</span> rank<span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> 用户id<span class="token punctuation">,</span>field<span class="token punctuation">(</span>学科，<span class="token string">'语文'</span><span class="token punctuation">,</span><span class="token string">'数学'</span><span class="token punctuation">,</span><span class="token string">'英语'</span><span class="token punctuation">)</span>
</code></pre>
<p>FIELD()函数返回的索引（从1开始的位置）的str在str1，str2，STR3，…列表中。如果str没有找到，则返回0。就是用第一个参数str,跟后面的N个字符串参数中寻找，如果寻找到一模一样的字符串，则返回其索引位置。</p>
<h2 id="快递场景"><a href="#快递场景" class="headerlink" title="快递场景"></a>快递场景</h2><p>有一张“快递揽收表”，包含3列：运单号、客户id、创建日期。<br><img src="https://cdn.kesci.com/upload/image/raji6h3q70.png" alt="Image Name"><br>问题：查询运单创建日期在0501-0531期间不同单量区间的客户分布。最终得出的数据如下：<br><img src="https://cdn.kesci.com/upload/image/rakeqpjeuy.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> 
    客户id<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> 运单号<span class="token punctuation">)</span> <span class="token keyword">AS</span> 运单数量 
<span class="token keyword">FROM</span>
    快递揽收表 
    <span class="token keyword">WHERE</span> DATE_FORMAT<span class="token punctuation">(</span>创建日期<span class="token punctuation">,</span> <span class="token string">'%Y/%m/%d'</span><span class="token punctuation">)</span> <span class="token operator">BETWEEN</span> <span class="token string">'2020/05/01'</span> 
      <span class="token operator">AND</span> <span class="token string">'2020/05/31'</span> 
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 客户id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t2 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> 
    <span class="token operator">*</span><span class="token punctuation">,</span>
    <span class="token keyword">CASE</span>
      <span class="token keyword">WHEN</span> 运单数量 <span class="token operator">BETWEEN</span> <span class="token number">0</span> 
      <span class="token operator">AND</span> <span class="token number">5</span> 
      <span class="token keyword">THEN</span> <span class="token string">'0-5'</span> 
      <span class="token keyword">WHEN</span> 运单数量 <span class="token operator">BETWEEN</span> <span class="token number">6</span> 
      <span class="token operator">AND</span> <span class="token number">10</span> 
      <span class="token keyword">THEN</span> <span class="token string">'6-10'</span> 
      <span class="token keyword">WHEN</span> 运单数量 <span class="token operator">BETWEEN</span> <span class="token number">11</span> 
      <span class="token operator">AND</span> <span class="token number">20</span> 
      <span class="token keyword">THEN</span> <span class="token string">'11-20'</span> 
      <span class="token keyword">ELSE</span> <span class="token string">'20以上'</span> 
    <span class="token keyword">END</span> <span class="token keyword">AS</span> 单量 
  <span class="token keyword">FROM</span> t1  
<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">SELECT</span> 
  单量<span class="token punctuation">,</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> 客户id<span class="token punctuation">)</span> <span class="token keyword">AS</span> 客户数 
<span class="token keyword">FROM</span> t2
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 单量
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> field<span class="token punctuation">(</span>单量<span class="token punctuation">,</span><span class="token string">'0-5'</span><span class="token punctuation">,</span><span class="token string">'6-10'</span><span class="token punctuation">,</span><span class="token string">'11-20'</span><span class="token punctuation">,</span><span class="token string">'20以上'</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="找到特殊的电话号码"><a href="#找到特殊的电话号码" class="headerlink" title="找到特殊的电话号码"></a>找到特殊的电话号码</h2><p>有一张“电话费用表”，包含3个字段：电话号码（8位数）、月份、月消费。<br><img src="https://cdn.kesci.com/upload/image/raj505ndk5.png" alt="Image Name"><br>其中，月消费为0表明该月没有产生费用。第一行数据含义：电话号码（64262631）在月份（2017年11月）产生的月消费（30.6元的话费）。</p>
<p>查找2017年截止到10月31日所有四位尾数符合AABB或者ABAB或者AAAA的电话号</p>
<p>SQL MID() 函数用于得到一个字符串的一部分。这个函数被MySQL支持，但不被MS SQL Server和Oracle支持。在SQL Server， Oracle 数据库中，我们可以使用 SQL SUBSTRING函数或者 SQL SUBSTR函数作为替代。</p>
<p>MID() 函数语法为：</p>
<p>SELECT MID(ColumnName, Start [, Length])</p>
<p>FROM TableName</p>
<p>注：字符串从1开始，而非0，Length是可选项，如果没有提供，MID()函数将返回余下的字符串。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> 电话号码
<span class="token keyword">from</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
<span class="token function">mid</span><span class="token punctuation">(</span>电话号码，<span class="token number">5</span>，<span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 第五位数，
<span class="token function">mid</span><span class="token punctuation">(</span>电话号码，<span class="token number">6</span>，<span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 第六位数，
<span class="token function">mid</span><span class="token punctuation">(</span>电话号码，<span class="token number">7</span>，<span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 第七位数，
<span class="token keyword">right</span><span class="token punctuation">(</span>电话号码，<span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 第八位数，
<span class="token keyword">from</span> 电话费用表
<span class="token keyword">where</span> 月份<span class="token operator">&lt;</span><span class="token number">201711</span><span class="token punctuation">)</span> <span class="token number">a</span>
<span class="token keyword">where</span> 第五位数<span class="token operator">=</span>第六位数 <span class="token operator">and</span> 第七位数<span class="token operator">=</span>第八位数 <span class="token operator">and</span> 第五位数<span class="token operator">&lt;></span>第七位数
<span class="token operator">or</span> 第五位数<span class="token operator">&lt;></span>第六位数 <span class="token operator">and</span> 第五位数<span class="token operator">=</span>第七位数 <span class="token operator">and</span> 第六位数<span class="token operator">=</span>第八位数
<span class="token operator">or</span> 第五位数<span class="token operator">=</span>第六位数 <span class="token operator">and</span> 第五位数<span class="token operator">=</span>第七位数 <span class="token operator">and</span> 第五位数<span class="token operator">=</span>第八位数
<span class="token punctuation">)</span>
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/raj52es5ee.png" alt="Image Name"></p>
<p>查找除去10月份重复数据的结果。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token keyword">from</span> 电话费用表
<span class="token keyword">where</span> 月份<span class="token operator">&lt;></span><span class="token number">201710</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> <span class="token operator">*</span>
<span class="token keyword">from</span> 电话费用表
<span class="token keyword">where</span> 月份<span class="token operator">=</span><span class="token number">201710</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> 月份
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/raj54ruqsi.png" alt="Image Name"></p>
<p>查找2017年6、7、8月都有话费，但是9、10月没有产生话费，并且6、7、8月话费均在51-100元之间的电话号码。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> 电话号码
<span class="token keyword">from</span> 
    电话费用表
<span class="token keyword">where</span> 月份 <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'201709'</span>，<span class="token string">'201710'</span><span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> 电话号码
<span class="token keyword">having</span> <span class="token function">max</span><span class="token punctuation">(</span>月消费<span class="token punctuation">)</span><span class="token operator">&lt;></span><span class="token number">0</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t2 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> 电话号码
<span class="token keyword">from</span> 
    电话费用表  
<span class="token keyword">where</span> 月份 <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'201706'</span><span class="token punctuation">,</span><span class="token string">'201707'</span><span class="token punctuation">,</span><span class="token string">'201708'</span><span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> 电话号码
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 月份<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">3</span>
    <span class="token operator">and</span> <span class="token function">min</span><span class="token punctuation">(</span>月消费<span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">51</span>
    <span class="token operator">and</span> <span class="token function">max</span><span class="token punctuation">(</span>月消费<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">100</span>
<span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token keyword">from</span> t2
<span class="token keyword">where</span> 电话号码 <span class="token operator">not</span> <span class="token operator">in</span> t1
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/rajff2elpo.png" alt="Image Name"></p>
<h2 id="分析学员续费"><a href="#分析学员续费" class="headerlink" title="分析学员续费"></a>分析学员续费</h2><p>某线上学习平台设置学员线上学习阶梯，新学员购买50节课为一个学习阶段，学习完想要进入下个阶段必须再次购买，即续费（假设所有学员只能续费一次）并且每个学员可选择不同老师进行学习。</p>
<p>表一：学员上课表<br><img src="https://cdn.kesci.com/upload/image/ragqs5o6ce.png" alt="Image Name"><br>表二：购买表<br><img src="https://cdn.kesci.com/upload/image/ragqsqf34p.png" alt="Image Name"></p>
<p><strong>问题：<br>1.现求出续费学员在续费前3个月内的总课量，3个月给学员上课老师数量，以及每个上课老师给学员的上课量。</strong></p>
<p>DATE_SUB() 函数从日期减去指定的时间间隔。</p>
<p>DATE_SUB(date,INTERVAL expr type)<br>date 参数是合法的日期表达式。expr 参数是您希望添加的时间间隔。</p>
<p>INTERVAL -31 DAY  表示未来31天</p>
<p>INTERVAL 31 DAY  表示过去的31天</p>
<pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#第一问前两解答：</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 续费学员的总课量<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 老师id<span class="token punctuation">)</span> <span class="token keyword">as</span> 上课老师数量，
<span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> 续费时间<span class="token punctuation">,</span>学员id
<span class="token keyword">from</span> 购买表
<span class="token keyword">where</span> 订单类型<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">a</span>
<span class="token keyword">join</span> 学员上课表 <span class="token number">b</span>
<span class="token keyword">on</span> <span class="token number">a</span><span class="token punctuation">.</span>学员id<span class="token operator">=</span><span class="token number">b</span><span class="token punctuation">.</span>学员id
<span class="token keyword">where</span> 上课时间<span class="token operator">></span>date_sub<span class="token punctuation">(</span>续费时间<span class="token punctuation">,</span>interval <span class="token number">3</span> montch<span class="token punctuation">)</span>
<span class="token operator">and</span> 上课时间<span class="token operator">&lt;</span>续费时间
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/ragqvns889.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#第一问最后一小问解答：</span>
<span class="token keyword">select</span> 
<span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 每个上课老师给学员的上课量<span class="token punctuation">,</span>
老师id，
<span class="token keyword">FROM</span> 
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> 续费时间<span class="token punctuation">,</span>学员id
<span class="token keyword">FROM</span> 购买表
<span class="token keyword">WHERE</span> 订单类型<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">a</span>
<span class="token keyword">JOIN</span> 学员上课表 <span class="token number">b</span>
<span class="token keyword">ON</span> <span class="token number">a</span><span class="token punctuation">.</span>学员id<span class="token operator">=</span><span class="token number">b</span><span class="token punctuation">.</span>学员id
<span class="token keyword">WHERE</span> 上课时间 <span class="token operator">></span>DATE_SUB<span class="token punctuation">(</span>续费时间<span class="token punctuation">,</span>INTERVAL <span class="token number">3</span> MONTH<span class="token punctuation">)</span> <span class="token operator">AND</span> 上课时间<span class="token operator">&lt;</span>续费时间
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 老师id
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/ragqy4qaaw.png" alt="Image Name"></p>
<p>2.现求出每个续费学员在续费前的最后一节课的时间，以及对应的学员。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#第二问</span>
<span class="token keyword">SELECT</span> <span class="token number">a</span><span class="token punctuation">.</span>学员id<span class="token punctuation">,</span><span class="token function">MAX</span><span class="token punctuation">(</span>上课时间<span class="token punctuation">)</span> <span class="token keyword">AS</span> 续费前最后一节课的时间
<span class="token keyword">FROM</span> 
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> 续费时间<span class="token punctuation">,</span>学员id
<span class="token keyword">FROM</span> 购买表
<span class="token keyword">WHERE</span> 订单类型<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">a</span>
<span class="token keyword">JOIN</span> 学员上课表 <span class="token number">b</span>
<span class="token keyword">ON</span> <span class="token number">a</span><span class="token punctuation">.</span>学员id<span class="token operator">=</span><span class="token number">b</span><span class="token punctuation">.</span>学员id
<span class="token keyword">WHERE</span> 上课时间<span class="token operator">&lt;</span>续费时间
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token number">a</span><span class="token punctuation">.</span>学员id
</code></pre>
<p>结果如下：-<br><img src="https://cdn.kesci.com/upload/image/ragr0logzr.png?imageView2/0/w/960/h/960" alt="Image Name"></p>
<h2 id="各岗位编号中位数所在位置"><a href="#各岗位编号中位数所在位置" class="headerlink" title="各岗位编号中位数所在位置"></a>各岗位编号中位数所在位置</h2><p>学校每次考试完，都会有一个考试成绩表。例如，表中第1行表示编号为1的用户选择了C++岗位，该科目考了11001分。<br><img src="https://cdn.kesci.com/upload/image/ragnj11je1.png" alt="Image Name"><br>问题：写一个sql语句查询每个岗位编号的中位数位置的范围，并且按岗位升序排序。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> 岗位，
floor<span class="token punctuation">(</span><span class="token punctuation">(</span>成绩个数<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 起始位置，
ceil<span class="token punctuation">(</span><span class="token punctuation">(</span>成绩个数<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 结束位置
<span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> 岗位<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 成绩个数
 <span class="token keyword">from</span> 考试成绩表
 <span class="token keyword">group</span> <span class="token keyword">by</span> 岗位<span class="token punctuation">)</span> <span class="token number">a</span>
 <span class="token keyword">order</span> <span class="token keyword">by</span> 岗位 <span class="token keyword">asc</span>
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/ragnpxfoj1.png" alt="Image Name"></p>
<h2 id="银行数据分析实战"><a href="#银行数据分析实战" class="headerlink" title="银行数据分析实战"></a>银行数据分析实战</h2><p>某理财银行有下面3个表。<br>交易表记录了每天交易的客户交易时间、客户号、消费类型和消费金额。其中，交易类型有两种值：消费和转账。<br><img src="https://cdn.kesci.com/upload/image/rafpubcf42.png" alt="Image Name"><br>客户表记录了客户信息，包括客户号，客户名称和客户所属的银行分行号。<br><img src="https://cdn.kesci.com/upload/image/rafpuw55a6.png" alt="Image Name"><br>银行分行记录表记录每个分行的信息，包括分行号、分行名称及对应上级分行。<br><img src="https://cdn.kesci.com/upload/image/rafpw0cgss.png" alt="Image Name"></p>
<p>该理财银行要求对客户及销售额分析报告，要求如下：<br>1.计算2016年1-3月的消费总金额，生成如下格式的查询结果：<br><img src="https://cdn.kesci.com/upload/image/rafpxkvt99.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> date_format<span class="token punctuation">(</span>交易时间<span class="token punctuation">,</span><span class="token string">'%Y年%m月'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 年月<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>交易金额<span class="token punctuation">)</span> <span class="token keyword">as</span> 消费总金额
<span class="token keyword">from</span> 交易表
<span class="token keyword">where</span> 交易时间 <span class="token operator">between</span> <span class="token string">'2016-01-01'</span> <span class="token operator">and</span> <span class="token string">'2016-03-31'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>交易时间<span class="token punctuation">,</span><span class="token string">'%Y年%m月'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> 年月<span class="token operator">=</span><span class="token string">'2016年01月'</span> <span class="token keyword">then</span> 消费金额 <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">2016</span>年<span class="token number">01</span>月，
<span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> 年月<span class="token operator">=</span><span class="token string">'2016年02月'</span> <span class="token keyword">then</span> 消费金额 <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">2016</span>年<span class="token number">02</span>月，
<span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> 年月<span class="token operator">=</span><span class="token string">'2016年03月'</span> <span class="token keyword">then</span> 消费金额 <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">2016</span>年<span class="token number">03</span>月
<span class="token keyword">from</span> t1
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/rafq1hexzf.png" alt="Image Name"></p>
<p>2.提取2016年3月消费金额大于等于1288的客户名单，并给出这些客户信息：<br><img src="https://cdn.kesci.com/upload/image/rafpyxsw5v.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> 客户名称，
<span class="token function">sum</span><span class="token punctuation">(</span>交易金额<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token number">2016</span>年<span class="token number">3</span>月总消费金额
<span class="token keyword">from</span> 交易表 <span class="token number">a</span>
<span class="token keyword">join</span> 客户表 <span class="token number">b</span>
<span class="token keyword">on</span> <span class="token number">a</span><span class="token punctuation">.</span>交易客户<span class="token operator">=</span><span class="token number">b</span><span class="token punctuation">.</span>客户号
<span class="token keyword">where</span> 交易时间 <span class="token operator">between</span> <span class="token string">'2016-01-01'</span> <span class="token operator">and</span> <span class="token string">'2016-03-31'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> 客户名称
<span class="token keyword">having</span> <span class="token function">sum</span><span class="token punctuation">(</span>交易金额<span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">1288</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t2 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>交易金额<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 客户名称 <span class="token keyword">order</span> <span class="token keyword">by</span> 交易时间<span class="token punctuation">)</span> <span class="token keyword">as</span> 累积消费
<span class="token keyword">from</span> 交易表 <span class="token number">a</span>
<span class="token keyword">join</span> 客户表 <span class="token number">b</span>
<span class="token keyword">on</span> <span class="token number">a</span><span class="token punctuation">.</span>交易客户<span class="token operator">=</span><span class="token number">b</span><span class="token punctuation">.</span>客户号
<span class="token keyword">where</span> 交易时间 <span class="token operator">between</span> <span class="token string">'2016-01-01'</span> <span class="token operator">and</span> <span class="token string">'2016-03-31'</span>
<span class="token keyword">where</span> 累计消费<span class="token operator">></span><span class="token number">1288</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t3 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> 客户名称，交易时间
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> 客户名称 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 交易时间<span class="token punctuation">)</span> <span class="token keyword">AS</span> 排序
<span class="token keyword">from</span> t2
<span class="token keyword">where</span> 排序<span class="token operator">=</span><span class="token number">1</span>
<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">select</span> t1<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>t3<span class="token punctuation">.</span>交易时间 <span class="token keyword">as</span> <span class="token number">2016</span>年<span class="token number">3</span>月消费金额首次达到<span class="token number">1288</span>的时间
<span class="token keyword">from</span> t1 
<span class="token keyword">left</span> <span class="token keyword">join</span> t3
<span class="token keyword">using</span><span class="token punctuation">(</span>客户名称<span class="token punctuation">)</span>
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/rafq587qnh.png" alt="Image Name"></p>
<p>3.汇总各省分行（省分行下属支行也需要汇总至省分行）的2016年3月的总消费金额。</p>
<p>mysql语句中like用法：</p>
<p>1、常见用法：</p>
<p>(1)搭配%使用</p>
<p>%代表一个或多个字符的通配符，譬如查询字段name中以大开头的数据：</p>
<p>(2)搭配_使用</p>
<p>_代表仅仅一个字符的通配符，把上面那条查询语句中的%改为_，会发现只能查询出一条数据。</p>
<p>(3)[ ] 指定范围 ([a-f]) 或集合 ([abcdef]) 中的任何单个字符：</p>
<p>1，like’[CK]ars[eo]n’ 将搜索下列字符串：Carsen、Karsen、Carson 和 Karson(如 Carson)。</p>
<p>2、like’[M-Z]inger’ 将搜索以字符串 inger 结尾、以从 M 到 Z 的任何单个字母开头的所有名称(如 Ringer)。</p>
<p> using()用于两张表的join查询，，要求using()指定的列在两个表中均存在，并使用之用于join的条件。 示例： select a.<em>, b.</em> from a left join b using(colA); 等同于： select a.<em>, b.</em> from a left join b on a.colA = b.colA;</p>
<p>using() 只是join中指定连接条件的简写，在简单的连接中常用。在列名称不同时或连接条件复杂时就无法用了</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> 分行号<span class="token punctuation">,</span>分行名称，上级分行，<span class="token function">sum</span><span class="token punctuation">(</span>交易金额<span class="token punctuation">)</span> <span class="token keyword">as</span> 分行消费总金额
    <span class="token keyword">from</span> 交易表 <span class="token number">a</span>
    <span class="token keyword">join</span> 客户表 <span class="token number">b</span>
    <span class="token keyword">on</span> <span class="token number">a</span><span class="token punctuation">.</span>交易客户<span class="token operator">=</span><span class="token number">b</span><span class="token punctuation">.</span>客户号
    <span class="token keyword">join</span> 银行分行对应表 <span class="token number">c</span>
    <span class="token keyword">on</span> <span class="token number">b</span><span class="token punctuation">.</span>所属分行<span class="token operator">=</span><span class="token number">c</span><span class="token punctuation">.</span>分行号
    <span class="token keyword">where</span> 交易时间 <span class="token operator">between</span> <span class="token string">'2016-03-01'</span> <span class="token operator">and</span> <span class="token string">'2016-03-31'</span> <span class="token operator">and</span> 交易类型<span class="token operator">=</span><span class="token string">'消费'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> 分行号，分行名称，上级分行
<span class="token punctuation">)</span>，
t2 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token number">a</span><span class="token punctuation">.</span>分行号 <span class="token keyword">as</span> 省分行号<span class="token punctuation">,</span><span class="token number">b</span><span class="token punctuation">.</span>分行号 <span class="token keyword">as</span> 分行号<span class="token punctuation">,</span><span class="token number">c</span><span class="token punctuation">.</span>分行号 <span class="token keyword">as</span> 分行号<span class="token number">1</span>
    <span class="token keyword">from</span> 银行分行对应表 <span class="token number">a</span><span class="token punctuation">,</span>银行分行对应表 <span class="token number">b</span><span class="token punctuation">,</span>银行分行对应表 <span class="token number">c</span>
    <span class="token keyword">where</span> <span class="token number">a</span><span class="token punctuation">.</span>分行号<span class="token operator">=</span><span class="token number">b</span><span class="token punctuation">.</span>上级分行 <span class="token operator">and</span> <span class="token number">b</span><span class="token punctuation">.</span>分行号<span class="token operator">=</span><span class="token number">c</span><span class="token punctuation">.</span>上级分行 <span class="token operator">and</span> <span class="token number">a</span><span class="token punctuation">.</span>分行名称 <span class="token operator">like</span> <span class="token string">'%省分行'</span>
<span class="token punctuation">)</span>，
t3 <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> 省分行号，分行号
    <span class="token keyword">from</span> t2
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span> 省分行号，分行号
    <span class="token keyword">from</span> t2
    uinon <span class="token keyword">all</span>
    <span class="token keyword">select</span> 省分行号，分行号
    <span class="token keyword">from</span> t2
    <span class="token keyword">order</span> <span class="token keyword">by</span> 省分行号 
<span class="token punctuation">)</span>，
t4 <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> 省分行号<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>分行消费总金额<span class="token punctuation">)</span> <span class="token keyword">as</span> 各省分行<span class="token number">2016</span>年<span class="token number">3</span>月的总消费金额
    <span class="token keyword">from</span> t1
    <span class="token keyword">left</span> <span class="token keyword">join</span> t3
    <span class="token keyword">using</span> <span class="token punctuation">(</span>分行号<span class="token punctuation">)</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> 省分行号
<span class="token punctuation">)</span>，
t5 <span class="token keyword">as</span> <span class="token punctuation">(</span>
selct <span class="token number">a</span><span class="token punctuation">.</span>分行名称<span class="token punctuation">,</span>各省分行<span class="token number">2016</span>年<span class="token number">3</span>月的总消费金额
    <span class="token keyword">from</span> t4
    <span class="token keyword">left</span> <span class="token keyword">join</span> 银行分行对应表 <span class="token number">a</span>
    <span class="token keyword">on</span> t4<span class="token punctuation">.</span>省分行号<span class="token operator">=</span><span class="token number">a</span><span class="token punctuation">.</span>分行号
<span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t5
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/rafq9l8tie.png" alt="Image Name"></p>
<h2 id="交易记录分析实战"><a href="#交易记录分析实战" class="headerlink" title="交易记录分析实战"></a>交易记录分析实战</h2><p>某商场为了分析用户购买渠道。表1是用户交易记录表，记录了用户id、交易日期、交易类型和交易金额。<br><img src="https://cdn.kesci.com/upload/image/raf9rdxcdh.png" alt="Image Name"><br>表2是用户类型表，记录了用户支付类型（比如微信、支付宝、信用卡等），分别有type1、type2。<br><img src="https://cdn.kesci.com/upload/image/raf9rqrjp6.png" alt="Image Name"></p>
<p>问题：<br>1.请在 type1的用户类型中，找出总交易金额最大的用户。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> 用户类型<span class="token punctuation">,</span>用户id<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>交易金额<span class="token punctuation">)</span> <span class="token keyword">as</span> 总易金额
<span class="token keyword">from</span> 用户交易记录表
<span class="token keyword">join</span> 用户类型表  <span class="token keyword">using</span> <span class="token punctuation">(</span>用户id<span class="token punctuation">)</span>
<span class="token keyword">where</span> 用户类型<span class="token operator">=</span><span class="token string">'type1'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> 用户id
<span class="token keyword">having</span> <span class="token function">sum</span><span class="token punctuation">(</span>交易金额<span class="token punctuation">)</span> <span class="token operator">>=</span><span class="token keyword">all</span>
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/raf9ww5jpq.png" alt="Image Name"></p>
<p>2.筛选每个用户的第2笔交易记录。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> 用户id <span class="token keyword">order</span> <span class="token keyword">by</span> 交易日期<span class="token punctuation">)</span> <span class="token keyword">as</span> 第几笔交易记录
<span class="token keyword">from</span> 用户交易记录表    
<span class="token punctuation">)</span> <span class="token number">a</span>
<span class="token keyword">where</span> 第几笔交易记录<span class="token operator">=</span><span class="token number">2</span>
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/raf9ywct9s.png" alt="Image Name"></p>
<p>3.如何实现如下表的数据格式？**<br><img src="https://cdn.kesci.com/upload/image/raf9utarma.png" alt="Image Name"></p>
<p>将group by产生的同一个分组中的值连接起来，返回一个<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%AD%97%E7%AC%A6%E4%B8%B2&amp;spm=1001.2101.3001.7020">字符串</a>结果。</p>
<p>group_concat([distinct] 字段名 [order by 排序字段 asc/desc] [separator ‘分隔符’])</p>
<p>说明：</p>
<p>(1)使用distinct可以排除重复值；</p>
<p>(2)如果需要对结果中的值进行排序，可以使用order by子句；</p>
<p>(3)separator是一个字符串值，默认为逗号。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> id<span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>交易日期<span class="token punctuation">)</span> <span class="token keyword">as</span> 交易日期<span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>交易类型<span class="token punctuation">)</span> <span class="token keyword">as</span> 交易类型
<span class="token keyword">from</span> 用户交易记录表
<span class="token keyword">group</span> <span class="token keyword">by</span> 用户id
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/rafa151k40.png" alt="Image Name"></p>
<h2 id="房产订单分析"><a href="#房产订单分析" class="headerlink" title="房产订单分析"></a>房产订单分析</h2><p>“成交订单表”里记录了某房产平台（类似链家、贝壳等）每日房屋成交的明细。（贝壳面试题）<br><img src="https://cdn.kesci.com/upload/image/raeysslash.png" alt="Image Name"><br>字段“成交客源渠道”中的值是“客源角色人”、“业主线上委托”、“null”表示线下渠道，其余的成交客源渠道是线上。<br>要求：<br>1．当月截止昨天二手线上成交单量占比（含车位）&gt;=50%的门店可获奖；</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span> <span class="token comment" spellcheck="true">-- 求出是否线上</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> 成交客源渠道 <span class="token operator">in</span><span class="token punctuation">(</span><span class="token string">'客源角色人'</span><span class="token punctuation">,</span><span class="token string">'业主线上委托'</span><span class="token punctuation">)</span> <span class="token operator">or</span> 成交客源渠道 <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token string">'否'</span> <span class="token keyword">else</span> <span class="token string">'是'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> 是否线上
    <span class="token keyword">from</span> 成交订单表
<span class="token punctuation">)</span>，
t2 <span class="token keyword">as</span><span class="token punctuation">(</span> <span class="token comment" spellcheck="true">-- 求出各门店的线上成交占比</span>
    <span class="token keyword">select</span> 签约经纪人门店，<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> 是否线上<span class="token operator">=</span><span class="token string">'是'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 经纪人门店的线上成交占比
<span class="token keyword">from</span> t1
<span class="token keyword">group</span> <span class="token keyword">by</span> 签约经纪人门店
<span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre>
<p>（线上成交占比=线上成交单量/总成交单量）<br>2．符合获奖条件的门店的第1单线上成交可获得200贝壳币（可以用于兑换奖金），第2单可获400贝壳币，第3单及以上可获800贝壳币，但车库不奖励（字段“房屋用途”中的值是”车位”、”车库”认为是车库）；</p>
<pre class=" language-sql"><code class="language-sql">t3 <span class="token keyword">as</span><span class="token punctuation">(</span> <span class="token comment" spellcheck="true">-- 得出原表加上前面所求2个字段,并添加一个线上订单排序</span>
<span class="token keyword">select</span> t1<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>t2<span class="token punctuation">.</span>经纪人门店的线上成交占比<span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 签约经纪人门店 <span class="token keyword">order</span> <span class="token keyword">by</span> 签约时间<span class="token punctuation">)</span> <span class="token keyword">as</span>  订单顺序
    <span class="token keyword">from</span> t1
    <span class="token keyword">join</span> t2
    <span class="token keyword">on</span> t1<span class="token punctuation">.</span>签约经纪人门店<span class="token operator">=</span>t2<span class="token punctuation">.</span>签约经纪人门店
    <span class="token keyword">where</span> 是否线上<span class="token operator">=</span><span class="token string">'是'</span>
    <span class="token operator">and</span> 经纪人门店的线上成交占比<span class="token operator">>=</span><span class="token number">0.5</span>
    <span class="token operator">and</span> 房屋用途 <span class="token operator">is</span> <span class="token boolean">null</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t4 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> 订单顺序<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'200'</span> <span class="token keyword">when</span> 订单顺序<span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">then</span> <span class="token string">'400'</span> <span class="token keyword">when</span> 订单顺序<span class="token operator">>=</span><span class="token number">3</span> <span class="token keyword">then</span> <span class="token string">'800'</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token keyword">as</span> 订单可获贝壳币
    <span class="token keyword">from</span> t3
<span class="token punctuation">)</span>
</code></pre>
<p>3.在一个连续的SQL中实现以上需求，不能拆分成多个SQL，必须输出表格字段如下（可增加）；**<br><img src="https://cdn.kesci.com/upload/image/raez0d965r.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> t1<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>t2<span class="token punctuation">.</span>经纪人门店的线上成交占比<span class="token punctuation">,</span>ifnull<span class="token punctuation">(</span>t4<span class="token punctuation">.</span>订单可获贝壳币<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 订单可获贝壳币
<span class="token keyword">from</span> t1
<span class="token keyword">left</span> <span class="token keyword">join</span> t2
<span class="token keyword">on</span> 签约经纪人门店<span class="token operator">=</span>t2<span class="token punctuation">.</span>签约经纪人门店
<span class="token keyword">left</span> <span class="token keyword">join</span> t4
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>协议id<span class="token operator">=</span>t4<span class="token punctuation">.</span>协议id
<span class="token keyword">order</span> <span class="token keyword">by</span> 签约经纪人门店<span class="token punctuation">,</span>签约时间
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/raeyxaq041.png" alt="Image Name"></p>
<h2 id="电影"><a href="#电影" class="headerlink" title="电影"></a>电影</h2><p>某电影平台（类似豆瓣、猫眼电影）用3个表来记录电影信息。<br>“电影表”中是电影编号、电影名称、电影描述信息。<br><img src="https://cdn.kesci.com/upload/image/raev4iwaud.png" alt="Image Name"><br>“类别表”是电影分类信息，类别包括：犯罪电影、爱情电影、科幻电影。<br><img src="https://cdn.kesci.com/upload/image/raev51o9q9.png" alt="Image Name"><br>“电影类别表”是对应电影（电影表中的电影编号）属于哪一类（类别表中的电影类别编号）<br><img src="https://cdn.kesci.com/upload/image/raev5jaoll.png" alt="Image Name"><br><strong>查找“电影表”电影描述信息包含“机器人”的电影，求出对应的电影类别名称和电影数目,还需该电影类别名称对应电影数量&gt;=5部。</strong></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> 电影类别名称，<span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 电影数目
<span class="token keyword">from</span> 电影表
<span class="token keyword">left</span> <span class="token keyword">join</span> 电影类别表 <span class="token keyword">using</span><span class="token punctuation">(</span>电影编号<span class="token punctuation">)</span>
<span class="token keyword">left</span> <span class="token keyword">join</span> 类别表 <span class="token keyword">using</span><span class="token punctuation">(</span>电影类别编号<span class="token punctuation">)</span>
<span class="token keyword">where</span> 电影描述信息 <span class="token operator">like</span> <span class="token string">'%机器人%'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> 电影类别名称
<span class="token keyword">having</span> 电影类别名称 <span class="token operator">in</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> 电影类别名称
<span class="token keyword">from</span> 电影类别表
<span class="token keyword">join</span> 类别表 <span class="token keyword">using</span><span class="token punctuation">(</span>电影类别编号<span class="token punctuation">)</span>
 <span class="token keyword">group</span> <span class="token keyword">by</span> 电影类别名称
 <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">5</span>
<span class="token punctuation">)</span>
</code></pre>
<h2 id="通讯运营商指标分析"><a href="#通讯运营商指标分析" class="headerlink" title="通讯运营商指标分析"></a>通讯运营商指标分析</h2><p>现有表一：各城市用户ARPU值<br><img src="https://cdn.kesci.com/upload/image/rad1h8z6eb.png" alt="Image Name"><br>表二：用户套餐费用表<br><img src="https://cdn.kesci.com/upload/image/rad1i0mmxq.png" alt="Image Name"></p>
<p>业务要求：</p>
<p>1.各城市用户数、总费用（ARPU之和）是多少？</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> 城市，<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 用户id<span class="token punctuation">)</span> <span class="token keyword">as</span> 各城市用户数<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>ARPU<span class="token punctuation">)</span> <span class="token keyword">as</span> 总费用
<span class="token keyword">from</span> 各城市用户ARPU值
<span class="token keyword">group</span> <span class="token keyword">by</span> 城市
</code></pre>
<p>2.各城市用户arpu值表中各城市ARPU(0,30)，[30,50)，[50-80)，[80以上)用户数分别是多少？</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>chase <span class="token keyword">when</span> ARPU值<span class="token operator">></span><span class="token number">0</span> <span class="token operator">and</span> ARPU值<span class="token operator">&lt;</span><span class="token number">30</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'[0,30)用户数'</span><span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>chase <span class="token keyword">when</span> ARPU值<span class="token operator">>=</span><span class="token number">30</span> <span class="token operator">and</span> ARPU值<span class="token operator">&lt;</span><span class="token number">50</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'[30,50)用户数'</span><span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>chase <span class="token keyword">when</span> ARPU值<span class="token operator">>=</span><span class="token number">50</span> <span class="token operator">and</span> ARPU值<span class="token operator">&lt;</span><span class="token number">80</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'[50,80)用户数'</span><span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>chase <span class="token keyword">when</span> ARPU值<span class="token operator">>=</span><span class="token number">80</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'80以上)用户数'</span><span class="token punctuation">,</span>
<span class="token keyword">from</span> 各城市用户ARPU值
<span class="token keyword">group</span> <span class="token keyword">by</span> 城市
</code></pre>
<p>3.用户套餐费用表中用户有重复的记录，找出重复的用户</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> 用户id
<span class="token keyword">from</span> 用户套餐费用表
<span class="token keyword">group</span> <span class="token keyword">by</span> 用户id
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span>用户id<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">1</span>
</code></pre>
<h2 id="打车业务分析"><a href="#打车业务分析" class="headerlink" title="打车业务分析"></a>打车业务分析</h2><p>“订单信息表”里记录了巴西乘客使用打车软件的信息，包括订单呼叫、应答、取消、完单时间。（滴滴2020年笔试题）<br><img src="https://cdn.kesci.com/upload/image/rabcwmga3.png" alt="Image Name"><br>字段释义：<br>订单id；呼叫订单识别号<br>乘客id：乘客识别号<br>呼叫时间：乘客从应用发起需要用车请求的时间（北京时间）<br>应答时间:司机点击接单的时间（北京时间）<br>取消时间：司机或乘客取消订单的时间（北京时间）<br>完单时间：司机点击到达目的地的时间（北京时间）</p>
<p><strong>注意：<br>（1）表中的时间是北京时间，巴西比中国慢11小时。<br>（2）应答时间列的数据值如果是“1970”年（巴西时间），表示该订单没有司机应答，属于无效订单。</strong></p>
<p>语法：date_sub(date,interval expr type)，函数从日期减去指定的时间间隔，</p>
<p>举例：Orders 表中 OrderDate 字段减去 2 天：</p>
<p>select OrderId,date_sub(OrderDate,interval 2 day) as OrderPayDate</p>
<p>from Orders</p>
<p>date_sub(‘2019-07-27’, interval 30 day)表示往前推30天</p>
<p>订单的应答率，完单率分别是多少？</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">case</span> <span class="token keyword">when</span> year<span class="token punctuation">(</span>date_sub<span class="token punctuation">(</span>t1<span class="token punctuation">.</span>应答时间<span class="token punctuation">,</span>interval <span class="token number">11</span> hour<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;></span><span class="token number">1970</span> <span class="token keyword">then</span> t1<span class="token punctuation">.</span>订单id <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span>订单id<span class="token punctuation">)</span> <span class="token keyword">as</span> 应答率<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">case</span> <span class="token keyword">when</span> year<span class="token punctuation">(</span>date_sub<span class="token punctuation">(</span>t1<span class="token punctuation">.</span>完单时间<span class="token punctuation">,</span>interval <span class="token number">11</span> hour<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;></span><span class="token number">1970</span> <span class="token keyword">then</span> t1<span class="token punctuation">.</span>订单id <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span>订单id<span class="token punctuation">)</span> <span class="token keyword">as</span> 完单率
<span class="token punctuation">)</span>
<span class="token keyword">from</span> 订单信息表 t1<span class="token punctuation">;</span>
</code></pre>
<p>呼叫应答平均时间有多长？</p>
<p>MySQL</p>
<p>  语法：  timestampdiff（unit，begin，end）<br>   begin和end可以为DATE或DATETIME类型，并且可允许参数为混合类型。</p>
<p>DB2</p>
<p>  语法：timestampdiff（unit，char（begin-end））</p>
<p>begin和end需要为时间戳格式。若非时间戳类型，用timestamp（）函数转换。</p>
<p>   timestampdiff（unit，char（timestamp（begin）-timestamp（end）））</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>timestampdiff<span class="token punctuation">(</span>minute<span class="token punctuation">,</span>t1<span class="token punctuation">.</span>呼叫时间<span class="token punctuation">,</span>t1<span class="token punctuation">.</span>应答时间<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">"呼叫应答平均时间(min)"</span>
<span class="token keyword">from</span> 订单信息表 t1
<span class="token keyword">where</span> year<span class="token punctuation">(</span>date_sub<span class="token punctuation">(</span>t1<span class="token punctuation">.</span>应答时间<span class="token punctuation">,</span>interval <span class="token number">11</span> hour<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;></span><span class="token number">1970</span><span class="token punctuation">;</span>
</code></pre>
<p>从这一周的数据来看，呼叫量最高的是哪一个小时（当地时间）？呼叫量最少的是哪一个小时（当地时间）？</p>
<pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">--呼叫量最高:</span>
<span class="token keyword">with</span>  t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> 
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 呼叫量 
  <span class="token keyword">FROM</span>
    订单信息表 
  <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> HOUR<span class="token punctuation">(</span>
      DATE_SUB<span class="token punctuation">(</span>呼叫时间<span class="token punctuation">,</span> INTERVAL <span class="token number">11</span> HOUR<span class="token punctuation">)</span> 
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> 
  HOUR<span class="token punctuation">(</span>
    DATE_SUB<span class="token punctuation">(</span>呼叫时间<span class="token punctuation">,</span> INTERVAL <span class="token number">11</span> HOUR<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token keyword">AS</span> 当地小时<span class="token punctuation">,</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 呼叫量 
<span class="token keyword">FROM</span> 订单信息表
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> HOUR<span class="token punctuation">(</span>
    DATE_SUB<span class="token punctuation">(</span>呼叫时间<span class="token punctuation">,</span> INTERVAL <span class="token number">11</span> HOUR<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> 
<span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token keyword">ALL</span> 
 <span class="token punctuation">(</span>t1<span class="token punctuation">)</span>   
<span class="token comment" spellcheck="true">--呼叫量最低:</span>
<span class="token keyword">SELECT</span> 
  HOUR<span class="token punctuation">(</span>
    DATE_SUB<span class="token punctuation">(</span>呼叫时间<span class="token punctuation">,</span> INTERVAL <span class="token number">11</span> HOUR<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token keyword">AS</span> 当地小时<span class="token punctuation">,</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 呼叫量 
<span class="token keyword">FROM</span>
  订单信息表 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> HOUR<span class="token punctuation">(</span>
    DATE_SUB<span class="token punctuation">(</span>呼叫时间<span class="token punctuation">,</span> INTERVAL <span class="token number">11</span> HOUR<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> 
<span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token keyword">ALL</span> 
    <span class="token punctuation">(</span>t1<span class="token punctuation">)</span>
</code></pre>
<p>最高如下：<br><img src="https://cdn.kesci.com/upload/image/rabdfesude.png" alt="Image Name"><br>最低如下：<br><img src="https://cdn.kesci.com/upload/image/rabdfsazr3.png" alt="Image Name"></p>
<p>呼叫订单第二天继续呼叫的比例有多少？</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t2 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> t1<span class="token punctuation">.</span>乘客id，day<span class="token punctuation">(</span>data_sub<span class="token punctuation">(</span>t1<span class="token punctuation">.</span>呼叫时间 interval <span class="token number">11</span> hour<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> day
    <span class="token keyword">from</span> 订单信息表 t1
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t3<span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
    lead<span class="token punctuation">(</span>day<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span>partiton <span class="token keyword">by</span> 乘客id <span class="token keyword">order</span> <span class="token keyword">by</span> day<span class="token punctuation">)</span> <span class="token keyword">as</span> next_day
    <span class="token keyword">from</span> t2
<span class="token punctuation">)</span>
<span class="token keyword">select</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> next_day<span class="token operator">-</span>day<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 次日呼叫比例
<span class="token keyword">from</span>
<span class="token punctuation">(</span>t3<span class="token punctuation">)</span>
</code></pre>
<p> 1.lag()</p>
<p>  lag(expr,N,default)</p>
<p>expr:它可以是列或任何内置函数。<br>N:它是一个正值，它确定当前行之前的行数。如果在查询中将其省略，则其默认值为1<br>default:如果在当前行之前没有行N行的情况下，它是函数返回的默认值。如果缺少，则默认为NULL。</p>
<p><strong>2.lead（）</strong></p>
<p>lead(expr,N,default)</p>
<p>expr:它可以是列或任何内置函数。</p>
<p>N:它是一个正值，它确定当前行之后的行数。如果在查询中将其省略，则其默认值为1</p>
<p>default:如果在当前行之后没有行N行的情况下，它是函数返回的默认值。如果缺少，则默认为NULL。</p>
<h2 id="常见的分组比较"><a href="#常见的分组比较" class="headerlink" title="常见的分组比较"></a>常见的分组比较</h2><p>现在有三个表，“学生表”，“课程表”，“成绩表”。<br>“学生表”记录了学生的基本信息，有“学号”、“姓名”、“出生日期”、“性别”。<br><img src="https://cdn.kesci.com/upload/image/ra80zbb9z4.png" alt="Image Name"><br>“成绩表”记录了学生选修课程的成绩，包括“学号”，选修的“课程号”以及对应课程的“成绩”。<br><img src="https://cdn.kesci.com/upload/image/ra80zwxolw.png" alt="Image Name"><br>“课程表”记录了学生选修的课程信息，包括课程号、课程名称及其对应的“教师号”<br><img src="https://cdn.kesci.com/upload/image/ra810x8qst.png" alt="Image Name"></p>
<p><strong>现在要查找出每门课程中成绩最好的学生的姓名和该学生的课程及成绩。<br>需要注意：可能出现并列第一的情况。</strong></p>
<pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">--解法一：</span>
<span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span>partiton <span class="token keyword">by</span> 课程号 <span class="token keyword">order</span> <span class="token keyword">by</span> 成绩 decs<span class="token punctuation">)</span> <span class="token keyword">as</span> 排名
    <span class="token keyword">from</span> 成绩表
    <span class="token keyword">join</span> 课程表
    <span class="token keyword">using</span><span class="token punctuation">(</span>课程号<span class="token punctuation">)</span>
    <span class="token keyword">join</span> 学生表
    <span class="token keyword">using</span><span class="token punctuation">(</span>学号<span class="token punctuation">)</span>   
<span class="token punctuation">)</span>
<span class="token keyword">select</span> 姓名<span class="token punctuation">,</span>课程名称<span class="token punctuation">,</span>成绩
<span class="token keyword">from</span> t1
    <span class="token keyword">where</span> 排名<span class="token operator">=</span><span class="token number">1</span>
    <span class="token keyword">order</span> <span class="token keyword">by</span> 课程名称
<span class="token comment" spellcheck="true">--解法二：</span>
<span class="token keyword">select</span> 姓名<span class="token punctuation">,</span>课程名称<span class="token punctuation">,</span>成绩
<span class="token keyword">from</span> 成绩表
<span class="token keyword">join</span> 课程表
<span class="token keyword">using</span><span class="token punctuation">(</span>课程号<span class="token punctuation">)</span>
<span class="token keyword">join</span> 学生表
<span class="token keyword">using</span><span class="token punctuation">(</span>学号<span class="token punctuation">)</span>
<span class="token keyword">where</span> <span class="token punctuation">(</span>课程号<span class="token punctuation">,</span>成绩<span class="token punctuation">)</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> 课程号<span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>成绩<span class="token punctuation">)</span> <span class="token keyword">from</span> 成绩表 <span class="token keyword">group</span> <span class="token keyword">by</span> 课程号<span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> 课程名称
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/ra815zvesp.png" alt="Image Name"></p>
<h2 id="行列互换"><a href="#行列互换" class="headerlink" title="行列互换"></a>行列互换</h2><p>表名：cook<br><img src="https://cdn.kesci.com/upload/image/ra7xpmgpo7.png" alt="Image Name"></p>
<p>要求查询结果如下：<br><img src="https://cdn.kesci.com/upload/image/ra7xrgqj0o.png?imageView2/0/w/960/h/960" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> 年<span class="token punctuation">,</span>
<span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">where</span> 月<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> 值 <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> m1<span class="token punctuation">,</span>
<span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">where</span> 月<span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">then</span> 值 <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> m2<span class="token punctuation">,</span>
<span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">where</span> 月<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">then</span> 值 <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> m3<span class="token punctuation">,</span>
<span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">where</span> 月<span class="token operator">=</span><span class="token number">4</span> <span class="token keyword">then</span> 值 <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> m4<span class="token punctuation">,</span>
<span class="token keyword">from</span> cook
<span class="token keyword">group</span> <span class="token keyword">by</span> 年
</code></pre>
<h2 id="球赛分析"><a href="#球赛分析" class="headerlink" title="球赛分析"></a>球赛分析</h2><p>两只篮球队进行了激烈的比赛，比分交替上升。比赛结束后，你有一张两队分数的明细表：<br><img src="https://cdn.kesci.com/upload/image/ra5ziz7z05.png" alt="Image Name"><br>该表记录了球队、球员号码、球员姓名、得分分数以及得分时间。现在球队要对比赛中表现突出的球员做出奖励。</p>
<p>问题：<br><strong>（1）请你写一个sql语句统计出：比赛中帮助各自球队反超比分的球员姓名以及对应时间</strong></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
    <span class="token keyword">case</span> <span class="token keyword">when</span> 球队<span class="token operator">=</span><span class="token string">'A'</span> <span class="token keyword">then</span> 得分分数 <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token keyword">as</span> A队分数<span class="token punctuation">,</span>
    <span class="token keyword">case</span> <span class="token keyword">when</span> 球队<span class="token operator">=</span><span class="token string">'B'</span> <span class="token keyword">then</span> 得分分数 <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token keyword">as</span> B队分数
    <span class="token keyword">from</span> 分数表
    <span class="token keyword">order</span> <span class="token keyword">by</span> 得分时间
<span class="token punctuation">)</span>
t2 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>A队分数<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> 得分时间<span class="token punctuation">)</span> <span class="token keyword">as</span> A队累计<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>B队分数<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> 得分时间<span class="token punctuation">)</span> <span class="token keyword">as</span> B队累计<span class="token punctuation">,</span>
    <span class="token keyword">from</span>
    t1
<span class="token punctuation">)</span>
t3 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
    <span class="token keyword">case</span> <span class="token keyword">when</span> A队累计<span class="token operator">></span>B队累计 <span class="token keyword">then</span> <span class="token string">'A'</span>
    <span class="token keyword">when</span> A队累计<span class="token operator">&lt;</span>B队累计 <span class="token keyword">then</span> <span class="token string">'B'</span>
    <span class="token keyword">else</span> <span class="token string">'平'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> 结果
<span class="token keyword">from</span> t2
<span class="token punctuation">)</span>
t4 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
    lag<span class="token punctuation">(</span>结果<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> 得分时间<span class="token punctuation">)</span> <span class="token keyword">as</span> 上次结果
    lag<span class="token punctuation">(</span>结果<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> 得分时间<span class="token punctuation">)</span> <span class="token keyword">as</span> 前次结果
    <span class="token keyword">from</span>
    t3
<span class="token punctuation">)</span>
t5 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
    <span class="token keyword">case</span> <span class="token keyword">when</span> 结果<span class="token operator">&lt;></span><span class="token string">'平'</span> <span class="token operator">and</span> 上次结果<span class="token operator">&lt;></span><span class="token string">'平'</span> <span class="token operator">and</span> 结果<span class="token operator">&lt;></span>上次结果 <span class="token keyword">then</span> <span class="token number">1</span>
    <span class="token keyword">when</span> 结果<span class="token operator">&lt;></span><span class="token string">'平'</span> <span class="token operator">AND</span> 上次结果<span class="token operator">=</span><span class="token string">'平'</span> <span class="token operator">AND</span> 结果<span class="token operator">&lt;></span>前次结果 <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token keyword">as</span> 判断
    <span class="token keyword">from</span>
    t4
<span class="token punctuation">)</span>
<span class="token keyword">select</span> 球员姓名<span class="token punctuation">,</span>得分时间
<span class="token keyword">from</span> 
t5
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/ra5zs2nqm2.png" alt="Image Name"></p>
<p><strong>（2）请你写一个sql语句统计出：连续三次（及以上）为球队得分的球员名单</strong></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> 球队<span class="token punctuation">,</span>球员姓名
<span class="token keyword">from</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
lead<span class="token punctuation">(</span>球员姓名<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span>partion <span class="token keyword">by</span> 球队 <span class="token keyword">order</span> <span class="token keyword">by</span> 得分时间<span class="token punctuation">)</span> <span class="token keyword">as</span> 二次得分球员<span class="token punctuation">,</span>
lead<span class="token punctuation">(</span>球员姓名<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span>partion <span class="token keyword">by</span> 球队 <span class="token keyword">order</span> <span class="token keyword">by</span> 得分时间<span class="token punctuation">)</span> <span class="token keyword">as</span> 三次得分球员
 <span class="token keyword">from</span> 分数表
<span class="token punctuation">)</span> <span class="token number">a</span>
<span class="token keyword">where</span> 球员姓名<span class="token operator">=</span>二次得分球员
<span class="token operator">and</span> 球员姓名<span class="token operator">=</span>三次得分球员
</code></pre>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/ra6jh5ddhn.png" alt="Image Name"></p>
<h2 id="选出当日浏览房源10套以上并且注册超过一年的用户"><a href="#选出当日浏览房源10套以上并且注册超过一年的用户" class="headerlink" title="选出当日浏览房源10套以上并且注册超过一年的用户"></a>选出当日浏览房源10套以上并且注册超过一年的用户</h2><p>某房源平台有两张表来记录用户信息、和用户查看房源信息。<br>用户表（用户号、用户注册时间）。<br><img src="https://cdn.kesci.com/upload/image/ra44ukgy0t.png" alt="Image Name"><br>浏览表，字段有日志号，用户号，房源号，浏览日期。<br><img src="https://cdn.kesci.com/upload/image/ra44uvfyxm.png?imageView2/0/w/960/h/960" alt="Image Name"></p>
<p>问题：选出当日浏览房源10套以上并且注册超过一年的用户。</p>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/ra44xiytmy.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> 
浏览日期<span class="token punctuation">,</span>
用户号<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span>房源号<span class="token punctuation">)</span> <span class="token keyword">as</span> 房源数
<span class="token keyword">from</span> 浏览表 <span class="token number">a</span>
<span class="token keyword">join</span> 用户表 <span class="token number">b</span> <span class="token keyword">using</span><span class="token punctuation">(</span>用户号<span class="token punctuation">)</span>
<span class="token keyword">where</span> data_sub<span class="token punctuation">(</span>浏览日期<span class="token punctuation">,</span>interval <span class="token number">1</span> year<span class="token punctuation">)</span> <span class="token operator">></span>注册时间
<span class="token keyword">group</span> <span class="token keyword">by</span> 浏览日期，用户号
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span>房源号<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">10</span>
</code></pre>
<h2 id="贷款逾期"><a href="#贷款逾期" class="headerlink" title="贷款逾期"></a>贷款逾期</h2><p>一家金融贷款公司，需要了解用户贷款逾期未还的情况。该公司数据库中有一张用户”贷款逾期天数”表。<br><img src="https://cdn.kesci.com/upload/image/ra1zox7pi3.png" alt="Image Name"></p>
<p>当逾期天数=0时，记为M0,</p>
<p>逾期天数在[1,30]区间时，记为M1,</p>
<p>逾期天数在[31,60]区间时, 记为M2,</p>
<p>逾期天数在[61,90]区间时，记为M3，</p>
<p>其他更高的逾期天数记为M4+，</p>
<p>现在需要在数据库中分析出每种逾期时段（M0、M1、M2、M3、M4+）的订单个数，如果是你，会如何分析呢？</p>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/ra1zz6agzk.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> 逾期天数<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> M0<span class="token punctuation">,</span> 
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">where</span> 逾期天数<span class="token operator">>=</span><span class="token number">1</span> <span class="token operator">and</span> 逾期天数<span class="token operator">&lt;=</span><span class="token number">30</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> M1<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">where</span> 逾期天数<span class="token operator">>=</span><span class="token number">31</span> <span class="token operator">and</span> 逾期天数<span class="token operator">&lt;=</span><span class="token number">60</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> M2<span class="token punctuation">,</span> 
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">where</span> 逾期天数<span class="token operator">>=</span><span class="token number">61</span> <span class="token operator">and</span> 逾期天数<span class="token operator">&lt;=</span><span class="token number">90</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> M3<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">where</span> 逾期天数<span class="token operator">>=</span><span class="token number">91</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> M4
    <span class="token keyword">from</span> 贷款逾期天数
</code></pre>
<h2 id="视频数据分析实战"><a href="#视频数据分析实战" class="headerlink" title="视频数据分析实战"></a>视频数据分析实战</h2><p>“用户操作记录表”里记录着每天某短视频平台的用户点击访问情况，以便帮助公司内部分析师了解用户对于当前页面的点击偏好。</p>
<p>表包字段有：用户名、操作记录、操作时间。<br><img src="https://cdn.kesci.com/upload/image/ra1x3y3hnz.png" alt="Image Name"></p>
<p>其中表内各字段含义如下：<br>用户名——表示用户在该短视频平台注册的唯一用户名。</p>
<p>操作记录——表示用户在该短视频平台点击的按钮名称。A表示用户点击“短视频”播放入口，B表示用户点击“长视频”播放入口。</p>
<p>操作时间——表示用户点击时候的时间，精确到秒。</p>
<p>现在运营人员找到作为数据分析师的你，想让你帮忙看看用SQL取两个数据，具体如下：</p>
<p>1.分析每天的访客数和他们的平均操作次数；<br>结果如下：<br><img src="https://cdn.kesci.com/upload/image/ra1x8c9ghz.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">date</span><span class="token punctuation">(</span>操作时间<span class="token punctuation">)</span> <span class="token keyword">as</span> 日期，
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 用户名<span class="token punctuation">)</span> <span class="token keyword">as</span> 每天访客数，
<span class="token function">count</span><span class="token punctuation">(</span>操作记录<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 用户名<span class="token punctuation">)</span> <span class="token keyword">as</span> 人均操作次数
<span class="token keyword">from</span> 用户操作记录表
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">date</span><span class="token punctuation">(</span>操作时间<span class="token punctuation">)</span>
</code></pre>
<p>2.统计每天符合以下条件的用户数：A操作之后是B操作，AB操作必须相邻；<br>结果如下：<br><img src="https://cdn.kesci.com/upload/image/ra1xayhxjp.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
lead<span class="token punctuation">(</span>操作记录<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span>partiton <span class="token keyword">by</span> 用户名<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">(</span>操作时间<span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> 操作时间<span class="token punctuation">)</span> <span class="token keyword">as</span> 下次操作记录
 <span class="token keyword">from</span> 用户操作记录表
<span class="token punctuation">)</span>

<span class="token keyword">select</span> <span class="token keyword">date</span><span class="token punctuation">(</span>操作时间<span class="token punctuation">)</span> <span class="token keyword">as</span> 日期<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">case</span> <span class="token keyword">when</span> 操作记录<span class="token operator">=</span><span class="token string">'A'</span> <span class="token operator">and</span> 下次操作记录<span class="token operator">=</span><span class="token string">'B'</span> <span class="token keyword">then</span> 用户名 <span class="token keyword">else</span> <span class="token boolean">null</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 用户数
<span class="token keyword">from</span> t1
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">date</span><span class="token punctuation">(</span>操作时间<span class="token punctuation">)</span>
</code></pre>
<h2 id="选出每个月有连续登录2天的用户名单"><a href="#选出每个月有连续登录2天的用户名单" class="headerlink" title="选出每个月有连续登录2天的用户名单"></a>选出每个月有连续登录2天的用户名单</h2><p>有一张“用户登陆记录表”，包含两个字段：用户id、日期。<br><img src="https://cdn.kesci.com/upload/image/ra1vnz2026.png" alt="Image Name"></p>
<p>结果如下：<br><img src="https://cdn.kesci.com/upload/image/ra1vrfcu3o.png" alt="Image Name"></p>
<p>查询2021年每个月，连续2天都有登陆的用户名单。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>lead<span class="token punctuation">(</span>日期<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span>partiton <span class="token keyword">by</span> 用户id<span class="token punctuation">,</span>month<span class="token punctuation">(</span>日期<span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> 日期<span class="token punctuation">)</span> <span class="token keyword">as</span> 本月第二次登录
<span class="token keyword">from</span> 用户登陆记录表
<span class="token keyword">where</span> year<span class="token punctuation">(</span>日期<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2021</span>        
<span class="token punctuation">)</span>
<span class="token keyword">select</span> month<span class="token punctuation">(</span>日期<span class="token punctuation">)</span> <span class="token keyword">as</span> 月<span class="token punctuation">,</span>
用户id
<span class="token keyword">from</span> t1
<span class="token keyword">where</span> datediff<span class="token punctuation">(</span>本月第二次登录<span class="token punctuation">,</span>日期<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> 月
</code></pre>
<h2 id="经营分析实战"><a href="#经营分析实战" class="headerlink" title="经营分析实战"></a>经营分析实战</h2><p>某公司数据库里有3张表，销售订单表、产品明细表、销售网点表。</p>
<p>”销售订单表”记录了销售情况，每一张数据表示哪位顾客、在哪一天、哪个网点购买了什么产品，购买的数量是多少，以及对应产品的零售价。<br><img src="https://cdn.kesci.com/upload/image/ra0x5m5lle.png" alt="Image Name"></p>
<p>“销售网点表”记录了公司的销售网点。<br><img src="https://cdn.kesci.com/upload/image/ra0x791h7e.png" alt="Image Name"></p>
<p><strong>销售订单表和产品明细表通过“产品”字段关联，销售订单表和销售网点通过“交易网点”关联。</strong></p>
<p>分析在2020年度第一季度的购买人数，销售金额，客单价，客单件，人均购买频次</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 顾客ID<span class="token punctuation">)</span> <span class="token keyword">as</span> 购买人数<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>销售数量<span class="token operator">*</span>零售价<span class="token punctuation">)</span> <span class="token keyword">as</span> 销售金额<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>销售数量<span class="token operator">*</span>零售价<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 顾客ID<span class="token punctuation">)</span> <span class="token keyword">as</span> 客单价<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>销售数量<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 顾客ID<span class="token punctuation">)</span> <span class="token keyword">as</span> 客单件<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 订单号<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 顾客ID<span class="token punctuation">)</span>  <span class="token keyword">as</span> 人均购买频次
<span class="token keyword">from</span> 销售订单表
<span class="token keyword">where</span> 交易日期 <span class="token operator">between</span> <span class="token string">'2020-01-01'</span> <span class="token operator">and</span> <span class="token string">'2020-03-31'</span>
</code></pre>
<p><img src="https://cdn.kesci.com/upload/image/ra0xb671u2.png" alt="Image Name"></p>
<p>分析品牌在2019.5-2020.4期间的复购率（复购率：在这期间下订单&gt;1的人数/总购买人数）</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> 顾客ID<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 订单号<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">1</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 复购率
<span class="token keyword">from</span> 销售订单表
<span class="token keyword">where</span> 交易日期 <span class="token operator">between</span> <span class="token string">'2019-05-01'</span> <span class="token operator">and</span> <span class="token string">'2020-04-31'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> 顾客ID
<span class="token comment" spellcheck="true">--解法二</span>
<span class="token keyword">SELECT</span> 
  <span class="token function">SUM</span><span class="token punctuation">(</span>
    <span class="token keyword">CASE</span>
      <span class="token keyword">WHEN</span> 每个顾客下单数 <span class="token operator">></span> <span class="token number">1</span> 
      <span class="token keyword">THEN</span> <span class="token number">1</span> 
      <span class="token keyword">ELSE</span> <span class="token number">0</span> 
    <span class="token keyword">END</span>
  <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 复购率 
<span class="token keyword">FROM</span>
  <span class="token punctuation">(</span><span class="token keyword">SELECT</span> 
    顾客ID<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> 订单号<span class="token punctuation">)</span> <span class="token keyword">AS</span> 每个顾客下单数 
  <span class="token keyword">FROM</span>
    销售订单表 
  <span class="token keyword">WHERE</span> 交易日期 <span class="token operator">BETWEEN</span> <span class="token string">'2019-05-01'</span> 
    <span class="token operator">AND</span> <span class="token string">'2020-04-30'</span> 
  <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 顾客ID<span class="token punctuation">)</span> <span class="token number">a</span> 
</code></pre>
<p>查找既购买过ProductA又购买过ProductB，但没有购买ProductC的顾客人数，并计算平均客单价</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
    <span class="token keyword">select</span> 顾客ID<span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span><span class="token keyword">distinct</span> 产品<span class="token punctuation">)</span> <span class="token keyword">as</span> 产品组合
<span class="token keyword">from</span> 销售订单表
<span class="token keyword">group</span> <span class="token keyword">by</span> 顾客ID
    <span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 顾客ID<span class="token punctuation">)</span> <span class="token keyword">as</span> 顾客人数<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>销售数量<span class="token operator">*</span>零售价<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 顾客ID<span class="token punctuation">)</span> <span class="token keyword">as</span> 平均客单价
<span class="token keyword">from</span> 销售订单表
<span class="token keyword">where</span> 顾客ID <span class="token operator">in</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> 顾客ID
    <span class="token keyword">from</span> t1
    <span class="token keyword">where</span> 产品组合 <span class="token operator">like</span> <span class="token string">'%ProductA%'</span>
    <span class="token operator">and</span> 产品组合 <span class="token operator">like</span> <span class="token string">'%ProductB%'</span>
    <span class="token operator">and</span> 产品组合 <span class="token operator">not</span> <span class="token operator">like</span> <span class="token string">'%ProductC%'</span>
<span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> 顾客ID
</code></pre>
<p><img src="https://cdn.kesci.com/upload/image/ra0zh24pzw.png" alt="Image Name"></p>
<p>查找每个城市购买金额排名第二的客人，列出其购买城市、顾客ID、购买金额</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>销售数量<span class="token operator">*</span><span class="token number">a</span><span class="token punctuation">.</span>零售价<span class="token punctuation">)</span> <span class="token keyword">as</span> 购买金额
    dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span>partiton <span class="token keyword">by</span> <span class="token number">b</span><span class="token punctuation">.</span>城市 <span class="token keyword">order</span> <span class="token keyword">by</span> 购买金额 decs<span class="token punctuation">)</span> <span class="token keyword">as</span> 购买金额排名
    <span class="token keyword">from</span> 销售订单表 <span class="token number">a</span>
    <span class="token keyword">join</span> 销售网点表 <span class="token number">b</span>
    <span class="token keyword">using</span><span class="token punctuation">(</span>交易网点<span class="token punctuation">)</span>  
    <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">b</span><span class="token punctuation">.</span>城市<span class="token punctuation">,</span><span class="token number">a</span><span class="token punctuation">.</span>顾客ID
<span class="token punctuation">)</span>
<span class="token keyword">select</span> 城市 <span class="token keyword">as</span> 购买城市<span class="token punctuation">,</span>
顾客ID<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>销售数量<span class="token operator">*</span>零售价<span class="token punctuation">)</span> <span class="token keyword">as</span> 购买金额
<span class="token keyword">from</span> t1
<span class="token keyword">group</span> <span class="token keyword">by</span> 购买城市
<span class="token keyword">where</span> 购买金额排名<span class="token operator">=</span><span class="token number">2</span>
<span class="token comment" spellcheck="true">--解法2</span>
<span class="token keyword">SELECT</span> 
  <span class="token operator">*</span> 
<span class="token keyword">FROM</span>
  <span class="token punctuation">(</span><span class="token keyword">SELECT</span> 
    <span class="token operator">*</span><span class="token punctuation">,</span>
    dense_rank <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span>
      <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> 城市 
  <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 购买金额 <span class="token keyword">DESC</span>
  <span class="token punctuation">)</span> <span class="token keyword">AS</span> 排名 
  <span class="token keyword">FROM</span>
    <span class="token punctuation">(</span><span class="token keyword">SELECT</span> 
      <span class="token number">b</span><span class="token punctuation">.</span>城市<span class="token punctuation">,</span>
      <span class="token number">a</span><span class="token punctuation">.</span>顾客ID<span class="token punctuation">,</span>
      <span class="token function">SUM</span><span class="token punctuation">(</span>销售数量 <span class="token operator">*</span> 零售价<span class="token punctuation">)</span> <span class="token keyword">AS</span> 购买金额 
    <span class="token keyword">FROM</span>
      销售订单表 <span class="token number">a</span> 
      <span class="token keyword">JOIN</span> 销售网点表 <span class="token number">b</span> 
        <span class="token keyword">ON</span> <span class="token number">a</span><span class="token punctuation">.</span>交易网点 <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>交易网点 
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token number">b</span><span class="token punctuation">.</span>城市<span class="token punctuation">,</span>
      <span class="token number">a</span><span class="token punctuation">.</span>顾客ID<span class="token punctuation">)</span> <span class="token number">a</span><span class="token punctuation">)</span> <span class="token number">b</span> 
<span class="token keyword">WHERE</span> 排名 <span class="token operator">=</span> <span class="token number">2</span>
</code></pre>
<p><img src="https://cdn.kesci.com/upload/image/ra0zz8cb5l.png" alt="Image Name"></p>
<p>计算每个城市的店铺数量及各个城市的生意汇总，输出包含无购买记录的城市</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> 城市<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 交易网点<span class="token punctuation">)</span> <span class="token keyword">as</span> 城市店铺数量<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>销售数量<span class="token operator">*</span>零售价<span class="token punctuation">)</span> <span class="token keyword">as</span> 生意汇总
<span class="token keyword">from</span> 销售网点表
<span class="token keyword">left</span> <span class="token keyword">join</span> 销售订单表 <span class="token keyword">using</span><span class="token punctuation">(</span>交易网点<span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> 城市
</code></pre>
<p><img src="https://cdn.kesci.com/upload/image/ra10eawfgg.png" alt="Image Name"></p>
<h2 id="窗口函数运用"><a href="#窗口函数运用" class="headerlink" title="窗口函数运用"></a>窗口函数运用</h2><p>有一张“学生成绩表”，包含4个字段：班级id、学生id、课程id、成绩。<br><img src="https://cdn.kesci.com/upload/image/ra0vlkla5p.png" alt="Image Name"></p>
<p>问题1：求出每个学生成绩最高的三条记录；</p>
<p><img src="https://cdn.kesci.com/upload/image/ra0vq76ebg.png" alt="Image Name"></p>
<ul>
<li>rank()：是并列排序，会跳过重复序号</li>
<li>dense_rank()：是并列排序，不会跳过重复序号</li>
<li>row_number()：是顺序排序，不跳过任何一个序号，就是行号</li>
</ul>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 学生id <span class="token keyword">order</span> <span class="token keyword">by</span> 成绩 decs<span class="token punctuation">)</span> <span class="token keyword">as</span> 学生成绩排名
<span class="token keyword">from</span> 学生成绩表
<span class="token keyword">where</span> 学生成绩排名<span class="token operator">&lt;=</span><span class="token number">3</span>
<span class="token comment" spellcheck="true">--解法二</span>
<span class="token keyword">SELECT</span> 
  <span class="token operator">*</span> 
<span class="token keyword">FROM</span>
  <span class="token punctuation">(</span><span class="token keyword">SELECT</span> 
    <span class="token operator">*</span><span class="token punctuation">,</span>
    row_number <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span>
      <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> 学生id 
  <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 成绩 <span class="token keyword">DESC</span>
  <span class="token punctuation">)</span> <span class="token keyword">AS</span> 学生成绩排名 
  <span class="token keyword">FROM</span>
    学生成绩表<span class="token punctuation">)</span> <span class="token number">a</span> 
<span class="token keyword">WHERE</span> 学生成绩排名 <span class="token operator">&lt;=</span> <span class="token number">3</span> 
</code></pre>
<p>问题2：找出每门课程都高于班级课程平均分的学生；<br><img src="https://cdn.kesci.com/upload/image/ra0vum9yqi.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
    <span class="token function">avg</span><span class="token punctuation">(</span>成绩<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 课程id<span class="token punctuation">)</span> <span class="token keyword">as</span> 班级课程平均分<span class="token punctuation">,</span>
    <span class="token keyword">case</span> <span class="token keyword">when</span> 成绩<span class="token operator">></span>班级课程平均分 <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token keyword">as</span> 是否高于平均分
    <span class="token keyword">from</span> 学生成绩表
    <span class="token keyword">where</span> 是否高于平均分<span class="token operator">=</span><span class="token number">1</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> 课程id<span class="token punctuation">,</span>学生id
<span class="token punctuation">)</span>
<span class="token keyword">select</span> 班级id<span class="token punctuation">,</span>学生id
<span class="token keyword">from</span>
t1
<span class="token keyword">group</span> <span class="token keyword">by</span> 课程id<span class="token punctuation">,</span>学生id
</code></pre>
<h2 id="帕累托分析"><a href="#帕累托分析" class="headerlink" title="帕累托分析"></a>帕累托分析</h2><p><strong>什么是二八定律？</strong></p>
<p>二八定律是说在任何一组东西中，最重要的只占一小部分，约20%。比如家店铺，卖的最多的商品数只占20%</p>
<p><strong>什么是ABC分类法？</strong></p>
<p>ABC分类方法是二八定律衍生出来的一种分类方法，由于它把对象分成A、B、C三类，所以叫做ABC分类法，也叫<strong>帕累托分析</strong></p>
<p>ABC分类法计算步骤：</p>
<p>1）将分析对象由大到小排序</p>
<p>2）计算每一个对象及排在该对象之前的累计占比</p>
<p>3）将累计占比为0<del>60%的记为A类，60%</del>85%记为B类，85%以上记为C类</p>
<p>有一张“学生成绩表”，包含3个字段：学号、课程、成绩。<br><img src="https://cdn.kesci.com/upload/image/ra05zij3mf.png" alt="Image Name"><br><strong>问题：<br>找出每门课程A类和B类的学生，判断标准是累计占比，0<del>60%的记为A类，60%</del>85%记为B类。</strong></p>
<p>累计占比:</p>
<p>比如课程A的累计占比=课程A的累计成绩/课程A的总成绩</p>
<p>课程A的累计成绩：<br>对课程A的学生成绩由大到小排序，累计成绩就是该学生的成绩加上排在他前面所有学生的成绩的总和；</p>
<p>课程A的总成绩：<br>所有学生课程A的成绩总和。</p>
<p>结果如图：</p>
<p><img src="https://cdn.kesci.com/upload/image/ra0657xlao.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
<span class="token keyword">from</span> 学生成绩表
<span class="token keyword">group</span> <span class="token keyword">by</span> 学号<span class="token punctuation">,</span>课程
<span class="token keyword">order</span> <span class="token keyword">by</span> 成绩 decs
<span class="token punctuation">)</span>
t2 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>成绩<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 课程 <span class="token keyword">order</span> <span class="token keyword">by</span> 成绩 decs <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">current</span> <span class="token keyword">row</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 累计成绩<span class="token punctuation">,</span>    
<span class="token function">sum</span><span class="token punctuation">(</span>成绩<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 课程<span class="token punctuation">)</span> <span class="token keyword">as</span> 科目总成绩
<span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>累计成绩<span class="token operator">/</span>科目总成绩<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0.6</span>  <span class="token keyword">then</span> <span class="token string">"A"</span>
    <span class="token keyword">when</span> <span class="token punctuation">(</span>累计成绩<span class="token operator">/</span>科目总成绩<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">0.6</span> <span class="token operator">and</span> <span class="token punctuation">(</span>累计成绩<span class="token operator">/</span>科目总成绩<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0.85</span> <span class="token keyword">then</span> <span class="token string">"B"</span> <span class="token keyword">else</span> <span class="token string">"C"</span> <span class="token keyword">end</span> <span class="token keyword">as</span> 类别
<span class="token keyword">from</span> t1    
<span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token keyword">from</span> t2
<span class="token keyword">where</span> 类别 <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">,</span><span class="token string">"B"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">--解法二</span>
<span class="token keyword">with</span> temp1 <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span>成绩<span class="token punctuation">)</span><span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> t1<span class="token punctuation">.</span>课程 <span class="token keyword">order</span> <span class="token keyword">by</span> t1<span class="token punctuation">.</span>成绩 <span class="token keyword">desc</span> <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">current</span> <span class="token keyword">row</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 累计成绩<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span>成绩<span class="token punctuation">)</span><span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> t1<span class="token punctuation">.</span>课程<span class="token punctuation">)</span> <span class="token keyword">as</span> 科目总成绩
<span class="token keyword">from</span> 学生成绩表 t1
<span class="token punctuation">)</span><span class="token punctuation">,</span>
temp2 <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> temp1<span class="token punctuation">.</span>学号<span class="token punctuation">,</span>
temp1<span class="token punctuation">.</span>课程<span class="token punctuation">,</span>
temp1<span class="token punctuation">.</span>成绩<span class="token punctuation">,</span>
<span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>累计成绩<span class="token operator">/</span>科目总成绩<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0.6</span> <span class="token keyword">then</span> <span class="token string">"A"</span>
<span class="token keyword">when</span> <span class="token punctuation">(</span>累计成绩<span class="token operator">/</span>科目总成绩<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">0.6</span> <span class="token operator">and</span> <span class="token punctuation">(</span>累计成绩<span class="token operator">/</span>科目总成绩<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0.85</span> <span class="token keyword">then</span> <span class="token string">"B"</span>
<span class="token keyword">else</span> <span class="token string">"C"</span> <span class="token keyword">end</span> <span class="token keyword">as</span> type_ABC
<span class="token keyword">from</span> temp1
<span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> temp2
<span class="token keyword">where</span> type_ABC <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">,</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>unbounded：无界限<br>preceding：从分区第一行头开始，则为 unbounded。 N为：相对当前行向前的偏移量<br>following ：与preceding相反,到该分区结束，则为 unbounded。N为：相对当前行向后的偏移量<br>current row：顾名思义，当前行，偏移量为0</p>
<h2 id="除去部门最高-amp-最低工资后的部门平均工资"><a href="#除去部门最高-amp-最低工资后的部门平均工资" class="headerlink" title="除去部门最高&amp;最低工资后的部门平均工资"></a>除去部门最高&amp;最低工资后的部门平均工资</h2><p>薪水表中记录了员工的编号，所在部门编号，和薪水：<br><img src="https://cdn.kesci.com/upload/image/r9y5thg6u8.png" alt="Image Name"><br>结果如下图：<br><img src="https://cdn.kesci.com/upload/image/r9y5w04xle.png" alt="Image Name"></p>
<p>#查询出每个部门除去最高、最低薪水后的平均薪水，并保留整数。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
<span class="token function">max</span><span class="token punctuation">(</span>薪水<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 部门编号<span class="token punctuation">)</span> <span class="token keyword">as</span> 最高薪水<span class="token punctuation">,</span>
<span class="token function">min</span><span class="token punctuation">(</span>薪水<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 部门编号<span class="token punctuation">)</span> <span class="token keyword">as</span> 最低薪水，
<span class="token keyword">from</span> 薪水表      
<span class="token punctuation">)</span>
<span class="token keyword">select</span> 部门编号<span class="token punctuation">,</span>
<span class="token keyword">case</span> <span class="token keyword">when</span> 薪水<span class="token operator">&lt;></span>最高薪水 <span class="token operator">and</span> 薪水<span class="token operator">&lt;></span>最低薪水 <span class="token keyword">then</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token function">avg</span><span class="token punctuation">(</span>薪水<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token boolean">null</span> <span class="token keyword">end</span> <span class="token keyword">as</span> 平均薪水
<span class="token keyword">from</span> t1
<span class="token keyword">group</span> <span class="token keyword">by</span> 部门编号
<span class="token comment" spellcheck="true">--解法二</span>
<span class="token keyword">SELECT</span> 
  部门编号<span class="token punctuation">,</span>
  <span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">AVG</span><span class="token punctuation">(</span>薪水<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 平均薪水 
<span class="token keyword">FROM</span>
  <span class="token punctuation">(</span><span class="token keyword">SELECT</span> 
    <span class="token operator">*</span><span class="token punctuation">,</span>
    <span class="token function">MAX</span><span class="token punctuation">(</span>薪水<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> 部门编号<span class="token punctuation">)</span> 部门最高薪水<span class="token punctuation">,</span>
    <span class="token function">MIN</span><span class="token punctuation">(</span>薪水<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> 部门编号<span class="token punctuation">)</span> 部门最低薪水 
  <span class="token keyword">FROM</span>
    薪水表<span class="token punctuation">)</span> <span class="token number">a</span> 
<span class="token keyword">WHERE</span> 薪水 <span class="token operator">&lt;></span> 部门最高薪水 
  <span class="token operator">AND</span> 薪水 <span class="token operator">&lt;></span> 部门最低薪水 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 部门编号
</code></pre>
<h2 id="分析红包领取情况"><a href="#分析红包领取情况" class="headerlink" title="分析红包领取情况"></a>分析红包领取情况</h2><p>活跃用户表：<br><img src="https://cdn.kesci.com/upload/image/r9x9kk1uhg.png" alt="Image Name"></p>
<p>领取红包表：</p>
<p><img src="https://cdn.kesci.com/upload/image/r9x9ngn9ji.png" alt="Image Name"></p>
<p>1.计算2019年6月1日至今，每日DAU（活跃用户是指有登陆的用户）</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> 登录日期<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 用户id<span class="token punctuation">)</span> <span class="token keyword">as</span> DAU
<span class="token keyword">from</span> 活跃用户表
<span class="token keyword">where</span> 登录日期<span class="token operator">>=</span><span class="token string">'20190601'</span> 
<span class="token keyword">group</span> <span class="token keyword">by</span> 登录日期<span class="token punctuation">;</span>
</code></pre>
<p><img src="https://cdn.kesci.com/upload/image/r9x9qfk7um.png" alt="Image Name"></p>
<p>2.分析每天领取红包的用户数、人均领取金额、人均领取次数，要考虑用户属性及领取红包未登录情况。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">case</span> <span class="token keyword">when</span> t2<span class="token punctuation">.</span>是新用户<span class="token operator">=</span><span class="token string">"1"</span> <span class="token keyword">then</span> t1<span class="token punctuation">.</span>用户id <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 新用户数<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">case</span> <span class="token keyword">when</span> t2<span class="token punctuation">.</span>是新用户<span class="token operator">=</span><span class="token string">"0"</span> <span class="token keyword">then</span> t1<span class="token punctuation">.</span>用户id <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 旧用户数<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">case</span> <span class="token keyword">when</span> t2<span class="token punctuation">.</span>是新用户 <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span> t1<span class="token punctuation">.</span>用户id <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 未登录用户数<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span>金额<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> t1<span class="token punctuation">.</span>用户ID<span class="token punctuation">)</span> <span class="token keyword">as</span> 人均领取金额<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> t1<span class="token punctuation">.</span>用户ID<span class="token punctuation">)</span> <span class="token keyword">as</span> 人均领取次数
<span class="token keyword">from</span> 领红包表 t1
<span class="token keyword">left</span> <span class="token keyword">join</span> 活跃用户表 t2
<span class="token keyword">using</span><span class="token punctuation">(</span>用户ID<span class="token punctuation">)</span> <span class="token operator">and</span> t1<span class="token punctuation">.</span>抢红包日期<span class="token operator">=</span>t2<span class="token punctuation">.</span>登录日期
<span class="token keyword">group</span> <span class="token keyword">by</span> t1<span class="token punctuation">.</span>抢红包日期<span class="token punctuation">;</span>
</code></pre>
<p><img src="https://cdn.kesci.com/upload/image/r9x9ut4nqg.png" alt="Image Name"></p>
<p>3.分析每个月红包领取天数、每个月领取红包的用户数、人均领取金额、人均领取次数。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> 
data_format<span class="token punctuation">(</span>抢红包日期<span class="token punctuation">,</span><span class="token string">'%Y%m'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 年月
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 抢红包日期<span class="token punctuation">)</span> <span class="token keyword">as</span> 每个月红包领取天数<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 用户id<span class="token punctuation">)</span> <span class="token keyword">as</span> 每个月领取红包的用户数<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>金额<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 用户ID<span class="token punctuation">)</span> <span class="token keyword">as</span> 人均领取金额<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 用户ID<span class="token punctuation">)</span> <span class="token keyword">as</span> 人均领取次数
<span class="token keyword">from</span> 领红包表
<span class="token keyword">group</span> <span class="token keyword">by</span> data_format<span class="token punctuation">(</span>抢红包日期<span class="token punctuation">,</span><span class="token string">'%Y%m'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>4.分析每个月领过红包用户和未领红包用户的数量</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> m1 <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> 
data_format<span class="token punctuation">(</span>t1<span class="token punctuation">.</span>登录日期<span class="token punctuation">,</span><span class="token string">'%Y%m'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 年月<span class="token punctuation">,</span>
    t1<span class="token punctuation">.</span>用户ID<span class="token punctuation">,</span>
    t2<span class="token punctuation">.</span>抢红包日期<span class="token punctuation">,</span>
    <span class="token function">min</span><span class="token punctuation">(</span>t2<span class="token punctuation">.</span>抢红包日期<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>t1<span class="token punctuation">.</span>登录日期<span class="token punctuation">)</span><span class="token punctuation">,</span>用户ID<span class="token punctuation">)</span> <span class="token keyword">as</span> 各用户每月首次抢到红包日期
<span class="token keyword">from</span> 活跃用户表 t1
    <span class="token keyword">left</span> <span class="token keyword">join</span> 领取红包表 t2
    <span class="token keyword">on</span> t1<span class="token punctuation">.</span>登录日期 <span class="token operator">=</span>t2<span class="token punctuation">.</span>抢红包日期 
    <span class="token operator">and</span> t1<span class="token punctuation">.</span>用户ID <span class="token operator">=</span>t2<span class="token punctuation">.</span>用户ID
<span class="token punctuation">)</span>
<span class="token keyword">select</span> 年月<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> 各用户每月首次抢到红包日期 <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> 用户ID <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 领过红包用户数<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> 各用户每月首次抢到红包日期 <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span> 用户ID <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 未领过红包用户数
<span class="token keyword">from</span> m1
<span class="token keyword">group</span> <span class="token keyword">by</span> 年月<span class="token punctuation">;</span>
</code></pre>
<p>DATE_FORMAT() 函数用于以不同的格式显示日期/时间数据。</p>
<p>语法</p>
<pre><code>DATE_FORMAT(date,format)
</code></pre>
<p><em>date</em> 参数是合法的日期。<em>format</em> 规定日期/时间的输出格式。</p>
<p>可以使用的格式有：</p>
<table>
<thead>
<tr>
<th align="left">格式</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">%a</td>
<td align="left">缩写星期名</td>
</tr>
<tr>
<td align="left">%b</td>
<td align="left">缩写月名</td>
</tr>
<tr>
<td align="left">%c</td>
<td align="left">月，数值</td>
</tr>
<tr>
<td align="left">%D</td>
<td align="left">带有英文前缀的月中的天</td>
</tr>
<tr>
<td align="left">%d</td>
<td align="left">月的天，数值(00-31)</td>
</tr>
<tr>
<td align="left">%e</td>
<td align="left">月的天，数值(0-31)</td>
</tr>
<tr>
<td align="left">%f</td>
<td align="left">微秒</td>
</tr>
<tr>
<td align="left">%H</td>
<td align="left">小时 (00-23)</td>
</tr>
<tr>
<td align="left">%h</td>
<td align="left">小时 (01-12)</td>
</tr>
<tr>
<td align="left">%I</td>
<td align="left">小时 (01-12)</td>
</tr>
<tr>
<td align="left">%i</td>
<td align="left">分钟，数值(00-59)</td>
</tr>
<tr>
<td align="left">%j</td>
<td align="left">年的天 (001-366)</td>
</tr>
<tr>
<td align="left">%k</td>
<td align="left">小时 (0-23)</td>
</tr>
<tr>
<td align="left">%l</td>
<td align="left">小时 (1-12)</td>
</tr>
<tr>
<td align="left">%M</td>
<td align="left">月名</td>
</tr>
<tr>
<td align="left">%m</td>
<td align="left">月，数值(00-12)</td>
</tr>
<tr>
<td align="left">%p</td>
<td align="left">AM 或 PM</td>
</tr>
<tr>
<td align="left">%r</td>
<td align="left">时间，12-小时（hh:mm:ss AM 或 PM）</td>
</tr>
<tr>
<td align="left">%S</td>
<td align="left">秒(00-59)</td>
</tr>
<tr>
<td align="left">%s</td>
<td align="left">秒(00-59)</td>
</tr>
<tr>
<td align="left">%T</td>
<td align="left">时间, 24-小时 (hh:mm:ss)</td>
</tr>
<tr>
<td align="left">%U</td>
<td align="left">周 (00-53) 星期日是一周的第一天</td>
</tr>
<tr>
<td align="left">%u</td>
<td align="left">周 (00-53) 星期一是一周的第一天</td>
</tr>
<tr>
<td align="left">%V</td>
<td align="left">周 (01-53) 星期日是一周的第一天，与 %X 使用</td>
</tr>
<tr>
<td align="left">%v</td>
<td align="left">周 (01-53) 星期一是一周的第一天，与 %x 使用</td>
</tr>
<tr>
<td align="left">%W</td>
<td align="left">星期名</td>
</tr>
<tr>
<td align="left">%w</td>
<td align="left">周的天 （0=星期日, 6=星期六）</td>
</tr>
<tr>
<td align="left">%X</td>
<td align="left">年，其中的星期日是周的第一天，4 位，与 %V 使用</td>
</tr>
<tr>
<td align="left">%x</td>
<td align="left">年，其中的星期一是周的第一天，4 位，与 %v 使用</td>
</tr>
<tr>
<td align="left">%Y</td>
<td align="left">年，4 位</td>
</tr>
<tr>
<td align="left">%y</td>
<td align="left">年，2 位</td>
</tr>
</tbody></table>
<h2 id="工资的众数、中位数"><a href="#工资的众数、中位数" class="headerlink" title="工资的众数、中位数"></a>工资的众数、中位数</h2><p>emp_salary表：<br><img src="https://cdn.kesci.com/upload/image/r9wq47jgbv.png" alt="Image Name"></p>
<p>求员工工资的众数（众数是一组数据中出现次数最多的数值，有时众数在一组数中有好几个。）</p>
<p>having字句可以让我们筛选分组之后的各种数据，where字句在聚合前先筛选记录，也就是说作用在group by和having字句前。and字句在聚合前先筛选记录，也就是说and字句要在group by和having字句前使用。</p>
<p>any,all关键字必须与一个比较操作符一起使用。any关键词可以理解为“对于子查询返回的列中的任一数值，如果比较结果为true，则返回true”。all的意思是“对于子查询返回的列中的所有值，如果比较结果为true，则返回true”</p>
<p>any 可以与=、&gt;、&gt;=、结合起来使用，分别表示等于、大于、大于等于、小于、小于等于、不等于其中的任何一个数据。</p>
<p>all可以与=、&gt;、&gt;=、结合是来使用，分别表示等于、大于、大于等于、小于、小于等于、不等于其中的其中的所有数据。</p>
<p>举个例子：</p>
<p>select s1 from t1 where s1 &gt; any (select s1 from t2);</p>
<p>假设any后面的s1返回了三个值，那其实就等价于</p>
<p>select s1 from t1 where s1 &gt; result1 or s1 &gt; result2 or s2 &gt; result3</p>
<p>而all的用法相当于把上述语句的‘or’缓冲‘and’</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> 
emp_salary
<span class="token keyword">from</span> emp_salary表
<span class="token keyword">group</span> <span class="token keyword">by</span> emp_salary
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span>emp_salary<span class="token punctuation">)</span><span class="token operator">>=</span><span class="token keyword">ALL</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> 
<span class="token function">count</span><span class="token punctuation">(</span>emp_salary<span class="token punctuation">)</span>
<span class="token keyword">from</span> emp_salary表
<span class="token keyword">group</span> <span class="token keyword">by</span> emp_salary
<span class="token punctuation">)</span>
</code></pre>
<p>求员工工资的中位数（把所有观察值高低排序后找出正中间的一个作为中位数。如果观察值有偶数个，通常取最中间的两个数值的平均数作为中位数。）</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>emp_salary<span class="token punctuation">)</span> <span class="token keyword">as</span> 工资中位数
<span class="token keyword">from</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> emp_salary<span class="token punctuation">)</span> 序号<span class="token punctuation">,</span>
 <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 最大序号
 <span class="token keyword">from</span> emp_salary表
<span class="token punctuation">)</span>
<span class="token keyword">where</span> 序号 <span class="token operator">in</span><span class="token punctuation">(</span>
floor<span class="token punctuation">(</span><span class="token punctuation">(</span>最大序号<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
ceil<span class="token punctuation">(</span><span class="token punctuation">(</span>最大序号<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre>
<h2 id="滴滴数据分析笔试题"><a href="#滴滴数据分析笔试题" class="headerlink" title="滴滴数据分析笔试题"></a>滴滴数据分析笔试题</h2><p>现有四张表，分别是“司机数据”表，“订单数据”表，“在线时长数据”表，“城市匹配数据”表。<br>1、“司机数据”表，记录了日期、司机id、城市id、首次完成订单时间</p>
<p><img src="https://cdn.kesci.com/upload/image/r9w9tc7get.png" alt="Image Name"></p>
<p>2、“订单数据”表，记录了日期、订单id、司机id、乘客id、产品线id、流水<br>产品线id: 1是表示专车，2表示企业，3表示快车，4表示企业快车</p>
<p><img src="https://cdn.kesci.com/upload/image/r9w9xqnlm6.png" alt="Image Name"></p>
<p>3、“在线时长数据”表，记录了日期、司机id、在线时长</p>
<p><img src="https://cdn.kesci.com/upload/image/r9wa0kr64m.png" alt="Image Name"></p>
<p>4、“城市匹配数据”表，记录了城市id、城市名称</p>
<p><img src="https://cdn.kesci.com/upload/image/r9wa2r3rmk.png" alt="Image Name"></p>
<p>问题：</p>
<ol>
<li>提取2020年8月各城市每天的快车司机数、快车订单量和快车流水数据。</li>
</ol>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> t1<span class="token punctuation">.</span>日期，
t3<span class="token punctuation">.</span>城市名称<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> t1<span class="token punctuation">.</span>司机id<span class="token punctuation">)</span>  <span class="token keyword">as</span> 每天快车司机数<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span>t2<span class="token punctuation">.</span>订单id<span class="token punctuation">)</span> <span class="token keyword">as</span> 快车订单量<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>t2<span class="token punctuation">.</span>流水<span class="token punctuation">)</span> <span class="token keyword">as</span> 快车流水
<span class="token keyword">from</span> 司机数据 t1
<span class="token keyword">left</span> <span class="token keyword">join</span> 订单数据 t2
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>司机id<span class="token operator">=</span>t2<span class="token punctuation">.</span>司机id
<span class="token keyword">left</span> <span class="token keyword">join</span> 城市匹配数据 t3
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>城市id<span class="token operator">=</span>t2<span class="token punctuation">.</span>城市id
<span class="token keyword">where</span> 日期 <span class="token operator">between</span> <span class="token string">"2020-08-01"</span> <span class="token operator">and</span> <span class="token string">"2020-08-31"</span> <span class="token operator">and</span> t2<span class="token punctuation">.</span>产品线id<span class="token operator">=</span><span class="token number">3</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> t1<span class="token punctuation">.</span>日期<span class="token punctuation">;</span>
</code></pre>
<p>第一问结果如图：<br><img src="https://cdn.kesci.com/upload/image/raqd2numvv.png" alt="Image Name"></p>
<ol start="2">
<li>提取2020年8月和9月，每个月的北京市新老司机（首单日期在当月为新司机）的司机数、在线时<br>长和TPH（订单量/在线时长）数据。</li>
</ol>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> 
data_format<span class="token punctuation">(</span>t1<span class="token punctuation">.</span>日期<span class="token punctuation">,</span><span class="token string">'%Y%m'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 日期年月<span class="token punctuation">,</span>
data_format<span class="token punctuation">(</span>t1<span class="token punctuation">.</span>首次完成订单时间<span class="token punctuation">,</span><span class="token string">'%Y%m'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 首次完成订单年月<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">case</span> <span class="token keyword">when</span> t1<span class="token punctuation">.</span>首次完成订单年月<span class="token operator">=</span>t1<span class="token punctuation">.</span>日期年月 <span class="token keyword">then</span> 司机id <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 新司机数<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">case</span> <span class="token keyword">when</span> t1<span class="token punctuation">.</span>首次完成订单年月<span class="token operator">&lt;></span>t1<span class="token punctuation">.</span>日期年月 <span class="token keyword">then</span> 司机id <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 老司机数<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>t4<span class="token punctuation">.</span>在线时长<span class="token punctuation">)</span> <span class="token keyword">as</span> 在线时长<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span>t2<span class="token punctuation">.</span>订单id<span class="token punctuation">)</span><span class="token operator">/</span>t4<span class="token punctuation">.</span>在线时长 <span class="token keyword">as</span> TPH
<span class="token keyword">from</span> 司机数据 t1
<span class="token keyword">join</span> 订单数据 t2
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>司机id<span class="token operator">=</span>t2<span class="token punctuation">.</span>司机id
<span class="token keyword">join</span> 城市匹配数据 t3
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>城市id<span class="token operator">=</span>t2<span class="token punctuation">.</span>城市id
<span class="token keyword">join</span> 在线时长数据 t4
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>司机id<span class="token operator">=</span>t4<span class="token punctuation">.</span>司机id
<span class="token keyword">where</span> 日期年月<span class="token operator">=</span><span class="token string">"2020-08"</span> <span class="token operator">and</span> 日期年月<span class="token operator">=</span><span class="token string">"2020-09"</span> <span class="token operator">and</span> t3<span class="token punctuation">.</span>城市名称<span class="token operator">=</span><span class="token string">"北京"</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> 日期年月
<span class="token comment" spellcheck="true">--解法二</span>
<span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> substr<span class="token punctuation">(</span><span class="token number">d</span><span class="token punctuation">.</span>日期<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 年月<span class="token punctuation">,</span>
<span class="token number">d</span><span class="token punctuation">.</span>司机id，
<span class="token keyword">case</span> <span class="token keyword">when</span> substr<span class="token punctuation">(</span><span class="token number">d</span><span class="token punctuation">.</span>日期<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">=</span>substr<span class="token punctuation">(</span><span class="token number">d</span><span class="token punctuation">.</span>首次完成订单时间<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token string">"新司机"</span> <span class="token keyword">else</span> <span class="token string">"老司机"</span> <span class="token keyword">end</span> <span class="token keyword">as</span> <span class="token string">"driver_state"</span>   
<span class="token keyword">from</span> 司机数据 <span class="token number">d</span>
    <span class="token keyword">where</span> month<span class="token punctuation">(</span><span class="token number">d</span><span class="token punctuation">.</span>日期<span class="token punctuation">)</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span>
    <span class="token operator">and</span> <span class="token number">d</span><span class="token punctuation">.</span>城市id <span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">c</span><span class="token punctuation">.</span>城市id <span class="token keyword">from</span> 城市匹配数据 <span class="token number">c</span> <span class="token keyword">where</span> <span class="token number">c</span><span class="token punctuation">.</span>城市名称<span class="token operator">=</span><span class="token string">"北京"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t2 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> 年月<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> driver_state<span class="token operator">=</span><span class="token string">"新司机"</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">"新司机数"</span><span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> driver_state<span class="token operator">=</span><span class="token string">"老司机"</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">"老司机数"</span>
<span class="token keyword">from</span> t1
<span class="token keyword">group</span> <span class="token keyword">by</span> 年月
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t3 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> substr<span class="token punctuation">(</span>t<span class="token punctuation">.</span>日期<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">"年月"</span><span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>在线时长<span class="token punctuation">)</span> <span class="token keyword">as</span> 在线时长 
<span class="token keyword">from</span> 在线时长数据 t
<span class="token keyword">left</span> <span class="token keyword">join</span> t1
<span class="token keyword">on</span> t<span class="token punctuation">.</span>司机id <span class="token operator">=</span>t1<span class="token punctuation">.</span>司机id
<span class="token keyword">where</span> month<span class="token punctuation">(</span>t<span class="token punctuation">.</span>日期<span class="token punctuation">)</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span>
<span class="token operator">and</span> t<span class="token punctuation">.</span>司机id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> t1<span class="token punctuation">.</span>司机id <span class="token keyword">from</span> t1<span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> substr<span class="token punctuation">(</span>t<span class="token punctuation">.</span>日期<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t4 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> substr<span class="token punctuation">(</span>o<span class="token punctuation">.</span>日期<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">"年月"</span><span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span>订单id<span class="token punctuation">)</span> <span class="token keyword">as</span> 订单量
<span class="token keyword">from</span> 订单数据 o
<span class="token keyword">where</span> month<span class="token punctuation">(</span>o<span class="token punctuation">.</span>日期<span class="token punctuation">)</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span>
<span class="token operator">and</span> o<span class="token punctuation">.</span>司机id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> t1<span class="token punctuation">.</span>司机id <span class="token keyword">from</span> t1<span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> substr<span class="token punctuation">(</span>o<span class="token punctuation">.</span>日期<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">select</span> t2<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>t3<span class="token punctuation">.</span>在线时长<span class="token punctuation">,</span>t4<span class="token punctuation">.</span>订单量<span class="token operator">/</span>t3<span class="token punctuation">.</span>在线时长 <span class="token keyword">as</span> <span class="token string">"TPH"</span>
<span class="token keyword">from</span> t2<span class="token punctuation">,</span>t3<span class="token punctuation">,</span>t4
<span class="token keyword">where</span> t2<span class="token punctuation">.</span>年月<span class="token operator">=</span>t3<span class="token punctuation">.</span>年月
<span class="token operator">and</span> t3<span class="token punctuation">.</span>年月<span class="token operator">=</span>t4<span class="token punctuation">.</span>年月<span class="token punctuation">;</span>
</code></pre>
<p>第二问结果如图：<br><img src="https://cdn.kesci.com/upload/image/r9wfrzex2k.png" alt="Image Name"></p>
<ol start="3">
<li>分别提取司机数大于20，司机总在线时长大于2小时，订单量大于1的城市名称数据。</li>
</ol>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 司机id<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 城市id<span class="token punctuation">)</span> <span class="token keyword">as</span> 司机数    
<span class="token keyword">from</span> 司机数据 
<span class="token keyword">group</span> <span class="token keyword">by</span> 城市id   
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t2 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>在线时长<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">partition</span> <span class="token keyword">by</span> 司机id<span class="token punctuation">)</span> <span class="token keyword">as</span> 总在线时长<span class="token punctuation">,</span>
<span class="token keyword">from</span> 在线时长数据    
<span class="token keyword">join</span> t1 
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>司机id<span class="token operator">=</span>在线时长数据<span class="token punctuation">.</span>司机id 
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t3 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span>订单id<span class="token punctuation">)</span> <span class="token keyword">as</span> 订单量  
<span class="token keyword">from</span> 订单数据
<span class="token keyword">join</span> t2
<span class="token keyword">on</span> t2<span class="token punctuation">.</span>司机id<span class="token operator">=</span>司机id    
<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">select</span>
城市名称<span class="token punctuation">,</span>司机id<span class="token punctuation">,</span>司机数<span class="token punctuation">,</span>总在线时长<span class="token punctuation">,</span>订单量
<span class="token keyword">from</span> 城市匹配数据
<span class="token keyword">join</span> t3
<span class="token keyword">on</span> t3<span class="token punctuation">.</span>城市id<span class="token operator">=</span>城市id
<span class="token keyword">group</span> <span class="token keyword">by</span> 城市名称
<span class="token keyword">having</span> 司机数<span class="token operator">></span><span class="token number">20</span> <span class="token operator">and</span> 总在线时长<span class="token operator">></span><span class="token number">2</span> <span class="token operator">and</span> 订单量<span class="token operator">></span><span class="token number">1</span>
</code></pre>
<p>解法二：</p>
<p>（3.1）提取司机数大于20的城市名称数据</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token number">c</span><span class="token punctuation">.</span>城市名称 <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">d</span><span class="token punctuation">.</span>司机id<span class="token punctuation">)</span> <span class="token keyword">as</span> 司机数
<span class="token keyword">from</span> 司机数据 <span class="token number">d</span>
<span class="token keyword">join</span> 城市匹配数据 <span class="token number">c</span>
<span class="token keyword">on</span> <span class="token number">d</span><span class="token punctuation">.</span>城市id <span class="token operator">=</span><span class="token number">c</span><span class="token punctuation">.</span>城市id
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">c</span><span class="token punctuation">.</span>城市名称 
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">d</span><span class="token punctuation">.</span>司机id<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">20</span><span class="token punctuation">;</span>
</code></pre>
<p><img src="https://cdn.kesci.com/upload/image/r9wg2e610r.png" alt="Image Name"></p>
<p>3.2）提取司机总在线时长大于2小时的城市名称数据</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token number">c</span><span class="token punctuation">.</span>城市名称 <span class="token punctuation">,</span>t1<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">from</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> t<span class="token punctuation">.</span>司机id <span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>在线时长<span class="token punctuation">)</span> <span class="token keyword">as</span> 总在线时长
<span class="token keyword">from</span> 在线时长数据 t
<span class="token keyword">group</span> <span class="token keyword">by</span> t<span class="token punctuation">.</span>司机id
<span class="token keyword">having</span> <span class="token function">sum</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>在线时长<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">2</span><span class="token punctuation">)</span> t1
<span class="token keyword">left</span> <span class="token keyword">join</span> 司机数据 <span class="token number">d</span>
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>司机id <span class="token operator">=</span><span class="token number">d</span><span class="token punctuation">.</span>司机id
<span class="token keyword">left</span> <span class="token keyword">join</span> 城市匹配数据 <span class="token number">c</span>
<span class="token keyword">on</span> <span class="token number">d</span><span class="token punctuation">.</span>城市id <span class="token operator">=</span><span class="token number">c</span><span class="token punctuation">.</span>城市id<span class="token punctuation">;</span>
</code></pre>
<p><img src="https://cdn.kesci.com/upload/image/r9wgg525ch.png" alt="Image Name"></p>
<p>（3.3）提取司机订单量大于1的城市名称数据</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token number">c</span><span class="token punctuation">.</span>城市名称 <span class="token punctuation">,</span>t1<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">from</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> o<span class="token punctuation">.</span>司机id <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>订单id<span class="token punctuation">)</span> <span class="token keyword">as</span> 司机订单量
<span class="token keyword">from</span> 订单数据 o
<span class="token keyword">group</span> <span class="token keyword">by</span> o<span class="token punctuation">.</span>司机id
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>订单id<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">1</span><span class="token punctuation">)</span>t1
<span class="token keyword">left</span> <span class="token keyword">join</span> 司机数据 <span class="token number">d</span>
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>司机id <span class="token operator">=</span><span class="token number">d</span><span class="token punctuation">.</span>司机id
<span class="token keyword">left</span> <span class="token keyword">join</span> 城市匹配数据 <span class="token number">c</span>
<span class="token keyword">on</span> <span class="token number">d</span><span class="token punctuation">.</span>城市id <span class="token operator">=</span><span class="token number">c</span><span class="token punctuation">.</span>城市id<span class="token punctuation">;</span>
</code></pre>
<p><img src="https://cdn.kesci.com/upload/image/r9wgyll82h.png" alt="Image Name"></p>
<h2 id="连续打卡天数"><a href="#连续打卡天数" class="headerlink" title="连续打卡天数"></a>连续打卡天数</h2><p>现在有一张表t，这张表存储了每个员工每天的打卡情况<br>现在需要统计截止目前每个员工的连续打卡天数，表t如下表所示：</p>
<p><img src="https://cdn.kesci.com/upload/image/r9vgwmrzqk.png" alt="Image Name"></p>
<p>结果如下：</p>
<p><img src="https://cdn.kesci.com/upload/image/r9vhwmudll.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>     
<span class="token keyword">from</span> t
<span class="token keyword">where</span> is_flag<span class="token operator">=</span><span class="token string">"1"</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> uid
<span class="token keyword">order</span> <span class="token keyword">by</span> tdate           
<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">select</span> uid<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> lag<span class="token punctuation">(</span>tdate<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> flag_days  
<span class="token keyword">from</span> t1   
<span class="token keyword">group</span> <span class="token keyword">by</span> uid    
<span class="token comment" spellcheck="true">--解法二</span>
<span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
lead<span class="token punctuation">(</span>tdate<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> uid <span class="token keyword">order</span> <span class="token keyword">by</span> tdate<span class="token punctuation">)</span> <span class="token keyword">as</span> 下次打卡日期<span class="token punctuation">,</span>
 <span class="token function">max</span><span class="token punctuation">(</span>tdate<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 截至日期
 <span class="token keyword">from</span> t
 <span class="token keyword">where</span> is_flag<span class="token operator">=</span><span class="token number">1</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t2 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
lead<span class="token punctuation">(</span>下次打卡日期<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> uid <span class="token keyword">order</span> <span class="token keyword">by</span> tdate<span class="token punctuation">)</span> <span class="token keyword">as</span> 在次打卡日期
<span class="token keyword">from</span> t1
<span class="token keyword">where</span> datediff<span class="token punctuation">(</span>下次打卡日期<span class="token punctuation">,</span>tdate<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span>    
<span class="token punctuation">)</span>
<span class="token keyword">select</span> uid<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> datediff<span class="token punctuation">(</span>再次打卡日期<span class="token punctuation">,</span>下次打卡日期<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> datediff<span class="token punctuation">(</span>下次打卡日期<span class="token punctuation">,</span>tdate<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> <span class="token number">2</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> flag_days
<span class="token keyword">from</span> t2
<span class="token keyword">group</span> <span class="token keyword">by</span> uid<span class="token punctuation">;</span>
</code></pre>
<h2 id="连续天数"><a href="#连续天数" class="headerlink" title="连续天数"></a>连续天数</h2><p>问题：请求出sales_record表中连续三天有销售记录的店铺</p>
<p>sales_record表：</p>
<p><img src="https://cdn.kesci.com/upload/image/r9vgh3u4nw.png" alt="Image Name"></p>
<p>结果如下：</p>
<p><img src="https://cdn.kesci.com/upload/image/r9vgrmgad4.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
    lead<span class="token punctuation">(</span>td<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">partition</span> <span class="token keyword">by</span> shopid <span class="token keyword">order</span> <span class="token keyword">by</span> td<span class="token punctuation">)</span> <span class="token keyword">as</span> 第二天销售记录
    <span class="token keyword">from</span> sales_record
    <span class="token keyword">where</span> sale <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">distinct</span> shopid
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t2 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
    lead<span class="token punctuation">(</span>第二天销售记录<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">partition</span> <span class="token keyword">by</span> shopid <span class="token keyword">order</span> <span class="token keyword">by</span> td<span class="token punctuation">)</span> <span class="token keyword">as</span> 第三天销售记录
    <span class="token keyword">from</span> t1
    <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">distinct</span> shopid
<span class="token punctuation">)</span><span class="token punctuation">,</span>
selet <span class="token keyword">distinct</span> shopid<span class="token punctuation">,</span>
<span class="token keyword">from</span> t2
<span class="token keyword">where</span> 第二天销售记录 <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token operator">and</span> 第三天销售记录 <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
<span class="token comment" spellcheck="true">--解法二</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> shopid
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span>
     <span class="token number">a</span><span class="token punctuation">.</span>shopid<span class="token punctuation">,</span>
     <span class="token number">a</span><span class="token punctuation">.</span>dt <span class="token keyword">as</span> day1<span class="token punctuation">,</span>
     <span class="token number">b</span><span class="token punctuation">.</span>dt <span class="token keyword">as</span> day2<span class="token punctuation">,</span>
     <span class="token number">c</span><span class="token punctuation">.</span>dt <span class="token keyword">as</span> day3
     <span class="token keyword">from</span> sales_record <span class="token number">a</span>
      <span class="token keyword">left</span> <span class="token keyword">join</span> sales_record <span class="token number">b</span>
      <span class="token keyword">on</span> <span class="token number">a</span><span class="token punctuation">.</span>shopid<span class="token operator">=</span><span class="token number">b</span><span class="token punctuation">.</span>shopid
      <span class="token keyword">left</span> <span class="token keyword">join</span> sales_revord <span class="token number">c</span>
      <span class="token keyword">on</span> <span class="token number">b</span><span class="token punctuation">.</span>shopid<span class="token operator">=</span><span class="token number">c</span><span class="token punctuation">.</span>shopid
     <span class="token punctuation">)</span> <span class="token number">d</span>
     <span class="token keyword">where</span> day2<span class="token operator">-</span>day1<span class="token operator">=</span><span class="token number">1</span>
     <span class="token operator">and</span> day3<span class="token operator">-</span>day2<span class="token operator">=</span><span class="token number">1</span>
</code></pre>
<h2 id="N日留存率"><a href="#N日留存率" class="headerlink" title="N日留存率"></a>N日留存率</h2><p>【相机】是深受大家喜爱的应用之一，现在我们需要研究相机的活跃情况，需统计如下数据：<br>某日活跃的用户(uid)在后续的一周内的留存情况（计算次留、三留、七留）<br>指标定义：<br>某日活跃用户数：某日活跃的去重用户数<br>N日留存用户数：某日活跃的用户在之后的第N日活跃用户数<br>N日活跃留存率：N日留存用户数/某日活跃用户数</p>
<p>例：<br>20180501日去重用户数10000，这批用户20190503仍有7000人活跃，则3日活跃的留存率为7000/10000=70%</p>
<p>数据表名：act_user_info</p>
<p><img src="https://cdn.kesci.com/upload/image/r9v2iupdd4.png" alt="Image Name"></p>
<p>要求：<br>1、活跃用户数为整数<br>2、该留存率表示为百分比，结果保留为两位小数<br>3、仅一条sql或hive sql完成<br>4、仅写出实现查询的代码即可</p>
<p>结果如下：</p>
<p><img src="https://cdn.kesci.com/upload/image/r9v54yii44.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> date_format<span class="token punctuation">(</span>登陆时间<span class="token punctuation">,</span><span class="token operator">%</span>Y<span class="token operator">%</span>m<span class="token operator">%</span><span class="token number">d</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 日期，
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> 用户id<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 日期 <span class="token keyword">order</span> <span class="token keyword">by</span> 日期<span class="token punctuation">)</span> <span class="token keyword">as</span> 活跃用户数<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span>lead<span class="token punctuation">(</span><span class="token keyword">distinct</span> 活跃用户数<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 日期 <span class="token keyword">order</span> <span class="token keyword">by</span> 日期<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 次日留存数，
<span class="token function">count</span><span class="token punctuation">(</span>lead<span class="token punctuation">(</span><span class="token keyword">distinct</span> 次日留存数<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 日期 <span class="token keyword">order</span> <span class="token keyword">by</span> 日期<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 三日留存数，
<span class="token function">count</span><span class="token punctuation">(</span>lead<span class="token punctuation">(</span><span class="token keyword">distinct</span> 三日留存数<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 日期 <span class="token keyword">order</span> <span class="token keyword">by</span> 日期<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 七日留存数，
concat<span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span>次日留存数<span class="token operator">/</span>活跃用户数<span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'%'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 次日留存率<span class="token punctuation">,</span>
concat<span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span>三日留存数<span class="token operator">/</span>活跃用户数<span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'%'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 三日留存率<span class="token punctuation">,</span>
concat<span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span>七日留存数<span class="token operator">/</span>活跃用户数<span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'%'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 七日留存率<span class="token punctuation">,</span>
<span class="token keyword">from</span> act_user_info
<span class="token keyword">where</span> 应用名称<span class="token operator">=</span><span class="token string">"相机"</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> 日期
<span class="token comment" spellcheck="true">--解法二</span>
<span class="token keyword">SELECT</span> 时间<span class="token number">1</span><span class="token punctuation">,</span>
<span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> 用户id<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'活跃用户数'</span><span class="token punctuation">,</span>
<span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> 时间<span class="token number">2</span><span class="token operator">-</span>时间<span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">THEN</span> 用户id <span class="token keyword">ELSE</span> <span class="token boolean">NULL</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'次日留存数'</span><span class="token punctuation">,</span>
<span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> 时间<span class="token number">2</span><span class="token operator">-</span>时间<span class="token number">1</span><span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">THEN</span> 用户id <span class="token keyword">ELSE</span> <span class="token boolean">NULL</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'三日留存数'</span><span class="token punctuation">,</span>
<span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> 时间<span class="token number">2</span><span class="token operator">-</span>时间<span class="token number">1</span><span class="token operator">=</span><span class="token number">6</span> <span class="token keyword">THEN</span> 用户id <span class="token keyword">ELSE</span> <span class="token boolean">NULL</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'七日留存数'</span><span class="token punctuation">,</span>
CONCAT<span class="token punctuation">(</span><span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> 时间<span class="token number">2</span><span class="token operator">-</span>时间<span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">THEN</span> 用户id <span class="token keyword">ELSE</span> <span class="token boolean">NULL</span> <span class="token keyword">END</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> 用户id<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'%'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'次日留存率'</span><span class="token punctuation">,</span>
CONCAT<span class="token punctuation">(</span><span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> 时间<span class="token number">2</span><span class="token operator">-</span>时间<span class="token number">1</span><span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">THEN</span> 用户id <span class="token keyword">ELSE</span> <span class="token boolean">NULL</span> <span class="token keyword">END</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> 用户id<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'%'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'三日留存率'</span><span class="token punctuation">,</span>
CONCAT<span class="token punctuation">(</span><span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> 时间<span class="token number">2</span><span class="token operator">-</span>时间<span class="token number">1</span><span class="token operator">=</span><span class="token number">6</span> <span class="token keyword">THEN</span> 用户id <span class="token keyword">ELSE</span> <span class="token boolean">NULL</span> <span class="token keyword">END</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> 用户id<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'%'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'七日留存率'</span>
<span class="token keyword">FROM</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">a</span><span class="token punctuation">.</span>用户id<span class="token punctuation">,</span>DATE_FORMAT<span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">.</span>登陆时间<span class="token punctuation">,</span><span class="token string">'%Y%m%d'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 时间<span class="token number">1</span><span class="token punctuation">,</span>DATE_FORMAT<span class="token punctuation">(</span><span class="token number">b</span><span class="token punctuation">.</span>登陆时间<span class="token punctuation">,</span><span class="token string">'%Y%m%d'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 时间<span class="token number">2</span>
<span class="token keyword">FROM</span> act_user_info <span class="token number">a</span>
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> act_user_info <span class="token number">b</span>
<span class="token keyword">ON</span> <span class="token number">a</span><span class="token punctuation">.</span>用户id<span class="token operator">=</span><span class="token number">b</span><span class="token punctuation">.</span>用户id
<span class="token keyword">WHERE</span> <span class="token number">a</span><span class="token punctuation">.</span>应用名称<span class="token operator">=</span><span class="token string">'相机'</span>
<span class="token operator">AND</span> <span class="token number">b</span><span class="token punctuation">.</span>应用名称<span class="token operator">=</span><span class="token string">'相机'</span><span class="token punctuation">)</span><span class="token number">a</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 时间<span class="token number">1</span>
</code></pre>
<h2 id="统计不同月份用户的回购数"><a href="#统计不同月份用户的回购数" class="headerlink" title="统计不同月份用户的回购数"></a>统计不同月份用户的回购数</h2><p><img src="https://cdn.kesci.com/upload/image/r9v0tgdike.png" alt="Image Name"></p>
<p>问题：统计不同月份用户的回购数<br>（回购：上月购买用户中有多少用户本月又再次购买）</p>
<p>结果如图：</p>
<p><img src="https://cdn.kesci.com/upload/image/r9v1pniqsm.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> date_format<span class="token punctuation">(</span>buy_datetime<span class="token punctuation">,</span><span class="token string">'%Y%m'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 日期<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> user_id<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 日期 <span class="token keyword">order</span> <span class="token keyword">by</span> 日期<span class="token punctuation">)</span> <span class="token keyword">as</span> 当月首购数<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span>lead<span class="token punctuation">(</span>当月首购数<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 次月回购数<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span>lead<span class="token punctuation">(</span>当月首购数<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 三月回购数<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span>lead<span class="token punctuation">(</span>当月首购数<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 四月回购数<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span>lead<span class="token punctuation">(</span>当月首购数<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 五月回购数<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span>lead<span class="token punctuation">(</span>当月首购数<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 六月回购数<span class="token punctuation">,</span>
<span class="token keyword">from</span> buy_data 
<span class="token keyword">group</span> <span class="token keyword">by</span> 日期
<span class="token comment" spellcheck="true">--解法二</span>
<span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span>
        <span class="token number">a</span><span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
        <span class="token number">a</span><span class="token punctuation">.</span>buy_datetime <span class="token keyword">as</span> 时间<span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token number">b</span><span class="token punctuation">.</span>buy_datetime <span class="token keyword">as</span> 时间<span class="token number">2</span>
    <span class="token keyword">from</span>
        buy_data <span class="token number">a</span>
    <span class="token keyword">left</span> <span class="token keyword">join</span> buy_data <span class="token number">b</span> 
      <span class="token keyword">on</span>
        <span class="token number">a</span><span class="token punctuation">.</span>user_id <span class="token operator">=</span> <span class="token number">b</span><span class="token punctuation">.</span>user_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">select</span>
    DATE_FORMAT<span class="token punctuation">(</span>时间<span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'%Y-%m'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 日期<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> user_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'当月首购数'</span><span class="token punctuation">,</span>

    <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">case</span> <span class="token keyword">when</span> date_format<span class="token punctuation">(</span>date_add<span class="token punctuation">(</span>时间<span class="token number">1</span><span class="token punctuation">,</span>interval <span class="token number">1</span> month<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span><span class="token operator">=</span>date_format<span class="token punctuation">(</span>时间<span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span> <span class="token keyword">then</span> user_id <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'次月回购数'</span><span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">case</span> <span class="token keyword">when</span> date_format<span class="token punctuation">(</span>date_add<span class="token punctuation">(</span>时间<span class="token number">1</span><span class="token punctuation">,</span>interval <span class="token number">2</span> month<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span><span class="token operator">=</span>date_format<span class="token punctuation">(</span>时间<span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span> <span class="token keyword">then</span> user_id <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'三月回购数'</span><span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">case</span> <span class="token keyword">when</span> date_format<span class="token punctuation">(</span>date_add<span class="token punctuation">(</span>时间<span class="token number">1</span><span class="token punctuation">,</span>interval <span class="token number">3</span> month<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span><span class="token operator">=</span>date_format<span class="token punctuation">(</span>时间<span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span> <span class="token keyword">then</span> user_id <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'四月回购数'</span><span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">case</span> <span class="token keyword">when</span> date_format<span class="token punctuation">(</span>date_add<span class="token punctuation">(</span>时间<span class="token number">1</span><span class="token punctuation">,</span>interval <span class="token number">4</span> month<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span><span class="token operator">=</span>date_format<span class="token punctuation">(</span>时间<span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span> <span class="token keyword">then</span> user_id <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'五月回购数'</span><span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">case</span> <span class="token keyword">when</span> date_format<span class="token punctuation">(</span>date_add<span class="token punctuation">(</span>时间<span class="token number">1</span><span class="token punctuation">,</span>interval <span class="token number">5</span> month<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span><span class="token operator">=</span>date_format<span class="token punctuation">(</span>时间<span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span> <span class="token keyword">then</span> user_id <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'六月回购数'</span><span class="token punctuation">,</span>
<span class="token keyword">from</span> t1
<span class="token keyword">group</span> <span class="token keyword">by</span> 日期   
</code></pre>
<h2 id="所有学生参加所有科目测试的次数"><a href="#所有学生参加所有科目测试的次数" class="headerlink" title="所有学生参加所有科目测试的次数"></a>所有学生参加所有科目测试的次数</h2><p>学生表: Students</p>
<p><img src="https://cdn.kesci.com/upload/image/r9uzpxfhcc.png" alt="Image Name"></p>
<p>科目表: Subjects</p>
<p><img src="https://cdn.kesci.com/upload/image/r9uzqgh0y.png" alt="Image Name"></p>
<p>考试表: Examinations</p>
<p><img src="https://cdn.kesci.com/upload/image/r9uzqy1ppr.png" alt="Image Name"></p>
<p>考试表的每一行记录就表示学生表里的某个学生参加了一次科目表里某门科目测试。<br>要求写一段 SQL 语句，查询出每个学生参加每一门科目测试的次数，结果按 student_id 和subject_name 排序。<br>结果表需包含所有学生和所有科目（<strong>即便测试次数为0</strong>）</p>
<p>结果如下：</p>
<p><img src="https://cdn.kesci.com/upload/image/r9v0kp9yq8.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token number">a</span><span class="token punctuation">.</span>student_id<span class="token punctuation">,</span><span class="token number">a</span><span class="token punctuation">.</span>student_name<span class="token punctuation">,</span><span class="token number">c</span><span class="token punctuation">.</span>subject_name<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token number">b</span><span class="token punctuation">.</span>student_id<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> subject_name<span class="token punctuation">)</span> <span class="token keyword">as</span> attended_exams
<span class="token keyword">from</span> Students <span class="token number">a</span>
<span class="token keyword">left</span> <span class="token keyword">join</span> Examinations <span class="token number">b</span>
<span class="token keyword">using</span><span class="token punctuation">(</span>student_id<span class="token punctuation">)</span>
<span class="token keyword">join</span> Subjects <span class="token number">c</span>
<span class="token keyword">using</span><span class="token punctuation">(</span>subject_name<span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">a</span><span class="token punctuation">.</span>student_id<span class="token punctuation">,</span><span class="token number">a</span><span class="token punctuation">.</span>student_name<span class="token punctuation">,</span><span class="token number">c</span><span class="token punctuation">.</span>subject_name
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">a</span><span class="token punctuation">.</span>student_id<span class="token punctuation">,</span><span class="token number">c</span><span class="token punctuation">.</span>subject_name
<span class="token comment" spellcheck="true">--解法二</span>
<span class="token keyword">SELECT</span> 
  <span class="token number">a</span><span class="token punctuation">.</span>student_id<span class="token punctuation">,</span>
  <span class="token number">a</span><span class="token punctuation">.</span>student_name<span class="token punctuation">,</span>
  <span class="token number">a</span><span class="token punctuation">.</span>subject_name<span class="token punctuation">,</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">e</span><span class="token punctuation">.</span>subject_name<span class="token punctuation">)</span> <span class="token keyword">AS</span> attended_exams 
<span class="token keyword">FROM</span>
  <span class="token punctuation">(</span><span class="token keyword">SELECT</span> 
    <span class="token operator">*</span> 
  <span class="token keyword">FROM</span>
    students 
    <span class="token keyword">CROSS</span> <span class="token keyword">JOIN</span> subjects<span class="token punctuation">)</span> <span class="token number">a</span> <span class="token comment" spellcheck="true">--cross join：笛卡尔积</span>
  <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> examinations <span class="token number">e</span> 
    <span class="token keyword">ON</span> <span class="token number">a</span><span class="token punctuation">.</span>student_id <span class="token operator">=</span> <span class="token number">e</span><span class="token punctuation">.</span>student_id
    <span class="token operator">AND</span> <span class="token number">a</span><span class="token punctuation">.</span>subject_name <span class="token operator">=</span> <span class="token number">e</span><span class="token punctuation">.</span>subject_name 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token number">a</span><span class="token punctuation">.</span>student_id<span class="token punctuation">,</span>
  <span class="token number">a</span><span class="token punctuation">.</span>student_name<span class="token punctuation">,</span>
  <span class="token number">a</span><span class="token punctuation">.</span>subject_name 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token number">a</span><span class="token punctuation">.</span>student_id<span class="token punctuation">,</span>
  <span class="token number">a</span><span class="token punctuation">.</span>subject_name 
</code></pre>
<h2 id="7天内是否玩过游戏"><a href="#7天内是否玩过游戏" class="headerlink" title="7天内是否玩过游戏"></a>7天内是否玩过游戏</h2><p><img src="https://cdn.kesci.com/upload/image/r9uyu8xws8.png" alt="Image Name"></p>
<p>请查询出以下表。”&lt;7 days” 表示此玩家每一行日期的前7天之内玩过游戏(不是今天之前的前7天，是玩家玩游戏日期的前7天）</p>
<p><img src="https://cdn.kesci.com/upload/image/r9uywicozg.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
lag<span class="token punctuation">(</span>play_date<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> player_name <span class="token keyword">order</span> <span class="token keyword">by</span> play_date<span class="token punctuation">)</span> <span class="token keyword">as</span> 上次游戏时间
<span class="token keyword">from</span> play_time
<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">select</span>
<span class="token operator">*</span><span class="token punctuation">,</span>
<span class="token keyword">case</span> <span class="token keyword">when</span> datediff<span class="token punctuation">(</span>play_date<span class="token punctuation">,</span>上次游戏时间<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">7</span> <span class="token keyword">then</span> <span class="token string">'yes'</span> <span class="token keyword">else</span> <span class="token string">'no'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> <span class="token string">"&lt;7 days"</span>
<span class="token keyword">from</span> t1
<span class="token keyword">order</span> play_date<span class="token punctuation">;</span>
</code></pre>
<h2 id="用户复购率"><a href="#用户复购率" class="headerlink" title="用户复购率"></a>用户复购率</h2><p>现在数据库中有一张用户交易表 netease_order，其中有orderid（订单ID）、userid（用户ID）、<br>amount（消费金额）、paytime（支付时间）<br>请写出对应的SQL语句，查出每个月的新客数（新客指在严选首次支付的用户），当月有复购的新客数，新客当月复购率（当月有复购的新客数/月总新客数）。</p>
<p><img src="https://cdn.kesci.com/upload/image/r9uwtyrw63.png" alt="Image Name"></p>
<p>得到结果如下图：</p>
<p><img src="https://cdn.kesci.com/upload/image/r9uxsxq96w.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
    substr<span class="token punctuation">(</span>paytime<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 年月<span class="token punctuation">,</span>
    <span class="token function">min</span><span class="token punctuation">(</span>paytime<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> userid<span class="token punctuation">)</span> 首次支付时间<span class="token punctuation">,</span>
    lead<span class="token punctuation">(</span>paytime<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id <span class="token keyword">order</span> <span class="token keyword">by</span> paytime<span class="token punctuation">)</span> <span class="token keyword">as</span> 下次支付时间
<span class="token keyword">from</span> netease_order 
<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">select</span> 年月<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 年月<span class="token punctuation">)</span> 月总新客数<span class="token punctuation">,</span>   
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> date_format<span class="token punctuation">(</span>首次支付时间<span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span><span class="token operator">=</span>date_format<span class="token punctuation">(</span>下次支付时间<span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 当月有复购的新客数<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> date_format<span class="token punctuation">(</span>首次支付时间<span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span><span class="token operator">=</span>date_format<span class="token punctuation">(</span>下次支付时间<span class="token punctuation">,</span><span class="token string">'%Y-%m'</span><span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span> <span class="token keyword">as</span> 当月有复购的新客数<span class="token punctuation">,</span>    
<span class="token keyword">from</span> t1
<span class="token keyword">where</span> paytime<span class="token operator">=</span>首次支付时间
<span class="token keyword">group</span> <span class="token keyword">by</span> 年月<span class="token punctuation">;</span>   
</code></pre>
<h2 id="用户行为分析"><a href="#用户行为分析" class="headerlink" title="用户行为分析"></a>用户行为分析</h2><p>有订单事务表、收藏事务表,要求：请用一句SQL取出所有用户对商品的行为特征，<br>特征分为：<br>已购买、购买未收藏、收藏未购买、收藏且购买</p>
<p>订单事务表如下（redbk_orders）：<br><img src="https://cdn.kesci.com/upload/image/rc22fn62e3.png" alt="Image Name"><br>收藏事务表如下（redbk_favorites）：<br><img src="https://cdn.kesci.com/upload/image/rc22g66zmq.png" alt="Image Name"><br>最终结果如图：<br><img src="https://cdn.kesci.com/upload/image/r9umz130yu.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token number">a</span><span class="token punctuation">.</span>user_id<span class="token punctuation">,</span><span class="token number">a</span><span class="token punctuation">.</span>item_id<span class="token punctuation">,</span>
<span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token number">a</span><span class="token punctuation">.</span>par_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token string">'1'</span> <span class="token keyword">else</span> <span class="token string">'0'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> 已购买<span class="token punctuation">,</span>
<span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token number">a</span><span class="token punctuation">.</span>par_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token operator">and</span> <span class="token number">b</span><span class="token punctuation">.</span>fav_time <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token string">'1'</span> <span class="token keyword">else</span> <span class="token string">'0'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> 购买未收藏<span class="token punctuation">,</span>
<span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token number">a</span><span class="token punctuation">.</span>par_time <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> <span class="token number">b</span><span class="token punctuation">.</span>fav_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token string">'1'</span> <span class="token keyword">else</span> <span class="token string">'0'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> 收藏未购买<span class="token punctuation">,</span>
<span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token number">a</span><span class="token punctuation">.</span>par_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token operator">and</span> <span class="token number">b</span><span class="token punctuation">.</span>fav_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token string">'1'</span> <span class="token keyword">else</span> <span class="token string">'0'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> 收藏且购买<span class="token punctuation">,</span>
<span class="token keyword">from</span> redbk_orders <span class="token number">a</span>
<span class="token keyword">join</span> redbk_favorites <span class="token number">b</span>
<span class="token keyword">using</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token operator">and</span>
<span class="token keyword">using</span><span class="token punctuation">(</span>item_id<span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">a</span><span class="token punctuation">.</span>user_id<span class="token punctuation">,</span><span class="token number">a</span><span class="token punctuation">.</span>item_id
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">a</span><span class="token punctuation">.</span>user_id<span class="token punctuation">,</span><span class="token number">a</span><span class="token punctuation">.</span>item_id
<span class="token comment" spellcheck="true">--解法二</span>
<span class="token keyword">SELECT</span> o<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>o<span class="token punctuation">.</span>item_id<span class="token punctuation">,</span>
<span class="token number">1</span> <span class="token keyword">AS</span> <span class="token string">'已购买'</span><span class="token punctuation">,</span>
<span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token number">f</span><span class="token punctuation">.</span>item_id <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span> <span class="token keyword">AS</span> <span class="token string">'购买未收藏'</span><span class="token punctuation">,</span>
<span class="token number">0</span> <span class="token keyword">AS</span> <span class="token string">'收藏未购买'</span><span class="token punctuation">,</span>
<span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token number">f</span><span class="token punctuation">.</span>item_id <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>  <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span> <span class="token keyword">AS</span> <span class="token string">'收藏且购买'</span>
<span class="token keyword">FROM</span> redbk_orders o
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> redbk_favorites <span class="token number">f</span>
<span class="token keyword">ON</span> o<span class="token punctuation">.</span>user_id<span class="token operator">=</span><span class="token number">f</span><span class="token punctuation">.</span>user_id
<span class="token operator">AND</span> o<span class="token punctuation">.</span>item_id<span class="token operator">=</span><span class="token number">f</span><span class="token punctuation">.</span>item_id
<span class="token keyword">union</span>
<span class="token keyword">SELECT</span> <span class="token number">f</span><span class="token punctuation">.</span>user_id<span class="token punctuation">,</span><span class="token number">f</span><span class="token punctuation">.</span>item_id<span class="token punctuation">,</span>
<span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> o<span class="token punctuation">.</span>item_id <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span> <span class="token keyword">AS</span> <span class="token string">'已购买'</span><span class="token punctuation">,</span>
<span class="token number">0</span> <span class="token keyword">AS</span> <span class="token string">'购买未收藏'</span><span class="token punctuation">,</span>
<span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> o<span class="token punctuation">.</span>item_id <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span> <span class="token keyword">AS</span> <span class="token string">'收藏未购买'</span><span class="token punctuation">,</span>
<span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> o<span class="token punctuation">.</span>item_id <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span> <span class="token keyword">AS</span> <span class="token string">'收藏且购买'</span>
<span class="token keyword">FROM</span> redbk_favorites <span class="token number">f</span>
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> redbk_orders o
<span class="token keyword">ON</span> o<span class="token punctuation">.</span>user_id<span class="token operator">=</span><span class="token number">f</span><span class="token punctuation">.</span>user_id
<span class="token operator">AND</span> o<span class="token punctuation">.</span>item_id<span class="token operator">=</span><span class="token number">f</span><span class="token punctuation">.</span>item_id
<span class="token keyword">order</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>item_id<span class="token punctuation">;</span>
</code></pre>
<p>题意分析</p>
<p>本题主要考察多表连接以及union的用法。分别将两个表作为主表进行左外连接，使用case when 取出相同的字段，最后通过union联结并过滤重复项得到最终结果。</p>
<p>(1)将订单表作为主表左外连接,连接条件不仅要user_id相同，item_id也要相同。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> redbk_orders o
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> redbk_favorites <span class="token number">f</span>
<span class="token keyword">ON</span> o<span class="token punctuation">.</span>user_id<span class="token operator">=</span><span class="token number">f</span><span class="token punctuation">.</span>user_id
<span class="token operator">AND</span> o<span class="token punctuation">.</span>item_id<span class="token operator">=</span><span class="token number">f</span><span class="token punctuation">.</span>item_id
</code></pre>
<p><img src="https://cdn.kesci.com/upload/image/r9uljyl55s.png" alt="Image Name"></p>
<p>(2)因为订单表作为主表，得到的是所有订单（无论是否收藏）的结果，所以已购买列全为1，收藏未购买列则全为0，通过判断收藏表的商品id(item_id)是否为null可判断是否收藏。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> o<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>o<span class="token punctuation">.</span>item_id<span class="token punctuation">,</span>
<span class="token number">1</span> <span class="token keyword">AS</span> <span class="token string">'已购买'</span><span class="token punctuation">,</span>
<span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token number">f</span><span class="token punctuation">.</span>item_id <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span> <span class="token keyword">AS</span> <span class="token string">'购买未收藏'</span><span class="token punctuation">,</span>
<span class="token number">0</span> <span class="token keyword">AS</span> <span class="token string">'收藏未购买'</span><span class="token punctuation">,</span>
<span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token number">f</span><span class="token punctuation">.</span>item_id <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span> <span class="token keyword">AS</span> <span class="token string">'收藏且购买'</span>
<span class="token keyword">FROM</span> redbk_orders o
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> redbk_favorites <span class="token number">f</span>
<span class="token keyword">ON</span> o<span class="token punctuation">.</span>user_id<span class="token operator">=</span><span class="token number">f</span><span class="token punctuation">.</span>user_id
<span class="token operator">AND</span> o<span class="token punctuation">.</span>item_id<span class="token operator">=</span><span class="token number">f</span><span class="token punctuation">.</span>item_id
</code></pre>
<p>得到结果如下：</p>
<p><img src="https://cdn.kesci.com/upload/image/r9um38xljt.png" alt="Image Name"></p>
<p>同上分析，将收藏表作为主表左外连接，得到的是所有收藏（无论是否下单）的结果，则购买情况通过订单表的item_id是否为null进行判断。而购买未收藏则全列为0。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token number">f</span><span class="token punctuation">.</span>user_id<span class="token punctuation">,</span><span class="token number">f</span><span class="token punctuation">.</span>item_id<span class="token punctuation">,</span>
<span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> o<span class="token punctuation">.</span>item_id <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span> <span class="token keyword">AS</span> <span class="token string">'已购买'</span><span class="token punctuation">,</span>
<span class="token number">0</span> <span class="token keyword">AS</span> <span class="token string">'购买未收藏'</span><span class="token punctuation">,</span>
<span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> o<span class="token punctuation">.</span>item_id <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span> <span class="token keyword">AS</span> <span class="token string">'收藏未购买'</span><span class="token punctuation">,</span>
<span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> o<span class="token punctuation">.</span>item_id <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span> <span class="token keyword">AS</span> <span class="token string">'收藏且购买'</span>
<span class="token keyword">FROM</span> redbk_favorites <span class="token number">f</span>
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> redbk_orders o
<span class="token keyword">ON</span> o<span class="token punctuation">.</span>user_id<span class="token operator">=</span><span class="token number">f</span><span class="token punctuation">.</span>user_id
<span class="token operator">AND</span> o<span class="token punctuation">.</span>item_id<span class="token operator">=</span><span class="token number">f</span><span class="token punctuation">.</span>item_id
</code></pre>
<p>结果如下：</p>
<p><img src="https://cdn.kesci.com/upload/image/r9umnaj9m5.png" alt="Image Name"></p>
<p>上两步的最终结果因为字段数和字段名称都一致，通过union联结一起并剔除重复行。再对最终结果的user_id,item_id排序就得出最后结果。</p>
<p>MySQL UNION 操作符用于连接两个以上的 SELECT 语句的结果组合到一个结果集合中。多个 SELECT 语句会删除重复的数据。</p>
<h2 id="用户取消率"><a href="#用户取消率" class="headerlink" title="用户取消率"></a>用户取消率</h2><p>Trips表中存所有货拉拉的行程信息。每段行程有唯一键 Id，Client_Id 和 Driver_Id。Status 是枚举类型，枚举内容为 (‘completed’,‘cancelled_by_driver’,‘cancelled_by_client’)。</p>
<p><img src="https://cdn.kesci.com/upload/image/r9uiv8ek9a.png" alt="Image Name"></p>
<p>Users 表存所有用户。每个用户有唯一键 Users_Id。Banned 表示这个用户是否被禁止，Role 则是一个表示（‘client’, ‘driver’, ‘partner’）的枚举类型。</p>
<p><img src="https://cdn.kesci.com/upload/image/r9uiy1iydu.png" alt="Image Name"></p>
<p>写一段 SQL 语句查出 2019年10月1日 至 2019年10月3日 期间非禁止用户的取消率。基于上表，你的SQL 语句应返回如下结果，取消率（Cancellation Rate）保留两位小数。</p>
<p>取消率即未完成订单（无所谓是司机还是顾客取消）/总订单，前提是这里订单都是不能有禁止用户参与的。</p>
<p><img src="https://cdn.kesci.com/upload/image/r9ujuoa7im.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> t<span class="token punctuation">.</span>Request_at <span class="token keyword">as</span> <span class="token string">"Day"</span><span class="token punctuation">,</span>
<span class="token keyword">case</span> <span class="token keyword">when</span> u<span class="token punctuation">.</span>Banned<span class="token operator">=</span><span class="token string">'No'</span> <span class="token keyword">then</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> t<span class="token punctuation">.</span><span class="token keyword">Status</span><span class="token operator">=</span><span class="token string">'cancelled_by_driver'</span> <span class="token operator">or</span> t<span class="token punctuation">.</span><span class="token keyword">Status</span><span class="token operator">=</span><span class="token string">'cancelled_by_client'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token boolean">null</span> <span class="token keyword">end</span> <span class="token keyword">as</span> <span class="token string">"Cancellation_Rate"</span>
<span class="token keyword">from</span> Trips t
<span class="token keyword">join</span> Users u
<span class="token keyword">on</span> u<span class="token punctuation">.</span>Users_ID<span class="token operator">=</span>t<span class="token punctuation">.</span>Client_Id
<span class="token keyword">where</span> Day <span class="token operator">between</span> <span class="token string">'2019/10/1'</span> <span class="token operator">and</span> <span class="token string">'2019/10/3'</span> 
<span class="token keyword">group</span> <span class="token keyword">by</span> Day
<span class="token keyword">order</span> <span class="token keyword">by</span>  Day
<span class="token comment" spellcheck="true">--解法二</span>
<span class="token keyword">SELECT</span> Request_at <span class="token keyword">AS</span> <span class="token string">"Day"</span><span class="token punctuation">,</span>
<span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token keyword">STATUS</span><span class="token operator">=</span><span class="token string">'completed'</span> <span class="token keyword">THEN</span> <span class="token number">0</span> <span class="token keyword">ELSE</span> <span class="token number">1</span> <span class="token keyword">END</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">"Cancellation_Rate"</span>
<span class="token keyword">FROM</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> trips
<span class="token keyword">WHERE</span> client_ID <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> Users_ID <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> Banned<span class="token operator">=</span><span class="token string">'Yes'</span><span class="token punctuation">)</span>
<span class="token operator">AND</span> Driver_ID <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> Users_ID <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> Banned<span class="token operator">=</span><span class="token string">'Yes'</span><span class="token punctuation">)</span>
<span class="token operator">AND</span> Request_at <span class="token operator">BETWEEN</span> <span class="token string">'2019-10-01'</span> <span class="token operator">AND</span> <span class="token string">'2019-10-03'</span><span class="token punctuation">)</span><span class="token number">a</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> Request_at
</code></pre>
<h2 id="改变相邻座位"><a href="#改变相邻座位" class="headerlink" title="改变相邻座位"></a>改变相邻座位</h2><p>小马是货拉拉的行政同学，她有一张座位表，储存员工名字和与他们相对应的座位号id。其中第一列的id 是连续递增的因工作需要小马想改变相邻俩同事的座位。你能不能帮她写一个 SQL query 来输出小马想要的结果呢？</p>
<p><img src="https://cdn.kesci.com/upload/image/r9uhelr58p.png" alt="Image Name"></p>
<p>结果图如下：</p>
<p><img src="https://cdn.kesci.com/upload/image/r9uienrsfm.png" alt="Image Name"></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">case</span> <span class="token keyword">when</span> mod<span class="token punctuation">(</span>ID<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">&lt;></span><span class="token number">0</span> <span class="token operator">and</span> ID<span class="token operator">&lt;></span>最大ID <span class="token keyword">then</span> id<span class="token operator">+</span><span class="token number">1</span>
<span class="token keyword">when</span> mod<span class="token punctuation">(</span>ID<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">&lt;></span><span class="token number">0</span> <span class="token operator">and</span> ID<span class="token operator">=</span>最大ID <span class="token keyword">then</span> id <span class="token keyword">else</span> id<span class="token number">-1</span> <span class="token keyword">end</span> <span class="token keyword">as</span> <span class="token string">"ID"</span><span class="token punctuation">,</span>
<span class="token keyword">FROM</span>
  <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token function">MAX</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> 最大ID 
  <span class="token keyword">FROM</span> Seat<span class="token punctuation">)</span> <span class="token number">a</span> 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> ID 
</code></pre>
<p>id为奇数的员工，如1、3、5的员工要换到2、4、6去，2、4、6员工则换到1、3、5去，这是当最大ID为偶数时的情况，当最大ID为奇数时，最大ID对应的员工就没有人换座位，则保持原位。而判断id为奇数还是偶数的方法，可以看它除以2的余数是否为0，为0的为偶数，不为0则是奇数。</p>
<h2 id="统计薪水最高员工-1"><a href="#统计薪水最高员工-1" class="headerlink" title="统计薪水最高员工"></a>统计薪水最高员工</h2><p>货拉拉EMPLOYEE表里包含着所有货拉拉的员工信息，每个员工有自己的工号、姓名、薪水、和部门ID<br><img src="https://cdn.kesci.com/upload/image/rau1u8vc8e.png" alt="Image Name"><br>货拉拉DEPARTMENT表里包含着货拉拉所有的部门<br><img src="https://cdn.kesci.com/upload/image/rau1tq4b1h.png" alt="Image Name"><br>现在需要统计出货拉拉每个部门薪水最高的员工（包含department/name/salary字段）</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> <span class="token number">b</span><span class="token punctuation">.</span>DEPARTMENT<span class="token punctuation">,</span><span class="token number">a</span><span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
<span class="token function">max</span><span class="token punctuation">(</span>Salary<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> DepartmentID<span class="token punctuation">)</span> <span class="token keyword">as</span> 部门最高薪水
<span class="token keyword">from</span> EMPLOYEE <span class="token number">a</span>
<span class="token keyword">join</span> DEPARTMENT <span class="token number">b</span>
<span class="token keyword">on</span> <span class="token number">a</span><span class="token punctuation">.</span>ID<span class="token operator">=</span><span class="token number">b</span><span class="token punctuation">.</span>DepartmentID
<span class="token keyword">where</span> <span class="token number">a</span><span class="token punctuation">.</span>Salary<span class="token operator">=</span>部门最高薪水
<span class="token keyword">group</span> <span class="token keyword">by</span> DEPARTMENT
</code></pre>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">读序</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://bigworldxld.github.io/2022/06/12/21735.html">https://bigworldxld.github.io/2022/06/12/21735.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">读序</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/SQL/">
                                    <span class="chip bg-color">SQL</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/06/22/48605.html">
                    <div class="card-image">
                        
                        <img src="/images/springboot+vue.jpg" class="responsive-img" alt="SpringBoot+Vue前后端分离后台管理系统">
                        
                        <span class="card-title">SpringBoot+Vue前后端分离后台管理系统</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-06-22
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/java/" class="post-category">
                                    java
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/vue/">
                        <span class="chip bg-color">vue</span>
                    </a>
                    
                    <a href="/tags/springboot/">
                        <span class="chip bg-color">springboot</span>
                    </a>
                    
                    <a href="/tags/nginx/">
                        <span class="chip bg-color">nginx</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/04/27/5123.html">
                    <div class="card-image">
                        
                        <img src="/images/go1.jpg" class="responsive-img" alt="go小型通讯系统">
                        
                        <span class="card-title">go小型通讯系统</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-04-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/OPL/" class="post-category">
                                    OPL
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/tcp/">
                        <span class="chip bg-color">tcp</span>
                    </a>
                    
                    <a href="/tags/Reids/">
                        <span class="chip bg-color">Reids</span>
                    </a>
                    
                    <a href="/tags/GoLang/">
                        <span class="chip bg-color">GoLang</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2025</span>
            
            <a href="/about" target="_blank">读序</a>
            |&nbsp;Author&nbsp;<a href="https://bigworldxld.github.io/" target="_blank">bigworldxld</a>
            |&nbsp;Dailylife&nbsp;<a href="https://bigworldxld.github.io/duxu-dailylife/" target="_blank">blog</a>
			|&nbsp;Desktop&nbsp;<a href="https://bigworldxld.github.io/desktop/" target="_blank">desktop</a>
            <br>
			
            
            
            
                
            
           
			      
				<span id="busuanzi_container_site_pv" style='display:none'></span>
				<i class="fa fa-heart-o"></i>
			本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>

			

			
				<span id="busuanzi_container_site_uv" style='display:none'></span>
					人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.

			

			
            <br>
		


            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2021";
                        var startMonth = "12";
                        var startDate = "30";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">

    <a href="https://github.com/bigworldxld/bigworldxld.github.io" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2117376396@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2117376396" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2117376396" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>
<div class="progress-bar"></div>
<span id="sitetime"></span>
<script language = javascript >
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
		let time = new Date().toLocaleString();
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        var t1 = Date.UTC(2021, 12, 30, 00, 00, 00); //北京时间2018-2-13 00:00:00 
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond); 
        var diff = t2 - t1; var diffYears = Math.floor(diff / years); 
        var diffDays = Math.floor((diff / days) - diffYears * 365); 
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours); 
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes); 
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds); 
		document.getElementById("sitetime").innerHTML = "当前时间为"+ time +"<br/>本站已运行 " +diffYears+" 年 "+diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒"; 
    } 
    siteTime(); 
</script>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/star.js"><\/script>');
            }
        </script>
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script type="text/javascript">
    var OriginTitile = document.title,
        st;
    document.addEventListener("visibilitychange", function () {
        document.hidden ? (document.title = "๑•̀ㅂ•́) ✧看不见～看不见～", clearTimeout(st)) : (document.title =
            "(๑•̀ㅂ•́) ✧看见～", st = setTimeout(function () {
                document.title = OriginTitile
            }, 3e3))
    })
</script>

</body>

</html>
