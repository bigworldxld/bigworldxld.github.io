<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="大数据项目之尚品汇（3数据仓库系统）, blogs,互联网,测试,大数据,生活,记录">
    <meta name="description" content="第1章 数仓分层1.1 为什么要分层

1.2 数据集市与数据仓库概念

1.3 数仓命名规范1.3.1 表命名
ODS层命名为ods_表名_
_DIM层命名为dim_表名
DWD层命名为dwd_表名_
_DWS层命名为dws_表名  
D">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>大数据项目之尚品汇（3数据仓库系统） | 读序</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.1">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="读序" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">读序</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">

      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/archives">
          
          <i class="fas fa-hourglass-half" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>时轴</span>
        </a>
      </li>
      
      <li>
        <a href="/pdf">
          
          <i class="fas fa-file-pdf" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>PDF</span>
        </a>
      </li>
      
      <li>
        <a href="/sql">
          
          <i class="fas fa-database" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>SQL</span>
        </a>
      </li>
      
      <li>
        <a href="/desktop">
          
          <i class="fas fa-desktop" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Desktop</span>
        </a>
      </li>
      
      <li>
        <a href="/duxu-dailylife">
          
          <i class="fas fa-pen" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>blog</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/books" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Medias</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/musics">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>musics</span>
        </a>
      </li>
      
      <li>
        <a href="/books">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>books</span>
        </a>
      </li>
      
      <li>
        <a href="/videos">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>videos</span>
        </a>
      </li>
      
      <li>
        <a href="/galleries">
          
          <i class="fas fa-image" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>galleries</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">读序</div>
        <div class="logo-desc">
            
            我们每一个人都因为生存而充满焦虑，我们真实的存在被不真实的存在所笼罩。而实际上，真正的我们并不会受到不真实存在的威胁。
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-archive"></i>
			
			归档
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/archives " style="margin-left:50px">
				  
				   <i class="fa fas fa-hourglass-half" style="position: absolute;left:28px" ></i>
			      
		          <span>时轴</span>
                  </a>
                </li>
              
                <li>

                  <a href="/pdf " style="margin-left:50px">
				  
				   <i class="fa fas fa-file-pdf" style="position: absolute;left:28px" ></i>
			      
		          <span>PDF</span>
                  </a>
                </li>
              
                <li>

                  <a href="/sql " style="margin-left:50px">
				  
				   <i class="fa fas fa-database" style="position: absolute;left:28px" ></i>
			      
		          <span>SQL</span>
                  </a>
                </li>
              
                <li>

                  <a href="/desktop " style="margin-left:50px">
				  
				   <i class="fa fas fa-desktop" style="position: absolute;left:28px" ></i>
			      
		          <span>Desktop</span>
                  </a>
                </li>
              
                <li>

                  <a href="/duxu-dailylife " style="margin-left:50px">
				  
				   <i class="fa fas fa-pen" style="position: absolute;left:28px" ></i>
			      
		          <span>blog</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Medias
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/musics " style="margin-left:50px">
				  
				   <i class="fa fas fa-music" style="position: absolute;left:28px" ></i>
			      
		          <span>musics</span>
                  </a>
                </li>
              
                <li>

                  <a href="/books " style="margin-left:50px">
				  
				   <i class="fa fas fa-book" style="position: absolute;left:28px" ></i>
			      
		          <span>books</span>
                  </a>
                </li>
              
                <li>

                  <a href="/videos " style="margin-left:50px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:28px" ></i>
			      
		          <span>videos</span>
                  </a>
                </li>
              
                <li>

                  <a href="/galleries " style="margin-left:50px">
				  
				   <i class="fa fas fa-image" style="position: absolute;left:28px" ></i>
			      
		          <span>galleries</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/bigworldxld/bigworldxld.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/bigworldxld/bigworldxld.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请使用开启大门的钥匙')).toString(CryptoJS.enc.Hex)) {
                alert('密钥错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/images/datawarehouse.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">大数据项目之尚品汇（3数据仓库系统）</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/hive/">
                                <span class="chip bg-color">hive</span>
                            </a>
                        
                            <a href="/tags/spark/">
                                <span class="chip bg-color">spark</span>
                            </a>
                        
                            <a href="/tags/kafka/">
                                <span class="chip bg-color">kafka</span>
                            </a>
                        
                            <a href="/tags/Azkaban/">
                                <span class="chip bg-color">Azkaban</span>
                            </a>
                        
                            <a href="/tags/hadoop/">
                                <span class="chip bg-color">hadoop</span>
                            </a>
                        
                            <a href="/tags/zookeeper/">
                                <span class="chip bg-color">zookeeper</span>
                            </a>
                        
                            <a href="/tags/flume/">
                                <span class="chip bg-color">flume</span>
                            </a>
                        
                            <a href="/tags/sqoop/">
                                <span class="chip bg-color">sqoop</span>
                            </a>
                        
                            <a href="/tags/superset/">
                                <span class="chip bg-color">superset</span>
                            </a>
                        
                            <a href="/tags/hbase/">
                                <span class="chip bg-color">hbase</span>
                            </a>
                        
                            <a href="/tags/Presto/">
                                <span class="chip bg-color">Presto</span>
                            </a>
                        
                            <a href="/tags/kylin/">
                                <span class="chip bg-color">kylin</span>
                            </a>
                        
                            <a href="/tags/zabbix/">
                                <span class="chip bg-color">zabbix</span>
                            </a>
                        
                            <a href="/tags/Kerberos/">
                                <span class="chip bg-color">Kerberos</span>
                            </a>
                        
                            <a href="/tags/ranger/">
                                <span class="chip bg-color">ranger</span>
                            </a>
                        
                            <a href="/tags/atlas/">
                                <span class="chip bg-color">atlas</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/data-warehouse/" class="post-category">
                                data warehouse
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-02-07
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    47.1k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    255 分
                </div>
                

                
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
				

            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="第1章-数仓分层"><a href="#第1章-数仓分层" class="headerlink" title="第1章 数仓分层"></a>第1章 数仓分层</h1><h2 id="1-1-为什么要分层"><a href="#1-1-为什么要分层" class="headerlink" title="1.1 为什么要分层"></a>1.1 为什么要分层</h2><img src="/2022/02/07/10237/%E5%88%86%E5%B1%82.png" class title="This is an example image">

<h2 id="1-2-数据集市与数据仓库概念"><a href="#1-2-数据集市与数据仓库概念" class="headerlink" title="1.2 数据集市与数据仓库概念"></a>1.2 数据集市与数据仓库概念</h2><img src="/2022/02/07/10237/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E6%A6%82%E5%BF%B5.png" class title="This is an example image">

<h2 id="1-3-数仓命名规范"><a href="#1-3-数仓命名规范" class="headerlink" title="1.3 数仓命名规范"></a>1.3 数仓命名规范</h2><h3 id="1-3-1-表命名"><a href="#1-3-1-表命名" class="headerlink" title="1.3.1 表命名"></a>1.3.1 表命名</h3><ul>
<li>ODS层命名为ods_表名_</li>
<li>_DIM层命名为dim_表名</li>
<li>DWD层命名为dwd_表名_</li>
<li>_DWS层命名为dws_表名  </li>
<li>DWT层命名为dwt_表名_</li>
<li>_ADS层命名为ads_表名</li>
<li>临时表命名为tmp_表名</li>
</ul>
<h3 id="1-3-2-脚本命名"><a href="#1-3-2-脚本命名" class="headerlink" title="1.3.2 脚本命名"></a>1.3.2 脚本命名</h3><p>数据源_to_目标_db/log.sh<br>用户行为脚本以log为后缀；业务数据脚本以db为后缀。</p>
<h3 id="1-3-3-表字段类型"><a href="#1-3-3-表字段类型" class="headerlink" title="1.3.3 表字段类型"></a>1.3.3 表字段类型</h3><p>数量类型为bigint<br>金额类型为decimal(16, 2)，表示：16位有效数字，其中小数部分2位<br>字符串(名字，描述信息等)类型为string<br>主键外键类型为string<br>时间戳类型为bigint</p>
<h1 id="第2章-数仓理论"><a href="#第2章-数仓理论" class="headerlink" title="第2章 数仓理论"></a>第2章 数仓理论</h1><h2 id="2-1-范式理论"><a href="#2-1-范式理论" class="headerlink" title="2.1 范式理论"></a>2.1 范式理论</h2><h2 id="2-1-1-范式概念"><a href="#2-1-1-范式概念" class="headerlink" title="2.1.1 范式概念"></a>2.1.1 范式概念</h2><p>1）定义<br>数据建模必须遵循一定的规则，在关系建模中，这种规则就是范式。<br>2）目的<br>采用范式，可以降低数据的冗余性。<br>为什么要降低数据冗余性？<br>（1）十几年前，磁盘很贵，为了减少磁盘存储。<br>（2）以前没有分布式系统，都是单机，只能增加磁盘，磁盘个数也是有限的<br>（3）一次修改，需要修改多个表，很难保证数据一致性<br>3）缺点<br>范式的缺点是获取数据时，需要通过Join拼接出最后的数据。<br>4）分类<br>目前业界范式有：第一范式(1NF)、第二范式(2NF)、第三范式(3NF)、巴斯-科德范式(BCNF)、第四范式(4NF)、第五范式(5NF)。 </p>
<h3 id="2-1-2-函数依赖"><a href="#2-1-2-函数依赖" class="headerlink" title="2.1.2 函数依赖"></a>2.1.2 函数依赖</h3><img src="/2022/02/07/10237/%E5%87%BD%E6%95%B0%E4%BE%9D%E8%B5%96.png" class title="This is an example image">

<h3 id="2-1-3-三范式区分"><a href="#2-1-3-三范式区分" class="headerlink" title="2.1.3 三范式区分"></a>2.1.3 三范式区分</h3><img src="/2022/02/07/10237/%E8%8C%83%E5%BC%8F1.png" class title="This is an example image">

<img src="/2022/02/07/10237/%E8%8C%83%E5%BC%8F2.png" class title="This is an example image">

<img src="/2022/02/07/10237/%E8%8C%83%E5%BC%8F3.png" class title="This is an example image">

<h2 id="2-2-关系建模与维度建模"><a href="#2-2-关系建模与维度建模" class="headerlink" title="2.2 关系建模与维度建模"></a>2.2 关系建模与维度建模</h2><p>关系建模和维度建模是两种数据仓库的建模技术。关系建模由Bill Inmon所倡导，维度建模由Ralph Kimball所倡导。</p>
<h3 id="2-2-1-关系建模"><a href="#2-2-1-关系建模" class="headerlink" title="2.2.1 关系建模"></a>2.2.1 关系建模</h3><p>关系建模将复杂的数据抽象为两个概念——实体和关系，并使用规范化的方式表示出来。关系模型如图所示，从图中可以看出，较为松散、零碎，物理表数量多。</p>
<img src="/2022/02/07/10237/%E5%85%B3%E7%B3%BB%E5%BB%BA%E6%A8%A1.png" class title="This is an example image">

<p>关系模型严格遵循第三范式（3NF），数据冗余程度低，数据的一致性容易得到保证。由于数据分布于众多的表中，查询会相对复杂，在大数据的场景下，查询效率相对较低。</p>
<h3 id="2-2-2-维度建模"><a href="#2-2-2-维度建模" class="headerlink" title="2.2.2 维度建模"></a>2.2.2 维度建模</h3><p>维度模型如图所示，从图中可以看出，模型相对清晰、简洁。 </p>
<img src="/2022/02/07/10237/%E7%BB%B4%E5%BA%A6%E6%A8%A1%E5%9E%8B.png" class title="This is an example image">

<p>图 维度模型示意图<br>维度模型以数据分析作为出发点，不遵循三范式，故数据存在一定的冗余。维度模型面向业务，将业务用事实表和维度表呈现出来。表结构简单，故查询简单，查询效率较高。</p>
<h2 id="2-3-维度表和事实表（重点）"><a href="#2-3-维度表和事实表（重点）" class="headerlink" title="2.3 维度表和事实表（重点）"></a>2.3 维度表和事实表（重点）</h2><h3 id="2-3-1-维度表"><a href="#2-3-1-维度表" class="headerlink" title="2.3.1 维度表"></a>2.3.1 维度表</h3><p>维度表：一般是对事实的描述信息。每一张维表对应现实世界中的一个对象或者概念。    例如：用户、商品、日期、地区等。<br>维表的特征：<br>维表的范围很宽（具有多个属性、列比较多）<br>跟事实表相比，行数相对较小：通常&lt; 10万条<br>内容相对固定：编码表<br>时间维度表：</p>
<table>
<thead>
<tr>
<th>日期ID</th>
<th>day of week</th>
<th>day of year</th>
<th>季度</th>
<th>节假日</th>
</tr>
</thead>
<tbody><tr>
<td>2020-01-01</td>
<td>2</td>
<td>1</td>
<td>1</td>
<td>元旦</td>
</tr>
<tr>
<td>2020-01-02</td>
<td>3</td>
<td>2</td>
<td>1</td>
<td>无</td>
</tr>
<tr>
<td>2020-01-03</td>
<td>4</td>
<td>3</td>
<td>1</td>
<td>无</td>
</tr>
<tr>
<td>2020-01-04</td>
<td>5</td>
<td>4</td>
<td>1</td>
<td>无</td>
</tr>
<tr>
<td>2020-01-05</td>
<td>6</td>
<td>5</td>
<td>1</td>
<td>无</td>
</tr>
</tbody></table>
<h3 id="2-3-2-事实表"><a href="#2-3-2-事实表" class="headerlink" title="2.3.2 事实表"></a>2.3.2 事实表</h3><p>事实表中的每行数据代表一个业务事件（下单、支付、退款、评价等）。“事实”这个术语表示的是业务事件的度量值（可统计次数、个数、金额等），例如，2020年5月21日，宋宋老师在京东花了250块钱买了一瓶海狗人参丸。维度表：时间、用户、商品、商家。事实表：250块钱、一瓶<br>每一个事实表的行包括：具有可加性的数值型的度量值、与维表相连接的外键，通常具有两个和两个以上的外键。<br>事实表的特征：<br>非常的大<br>内容相对的窄：列数较少（主要是外键id和度量值）<br>经常发生变化，每天会新增加很多。<br>1）事务型事实表<br>以每个事务或事件为单位，例如一个销售订单记录，一笔支付记录等，作为事实表里的一行数据。一旦事务被提交，事实表数据被插入，数据就不再进行更改，其更新方式为增量更新。<br>2）周期型快照事实表<br>周期型快照事实表中不会保留所有数据，只保留固定时间间隔的数据，例如每天或者每月的销售额，或每月的账户余额等。<br>例如购物车，有加减商品，随时都有可能变化，但是我们更关心每天结束时这里面有多少商品，方便我们后期统计分析。<br>3）累积型快照事实表<br>累计快照事实表用于跟踪业务事实的变化。例如，数据仓库中可能需要累积或者存储订单从下订单开始，到订单商品被打包、运输、和签收的各个业务阶段的时间点数据来跟踪订单声明周期的进展情况。当这个业务过程进行时，事实表的记录也要不断更新。</p>
<table>
<thead>
<tr>
<th><em><strong>*订单*</strong></em><em><strong>*id*</strong></em></th>
<th><em><strong>*用户id*</strong></em></th>
<th><em><strong>*下单时间*</strong></em></th>
<th><em><strong>*打包时间*</strong></em></th>
<th><em><strong>*发货时间*</strong></em></th>
<th><em><strong>*签收时间*</strong></em></th>
<th><em><strong>*订单金额*</strong></em></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td>3-8</td>
<td>3-8</td>
<td>3-9</td>
<td>3-10</td>
<td></td>
</tr>
</tbody></table>
<h2 id="2-4-维度模型分类"><a href="#2-4-维度模型分类" class="headerlink" title="2.4 维度模型分类"></a>2.4 维度模型分类</h2><p>在维度建模的基础上又分为三种模型：星型模型、雪花模型、星座模型。</p>
<img src="/2022/02/07/10237/%E4%B8%89%E7%A7%8D%E6%A8%A1%E5%9E%8B.png" class title="This is an example image">

<img src="/2022/02/07/10237/%E4%B8%89%E7%A7%8D%E6%A8%A1%E5%9E%8B1.png" class title="This is an example image">

<h2 id="2-5-数据仓库建模（绝对重点）"><a href="#2-5-数据仓库建模（绝对重点）" class="headerlink" title="2.5 数据仓库建模（绝对重点）"></a>2.5 数据仓库建模（绝对重点）</h2><h3 id="2-5-1-ODS层"><a href="#2-5-1-ODS层" class="headerlink" title="2.5.1 ODS层"></a>2.5.1 ODS层</h3><p>1）HDFS用户行为数据</p>
<img src="/2022/02/07/10237/HDFS%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA.png" class title="This is an example image">

<p>2）HDFS业务数据</p>


<p>3）针对HDFS上的用户行为数据和业务数据，我们如何规划处理？<br>（1）保持数据原貌不做任何修改，起到备份数据的作用。<br>（2）数据采用压缩，减少磁盘存储空间（例如：原始数据100G，可以压缩到10G左右）<br>（3）创建分区表，防止后续的全表扫描</p>
<h3 id="2-5-2-DIM层和DWD层"><a href="#2-5-2-DIM层和DWD层" class="headerlink" title="2.5.2 DIM层和DWD层"></a>2.5.2 DIM层和DWD层</h3><p>DIM层DWD层需构建维度模型，一般采用星型模型，呈现的状态一般为星座模型。<br>维度建模一般按照以下四个步骤：<br>选择业务过程→声明粒度→确认维度→确认事实<br>（1）选择业务过程<br>在业务系统中，挑选我们感兴趣的业务线，比如下单业务，支付业务，退款业务，物流业务，一条业务线对应一张事实表。<br>（2）声明粒度<br>数据粒度指数据仓库的数据中保存数据的细化程度或综合程度的级别。<br>声明粒度意味着精确定义事实表中的一行数据表示什么，应该尽可能选择最小粒度，以此来应各种各样的需求。<br>典型的粒度声明如下：<br>订单事实表中一行数据表示的是一个订单中的一个商品项。<br>支付事实表中一行数据表示的是一个支付记录。<br>（3）确定维度<br>维度的主要作用是描述业务是事实，主要表示的是“谁，何处，何时”等信息。<br>确定维度的原则是：后续需求中是否要分析相关维度的指标。例如，需要统计，什么时间下的订单多，哪个地区下的订单多，哪个用户下的订单多。需要确定的维度就包括：时间维度、地区维度、用户维度。<br>（4）确定事实<br>此处的“事实”一词，指的是业务中的度量值（次数、个数、件数、金额，可以进行累加），例如订单金额、下单次数等。<br>在DWD层，以业务过程为建模驱动，基于每个具体业务过程的特点，构建最细粒度的明细层事实表。事实表可做适当的宽表化处理。<br>事实表和维度表的关联比较灵活，但是为了应对更复杂的业务需求，可以将能关联上的表尽量关联上。</p>
<table>
<thead>
<tr>
<th></th>
<th><em><strong>*时间*</strong></em></th>
<th><em><strong>*用户*</strong></em></th>
<th><em><strong>*地区*</strong></em></th>
<th><em><strong>*商品*</strong></em></th>
<th><em><strong>*优惠券*</strong></em></th>
<th><em><strong>*活动*</strong></em></th>
<th><em><strong>*度量值*</strong></em></th>
</tr>
</thead>
<tbody><tr>
<td><em><strong>*订单*</strong></em></td>
<td>√</td>
<td>√</td>
<td>√</td>
<td></td>
<td></td>
<td></td>
<td>运费/优惠金额/原始金额/最终金额</td>
</tr>
<tr>
<td><em><strong>*订单详情*</strong></em></td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>件数/优惠金额/原始金额/最终金额</td>
</tr>
<tr>
<td><em><strong>*支付*</strong></em></td>
<td>√</td>
<td>√</td>
<td>√</td>
<td></td>
<td></td>
<td></td>
<td>支付金额</td>
</tr>
<tr>
<td><em><strong>*加购*</strong></em></td>
<td>√</td>
<td>√</td>
<td></td>
<td>√</td>
<td></td>
<td></td>
<td>件数/金额</td>
</tr>
<tr>
<td><em><strong>*收藏*</strong></em></td>
<td>√</td>
<td>√</td>
<td></td>
<td>√</td>
<td></td>
<td></td>
<td>次数</td>
</tr>
<tr>
<td><em><strong>*评价*</strong></em></td>
<td>√</td>
<td>√</td>
<td></td>
<td>√</td>
<td></td>
<td></td>
<td>次数</td>
</tr>
<tr>
<td><em><strong>*退单*</strong></em></td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td></td>
<td></td>
<td>件数/金额</td>
</tr>
<tr>
<td><em><strong>*退款*</strong></em></td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td></td>
<td></td>
<td>件数/金额</td>
</tr>
<tr>
<td><em><strong>*优惠券领用*</strong></em></td>
<td>√</td>
<td>√</td>
<td></td>
<td></td>
<td>√</td>
<td></td>
<td>次数</td>
</tr>
</tbody></table>
<p>至此，数据仓库的维度建模已经完毕，DWD层是以业务过程为驱动。<br>DWS层、DWT层和ADS层都是以需求为驱动，和维度建模已经没有关系了。<br>DWS和DWT都是建宽表，按照主题去建表。主题相当于观察问题的角度。对应着维度表。</p>
<h3 id="2-5-3-DWS层与DWT层"><a href="#2-5-3-DWS层与DWT层" class="headerlink" title="2.5.3 DWS层与DWT层"></a>2.5.3 DWS层与DWT层</h3><p>DWS层和DWT层统称宽表层，这两层的设计思想大致相同，通过以下案例进行阐述。<br>1）问题引出：两个需求，统计每个省份订单的个数、统计每个省份订单的总金额<br>2）处理办法：都是将省份表和订单表进行join，group by省份，然后计算。同样数据被计算了两次，实际上类似的场景还会更多。<br>    那怎么设计能避免重复计算呢？<br>针对上述场景，可以设计一张地区宽表，其主键为地区ID，字段包含为：下单次数、下单金额、支付次数、支付金额等。上述所有指标都统一进行计算，并将结果保存在该宽表中，这样就能有效避免数据的重复计算。<br>3）总结：<br>（１）需要建哪些宽表：以维度为基准。<br>（２）宽表里面的字段：是站在不同维度的角度去看事实表，重点关注事实表聚合后的度量值。<br>（３）DWS和DWT层的区别：DWS层存放的所有主题对象当天的汇总行为，例如每个地区当天的下单次数，下单金额等，DWT层存放的是所有主题对象的累积行为，例如每个地区最近７天（１５天、３０天、６０天）的下单次数、下单金额等。</p>
<h3 id="2-5-4-ADS层"><a href="#2-5-4-ADS层" class="headerlink" title="2.5.4 ADS层"></a>2.5.4 ADS层</h3><p>​    对电商系统各大主题指标分别进行分析。</p>
<h1 id="第3章-数仓环境搭建"><a href="#第3章-数仓环境搭建" class="headerlink" title="第3章 数仓环境搭建"></a>第3章 数仓环境搭建</h1><h2 id="3-1-Hive环境搭建"><a href="#3-1-Hive环境搭建" class="headerlink" title="3.1 Hive环境搭建"></a>3.1 Hive环境搭建</h2><h3 id="3-1-1-Hive引擎简介"><a href="#3-1-1-Hive引擎简介" class="headerlink" title="3.1.1 Hive引擎简介"></a>3.1.1 Hive引擎简介</h3><p>​    Hive引擎包括：默认MR、tez、spark<br>Hive on Spark：Hive既作为存储元数据又负责SQL的解析优化，语法是HQL语法，执行引擎变成了Spark，Spark负责采用RDD执行。<br>Spark on Hive : Hive只作为存储元数据，Spark负责SQL解析优化，语法是Spark SQL语法，Spark负责采用RDD执行。</p>
<h3 id="3-1-2-Hive-on-Spark配置"><a href="#3-1-2-Hive-on-Spark配置" class="headerlink" title="3.1.2 Hive on Spark配置"></a>3.1.2 Hive on Spark配置</h3><p>1）兼容性说明<br>注意：官网下载的Hive3.1.2和Spark3.0.0默认是不兼容的。因为Hive3.1.2支持的Spark版本是2.4.5，所以需要我们重新编译Hive3.1.2版本。<br>编译步骤：官网下载Hive3.1.2源码，修改pom文件中引用的Spark版本为3.0.0，如果编译通过，直接打包获取jar包。如果报错，就根据提示，修改相关方法，直到不报错，打包获取jar包。<br>2）在Hive所在节点部署Spark<br>如果之前已经部署了Spark，则该步骤可以跳过，但要检查SPARK_HOME的环境变量配置是否正确。<br>（1）Spark官网下载jar包地址：<br><a target="_blank" rel="noopener" href="http://spark.apache.org/downloads.html">http://spark.apache.org/downloads.html</a><br>（2）上传并解压解压spark-3.0.0-bin-hadoop3.2.tgz</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 software]$ tar -zxvf spark-3.0.0-bin-hadoop3.2.tgz -C /opt/module/
[atguigu@hadoop102 software]$ mv /opt/module/spark-3.0.0-bin-hadoop3.2 /opt/module/spark
</code></pre>
<p>（3）配置SPARK_HOME环境变量</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 software]$ sudo vim /etc/profile.d/my_env.sh
</code></pre>
<p>添加如下内容</p>
<pre class=" language-shell"><code class="language-shell">#SPARK_HOME
export SPARK_HOME=/opt/module/spark
export PATH=$PATH:$SPARK_HOME/bin
</code></pre>
<p>source 使其生效</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 software]$ source /etc/profile.d/my_env.sh
</code></pre>
<p>３）在hive中创建spark配置文件</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 software]$ vim /opt/module/hive/conf/spark-defaults.conf
</code></pre>
<p>添加如下内容（在执行任务时，会根据如下参数执行）</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">spark.master</span> <span class="token attr-value">                              yarn</span>
<span class="token attr-name">spark.eventLog.enabled</span> <span class="token attr-value">                  true</span>
<span class="token attr-name">spark.eventLog.dir</span> <span class="token attr-value">                       hdfs://hadoop102:8020/spark-history</span>
<span class="token attr-name">spark.executor.memory</span> <span class="token attr-value">                   1g</span>
<span class="token attr-name">spark.driver.memory</span> <span class="token attr-value">                      1g</span>
</code></pre>
<p>在HDFS创建如下路径，用于存储历史日志</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 software]$ hadoop fs -mkdir /spark-history
</code></pre>
<p>４）向HDFS上传Spark纯净版jar包<br>    说明1：由于Spark3.0.0非纯净版默认支持的是hive2.3.7版本，直接使用会和安装的Hive3.1.2出现兼容性问题。所以采用Spark纯净版jar包，不包含hadoop和hive相关依赖，避免冲突。<br>    说明2：Hive任务最终由Spark来执行，Spark任务资源分配由Yarn来调度，该任务有可能被分配到集群的任何一个节点。所以需要将Spark的依赖上传到HDFS集群路径，这样集群中任何一个节点都能获取到。<br>（1）上传并解压spark-3.0.0-bin-without-hadoop.tgz</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 software]$ tar -zxvf /opt/software/spark-3.0.0-bin-without-hadoop.tgz
</code></pre>
<p>（2）上传Spark纯净版jar包到HDFS</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 software]$ hadoop fs -mkdir /spark-jars

[atguigu@hadoop102 software]$ hadoop fs -put spark-3.0.0-bin-without-hadoop/jars/* /spark-jars
</code></pre>
<p>５）修改hive-site.xml文件</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 ~]$ vim /opt/module/hive/conf/hive-site.xml
</code></pre>
<p>添加如下内容</p>
<pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!--Spark依赖位置（注意：端口号8020必须和namenode的端口号一致）--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>spark.yarn.jars<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>hdfs://hadoop102:8020/spark-jars/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>

<span class="token comment" spellcheck="true">&lt;!--Hive执行引擎--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>hive.execution.engine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
</code></pre>
<h3 id="3-1-3-Hive-on-Spark测试"><a href="#3-1-3-Hive-on-Spark测试" class="headerlink" title="3.1.3 Hive on Spark测试"></a>3.1.3 Hive on Spark测试</h3><p>（1）启动hive客户端</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 hive]$ bin/hive
</code></pre>
<p>（2）创建一张测试表</p>
<pre class=" language-shell"><code class="language-shell">hive (default)> create table student(id int, name string);
</code></pre>
<p>（3）通过insert测试效果</p>
<pre class=" language-shell"><code class="language-shell">hive (default)> insert into table student values(1,'abc');
</code></pre>
<p>若结果如下，则说明配置成功</p>
<img src="/2022/02/07/10237/%E9%85%8D%E7%BD%AE%E6%88%90%E5%8A%9F.png" class title="This is an example image">

<p>3.2 Yarn配置<br>3.2.1 增加ApplicationMaster资源比例<br>容量调度器对每个资源队列中同时运行的Application Master占用的资源进行了限制，该限制通过yarn.scheduler.capacity.maximum-am-resource-percent参数实现，其默认值是0.1，表示每个资源队列上Application Master最多可使用的资源为该队列总资源的10%，目的是防止大部分资源都被Application Master占用，而导致Map/Reduce Task无法执行。<br>生产环境该参数可使用默认值。但学习环境，集群资源总数很少，如果只分配10%的资源给Application Master，则可能出现，同一时刻只能运行一个Job的情况，因为一个Application Master使用的资源就可能已经达到10%的上限了。故此处可将该值适当调大。<br>（1）在hadoop102的/opt/module/hadoop-3.1.3/etc/hadoop/capacity-scheduler.xml文件中修改如下参数值</p>
<pre class=" language-xml"><code class="language-xml">[atguigu@hadoop102 hadoop]$ vim capacity-scheduler.xml

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>yarn.scheduler.capacity.maximum-am-resource-percent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>0.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
&lt;/property
</code></pre>
<p>（2）分发capacity-scheduler.xml配置文件</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 hadoop]$ xsync capacity-scheduler.xml
</code></pre>
<p>（3）关闭正在运行的任务，重新启动yarn集群</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop103 hadoop-3.1.3]$ sbin/stop-yarn.sh
[atguigu@hadoop103 hadoop-3.1.3]$ sbin/start-yarn.sh
</code></pre>
<h2 id="3-3-数仓开发环境"><a href="#3-3-数仓开发环境" class="headerlink" title="3.3 数仓开发环境"></a>3.3 数仓开发环境</h2><p>数仓开发工具可选用DBeaver或者DataGrip。两者都需要用到JDBC协议连接到Hive，故需要启动HiveServer2。<br>1.启动HiveServer2</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 hive]$ hiveserver2
</code></pre>
<p>2.配置DataGrip连接<br>1）创建连接</p>
<img src="/2022/02/07/10237/%E5%88%9B%E5%BB%BA%E8%BF%9E%E6%8E%A5.png" class title="This is an example image">

<p>2）配置连接属性<br>所有属性配置，和Hive的beeline客户端配置一致即可。初次使用，配置过程会提示缺少JDBC驱动，按照提示下载即可。</p>
<img src="/2022/02/07/10237/%E9%85%8D%E7%BD%AE%E8%BF%9E%E6%8E%A5%E5%B1%9E%E6%80%A7.png" class title="This is an example image">

<p>3.测试使用<br>创建数据库gmall，并观察是否创建成功。<br>1）创建数据库</p>
<img src="/2022/02/07/10237/%E5%88%9B%E5%BB%BA%E8%BF%9E%E6%8E%A5.png" class title="This is an example image">

<p>2）查看数据库</p>
<img src="/2022/02/07/10237/%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%BA%93.png" class title="This is an example image">

<p>3）修改连接，指明连接数据库</p>
<img src="/2022/02/07/10237/%E4%BF%AE%E6%94%B9%E8%BF%9E%E6%8E%A5.png" class title="This is an example image">

<p>4）选择当前数据库为gmall</p>
<img src="/2022/02/07/10237/%E9%80%89%E6%8B%A9%E5%BD%93%E5%89%8D%E6%95%B0%E6%8D%AE%E5%BA%93.png" class title="This is an example image">

<h2 id="3-4-数据准备"><a href="#3-4-数据准备" class="headerlink" title="3.4 数据准备"></a>3.4 数据准备</h2><p>一般企业在搭建数仓时，业务系统中会存在一定的历史数据，此处为模拟真实场景，需准备若干历史数据。假定数仓上线的日期为2020-06-14，具体说明如下。<br><strong>1.用户行为日志</strong><br>用户行为日志，一般是没有历史数据的，故日志只需要准备2020-06-14一天的数据。具体操作如下：<br>1）启动日志采集通道，包括Flume、Kafak等<br>2）修改两个日志服务器（hadoop102、hadoop103）中的/opt/module/applog/application.yml配置文件，将mock.date参数改为2020-06-14。<br>3）执行日志生成脚本lg.sh。<br>4）观察HDFS是否出现相应文件。</p>
<img src="/2022/02/07/10237/%E7%9B%B8%E5%BA%94%E6%96%87%E4%BB%B6.png" class title="This is an example image">

<p><strong>2.业务数据</strong><br>业务数据一般存在历史数据，此处需准备2020-06-10至2020-06-14的数据。具体操作如下。<br>1）修改hadoop102节点上的/opt/module/db_log/application.properties文件，将mock.date、mock.clear，mock.clear.user三个参数调整为如图所示的值。</p>
<img src="/2022/02/07/10237/application.png" class title="This is an example image">

<p>2）执行模拟生成业务数据的命令，生成第一天2020-06-10的历史数据。</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 db_log]$ java -jar gmall2020-mock-db-2021-01-22.jar
</code></pre>
<p>3）修改/opt/module/db_log/application.properties文件，将mock.date、mock.clear，mock.clear.user三个参数调整为如图所示的值。</p>
<img src="/2022/02/07/10237/application1.png" class title="This is an example image">

<p>4）执行模拟生成业务数据的命令，生成第二天2020-06-11的历史数据。</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 db_log]$ java -jar gmall2020-mock-db-2021-01-22.jar
</code></pre>
<p>5）之后只修改/opt/module/db_log/application.properties文件中的mock.date参数，依次改为2020-06-12，2020-06-13，2020-06-14，并分别生成对应日期的数据。<br>6）执行mysql_to_hdfs_init.sh脚本，将模拟生成的业务数据同步到HDFS。</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ mysql_to_hdfs_init.sh all 2020-06-14
</code></pre>
<p>7）观察HDFS上是否出现相应的数据</p>
<h1 id="第4章-数仓搭建-ODS层"><a href="#第4章-数仓搭建-ODS层" class="headerlink" title="第4章 数仓搭建-ODS层"></a>第4章 数仓搭建-ODS层</h1><p>1）保持数据原貌不做任何修改，起到备份数据的作用。<br>2）数据采用LZO压缩，减少磁盘存储空间。100G数据可以压缩到10G以内。<br>3）创建分区表，防止后续的全表扫描，在企业开发中大量使用分区表。<br>4）创建外部表。在企业开发中，除了自己用的临时表，创建内部表外，绝大多数场景都是创建外部表。</p>
<h2 id="4-1-ODS层（用户行为数据）"><a href="#4-1-ODS层（用户行为数据）" class="headerlink" title="4.1 ODS层（用户行为数据）"></a>4.1 ODS层（用户行为数据）</h2><h3 id="4-1-1-创建日志表ods-log"><a href="#4-1-1-创建日志表ods-log" class="headerlink" title="4.1.1 创建日志表ods_log"></a>4.1.1 创建日志表ods_log</h3><p>1）创建支持lzo压缩的分区表<br>（1）建表语句</p>
<pre class=" language-shell"><code class="language-shell">hive (gmall)> 
drop table if exists ods_log;
CREATE EXTERNAL TABLE ods_log (`line` string)
PARTITIONED BY (`dt` string) -- 按照时间创建分区
STORED AS -- 指定存储方式，读数据采用LzoTextInputFormat；
  INPUTFORMAT 'com.hadoop.mapred.DeprecatedLzoTextInputFormat'
  OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'
LOCATION '/warehouse/gmall/ods/ods_log'  -- 指定数据在hdfs上的存储位置
;
</code></pre>
<p>说明Hive的LZO压缩：<a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+LZO">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+LZO</a><br>（2）分区规划</p>
<img src="/2022/02/07/10237/%E5%88%86%E5%8C%BA%E8%A7%84%E5%88%92.png" class title="This is an example image">

<p>2）加载数据</p>
<img src="/2022/02/07/10237/%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE.png" class title="This is an example image">

<pre class=" language-shell"><code class="language-shell">hive (gmall)> 
load data inpath '/origin_data/gmall/log/topic_log/2020-06-14' into table ods_log partition(dt='2020-06-14');
</code></pre>
<p>注意：时间格式都配置成YYYY-MM-DD格式，这是Hive默认支持的时间格式<br>3）为lzo压缩文件创建索引</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ hadoop jar /opt/module/hadoop-3.1.3/share/hadoop/common/hadoop-lzo-0.4.20.jar com.hadoop.compression.lzo.DistributedLzoIndexer /warehouse/gmall/ods/ods_log/dt=2020-06-14
</code></pre>
<h3 id="4-1-2-Shell中单引号和双引号区别"><a href="#4-1-2-Shell中单引号和双引号区别" class="headerlink" title="4.1.2 Shell中单引号和双引号区别"></a>4.1.2 Shell中单引号和双引号区别</h3><p>1）在/home/atguigu/bin创建一个test.sh文件</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim test.sh 
</code></pre>
<p>在文件中添加如下内容</p>
<pre class=" language-shell"><code class="language-shell">#!/bin/bash
do_date=$1

echo '$do_date'
echo "$do_date"
echo "'$do_date'"
echo '"$do_date"'
echo `date
</code></pre>
<p>2）查看执行结果</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ test.sh 2020-06-14
$do_date
2020-06-14
'2020-06-14'
"$do_date"
2020年 06月 18日 星期四 21:02:08 CST
</code></pre>
<p>3）总结：<br>（1）单引号不取变量值<br>（2）双引号取变量值<br>（3）反引号`，执行引号中命令<br>（4）双引号内部嵌套单引号，取出变量值<br>（5）单引号内部嵌套双引号，不取出变量值</p>
<h3 id="4-1-3-ODS层日志表加载数据脚本"><a href="#4-1-3-ODS层日志表加载数据脚本" class="headerlink" title="4.1.3 ODS层日志表加载数据脚本"></a>4.1.3 ODS层日志表加载数据脚本</h3><p>1）编写脚本<br>（1）在hadoop102的/home/atguigu/bin目录下创建脚本</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim hdfs_to_ods_log.sh
</code></pre>
<p>​    在脚本中编写如下内容</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash

定义变量方便修改

APP=gmall

如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天

if [ -n "$1" ] ;then
   do_date=$1
else 
   do_date=`date -d "-1 day" +%F`
fi 

echo ================== 日志日期为 $do_date ==================
sql="
load data inpath '/origin_data/$APP/log/topic_log/$do_date' into table ${APP}.ods_log partition(dt='$do_date');
"

hive -e "$sql"

hadoop jar /opt/module/hadoop-3.1.3/share/hadoop/common/hadoop-lzo-0.4.20.jar com.hadoop.compression.lzo.DistributedLzoIndexer /warehouse/$APP/ods/ods_log/dt=$do_date
</code></pre>
<p>（1）说明1：<br>[ -n 变量值 ] 判断变量的值，是否为空<br>– 变量的值，非空，返回true<br>– 变量的值，为空，返回false<br>注意：[ -n 变量值 ]不会解析数据，使用[ -n 变量值 ]时，需要对变量加上双引号(“ “)<br>（2）说明2：<br>查看date命令的使用，date –help<br>（2）增加脚本执行权限</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 hdfs_to_ods_log.sh
</code></pre>
<p>2）脚本使用<br>（1）执行脚本</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 module]$ hdfs_to_ods_log.sh 2020-06-14
</code></pre>
<p>（2）查看导入数据</p>
<h2 id="4-2-ODS层（业务数据）"><a href="#4-2-ODS层（业务数据）" class="headerlink" title="4.2 ODS层（业务数据）"></a>4.2 ODS层（业务数据）</h2><p>ODS层业务表分区规划如下</p>
<img src="/2022/02/07/10237/ODS%E5%B1%82%E4%B8%9A%E5%8A%A1%E8%A1%A8%E5%88%86%E5%8C%BA.png" class title="This is an example image">

<p>ODS层业务表数据装载思路如下</p>
<img src="/2022/02/07/10237/ODS%E5%B1%82%E4%B8%9A%E5%8A%A1%E8%A1%A8%E6%95%B0%E6%8D%AE%E8%A3%85%E8%BD%BD.png" class title="This is an example image">

<h3 id="4-2-1-活动信息表"><a href="#4-2-1-活动信息表" class="headerlink" title="4.2.1 活动信息表"></a>4.2.1 活动信息表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_activity_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_activity_info<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>activity_name<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'活动名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>activity_type<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'活动类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>start_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'开始时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>end_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'结束时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动信息表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_activity_info/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-2-活动规则表"><a href="#4-2-2-活动规则表" class="headerlink" title="4.2.2 活动规则表"></a>4.2.2 活动规则表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_activity_rule<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_activity_rule<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'活动ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>activity_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>condition_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'满减金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>condition_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'满减件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>benefit_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>benefit_discount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠折扣'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>benefit_level<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠级别'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动规则表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_activity_rule/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-3-一级品类表"><a href="#4-2-3-一级品类表" class="headerlink" title="4.2.3 一级品类表"></a>4.2.3 一级品类表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_category1<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_category1<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'名称'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品一级分类表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_category1/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-4-二级品类表"><a href="#4-2-4-二级品类表" class="headerlink" title="4.2.4 二级品类表"></a>4.2.4 二级品类表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_category2<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_category2<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">' id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>category1_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'一级品类id'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品二级分类表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_category2/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-5-三级品类表"><a href="#4-2-5-三级品类表" class="headerlink" title="4.2.5 三级品类表"></a>4.2.5 三级品类表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_category3<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_category3<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">' id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>category2_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'二级品类id'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品三级分类表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_category3/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-6-编码字典表"><a href="#4-2-6-编码字典表" class="headerlink" title="4.2.6 编码字典表"></a>4.2.6 编码字典表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_dic<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_dic<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>dic_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>dic_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编码名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>parent_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'父编码'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作日期'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'编码字典表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_dic/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-7-省份表"><a href="#4-2-7-省份表" class="headerlink" title="4.2.7 省份表"></a>4.2.7 省份表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_province<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_province <span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'省份名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>region_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>iso_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'ISO-3166编码，供可视化使用'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>iso_3166_2<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'IOS-3166-2编码，供可视化使用'</span>
<span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'省份表'</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_province/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-8-地区表"><a href="#4-2-8-地区表" class="headerlink" title="4.2.8 地区表"></a>4.2.8 地区表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_region<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_region <span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>region_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区名称'</span>
<span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'地区表'</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_region/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-9-品牌表"><a href="#4-2-9-品牌表" class="headerlink" title="4.2.9 品牌表"></a>4.2.9 品牌表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_trademark<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_trademark <span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>tm_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌名称'</span>
<span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'品牌表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_trademark/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-10-购物车表"><a href="#4-2-10-购物车表" class="headerlink" title="4.2.10 购物车表"></a>4.2.10 购物车表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_cart_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_cart_info<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'skuid'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>cart_price<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'放入购物车时价格'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'数量'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'sku名称 (冗余)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>is_ordered<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否已经下单'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'下单时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>source_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>source_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源编号'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'加购表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_cart_info/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-11-评论表"><a href="#4-2-11-评论表" class="headerlink" title="4.2.11 评论表"></a>4.2.11 评论表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_comment_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_comment_info<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品sku'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品spu'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'评价'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'评价时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品评论表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_comment_info/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-12-优惠券信息表"><a href="#4-2-12-优惠券信息表" class="headerlink" title="4.2.12 优惠券信息表"></a>4.2.12 优惠券信息表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_coupon_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_coupon_info<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'购物券编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'购物券名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'购物券类型 1 现金券 2 折扣券 3 满减券 4 满件打折券'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>condition_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'满额数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>condition_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'满件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>benefit_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'减金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>benefit_discount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'折扣'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>range_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'范围类型 1、商品 2、品类 3、品牌'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>limit_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最多领用次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>taken_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'已领用次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>start_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'开始领取时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>end_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'结束领取时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>expire_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'过期时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_coupon_info/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-13-优惠券领用表"><a href="#4-2-13-优惠券领用表" class="headerlink" title="4.2.13 优惠券领用表"></a>4.2.13 优惠券领用表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_coupon_use<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_coupon_use<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'优惠券ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'skuid'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'spuid'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_status<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'优惠券状态'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>get_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'领取时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>using_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'使用时间(下单)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>used_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'使用时间(支付)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>expire_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'过期时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券领用表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_coupon_use/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-14-收藏表"><a href="#4-2-14-收藏表" class="headerlink" title="4.2.14 收藏表"></a>4.2.14 收藏表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_favor_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_favor_info<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'skuid'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'spuid'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>is_cancel<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否取消'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'收藏时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>cancel_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'取消时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品收藏表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_favor_info/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-15-订单明细表"><a href="#4-2-15-订单明细表" class="headerlink" title="4.2.15 订单明细表"></a>4.2.15 订单明细表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_detail<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_detail<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'订单号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_price<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品价格'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品数量'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>source_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>source_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>split_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'分摊最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>split_activity_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'分摊活动优惠'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>split_coupon_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'分摊优惠券优惠'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单详情表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_detail/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-16-订单明细活动关联表"><a href="#4-2-16-订单明细活动关联表" class="headerlink" title="4.2.16 订单明细活动关联表"></a>4.2.16 订单明细活动关联表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_detail_activity<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_detail_activity<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'订单号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_detail_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单明细id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>activity_rule_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动规则id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单详情活动关联表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_detail_activity/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-17-订单明细优惠券关联表"><a href="#4-2-17-订单明细优惠券关联表" class="headerlink" title="4.2.17 订单明细优惠券关联表"></a>4.2.17 订单明细优惠券关联表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_detail_coupon<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_detail_coupon<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'订单号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_detail_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单明细id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_use_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券领用记录id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单详情活动关联表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_detail_coupon/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-18-订单表"><a href="#4-2-18-订单表" class="headerlink" title="4.2.18 订单表"></a>4.2.18 订单表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_info <span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_status<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单状态'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_way<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付方式'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>delivery_address<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'送货地址'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>out_trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付流水号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>expire_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'过期时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>tracking_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'物流单编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'省份ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>activity_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动减免金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券减免金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'订单原价金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>feight_fee<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'运费'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>feight_fee_reduce<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'运费减免'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_info/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-19-退单表"><a href="#4-2-19-退单表" class="headerlink" title="4.2.19 退单表"></a>4.2.19 退单表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_refund_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_refund_info<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退单类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_reason_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退单原因类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_status<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退单状态'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">--退单状态应包含买家申请、卖家审核、卖家收货、退款完成等状态。此处未涉及到，故该表按增量处理</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退单时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_refund_info/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-20-订单状态日志表"><a href="#4-2-20-订单状态日志表" class="headerlink" title="4.2.20 订单状态日志表"></a>4.2.20 订单状态日志表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_status_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_status_log <span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_status<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单状态'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span>
<span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'订单状态表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_status_log/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-21-支付表"><a href="#4-2-21-支付表" class="headerlink" title="4.2.21 支付表"></a>4.2.21 支付表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_payment_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_payment_info<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>out_trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'对外业务编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'交易编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>subject<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'交易内容'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_status<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付状态'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>callback_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'回调时间'</span>
<span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'支付流水表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_payment_info/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-22-退款表"><a href="#4-2-22-退款表" class="headerlink" title="4.2.22 退款表"></a>4.2.22 退款表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_refund_payment<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_refund_payment<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>out_trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'对外业务编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'SKU编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'交易编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>subject<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'交易内容'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_status<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付状态'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>callback_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'回调时间'</span>
<span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'支付流水表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_refund_payment/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-23-商品平台属性表"><a href="#4-2-23-商品平台属性表" class="headerlink" title="4.2.23 商品平台属性表"></a>4.2.23 商品平台属性表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_sku_attr_value<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_sku_attr_value<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>attr_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'平台属性ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>value_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'平台属性值ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>attr_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'平台属性名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>value_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'平台属性值名称'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'sku平台属性表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_sku_attr_value/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-24-商品（SKU）表"><a href="#4-2-24-商品（SKU）表" class="headerlink" title="4.2.24 商品（SKU）表"></a>4.2.24 商品（SKU）表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_sku_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_sku_info<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'skuId'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'spuid'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>price<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'价格'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_desc<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品描述'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>weight<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'重量'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>category3_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品类id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>is_sale<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否在售'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'SKU商品表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_sku_info/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-25-商品销售属性表"><a href="#4-2-25-商品销售属性表" class="headerlink" title="4.2.25 商品销售属性表"></a>4.2.25 商品销售属性表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_sku_sale_attr_value<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_sku_sale_attr_value<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'sku_id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'spu_id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sale_attr_value_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'销售属性值id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sale_attr_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'销售属性id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sale_attr_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'销售属性名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sale_attr_value_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'销售属性值名称'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'sku销售属性名称'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_sku_sale_attr_value/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-26-商品（SPU）表"><a href="#4-2-26-商品（SPU）表" class="headerlink" title="4.2.26 商品（SPU）表"></a>4.2.26 商品（SPU）表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_spu_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_spu_info<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'spuid'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>spu_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'spu名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>category3_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品类id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌id'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'SPU商品表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_spu_info/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-27-用户表"><a href="#4-2-27-用户表" class="headerlink" title="4.2.27 用户表"></a>4.2.27 用户表</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_user_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_user_info<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>login_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>nick_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户昵称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户姓名'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>phone_num<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机号码'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>email<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'邮箱'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_level<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户等级'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>birthday<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'生日'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>gender<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'性别'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
STORED <span class="token keyword">AS</span>
  INPUTFORMAT <span class="token string">'com.hadoop.mapred.DeprecatedLzoTextInputFormat'</span>
  OUTPUTFORMAT <span class="token string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_user_info/'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-2-28-ODS层业务表首日数据装载脚本"><a href="#4-2-28-ODS层业务表首日数据装载脚本" class="headerlink" title="4.2.28 ODS层业务表首日数据装载脚本"></a>4.2.28 ODS层业务表首日数据装载脚本</h3><p>1）编写脚本<br>（1）在/home/atguigu/bin目录下创建脚本hdfs_to_ods_db_init.sh</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim hdfs_to_ods_db_init.sh
</code></pre>
<p>在脚本中填写如下内容</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash

APP=gmall

if [ -n "$2" ] ;then
   do_date=$2
else 
   echo "请传入日期参数"
   exit
fi 

ods_order_info=" 
load data inpath '/origin_data/$APP/db/order_info/$do_date' OVERWRITE into table ${APP}.ods_order_info partition(dt='$do_date');"

ods_order_detail="
load data inpath '/origin_data/$APP/db/order_detail/$do_date' OVERWRITE into table ${APP}.ods_order_detail partition(dt='$do_date');"

ods_sku_info="
load data inpath '/origin_data/$APP/db/sku_info/$do_date' OVERWRITE into table ${APP}.ods_sku_info partition(dt='$do_date');"

ods_user_info="
load data inpath '/origin_data/$APP/db/user_info/$do_date' OVERWRITE into table ${APP}.ods_user_info partition(dt='$do_date');"

ods_payment_info="
load data inpath '/origin_data/$APP/db/payment_info/$do_date' OVERWRITE into table ${APP}.ods_payment_info partition(dt='$do_date');"

ods_base_category1="
load data inpath '/origin_data/$APP/db/base_category1/$do_date' OVERWRITE into table ${APP}.ods_base_category1 partition(dt='$do_date');"

ods_base_category2="
load data inpath '/origin_data/$APP/db/base_category2/$do_date' OVERWRITE into table ${APP}.ods_base_category2 partition(dt='$do_date');"

ods_base_category3="
load data inpath '/origin_data/$APP/db/base_category3/$do_date' OVERWRITE into table ${APP}.ods_base_category3 partition(dt='$do_date'); "

ods_base_trademark="
load data inpath '/origin_data/$APP/db/base_trademark/$do_date' OVERWRITE into table ${APP}.ods_base_trademark partition(dt='$do_date'); "

ods_activity_info="
load data inpath '/origin_data/$APP/db/activity_info/$do_date' OVERWRITE into table ${APP}.ods_activity_info partition(dt='$do_date'); "

ods_cart_info="
load data inpath '/origin_data/$APP/db/cart_info/$do_date' OVERWRITE into table ${APP}.ods_cart_info partition(dt='$do_date'); "

ods_comment_info="
load data inpath '/origin_data/$APP/db/comment_info/$do_date' OVERWRITE into table ${APP}.ods_comment_info partition(dt='$do_date'); "

ods_coupon_info="
load data inpath '/origin_data/$APP/db/coupon_info/$do_date' OVERWRITE into table ${APP}.ods_coupon_info partition(dt='$do_date'); "

ods_coupon_use="
load data inpath '/origin_data/$APP/db/coupon_use/$do_date' OVERWRITE into table ${APP}.ods_coupon_use partition(dt='$do_date'); "

ods_favor_info="
load data inpath '/origin_data/$APP/db/favor_info/$do_date' OVERWRITE into table ${APP}.ods_favor_info partition(dt='$do_date'); "

ods_order_refund_info="
load data inpath '/origin_data/$APP/db/order_refund_info/$do_date' OVERWRITE into table ${APP}.ods_order_refund_info partition(dt='$do_date'); "

ods_order_status_log="
load data inpath '/origin_data/$APP/db/order_status_log/$do_date' OVERWRITE into table ${APP}.ods_order_status_log partition(dt='$do_date'); "

ods_spu_info="
load data inpath '/origin_data/$APP/db/spu_info/$do_date' OVERWRITE into table ${APP}.ods_spu_info partition(dt='$do_date'); "

ods_activity_rule="
load data inpath '/origin_data/$APP/db/activity_rule/$do_date' OVERWRITE into table ${APP}.ods_activity_rule partition(dt='$do_date');" 

ods_base_dic="
load data inpath '/origin_data/$APP/db/base_dic/$do_date' OVERWRITE into table ${APP}.ods_base_dic partition(dt='$do_date'); "

ods_order_detail_activity="
load data inpath '/origin_data/$APP/db/order_detail_activity/$do_date' OVERWRITE into table ${APP}.ods_order_detail_activity partition(dt='$do_date'); "

ods_order_detail_coupon="
load data inpath '/origin_data/$APP/db/order_detail_coupon/$do_date' OVERWRITE into table ${APP}.ods_order_detail_coupon partition(dt='$do_date'); "

ods_refund_payment="
load data inpath '/origin_data/$APP/db/refund_payment/$do_date' OVERWRITE into table ${APP}.ods_refund_payment partition(dt='$do_date'); "

ods_sku_attr_value="
load data inpath '/origin_data/$APP/db/sku_attr_value/$do_date' OVERWRITE into table ${APP}.ods_sku_attr_value partition(dt='$do_date'); "

ods_sku_sale_attr_value="
load data inpath '/origin_data/$APP/db/sku_sale_attr_value/$do_date' OVERWRITE into table ${APP}.ods_sku_sale_attr_value partition(dt='$do_date'); "

ods_base_province=" 
load data inpath '/origin_data/$APP/db/base_province/$do_date' OVERWRITE into table ${APP}.ods_base_province;"

ods_base_region="
load data inpath '/origin_data/$APP/db/base_region/$do_date' OVERWRITE into table ${APP}.ods_base_region;"

case $1 in
    "ods_order_info"){
        hive -e "$ods_order_info"
    };;
    "ods_order_detail"){
        hive -e "$ods_order_detail"
    };;
    "ods_sku_info"){
        hive -e "$ods_sku_info"
    };;
    "ods_user_info"){
        hive -e "$ods_user_info"
    };;
    "ods_payment_info"){
        hive -e "$ods_payment_info"
    };;
    "ods_base_category1"){
        hive -e "$ods_base_category1"
    };;
    "ods_base_category2"){
        hive -e "$ods_base_category2"
    };;
    "ods_base_category3"){
        hive -e "$ods_base_category3"
    };;
    "ods_base_trademark"){
        hive -e "$ods_base_trademark"
    };;
    "ods_activity_info"){
        hive -e "$ods_activity_info"
    };;
    "ods_cart_info"){
        hive -e "$ods_cart_info"
    };;
    "ods_comment_info"){
        hive -e "$ods_comment_info"
    };;
    "ods_coupon_info"){
        hive -e "$ods_coupon_info"
    };;
    "ods_coupon_use"){
        hive -e "$ods_coupon_use"
    };;
    "ods_favor_info"){
        hive -e "$ods_favor_info"
    };;
    "ods_order_refund_info"){
        hive -e "$ods_order_refund_info"
    };;
    "ods_order_status_log"){
        hive -e "$ods_order_status_log"
    };;
    "ods_spu_info"){
        hive -e "$ods_spu_info"
    };;
    "ods_activity_rule"){
        hive -e "$ods_activity_rule"
    };;
    "ods_base_dic"){
        hive -e "$ods_base_dic"
    };;
    "ods_order_detail_activity"){
        hive -e "$ods_order_detail_activity"
    };;
    "ods_order_detail_coupon"){
        hive -e "$ods_order_detail_coupon"
    };;
    "ods_refund_payment"){
        hive -e "$ods_refund_payment"
    };;
    "ods_sku_attr_value"){
        hive -e "$ods_sku_attr_value"
    };;
    "ods_sku_sale_attr_value"){
        hive -e "$ods_sku_sale_attr_value"
    };;
    "ods_base_province"){
        hive -e "$ods_base_province"
    };;
    "ods_base_region"){
        hive -e "$ods_base_region"
    };;
    "all"){
        hive -e "$ods_order_info$ods_order_detail$ods_sku_info$ods_user_info$ods_payment_info$ods_base_category1$ods_base_category2$ods_base_category3$ods_base_trademark$ods_activity_info$ods_cart_info$ods_comment_info$ods_coupon_info$ods_coupon_use$ods_favor_info$ods_order_refund_info$ods_order_status_log$ods_spu_info$ods_activity_rule$ods_base_dic$ods_order_detail_activity$ods_order_detail_coupon$ods_refund_payment$ods_sku_attr_value$ods_sku_sale_attr_value$ods_base_province$ods_base_region"
    };;
esac
</code></pre>
<p>（2）增加执行权限</p>
<pre class=" language-sh"><code class="language-sh">[atguigu@hadoop102 bin]$ chmod +x hdfs_to_ods_db_init.sh
</code></pre>
<p>2）脚本使用<br>（1）执行脚本</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ hdfs_to_ods_db_init.sh all 2020-06-14
</code></pre>
<p>（2）查看数据是否导入成功<br>4.2.29 ODS层业务表每日数据装载脚本<br>1）编写脚本<br>（1）在/home/atguigu/bin目录下创建脚本hdfs_to_ods_db.sh</p>
<pre class=" language-sh"><code class="language-sh">[atguigu@hadoop102 bin]$ vim hdfs_to_ods_db.sh
</code></pre>
<p>在脚本中填写如下内容</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash

APP=gmall

如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天

if [ -n "$2" ] ;then
    do_date=$2
else 
    do_date=`date -d "-1 day" +%F`
fi

ods_order_info=" 
load data inpath '/origin_data/$APP/db/order_info/$do_date' OVERWRITE into table ${APP}.ods_order_info partition(dt='$do_date');"

ods_order_detail="
load data inpath '/origin_data/$APP/db/order_detail/$do_date' OVERWRITE into table ${APP}.ods_order_detail partition(dt='$do_date');"

ods_sku_info="
load data inpath '/origin_data/$APP/db/sku_info/$do_date' OVERWRITE into table ${APP}.ods_sku_info partition(dt='$do_date');"

ods_user_info="
load data inpath '/origin_data/$APP/db/user_info/$do_date' OVERWRITE into table ${APP}.ods_user_info partition(dt='$do_date');"

ods_payment_info="
load data inpath '/origin_data/$APP/db/payment_info/$do_date' OVERWRITE into table ${APP}.ods_payment_info partition(dt='$do_date');"

ods_base_category1="
load data inpath '/origin_data/$APP/db/base_category1/$do_date' OVERWRITE into table ${APP}.ods_base_category1 partition(dt='$do_date');"

ods_base_category2="
load data inpath '/origin_data/$APP/db/base_category2/$do_date' OVERWRITE into table ${APP}.ods_base_category2 partition(dt='$do_date');"

ods_base_category3="
load data inpath '/origin_data/$APP/db/base_category3/$do_date' OVERWRITE into table ${APP}.ods_base_category3 partition(dt='$do_date'); "

ods_base_trademark="
load data inpath '/origin_data/$APP/db/base_trademark/$do_date' OVERWRITE into table ${APP}.ods_base_trademark partition(dt='$do_date'); "

ods_activity_info="
load data inpath '/origin_data/$APP/db/activity_info/$do_date' OVERWRITE into table ${APP}.ods_activity_info partition(dt='$do_date'); "

ods_cart_info="
load data inpath '/origin_data/$APP/db/cart_info/$do_date' OVERWRITE into table ${APP}.ods_cart_info partition(dt='$do_date'); "

ods_comment_info="
load data inpath '/origin_data/$APP/db/comment_info/$do_date' OVERWRITE into table ${APP}.ods_comment_info partition(dt='$do_date'); "

ods_coupon_info="
load data inpath '/origin_data/$APP/db/coupon_info/$do_date' OVERWRITE into table ${APP}.ods_coupon_info partition(dt='$do_date'); "

ods_coupon_use="
load data inpath '/origin_data/$APP/db/coupon_use/$do_date' OVERWRITE into table ${APP}.ods_coupon_use partition(dt='$do_date'); "

ods_favor_info="
load data inpath '/origin_data/$APP/db/favor_info/$do_date' OVERWRITE into table ${APP}.ods_favor_info partition(dt='$do_date'); "

ods_order_refund_info="
load data inpath '/origin_data/$APP/db/order_refund_info/$do_date' OVERWRITE into table ${APP}.ods_order_refund_info partition(dt='$do_date'); "

ods_order_status_log="
load data inpath '/origin_data/$APP/db/order_status_log/$do_date' OVERWRITE into table ${APP}.ods_order_status_log partition(dt='$do_date'); "

ods_spu_info="
load data inpath '/origin_data/$APP/db/spu_info/$do_date' OVERWRITE into table ${APP}.ods_spu_info partition(dt='$do_date'); "

ods_activity_rule="
load data inpath '/origin_data/$APP/db/activity_rule/$do_date' OVERWRITE into table ${APP}.ods_activity_rule partition(dt='$do_date');" 

ods_base_dic="
load data inpath '/origin_data/$APP/db/base_dic/$do_date' OVERWRITE into table ${APP}.ods_base_dic partition(dt='$do_date'); "

ods_order_detail_activity="
load data inpath '/origin_data/$APP/db/order_detail_activity/$do_date' OVERWRITE into table ${APP}.ods_order_detail_activity partition(dt='$do_date'); "

ods_order_detail_coupon="
load data inpath '/origin_data/$APP/db/order_detail_coupon/$do_date' OVERWRITE into table ${APP}.ods_order_detail_coupon partition(dt='$do_date'); "

ods_refund_payment="
load data inpath '/origin_data/$APP/db/refund_payment/$do_date' OVERWRITE into table ${APP}.ods_refund_payment partition(dt='$do_date'); "

ods_sku_attr_value="
load data inpath '/origin_data/$APP/db/sku_attr_value/$do_date' OVERWRITE into table ${APP}.ods_sku_attr_value partition(dt='$do_date'); "

ods_sku_sale_attr_value="
load data inpath '/origin_data/$APP/db/sku_sale_attr_value/$do_date' OVERWRITE into table ${APP}.ods_sku_sale_attr_value partition(dt='$do_date'); "

ods_base_province=" 
load data inpath '/origin_data/$APP/db/base_province/$do_date' OVERWRITE into table ${APP}.ods_base_province;"

ods_base_region="
load data inpath '/origin_data/$APP/db/base_region/$do_date' OVERWRITE into table ${APP}.ods_base_region;"

case $1 in
    "ods_order_info"){
        hive -e "$ods_order_info"
    };;
    "ods_order_detail"){
        hive -e "$ods_order_detail"
    };;
    "ods_sku_info"){
        hive -e "$ods_sku_info"
    };;
    "ods_user_info"){
        hive -e "$ods_user_info"
    };;
    "ods_payment_info"){
        hive -e "$ods_payment_info"
    };;
    "ods_base_category1"){
        hive -e "$ods_base_category1"
    };;
    "ods_base_category2"){
        hive -e "$ods_base_category2"
    };;
    "ods_base_category3"){
        hive -e "$ods_base_category3"
    };;
    "ods_base_trademark"){
        hive -e "$ods_base_trademark"
    };;
    "ods_activity_info"){
        hive -e "$ods_activity_info"
    };;
    "ods_cart_info"){
        hive -e "$ods_cart_info"
    };;
    "ods_comment_info"){
        hive -e "$ods_comment_info"
    };;
    "ods_coupon_info"){
        hive -e "$ods_coupon_info"
    };;
    "ods_coupon_use"){
        hive -e "$ods_coupon_use"
    };;
    "ods_favor_info"){
        hive -e "$ods_favor_info"
    };;
    "ods_order_refund_info"){
        hive -e "$ods_order_refund_info"
    };;
    "ods_order_status_log"){
        hive -e "$ods_order_status_log"
    };;
    "ods_spu_info"){
        hive -e "$ods_spu_info"
    };;
    "ods_activity_rule"){
        hive -e "$ods_activity_rule"
    };;
    "ods_base_dic"){
        hive -e "$ods_base_dic"
    };;
    "ods_order_detail_activity"){
        hive -e "$ods_order_detail_activity"
    };;
    "ods_order_detail_coupon"){
        hive -e "$ods_order_detail_coupon"
    };;
    "ods_refund_payment"){
        hive -e "$ods_refund_payment"
    };;
    "ods_sku_attr_value"){
        hive -e "$ods_sku_attr_value"
    };;
    "ods_sku_sale_attr_value"){
        hive -e "$ods_sku_sale_attr_value"
    };;
    "all"){
        hive -e "$ods_order_info$ods_order_detail$ods_sku_info$ods_user_info$ods_payment_info$ods_base_category1$ods_base_category2$ods_base_category3$ods_base_trademark$ods_activity_info$ods_cart_info$ods_comment_info$ods_coupon_info$ods_coupon_use$ods_favor_info$ods_order_refund_info$ods_order_status_log$ods_spu_info$ods_activity_rule$ods_base_dic$ods_order_detail_activity$ods_order_detail_coupon$ods_refund_payment$ods_sku_attr_value$ods_sku_sale_attr_value"
    };;
esac
</code></pre>
<p>（2）修改权限</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod +x hdfs_to_ods_db.sh
</code></pre>
<p>2）脚本使用<br>（1）执行脚本</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ hdfs_to_ods_db.sh all 2020-06-14
</code></pre>
<p>（2）查看数据是否导入成功</p>
<h1 id="第5章-数仓搭建-DIM层"><a href="#第5章-数仓搭建-DIM层" class="headerlink" title="第5章 数仓搭建-DIM层"></a>第5章 数仓搭建-DIM层</h1><h2 id="5-1-商品维度表（全量）"><a href="#5-1-商品维度表（全量）" class="headerlink" title="5.1 商品维度表（全量）"></a>5.1 商品维度表（全量）</h2><p>1.建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_sku_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_sku_info <span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>price<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品价格'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_desc<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品描述'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>weight<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'重量'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>is_sale<span class="token punctuation">`</span> <span class="token keyword">BOOLEAN</span> <span class="token keyword">COMMENT</span> <span class="token string">'是否在售'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'spu编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>spu_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'spu名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>category3_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'三级分类id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>category3_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'三级分类名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>category2_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'二级分类id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>category2_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'二级分类名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>category1_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'一级分类id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>category1_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'一级分类名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>tm_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_attr_values<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRUCT<span class="token operator">&lt;</span>attr_id:STRING<span class="token punctuation">,</span>value_id:STRING<span class="token punctuation">,</span>attr_name:STRING<span class="token punctuation">,</span>value_name:STRING<span class="token operator">>></span> <span class="token keyword">COMMENT</span> <span class="token string">'平台属性'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_sale_attr_values<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRUCT<span class="token operator">&lt;</span>sale_attr_id:STRING<span class="token punctuation">,</span>sale_attr_value_id:STRING<span class="token punctuation">,</span>sale_attr_name:STRING<span class="token punctuation">,</span>sale_attr_value_name:STRING<span class="token operator">>></span> <span class="token keyword">COMMENT</span> <span class="token string">'销售属性'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品维度表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dim/dim_sku_info/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2.分区规划</p>
<img src="/2022/02/07/10237/%E5%95%86%E5%93%81%E7%BB%B4%E5%BA%A6%E8%A1%A8%E5%88%86%E5%8C%BA.png" class title="This is an example image">

<p>3.数据装载</p>
<img src="/2022/02/07/10237/%E5%95%86%E5%93%81%E7%BB%B4%E5%BA%A6%E8%A1%A8%E6%95%B0%E6%8D%AE%E8%A3%85%E8%BD%BD.png" class title="This is an example image">

<p>１）Hive读取索引文件问题<br>（1）两种方式，分别查询数据有多少行 </p>
<pre class=" language-shell"><code class="language-shell">hive (gmall)> select * from ods_log;
Time taken: 0.706 seconds, Fetched: 2955 row(s)

hive (gmall)> select count(*) from ods_log;
2959
</code></pre>
<p>（2）两次查询结果不一致。<br>原因是select * from ods_log不执行MR操作，直接采用的是ods_log建表语句中指定的DeprecatedLzoTextInputFormat，能够识别lzo.index为索引文件。<br>select count(*) from ods_log执行MR操作，会先经过hive.input.format，其默认值为CombineHiveInputFormat，其会先将索引文件当成小文件合并，将其当做普通文件处理。更严重的是，这会导致LZO文件无法切片。</p>
<pre class=" language-shell"><code class="language-shell">hive (gmall)> 
hive.input.format=org.apache.hadoop.hive.ql.io.CombineHiveInputFormat;
</code></pre>
<p>解决办法：修改CombineHiveInputFormat为HiveInputFormat</p>
<pre class=" language-shell"><code class="language-shell">hive (gmall)> 
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
</code></pre>
<p>２）首日装载</p>
<pre class=" language-sh"><code class="language-sh">with
sku as
(
    select
        id,
        price,
        sku_name,
        sku_desc,
        weight,
        is_sale,
        spu_id,
        category3_id,
        tm_id,
        create_time
    from ods_sku_info
    where dt='2020-06-14'
),
spu as
(
    select
        id,
        spu_name
    from ods_spu_info
    where dt='2020-06-14'
),
c3 as
(
    select
        id,
        name,
        category2_id
    from ods_base_category3
    where dt='2020-06-14'
),
c2 as
(
    select
        id,
        name,
        category1_id
    from ods_base_category2
    where dt='2020-06-14'
),
c1 as
(
    select
        id,
        name
    from ods_base_category1
    where dt='2020-06-14'
),
tm as
(
    select
        id,
        tm_name
    from ods_base_trademark
    where dt='2020-06-14'
),
attr as
(
    select
        sku_id,
        collect_set(named_struct('attr_id',attr_id,'value_id',value_id,'attr_name',attr_name,'value_name',value_name)) attrs
    from ods_sku_attr_value
    where dt='2020-06-14'
    group by sku_id
),
sale_attr as
(
    select
        sku_id,
        collect_set(named_struct('sale_attr_id',sale_attr_id,'sale_attr_value_id',sale_attr_value_id,'sale_attr_name',sale_attr_name,'sale_attr_value_name',sale_attr_value_name)) sale_attrs
    from ods_sku_sale_attr_value
    where dt='2020-06-14'
    group by sku_id
)
insert overwrite table dim_sku_info partition(dt='2020-06-14')
select
    sku.id,
    sku.price,
    sku.sku_name,
    sku.sku_desc,
    sku.weight,
    sku.is_sale,
    sku.spu_id,
    spu.spu_name,
    sku.category3_id,
    c3.name,
    c3.category2_id,
    c2.name,
    c2.category1_id,
    c1.name,
    sku.tm_id,
    tm.tm_name,
    attr.attrs,
    sale_attr.sale_attrs,
    sku.create_time
from sku
left join spu on sku.spu_id=spu.id
left join c3 on sku.category3_id=c3.id
left join c2 on c3.category2_id=c2.id
left join c1 on c2.category1_id=c1.id
left join tm on sku.tm_id=tm.id
left join attr on sku.id=attr.sku_id
left join sale_attr on sku.id=sale_attr.sku_id;
</code></pre>
<p>３）每日装载</p>
<pre class=" language-sh"><code class="language-sh">with
sku as
(
    select
        id,
        price,
        sku_name,
        sku_desc,
        weight,
        is_sale,
        spu_id,
        category3_id,
        tm_id,
        create_time
    from ods_sku_info
    where dt='2020-06-15'
),
spu as
(
    select
        id,
        spu_name
    from ods_spu_info
    where dt='2020-06-15'
),
c3 as
(
    select
        id,
        name,
        category2_id
    from ods_base_category3
    where dt='2020-06-15'
),
c2 as
(
    select
        id,
        name,
        category1_id
    from ods_base_category2
    where dt='2020-06-15'
),
c1 as
(
    select
        id,
        name
    from ods_base_category1
    where dt='2020-06-15'
),
tm as
(
    select
        id,
        tm_name
    from ods_base_trademark
    where dt='2020-06-15'
),
attr as
(
    select
        sku_id,
        collect_set(named_struct('attr_id',attr_id,'value_id',value_id,'attr_name',attr_name,'value_name',value_name)) attrs
    from ods_sku_attr_value
    where dt='2020-06-15'
    group by sku_id
),
sale_attr as
(
    select
        sku_id,
        collect_set(named_struct('sale_attr_id',sale_attr_id,'sale_attr_value_id',sale_attr_value_id,'sale_attr_name',sale_attr_name,'sale_attr_value_name',sale_attr_value_name)) sale_attrs
    from ods_sku_sale_attr_value
    where dt='2020-06-15'
    group by sku_id
)
insert overwrite table dim_sku_info partition(dt='2020-06-15')
select
    sku.id,
    sku.price,
    sku.sku_name,
    sku.sku_desc,
    sku.weight,
    sku.is_sale,
    sku.spu_id,
    spu.spu_name,
    sku.category3_id,
    c3.name,
    c3.category2_id,
    c2.name,
    c2.category1_id,
    c1.name,
    sku.tm_id,
    tm.tm_name,
    attr.attrs,
    sale_attr.sale_attrs,
    sku.create_time
from sku
left join spu on sku.spu_id=spu.id
left join c3 on sku.category3_id=c3.id
left join c2 on c3.category2_id=c2.id
left join c1 on c2.category1_id=c1.id
left join tm on sku.tm_id=tm.id
left join attr on sku.id=attr.sku_id
left join sale_attr on sku.id=sale_attr.sku_id;
</code></pre>
<h2 id="5-2-优惠券维度表（全量）"><a href="#5-2-优惠券维度表（全量）" class="headerlink" title="5.2 优惠券维度表（全量）"></a>5.2 优惠券维度表（全量）</h2><p>1.建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_coupon_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_coupon_info<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'购物券编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'购物券名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'购物券类型 1 现金券 2 折扣券 3 满减券 4 满件打折券'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>condition_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'满额数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>condition_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'满件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>benefit_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'减金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>benefit_discount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'折扣'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>range_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'范围类型 1、商品 2、品类 3、品牌'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>limit_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最多领取次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>taken_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'已领取次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>start_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'可以领取的开始日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>end_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'可以领取的结束日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>expire_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'过期时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券维度表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dim/dim_coupon_info/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2.分区规划</p>
<img src="/2022/02/07/10237/%E4%BC%98%E6%83%A0%E5%8D%B7%E7%BB%B4%E5%BA%A6%E8%A1%A8%E5%88%86%E5%8C%BA.png" class title="This is an example image">

<p>3.数据装载</p>
<img src="/2022/02/07/10237/%E4%BC%98%E6%83%A0%E5%8D%B7%E7%BB%B4%E5%BA%A6%E8%A1%A8%E6%95%B0%E6%8D%AE%E8%A3%85%E8%BD%BD.png" class title="This is an example image">

<p>1）首日装载</p>
<pre class=" language-sh"><code class="language-sh">with
sku as
(
    select
        id,
        price,
        sku_name,
        sku_desc,
        weight,
        is_sale,
        spu_id,
        category3_id,
        tm_id,
        create_time
    from ods_sku_info
    where dt='2020-06-14'
),
spu as
(
    select
        id,
        spu_name
    from ods_spu_info
    where dt='2020-06-14'
),
c3 as
(
    select
        id,
        name,
        category2_id
    from ods_base_category3
    where dt='2020-06-14'
),
c2 as
(
    select
        id,
        name,
        category1_id
    from ods_base_category2
    where dt='2020-06-14'
),
c1 as
(
    select
        id,
        name
    from ods_base_category1
    where dt='2020-06-14'
),
tm as
(
    select
        id,
        tm_name
    from ods_base_trademark
    where dt='2020-06-14'
),
attr as
(
    select
        sku_id,
        collect_set(named_struct('attr_id',attr_id,'value_id',value_id,'attr_name',attr_name,'value_name',value_name)) attrs
    from ods_sku_attr_value
    where dt='2020-06-14'
    group by sku_id
),
sale_attr as
(
    select
        sku_id,
        collect_set(named_struct('sale_attr_id',sale_attr_id,'sale_attr_value_id',sale_attr_value_id,'sale_attr_name',sale_attr_name,'sale_attr_value_name',sale_attr_value_name)) sale_attrs
    from ods_sku_sale_attr_value
    where dt='2020-06-14'
    group by sku_id
)
insert overwrite table dim_sku_info partition(dt='2020-06-14')
select
    sku.id,
    sku.price,
    sku.sku_name,
    sku.sku_desc,
    sku.weight,
    sku.is_sale,
    sku.spu_id,
    spu.spu_name,
    sku.category3_id,
    c3.name,
    c3.category2_id,
    c2.name,
    c2.category1_id,
    c1.name,
    sku.tm_id,
    tm.tm_name,
    attr.attrs,
    sale_attr.sale_attrs,
    sku.create_time
from sku
left join spu on sku.spu_id=spu.id
left join c3 on sku.category3_id=c3.id
left join c2 on c3.category2_id=c2.id
left join c1 on c2.category1_id=c1.id
left join tm on sku.tm_id=tm.id
left join attr on sku.id=attr.sku_id
left join sale_attr on sku.id=sale_attr.sku_id;
</code></pre>
<p>2）每日装载</p>
<pre class=" language-sh"><code class="language-sh">with
sku as
(
    select
        id,
        price,
        sku_name,
        sku_desc,
        weight,
        is_sale,
        spu_id,
        category3_id,
        tm_id,
        create_time
    from ods_sku_info
    where dt='2020-06-15'
),
spu as
(
    select
        id,
        spu_name
    from ods_spu_info
    where dt='2020-06-15'
),
c3 as
(
    select
        id,
        name,
        category2_id
    from ods_base_category3
    where dt='2020-06-15'
),
c2 as
(
    select
        id,
        name,
        category1_id
    from ods_base_category2
    where dt='2020-06-15'
),
c1 as
(
    select
        id,
        name
    from ods_base_category1
    where dt='2020-06-15'
),
tm as
(
    select
        id,
        tm_name
    from ods_base_trademark
    where dt='2020-06-15'
),
attr as
(
    select
        sku_id,
        collect_set(named_struct('attr_id',attr_id,'value_id',value_id,'attr_name',attr_name,'value_name',value_name)) attrs
    from ods_sku_attr_value
    where dt='2020-06-15'
    group by sku_id
),
sale_attr as
(
    select
        sku_id,
        collect_set(named_struct('sale_attr_id',sale_attr_id,'sale_attr_value_id',sale_attr_value_id,'sale_attr_name',sale_attr_name,'sale_attr_value_name',sale_attr_value_name)) sale_attrs
    from ods_sku_sale_attr_value
    where dt='2020-06-15'
    group by sku_id
)
insert overwrite table dim_sku_info partition(dt='2020-06-15')
select
    sku.id,
    sku.price,
    sku.sku_name,
    sku.sku_desc,
    sku.weight,
    sku.is_sale,
    sku.spu_id,
    spu.spu_name,
    sku.category3_id,
    c3.name,
    c3.category2_id,
    c2.name,
    c2.category1_id,
    c1.name,
    sku.tm_id,
    tm.tm_name,
    attr.attrs,
    sale_attr.sale_attrs,
    sku.create_time
from sku
left join spu on sku.spu_id=spu.id
left join c3 on sku.category3_id=c3.id
left join c2 on c3.category2_id=c2.id
left join c1 on c2.category1_id=c1.id
left join tm on sku.tm_id=tm.id
left join attr on sku.id=attr.sku_id
left join sale_attr on sku.id=sale_attr.sku_id;
5.2 优惠券维度表（全量）
1.建表语句
DROP TABLE IF EXISTS dim_coupon_info;
CREATE EXTERNAL TABLE dim_coupon_info(
    `id` STRING COMMENT '购物券编号',
    `coupon_name` STRING COMMENT '购物券名称',
    `coupon_type` STRING COMMENT '购物券类型 1 现金券 2 折扣券 3 满减券 4 满件打折券',
    `condition_amount` DECIMAL(16,2) COMMENT '满额数',
    `condition_num` BIGINT COMMENT '满件数',
    `activity_id` STRING COMMENT '活动编号',
    `benefit_amount` DECIMAL(16,2) COMMENT '减金额',
    `benefit_discount` DECIMAL(16,2) COMMENT '折扣',
    `create_time` STRING COMMENT '创建时间',
    `range_type` STRING COMMENT '范围类型 1、商品 2、品类 3、品牌',
    `limit_num` BIGINT COMMENT '最多领取次数',
    `taken_count` BIGINT COMMENT '已领取次数',
    `start_time` STRING COMMENT '可以领取的开始日期',
    `end_time` STRING COMMENT '可以领取的结束日期',
    `operate_time` STRING COMMENT '修改时间',
    `expire_time` STRING COMMENT '过期时间'
) COMMENT '优惠券维度表'
PARTITIONED BY (`dt` STRING)
STORED AS PARQUET
LOCATION '/warehouse/gmall/dim/dim_coupon_info/'
TBLPROPERTIES ("parquet.compression"="lzo");
</code></pre>
<p><em><strong>*2*</strong></em><em><strong>*.*</strong></em><em><strong>*分区规划*</strong></em></p>
<p><em><strong>*3*</strong></em><em><strong>*.数据装载*</strong></em></p>
<p>1）首日装载</p>
<pre class=" language-shell"><code class="language-shell">insert overwrite table dim_coupon_info partition(dt='2020-06-14')

select

  id,

  coupon_name,

  coupon_type,

  condition_amount,

  condition_num,

  activity_id,

  benefit_amount,

  benefit_discount,

  create_time,

  range_type,

  limit_num,

  taken_count,

  start_time,

  end_time,

  operate_time,

  expire_time

from ods_coupon_info

where dt='2020-06-14';
</code></pre>
<p><em><strong>*2）每日装载*</strong></em></p>
<pre class=" language-sh"><code class="language-sh">insert overwrite table dim_coupon_info partition(dt='2020-06-15')

select

  id,

  coupon_name,

  coupon_type,

  condition_amount,

  condition_num,

  activity_id,

  benefit_amount,

  benefit_discount,

  create_time,

  range_type,

  limit_num,

  taken_count,

  start_time,

  end_time,

  operate_time,

  expire_time

from ods_coupon_info

where dt='2020-06-15';
</code></pre>
<h2 id="5-3-活动维度表（全量）"><a href="#5-3-活动维度表（全量）" class="headerlink" title="5.3 活动维度表（全量）"></a>5.3 活动维度表（全量）</h2><p><em><strong>*1.建表语句*</strong></em></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_activity_rule_info<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_activity_rule_info<span class="token punctuation">(</span>

  <span class="token punctuation">`</span>activity_rule_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动规则ID'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动ID'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>activity_name<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'活动名称'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>activity_type<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'活动类型'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>start_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'开始时间'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>end_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'结束时间'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>condition_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'满减金额'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>condition_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'满减件数'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>benefit_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠金额'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>benefit_discount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠折扣'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>benefit_level<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠级别'</span>

<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动信息表'</span>

PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>

STORED <span class="token keyword">AS</span> PARQUET

LOCATION <span class="token string">'/warehouse/gmall/dim/dim_activity_rule_info/'</span>

TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><em><strong>*2*</strong></em><em><strong>*.*</strong></em><em><strong>*分区规划*</strong></em></p>


<p><em><strong>*3*</strong></em><em><strong>*.数据装载*</strong></em></p>


<p><em><strong>*1）首日装载*</strong></em></p>
<hr>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_activity_rule_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span>

<span class="token keyword">select</span>

  ar<span class="token punctuation">.</span>id<span class="token punctuation">,</span>

  ar<span class="token punctuation">.</span>activity_id<span class="token punctuation">,</span>

  ai<span class="token punctuation">.</span>activity_name<span class="token punctuation">,</span>

  ar<span class="token punctuation">.</span>activity_type<span class="token punctuation">,</span>

  ai<span class="token punctuation">.</span>start_time<span class="token punctuation">,</span>

  ai<span class="token punctuation">.</span>end_time<span class="token punctuation">,</span>

  ai<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>

  ar<span class="token punctuation">.</span>condition_amount<span class="token punctuation">,</span>

  ar<span class="token punctuation">.</span>condition_num<span class="token punctuation">,</span>

  ar<span class="token punctuation">.</span>benefit_amount<span class="token punctuation">,</span>

  ar<span class="token punctuation">.</span>benefit_discount<span class="token punctuation">,</span>

  ar<span class="token punctuation">.</span>benefit_level

<span class="token keyword">from</span>

<span class="token punctuation">(</span>

  <span class="token keyword">select</span>

​    id<span class="token punctuation">,</span>

​    activity_id<span class="token punctuation">,</span>

​    activity_type<span class="token punctuation">,</span>

​    condition_amount<span class="token punctuation">,</span>

​    condition_num<span class="token punctuation">,</span>

​    benefit_amount<span class="token punctuation">,</span>

​    benefit_discount<span class="token punctuation">,</span>

​    benefit_level

  <span class="token keyword">from</span> ods_activity_rule

  <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>

<span class="token punctuation">)</span>ar

<span class="token keyword">left</span> <span class="token keyword">join</span>

<span class="token punctuation">(</span>

  <span class="token keyword">select</span>

​    id<span class="token punctuation">,</span>

​    activity_name<span class="token punctuation">,</span>

​    start_time<span class="token punctuation">,</span>

​    end_time<span class="token punctuation">,</span>

​    create_time

  <span class="token keyword">from</span> ods_activity_info

  <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>

<span class="token punctuation">)</span>ai

<span class="token keyword">on</span> ar<span class="token punctuation">.</span>activity_id<span class="token operator">=</span>ai<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre>
<p><em><strong>*2）每日转载*</strong></em></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_activity_rule_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">)</span>

<span class="token keyword">select</span>

  ar<span class="token punctuation">.</span>id<span class="token punctuation">,</span>

  ar<span class="token punctuation">.</span>activity_id<span class="token punctuation">,</span>

  ai<span class="token punctuation">.</span>activity_name<span class="token punctuation">,</span>

  ar<span class="token punctuation">.</span>activity_type<span class="token punctuation">,</span>

  ai<span class="token punctuation">.</span>start_time<span class="token punctuation">,</span>

  ai<span class="token punctuation">.</span>end_time<span class="token punctuation">,</span>

  ai<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>

  ar<span class="token punctuation">.</span>condition_amount<span class="token punctuation">,</span>

  ar<span class="token punctuation">.</span>condition_num<span class="token punctuation">,</span>

  ar<span class="token punctuation">.</span>benefit_amount<span class="token punctuation">,</span>

  ar<span class="token punctuation">.</span>benefit_discount<span class="token punctuation">,</span>

  ar<span class="token punctuation">.</span>benefit_level

<span class="token keyword">from</span>

<span class="token punctuation">(</span>

  <span class="token keyword">select</span>

​    id<span class="token punctuation">,</span>

​    activity_id<span class="token punctuation">,</span>

​    activity_type<span class="token punctuation">,</span>

​    condition_amount<span class="token punctuation">,</span>

​    condition_num<span class="token punctuation">,</span>

​    benefit_amount<span class="token punctuation">,</span>

​    benefit_discount<span class="token punctuation">,</span>

​    benefit_level

  <span class="token keyword">from</span> ods_activity_rule

  <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>

<span class="token punctuation">)</span>ar

<span class="token keyword">left</span> <span class="token keyword">join</span>

<span class="token punctuation">(</span>

  <span class="token keyword">select</span>

​    id<span class="token punctuation">,</span>

​    activity_name<span class="token punctuation">,</span>

​    start_time<span class="token punctuation">,</span>

​    end_time<span class="token punctuation">,</span>

​    create_time

  <span class="token keyword">from</span> ods_activity_info

  <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>

<span class="token punctuation">)</span>ai

<span class="token keyword">on</span> ar<span class="token punctuation">.</span>activity_id<span class="token operator">=</span>ai<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre>
<h2 id="5-4-地区维度表（特殊）"><a href="#5-4-地区维度表（特殊）" class="headerlink" title="5.4 地区维度表（特殊）"></a>5.4 地区维度表（特殊）</h2><p><em><strong>*1.建表语句*</strong></em></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_base_province<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_base_province <span class="token punctuation">(</span>

  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>province_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'省市名称'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>iso_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'ISO-3166编码，供可视化使用'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>iso_3166_2<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'IOS-3166-2编码，供可视化使用'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>region_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区id'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>region_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区名称'</span>

<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'地区维度表'</span>

STORED <span class="token keyword">AS</span> PARQUET

LOCATION <span class="token string">'/warehouse/gmall/dim/dim_base_province/'</span>

TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><em><strong>*2.数据装载*</strong></em></p>
<img src="/2022/02/07/10237/%E5%9C%B0%E5%8C%BA%E7%BB%B4%E5%BA%A6%E8%A1%A8%E5%88%86%E5%8C%BA.png" class title="This is an example image">

<p>地区维度表数据相对稳定，变化概率较低，故无需每日装载。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_base_province

<span class="token keyword">select</span>

  bp<span class="token punctuation">.</span>id<span class="token punctuation">,</span>

  bp<span class="token punctuation">.</span>name<span class="token punctuation">,</span>

  bp<span class="token punctuation">.</span>area_code<span class="token punctuation">,</span>

  bp<span class="token punctuation">.</span>iso_code<span class="token punctuation">,</span>

  bp<span class="token punctuation">.</span>iso_3166_2<span class="token punctuation">,</span>

  bp<span class="token punctuation">.</span>region_id<span class="token punctuation">,</span>

  br<span class="token punctuation">.</span>region_name

<span class="token keyword">from</span> ods_base_province bp

<span class="token keyword">join</span> ods_base_region br <span class="token keyword">on</span> bp<span class="token punctuation">.</span>region_id <span class="token operator">=</span> br<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre>
<h2 id="5-5-时间维度表（特殊）"><a href="#5-5-时间维度表（特殊）" class="headerlink" title="5.5 时间维度表（特殊）"></a>5.5 时间维度表（特殊）</h2><p><em><strong>*1.建表语句*</strong></em></p>
<hr>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_date_info<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_date_info<span class="token punctuation">(</span>

  <span class="token punctuation">`</span>date_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'日'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>week_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'周ID'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>week_day<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'周几'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>day<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'每月的第几天'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>month<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'第几月'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>quarter<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'第几季度'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>year<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'年'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>is_workday<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否是工作日'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>holiday_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'节假日'</span>

<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'时间维度表'</span>

STORED <span class="token keyword">AS</span> PARQUET

LOCATION <span class="token string">'/warehouse/gmall/dim/dim_date_info/'</span>

TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><em><strong>*2.数据装载*</strong></em></p>
<p>通常情况下，时间维度表的数据并不是来自于业务系统，而是手动写入，并且由于时间维度表数据的可预见性，无须每日导入，一般可一次性导入一年的数据。</p>
<p>1）创建临时表</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> tmp_dim_date_info<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> tmp_dim_date_info <span class="token punctuation">(</span>

  <span class="token punctuation">`</span>date_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'日'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>week_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'周ID'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>week_day<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'周几'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>day<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'每月的第几天'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>month<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'第几月'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>quarter<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'第几季度'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>year<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'年'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>is_workday<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否是工作日'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>holiday_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'节假日'</span>

<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'时间维度表'</span>

<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>

LOCATION <span class="token string">'/warehouse/gmall/tmp/tmp_dim_date_info/'</span><span class="token punctuation">;</span>
</code></pre>
<p>2）将数据文件上传到HFDS上临时表指定路径/warehouse/gmall/tmp/tmp_dim_date_info/</p>
<p>3）执行以下语句将其导入时间维度表</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_date_info <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tmp_dim_date_info<span class="token punctuation">;</span>
</code></pre>
<p>4）检查数据是否导入成功</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dim_date_info<span class="token punctuation">;</span>
</code></pre>
<h2 id="5-6-用户维度表（拉链表）"><a href="#5-6-用户维度表（拉链表）" class="headerlink" title="5.6 用户维度表（拉链表）"></a>5.6 用户维度表（拉链表）</h2><h3 id="5-6-1-拉链表概述"><a href="#5-6-1-拉链表概述" class="headerlink" title="5.6.1 拉链表概述"></a>5.6.1 拉链表概述</h3><p><em><strong>*1）什么是拉链表*</strong></em></p>
<img src="/2022/02/07/10237/%E4%BB%80%E4%B9%88%E6%98%AF%E6%8B%89%E9%93%BE%E8%A1%A8.png" class title="This is an example image">

<p><em><strong>*2）为什么要做拉链表*</strong></em></p>
<img src="/2022/02/07/10237/%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%81%9A%E6%8B%89%E9%93%BE%E8%A1%A8.png" class title="This is an example image">

<p><em><strong>*3）如何使用拉链表*</strong></em></p>
<img src="/2022/02/07/10237/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E6%8B%89%E9%93%BE%E8%A1%A8.png" class title="This is an example image">

<p><em><strong>*4*</strong></em><em><strong>*）拉链表形成过程*</strong></em></p>
<img src="/2022/02/07/10237/%E6%8B%89%E9%93%BE%E8%A1%A8%E5%BD%A2%E6%88%90%E8%BF%87%E7%A8%8B.png" class title="This is an example image">

<h3 id="5-6-2-制作拉链表"><a href="#5-6-2-制作拉链表" class="headerlink" title="5.6.2 制作拉链表"></a>5.6.2 制作拉链表</h3><p><em><strong>*1.建表语句*</strong></em></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_user_info<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_user_info<span class="token punctuation">(</span>

  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>login_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户名称'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>nick_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户昵称'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户姓名'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>phone_num<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机号码'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>email<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'邮箱'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>user_level<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户等级'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>birthday<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'生日'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>gender<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'性别'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作时间'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>start_date<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'开始日期'</span><span class="token punctuation">,</span>

  <span class="token punctuation">`</span>end_date<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'结束日期'</span>

<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户表'</span>

PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>

STORED <span class="token keyword">AS</span> PARQUET

LOCATION <span class="token string">'/warehouse/gmall/dim/dim_user_info/'</span>

TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><em><strong>*2*</strong></em><em><strong>*.*</strong></em><em><strong>*分区规划*</strong></em></p>
<img src="/2022/02/07/10237/%E7%94%A8%E6%88%B7%E6%8B%89%E9%93%BE%E8%A1%A8%E5%88%86%E5%8C%BA.png" class title="This is an example image">

<p><em><strong>*3.*</strong></em><em><strong>*数据装载*</strong></em></p>
<img src="/2022/02/07/10237/%E7%94%A8%E6%88%B7%E7%BB%B4%E5%BA%A6%E8%A1%A8%E8%A3%85%E8%BD%BD.png" class title="This is an example image">

<p><em><strong>*1）首日装载*</strong></em></p>
<p>拉链表首日装载，需要进行初始化操作，具体工作为将截止到初始化当日的全部历史用户导入一次性导入到拉链表中。目前的ods_user_info表的第一个分区，即2020-06-14分区中就是全部的历史用户，故将该分区数据进行一定处理后导入拉链表的9999-99-99分区即可。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_user_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span>

<span class="token keyword">select</span>

  id<span class="token punctuation">,</span>

  login_name<span class="token punctuation">,</span>

  nick_name<span class="token punctuation">,</span>

  md5<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>

  md5<span class="token punctuation">(</span>phone_num<span class="token punctuation">)</span><span class="token punctuation">,</span>

  md5<span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">,</span>

  user_level<span class="token punctuation">,</span>

  birthday<span class="token punctuation">,</span>

  gender<span class="token punctuation">,</span>

  create_time<span class="token punctuation">,</span>

  operate_time<span class="token punctuation">,</span>

  <span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>

  <span class="token string">'9999-99-99'</span>

<span class="token keyword">from</span> ods_user_info

<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">;</span>
</code></pre>
<p><em><strong>*2）每日装载*</strong></em></p>
<p><em><strong>*（1）实现思路*</strong></em></p>
<img src="/2022/02/07/10237/%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF.png" class title="This is an example image">

<p><em><strong>*（2）sql编写*</strong></em></p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span>

tmp <span class="token keyword">as</span>

<span class="token punctuation">(</span>

  <span class="token keyword">select</span>

​    old<span class="token punctuation">.</span>id old_id<span class="token punctuation">,</span>

​    old<span class="token punctuation">.</span>login_name old_login_name<span class="token punctuation">,</span>

​    old<span class="token punctuation">.</span>nick_name old_nick_name<span class="token punctuation">,</span>

​    old<span class="token punctuation">.</span>name old_name<span class="token punctuation">,</span>

​    old<span class="token punctuation">.</span>phone_num old_phone_num<span class="token punctuation">,</span>

​    old<span class="token punctuation">.</span>email old_email<span class="token punctuation">,</span>

​    old<span class="token punctuation">.</span>user_level old_user_level<span class="token punctuation">,</span>

​    old<span class="token punctuation">.</span>birthday old_birthday<span class="token punctuation">,</span>

​    old<span class="token punctuation">.</span>gender old_gender<span class="token punctuation">,</span>

​    old<span class="token punctuation">.</span>create_time old_create_time<span class="token punctuation">,</span>

​    old<span class="token punctuation">.</span>operate_time old_operate_time<span class="token punctuation">,</span>

​    old<span class="token punctuation">.</span>start_date old_start_date<span class="token punctuation">,</span>

​    old<span class="token punctuation">.</span>end_date old_end_date<span class="token punctuation">,</span>

​    new<span class="token punctuation">.</span>id new_id<span class="token punctuation">,</span>

​    new<span class="token punctuation">.</span>login_name new_login_name<span class="token punctuation">,</span>

​    new<span class="token punctuation">.</span>nick_name new_nick_name<span class="token punctuation">,</span>

​    new<span class="token punctuation">.</span>name new_name<span class="token punctuation">,</span>

​    new<span class="token punctuation">.</span>phone_num new_phone_num<span class="token punctuation">,</span>

​    new<span class="token punctuation">.</span>email new_email<span class="token punctuation">,</span>

​    new<span class="token punctuation">.</span>user_level new_user_level<span class="token punctuation">,</span>

​    new<span class="token punctuation">.</span>birthday new_birthday<span class="token punctuation">,</span>

​    new<span class="token punctuation">.</span>gender new_gender<span class="token punctuation">,</span>

​    new<span class="token punctuation">.</span>create_time new_create_time<span class="token punctuation">,</span>

​    new<span class="token punctuation">.</span>operate_time new_operate_time<span class="token punctuation">,</span>

​    new<span class="token punctuation">.</span>start_date new_start_date<span class="token punctuation">,</span>

​    new<span class="token punctuation">.</span>end_date new_end_date

  <span class="token keyword">from</span>

  <span class="token punctuation">(</span>

​    <span class="token keyword">select</span>

​      id<span class="token punctuation">,</span>

​      login_name<span class="token punctuation">,</span>

​      nick_name<span class="token punctuation">,</span>

​      name<span class="token punctuation">,</span>

​      phone_num<span class="token punctuation">,</span>

​      email<span class="token punctuation">,</span>

​      user_level<span class="token punctuation">,</span>

​      birthday<span class="token punctuation">,</span>

​      gender<span class="token punctuation">,</span>

​      create_time<span class="token punctuation">,</span>

​      operate_time<span class="token punctuation">,</span>

​      start_date<span class="token punctuation">,</span>

​      end_date

​    <span class="token keyword">from</span> dim_user_info

​    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span>

  <span class="token punctuation">)</span>old

  <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>

  <span class="token punctuation">(</span>

​    <span class="token keyword">select</span>

​      id<span class="token punctuation">,</span>

​      login_name<span class="token punctuation">,</span>

​      nick_name<span class="token punctuation">,</span>

​      md5<span class="token punctuation">(</span>name<span class="token punctuation">)</span> name<span class="token punctuation">,</span>

​      md5<span class="token punctuation">(</span>phone_num<span class="token punctuation">)</span> phone_num<span class="token punctuation">,</span>

​      md5<span class="token punctuation">(</span>email<span class="token punctuation">)</span> email<span class="token punctuation">,</span>

​      user_level<span class="token punctuation">,</span>

​      birthday<span class="token punctuation">,</span>

​      gender<span class="token punctuation">,</span>

​      create_time<span class="token punctuation">,</span>

​      operate_time<span class="token punctuation">,</span>

​      <span class="token string">'2020-06-15'</span> start_date<span class="token punctuation">,</span>

​      <span class="token string">'9999-99-99'</span> end_date

​    <span class="token keyword">from</span> ods_user_info

​    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>

  <span class="token punctuation">)</span>new

  <span class="token keyword">on</span> old<span class="token punctuation">.</span>id<span class="token operator">=</span>new<span class="token punctuation">.</span>id

<span class="token punctuation">)</span>

<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_user_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>

<span class="token keyword">select</span>

  nvl<span class="token punctuation">(</span>new_id<span class="token punctuation">,</span>old_id<span class="token punctuation">)</span><span class="token punctuation">,</span>

  nvl<span class="token punctuation">(</span>new_login_name<span class="token punctuation">,</span>old_login_name<span class="token punctuation">)</span><span class="token punctuation">,</span>

  nvl<span class="token punctuation">(</span>new_nick_name<span class="token punctuation">,</span>old_nick_name<span class="token punctuation">)</span><span class="token punctuation">,</span>

  nvl<span class="token punctuation">(</span>new_name<span class="token punctuation">,</span>old_name<span class="token punctuation">)</span><span class="token punctuation">,</span>

  nvl<span class="token punctuation">(</span>new_phone_num<span class="token punctuation">,</span>old_phone_num<span class="token punctuation">)</span><span class="token punctuation">,</span>

  nvl<span class="token punctuation">(</span>new_email<span class="token punctuation">,</span>old_email<span class="token punctuation">)</span><span class="token punctuation">,</span>

  nvl<span class="token punctuation">(</span>new_user_level<span class="token punctuation">,</span>old_user_level<span class="token punctuation">)</span><span class="token punctuation">,</span>

  nvl<span class="token punctuation">(</span>new_birthday<span class="token punctuation">,</span>old_birthday<span class="token punctuation">)</span><span class="token punctuation">,</span>

  nvl<span class="token punctuation">(</span>new_gender<span class="token punctuation">,</span>old_gender<span class="token punctuation">)</span><span class="token punctuation">,</span>

  nvl<span class="token punctuation">(</span>new_create_time<span class="token punctuation">,</span>old_create_time<span class="token punctuation">)</span><span class="token punctuation">,</span>

  nvl<span class="token punctuation">(</span>new_operate_time<span class="token punctuation">,</span>old_operate_time<span class="token punctuation">)</span><span class="token punctuation">,</span>

  nvl<span class="token punctuation">(</span>new_start_date<span class="token punctuation">,</span>old_start_date<span class="token punctuation">)</span><span class="token punctuation">,</span>

  nvl<span class="token punctuation">(</span>new_end_date<span class="token punctuation">,</span>old_end_date<span class="token punctuation">)</span><span class="token punctuation">,</span>

  nvl<span class="token punctuation">(</span>new_end_date<span class="token punctuation">,</span>old_end_date<span class="token punctuation">)</span> dt

<span class="token keyword">from</span> tmp

<span class="token keyword">union</span> <span class="token keyword">all</span>

<span class="token keyword">select</span>

  old_id<span class="token punctuation">,</span>

  old_login_name<span class="token punctuation">,</span>

  old_nick_name<span class="token punctuation">,</span>

  old_name<span class="token punctuation">,</span>

  old_phone_num<span class="token punctuation">,</span>

  old_email<span class="token punctuation">,</span>

  old_user_level<span class="token punctuation">,</span>

  old_birthday<span class="token punctuation">,</span>

  old_gender<span class="token punctuation">,</span>

  old_create_time<span class="token punctuation">,</span>

  old_operate_time<span class="token punctuation">,</span>

  old_start_date<span class="token punctuation">,</span>

  cast<span class="token punctuation">(</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> string<span class="token punctuation">)</span><span class="token punctuation">,</span>

  cast<span class="token punctuation">(</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> string<span class="token punctuation">)</span> dt

<span class="token keyword">from</span> tmp

<span class="token keyword">where</span> new_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token operator">and</span> old_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="5-7-DIM层首日数据装载脚本"><a href="#5-7-DIM层首日数据装载脚本" class="headerlink" title="5.7 DIM层首日数据装载脚本"></a>5.7 DIM层首日数据装载脚本</h2><p><em><strong>*1）编写脚本*</strong></em></p>
<p>（1）在/home/atguigu/bin目录下创建脚本ods_to_dim_db_init.sh</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim ods_to_dim_db_init.sh
</code></pre>
<p>在脚本中填写如下内容</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash

 

APP=gmall

 

if [ -n "$2" ] ;then

  do_date=$2

else 

  echo "请传入日期参数"

  exit

fi 

 

dim_user_info="

set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;

insert overwrite table ${APP}.dim_user_info partition(dt='9999-99-99')

select

  id,

  login_name,

  nick_name,

  md5(name),

  md5(phone_num),

  md5(email),

  user_level,

  birthday,

  gender,

  create_time,

  operate_time,

  '$do_date',

  '9999-99-99'

from ${APP}.ods_user_info

where dt='$do_date';

"

 

dim_sku_info="

set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;

with

sku as

(

  select

​    id,

​    price,

​    sku_name,

​    sku_desc,

​    weight,

​    is_sale,

​    spu_id,

​    category3_id,

​    tm_id,

​    create_time

  from ${APP}.ods_sku_info

  where dt='$do_date'

),

spu as

(

  select

​    id,

​    spu_name

  from ${APP}.ods_spu_info

  where dt='$do_date'

),

c3 as

(

  select

​    id,

​    name,

​    category2_id

  from ${APP}.ods_base_category3

  where dt='$do_date'

),

c2 as

(

  select

​    id,

​    name,

​    category1_id

  from ${APP}.ods_base_category2

  where dt='$do_date'

),

c1 as

(

  select

​    id,

​    name

  from ${APP}.ods_base_category1

  where dt='$do_date'

),

tm as

(

  select

​    id,

​    tm_name

  from ${APP}.ods_base_trademark

  where dt='$do_date'

),

attr as

(

  select

​    sku_id,

​    collect_set(named_struct('attr_id',attr_id,'value_id',value_id,'attr_name',attr_name,'value_name',value_name)) attrs

  from ${APP}.ods_sku_attr_value

  where dt='$do_date'

  group by sku_id

),

sale_attr as

(

  select

​    sku_id,

​    collect_set(named_struct('sale_attr_id',sale_attr_id,'sale_attr_value_id',sale_attr_value_id,'sale_attr_name',sale_attr_name,'sale_attr_value_name',sale_attr_value_name)) sale_attrs

  from ${APP}.ods_sku_sale_attr_value

  where dt='$do_date'

  group by sku_id

)

 

insert overwrite table ${APP}.dim_sku_info partition(dt='$do_date')

select

  sku.id,

  sku.price,

  sku.sku_name,

  sku.sku_desc,

  sku.weight,

  sku.is_sale,

  sku.spu_id,

  spu.spu_name,

  sku.category3_id,

  c3.name,

  c3.category2_id,

  c2.name,

  c2.category1_id,

  c1.name,

  sku.tm_id,

  tm.tm_name,

  attr.attrs,

  sale_attr.sale_attrs,

  sku.create_time

from sku

left join spu on sku.spu_id=spu.id

left join c3 on sku.category3_id=c3.id

left join c2 on c3.category2_id=c2.id

left join c1 on c2.category1_id=c1.id

left join tm on sku.tm_id=tm.id

left join attr on sku.id=attr.sku_id

left join sale_attr on sku.id=sale_attr.sku_id;

"

 

dim_base_province="

set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;

insert overwrite table ${APP}.dim_base_province

select

  bp.id,

  bp.name,

  bp.area_code,

  bp.iso_code,

  bp.iso_3166_2,

  bp.region_id,

  br.region_name

from ${APP}.ods_base_province bp

join ${APP}.ods_base_region br on bp.region_id = br.id;

"

 

dim_coupon_info="

set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;

insert overwrite table ${APP}.dim_coupon_info partition(dt='$do_date')

select

  id,

  coupon_name,

  coupon_type,

  condition_amount,

  condition_num,

  activity_id,

  benefit_amount,

  benefit_discount,

  create_time,

  range_type,

  limit_num,

  taken_count,

  start_time,

  end_time,

  operate_time,

  expire_time

from ${APP}.ods_coupon_info

where dt='$do_date';

"

 

dim_activity_rule_info="

set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;

insert overwrite table ${APP}.dim_activity_rule_info partition(dt='$do_date')

select

  ar.id,

  ar.activity_id,

  ai.activity_name,

  ar.activity_type,

  ai.start_time,

  ai.end_time,

  ai.create_time,

  ar.condition_amount,

  ar.condition_num,

  ar.benefit_amount,

  ar.benefit_discount,

  ar.benefit_level

from

(

  select

​    id,

​    activity_id,

​    activity_type,

​    condition_amount,

​    condition_num,

​    benefit_amount,

​    benefit_discount,

​    benefit_level

  from ${APP}.ods_activity_rule

  where dt='$do_date'

)ar

left join

(

  select

​    id,

​    activity_name,

​    start_time,

​    end_time,

​    create_time

  from ${APP}.ods_activity_info

  where dt='$do_date'

)ai

on ar.activity_id=ai.id;

"

 

case $1 in

"dim_user_info"){

  hive -e "$dim_user_info"

};;

"dim_sku_info"){

  hive -e "$dim_sku_info"

};;

"dim_base_province"){

  hive -e "$dim_base_province"

};;

"dim_coupon_info"){

  hive -e "$dim_coupon_info"

};;

"dim_activity_rule_info"){

  hive -e "$dim_activity_rule_info"

};;

"all"){

  hive -e "$dim_user_info$dim_sku_info$dim_coupon_info$dim_activity_rule_info$dim_base_province"

};;

esac
</code></pre>
<p>（2）增加执行权限</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod +x ods_to_dim_db_init.sh
</code></pre>
<p><em><strong>*2）脚本使用*</strong></em></p>
<p>（1）执行脚本</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ ods_to_dim_db_init.sh all 2020-06-14
</code></pre>
<p><em><strong>*注意：该脚本不包含时间维度表的装载，时间维度表需手动装载数据，参考5*</strong></em><em><strong>*.5*</strong></em><em><strong>*节。*</strong></em></p>
<p>（2）查看数据是否导入成功</p>
<h2 id="5-8-DIM层每日数据装载脚本"><a href="#5-8-DIM层每日数据装载脚本" class="headerlink" title="5.8 DIM层每日数据装载脚本"></a>5.8 DIM层每日数据装载脚本</h2><p><em><strong>*1）编写脚本*</strong></em></p>
<p>（1）在/home/atguigu/bin目录下创建脚本ods_to_dim_db.sh</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim ods_to_dim_db.sh
</code></pre>
<p>在脚本中填写如下内容</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash 

APP=gmall

\# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天

if [ -n "$2" ] ;then

  do_date=$2

else 

  do_date=`date -d "-1 day" +%F`

fi

 

dim_user_info="

set hive.exec.dynamic.partition.mode=nonstrict;

set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;

with

tmp as

(

  select

​    old.id old_id,

​    old.login_name old_login_name,

​    old.nick_name old_nick_name,

​    old.name old_name,

​    old.phone_num old_phone_num,

​    old.email old_email,

​    old.user_level old_user_level,

​    old.birthday old_birthday,

​    old.gender old_gender,

​    old.create_time old_create_time,

​    old.operate_time old_operate_time,

​    old.start_date old_start_date,

​    old.end_date old_end_date,

​    new.id new_id,

​    new.login_name new_login_name,

​    new.nick_name new_nick_name,

​    new.name new_name,

​    new.phone_num new_phone_num,

​    new.email new_email,

​    new.user_level new_user_level,

​    new.birthday new_birthday,

​    new.gender new_gender,

​    new.create_time new_create_time,

​    new.operate_time new_operate_time,

​    new.start_date new_start_date,

​    new.end_date new_end_date

  from

  (

​    select

​      id,

​      login_name,

​      nick_name,

​      name,

​      phone_num,

​      email,

​      user_level,

​      birthday,

​      gender,

​      create_time,

​      operate_time,

​      start_date,

​      end_date

​    from ${APP}.dim_user_info

​    where dt='9999-99-99'

​    and start_date<'$do_date'

  )old

  full outer join

  (

​    select

​      id,

​      login_name,

​      nick_name,

​      md5(name) name,

​      md5(phone_num) phone_num,

​      md5(email) email,

​      user_level,

​      birthday,

​      gender,

​      create_time,

​      operate_time,

​      '$do_date' start_date,

​      '9999-99-99' end_date

​    from ${APP}.ods_user_info

​    where dt='$do_date'

  )new

  on old.id=new.id

)

insert overwrite table ${APP}.dim_user_info partition(dt)

select

  nvl(new_id,old_id),

  nvl(new_login_name,old_login_name),

  nvl(new_nick_name,old_nick_name),

  nvl(new_name,old_name),

  nvl(new_phone_num,old_phone_num),

  nvl(new_email,old_email),

  nvl(new_user_level,old_user_level),

  nvl(new_birthday,old_birthday),

  nvl(new_gender,old_gender),

  nvl(new_create_time,old_create_time),

  nvl(new_operate_time,old_operate_time),

  nvl(new_start_date,old_start_date),

  nvl(new_end_date,old_end_date),

  nvl(new_end_date,old_end_date) dt

from tmp

union all

select

  old_id,

  old_login_name,

  old_nick_name,

  old_name,

  old_phone_num,

  old_email,

  old_user_level,

  old_birthday,

  old_gender,

  old_create_time,

  old_operate_time,

  old_start_date,

  cast(date_add('$do_date',-1) as string),

  cast(date_add('$do_date',-1) as string) dt

from tmp

where new_id is not null and old_id is not null;

"

 

dim_sku_info="

set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;

with

sku as

(

  select

​    id,

​    price,

​    sku_name,

​    sku_desc,

​    weight,

​    is_sale,

​    spu_id,

​    category3_id,

​    tm_id,

​    create_time

  from ${APP}.ods_sku_info

  where dt='$do_date'

),

spu as

(

  select

​    id,

​    spu_name

  from ${APP}.ods_spu_info

  where dt='$do_date'

),

c3 as

(

  select

​    id,

​    name,

​    category2_id

  from ${APP}.ods_base_category3

  where dt='$do_date'

),

c2 as

(

  select

​    id,

​    name,

​    category1_id

  from ${APP}.ods_base_category2

  where dt='$do_date'

),

c1 as

(

  select

​    id,

​    name

  from ${APP}.ods_base_category1

  where dt='$do_date'

),

tm as

(

  select

​    id,

​    tm_name

  from ${APP}.ods_base_trademark

  where dt='$do_date'

),

attr as

(

  select

​    sku_id,

​    collect_set(named_struct('attr_id',attr_id,'value_id',value_id,'attr_name',attr_name,'value_name',value_name)) attrs

  from ${APP}.ods_sku_attr_value

  where dt='$do_date'

  group by sku_id

),

sale_attr as

(

  select

​    sku_id,

​    collect_set(named_struct('sale_attr_id',sale_attr_id,'sale_attr_value_id',sale_attr_value_id,'sale_attr_name',sale_attr_name,'sale_attr_value_name',sale_attr_value_name)) sale_attrs

  from ${APP}.ods_sku_sale_attr_value

  where dt='$do_date'

  group by sku_id

)

 

insert overwrite table ${APP}.dim_sku_info partition(dt='$do_date')

select

  sku.id,

  sku.price,

  sku.sku_name,

  sku.sku_desc,

  sku.weight,

  sku.is_sale,

  sku.spu_id,

  spu.spu_name,

  sku.category3_id,

  c3.name,

  c3.category2_id,

  c2.name,

  c2.category1_id,

  c1.name,

  sku.tm_id,

  tm.tm_name,

  attr.attrs,

  sale_attr.sale_attrs,

  sku.create_time

from sku

left join spu on sku.spu_id=spu.id

left join c3 on sku.category3_id=c3.id

left join c2 on c3.category2_id=c2.id

left join c1 on c2.category1_id=c1.id

left join tm on sku.tm_id=tm.id

left join attr on sku.id=attr.sku_id

left join sale_attr on sku.id=sale_attr.sku_id;

"

 

dim_base_province="

set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;

insert overwrite table ${APP}.dim_base_province

select

  bp.id,

  bp.name,

  bp.area_code,

  bp.iso_code,

  bp.iso_3166_2,

  bp.region_id,

  bp.name

from ${APP}.ods_base_province bp

join ${APP}.ods_base_region br on bp.region_id = br.id;

"

 

dim_coupon_info="

set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;

insert overwrite table ${APP}.dim_coupon_info partition(dt='$do_date')

select

  id,

  coupon_name,

  coupon_type,

  condition_amount,

  condition_num,

  activity_id,

  benefit_amount,

  benefit_discount,

  create_time,

  range_type,

  limit_num,

  taken_count,

  start_time,

  end_time,

  operate_time,

  expire_time

from ${APP}.ods_coupon_info

where dt='$do_date';

"

 

dim_activity_rule_info="

set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;

insert overwrite table ${APP}.dim_activity_rule_info partition(dt='$do_date')

select

  ar.id,

  ar.activity_id,

  ai.activity_name,

  ar.activity_type,

  ai.start_time,

  ai.end_time,

  ai.create_time,

  ar.condition_amount,

  ar.condition_num,

  ar.benefit_amount,

  ar.benefit_discount,

  ar.benefit_level

from

(

  select

​    id,

​    activity_id,

​    activity_type,

​    condition_amount,

​    condition_num,

​    benefit_amount,

​    benefit_discount,

​    benefit_level

  from ${APP}.ods_activity_rule

  where dt='$do_date'

)ar

left join

(

  select

​    id,

​    activity_name,

​    start_time,

​    end_time,

​    create_time

  from ${APP}.ods_activity_info

  where dt='$do_date'

)ai

on ar.activity_id=ai.id;

"

 

case $1 in

"dim_user_info"){

  hive -e "$dim_user_info"

};;

"dim_sku_info"){

  hive -e "$dim_sku_info"

};;

"dim_base_province"){

  hive -e "$dim_base_province"

};;

"dim_coupon_info"){

  hive -e "$dim_coupon_info"

};;

"dim_activity_rule_info"){

  hive -e "$dim_activity_rule_info"

};;

"all"){

  hive -e "$dim_user_info$dim_sku_info$dim_coupon_info$dim_activity_rule_info"

};;

esac
</code></pre>
<p>（2）增加执行权限</p>
<pre class=" language-sh"><code class="language-sh">[atguigu@hadoop102 bin]$ chmod +x ods_to_dim_db.sh
</code></pre>
<p><em><strong>*2）脚本使用*</strong></em></p>
<p>（1）执行脚本</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ ods_to_dim_db.sh all 2020-06-14
</code></pre>
<p>（2）查看数据是否导入成功</p>
<h1 id="第6章-数仓搭建-DWD层"><a href="#第6章-数仓搭建-DWD层" class="headerlink" title="第6章 数仓搭建-DWD层"></a>第6章 数仓搭建-DWD层</h1><p>1）对用户行为数据解析。<br>2）对业务数据采用维度模型重新建模。</p>
<h2 id="6-1-DWD层（用户行为日志）"><a href="#6-1-DWD层（用户行为日志）" class="headerlink" title="6.1 DWD层（用户行为日志）"></a>6.1 DWD层（用户行为日志）</h2><h3 id="6-1-1-日志解析思路"><a href="#6-1-1-日志解析思路" class="headerlink" title="6.1.1 日志解析思路"></a>6.1.1 日志解析思路</h3><p>1）日志结构回顾<br>（1）页面埋点日志</p>
<img src="/2022/02/07/10237/%E9%A1%B5%E9%9D%A2%E5%9F%8B%E7%82%B9%E6%97%A5%E5%BF%97.png" class title="This is an example image">

<p>（2）启动日志</p>
<img src="/2022/02/07/10237/%E5%90%AF%E5%8A%A8%E6%97%A5%E5%BF%97.png" class title="This is an example image">

<p>2）日志解析思路</p>
<img src="/2022/02/07/10237/%E6%97%A5%E5%BF%97%E8%A7%A3%E6%9E%90%E6%80%9D%E8%B7%AF.png" class title="This is an example image">

<h3 id="6-1-2-get-json-object函数使用"><a href="#6-1-2-get-json-object函数使用" class="headerlink" title="6.1.2 get_json_object函数使用"></a>6.1.2 get_json_object函数使用</h3><p>1）数据<br>[{“name”:”大郎”,”sex”:”男”,”age”:”25”},{“name”:”西门庆”,”sex”:”男”,”age”:”47”}]<br>2）取出第一个json对象<br>hive (gmall)&gt;<br>select get_json_object(‘[{“name”:”大郎”,”sex”:”男”,”age”:”25”},{“name”:”西门庆”,”sex”:”男”,”age”:”47”}]’,’$[0]’);<br>结果是：{“name”:”大郎”,”sex”:”男”,”age”:”25”}<br>3）取出第一个json的age字段的值<br>hive (gmall)&gt;<br>SELECT get_json_object(‘[{“name”:”大郎”,”sex”:”男”,”age”:”25”},{“name”:”西门庆”,”sex”:”男”,”age”:”47”}]’,”$[0].age”);<br>结果是：25</p>
<h3 id="6-1-3-启动日志表"><a href="#6-1-3-启动日志表" class="headerlink" title="6.1.3 启动日志表"></a>6.1.3 启动日志表</h3><p>启动日志解析思路：启动日志表中每行数据对应一个启动记录，一个启动记录应该包含日志中的公共信息和启动信息。先将所有包含start字段的日志过滤出来，然后使用get_json_object函数解析每个字段。</p>
<img src="/2022/02/07/10237/%E5%90%AF%E5%8A%A8%E6%97%A5%E5%BF%97%E8%A7%A3%E6%9E%90%E6%80%9D%E8%B7%AF.png" class title="This is an example image">

<p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_start_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_start_log<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机品牌'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>channel<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'渠道'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>is_new<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否首次启动'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机型号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>os<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作系统'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'会员id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'app版本号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>entry<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'icon手机图标 notice 通知 install 安装后启动'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>loading_time<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'启动加载时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>open_ad_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'广告页ID '</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>open_ad_ms<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'广告总共播放时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>open_ad_skip_ms<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户跳过广告时点'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>ts<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'启动日志表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">-- 按照时间创建分区</span>
STORED <span class="token keyword">AS</span> PARQUET <span class="token comment" spellcheck="true">-- 采用parquet列式存储</span>
LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_start_log'</span> <span class="token comment" spellcheck="true">-- 指定在HDFS上存储位置</span>
TBLPROPERTIES<span class="token punctuation">(</span><span class="token string">'parquet.compression'</span><span class="token operator">=</span><span class="token string">'lzo'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">-- 采用LZO压缩</span>
<span class="token punctuation">;</span>
</code></pre>
<p>2）数据导入</p>
<img src="/2022/02/07/10237/DWD%E6%97%A5%E5%BF%97%E6%95%B0%E6%8D%AE%E8%A3%85%E8%BD%BD.png" class title="This is an example image">

<pre class=" language-shell"><code class="language-shell">hive (gmall)> 
insert overwrite table dwd_start_log partition(dt='2020-06-14')
select
    get_json_object(line,'$.common.ar'),
    get_json_object(line,'$.common.ba'),
    get_json_object(line,'$.common.ch'),
    get_json_object(line,'$.common.is_new'),
    get_json_object(line,'$.common.md'),
    get_json_object(line,'$.common.mid'),
    get_json_object(line,'$.common.os'),
    get_json_object(line,'$.common.uid'),
    get_json_object(line,'$.common.vc'),
    get_json_object(line,'$.start.entry'),
    get_json_object(line,'$.start.loading_time'),
    get_json_object(line,'$.start.open_ad_id'),
    get_json_object(line,'$.start.open_ad_ms'),
    get_json_object(line,'$.start.open_ad_skip_ms'),
    get_json_object(line,'$.ts')
from ods_log
where dt='2020-06-14'
and get_json_object(line,'$.start') is not null;
</code></pre>
<p>3）查看数据</p>
<pre class=" language-shell"><code class="language-shell">hive (gmall)> 
select * from dwd_start_log where dt='2020-06-14' limit 2;
</code></pre>
<h3 id="6-1-4-页面日志表"><a href="#6-1-4-页面日志表" class="headerlink" title="6.1.4 页面日志表"></a>6.1.4 页面日志表</h3><p>页面日志解析思路：页面日志表中每行数据对应一个页面访问记录，一个页面访问记录应该包含日志中的公共信息和页面信息。先将所有包含page字段的日志过滤出来，然后使用get_json_object函数解析每个字段。</p>
<img src="/2022/02/07/10237/%E9%A1%B5%E9%9D%A2%E6%97%A5%E5%BF%97%E8%A1%A8%E8%A7%A3%E6%9E%90%E6%80%9D%E8%B7%AF.png" class title="This is an example image">

<p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_page_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_page_log<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机品牌'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>channel<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'渠道'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>is_new<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否首次启动'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机型号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>os<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作系统'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'会员id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'app版本号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>during_time<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'持续时间毫秒'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>page_item<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标id '</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>page_item_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>last_page_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'上页类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>page_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'页面ID '</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>source_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>ts<span class="token punctuation">`</span> <span class="token keyword">bigint</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'页面日志表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_page_log'</span>
TBLPROPERTIES<span class="token punctuation">(</span><span class="token string">'parquet.compression'</span><span class="token operator">=</span><span class="token string">'lzo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）数据导入</p>
<pre class=" language-shell"><code class="language-shell">hive (gmall)>
insert overwrite table dwd_page_log partition(dt='2020-06-14')
select
    get_json_object(line,'$.common.ar'),
    get_json_object(line,'$.common.ba'),
    get_json_object(line,'$.common.ch'),
    get_json_object(line,'$.common.is_new'),
    get_json_object(line,'$.common.md'),
    get_json_object(line,'$.common.mid'),
    get_json_object(line,'$.common.os'),
    get_json_object(line,'$.common.uid'),
    get_json_object(line,'$.common.vc'),
    get_json_object(line,'$.page.during_time'),
    get_json_object(line,'$.page.item'),
    get_json_object(line,'$.page.item_type'),
    get_json_object(line,'$.page.last_page_id'),
    get_json_object(line,'$.page.page_id'),
    get_json_object(line,'$.page.source_type'),
    get_json_object(line,'$.ts')
from ods_log
where dt='2020-06-14'
and get_json_object(line,'$.page') is not null;
</code></pre>
<p>3）查看数据</p>
<pre class=" language-shell"><code class="language-shell">hive (gmall)> 
select * from dwd_page_log where dt='2020-06-14' limit 2;
</code></pre>
<h3 id="6-1-5-动作日志表"><a href="#6-1-5-动作日志表" class="headerlink" title="6.1.5 动作日志表"></a>6.1.5 动作日志表</h3><p>动作日志解析思路：动作日志表中每行数据对应用户的一个动作记录，一个动作记录应当包含公共信息、页面信息以及动作信息。先将包含action字段的日志过滤出来，然后通过UDTF函数，将action数组“炸开”（类似于explode函数的效果），然后使用get_json_object函数解析每个字段。</p>
<img src="/2022/02/07/10237/%E5%8A%A8%E4%BD%9C%E6%97%A5%E5%BF%97%E8%A7%A3%E6%9E%90%E6%80%9D%E8%B7%AF.png" class title="This is an example image">

<p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_action_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_action_log<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机品牌'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>channel<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'渠道'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>is_new<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否首次启动'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机型号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>os<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作系统'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'会员id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'app版本号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>during_time<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'持续时间毫秒'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>page_item<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标id '</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>page_item_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>last_page_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'上页类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>page_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'页面id '</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>source_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>action_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'动作id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>item<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标id '</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>item_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>ts<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'动作日志表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_action_log'</span>
TBLPROPERTIES<span class="token punctuation">(</span><span class="token string">'parquet.compression'</span><span class="token operator">=</span><span class="token string">'lzo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）创建UDTF函数——设计思路</p>
<img src="/2022/02/07/10237/%E5%88%9B%E5%BB%BAUDTF%E5%87%BD%E6%95%B0.png" class title="This is an example image">

<img src="/2022/02/07/10237/%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF.png" class title="This is an example image">

<p>3）创建UDTF函数——编写代码<br>（1）创建一个maven工程：hivefunction<br>（2）创建包名：com.atguigu.hive.udtf<br>（3）引入如下依赖</p>
<pre class=" language-properties"><code class="language-properties">&lt;dependencies>
    &lt;!--添加hive依赖-->
    &lt;dependency>
        &lt;groupId>org.apache.hive&lt;/groupId>
        &lt;artifactId>hive-exec&lt;/artifactId>
        &lt;version>3.1.2&lt;/version>
    &lt;/dependency>
&lt;/dependencies>
</code></pre>
<p>（4）编码</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>udtf<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>ql<span class="token punctuation">.</span>exec<span class="token punctuation">.</span>UDFArgumentException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>ql<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>HiveException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>ql<span class="token punctuation">.</span>udf<span class="token punctuation">.</span>generic<span class="token punctuation">.</span>GenericUDTF<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>serde2<span class="token punctuation">.</span>objectinspector<span class="token punctuation">.</span>ObjectInspector<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>serde2<span class="token punctuation">.</span>objectinspector<span class="token punctuation">.</span>ObjectInspectorFactory<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>serde2<span class="token punctuation">.</span>objectinspector<span class="token punctuation">.</span>PrimitiveObjectInspector<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>serde2<span class="token punctuation">.</span>objectinspector<span class="token punctuation">.</span>StructObjectInspector<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hive<span class="token punctuation">.</span>serde2<span class="token punctuation">.</span>objectinspector<span class="token punctuation">.</span>primitive<span class="token punctuation">.</span>PrimitiveObjectInspectorFactory<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>json<span class="token punctuation">.</span>JSONArray<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExplodeJSONArray</span> <span class="token keyword">extends</span> <span class="token class-name">GenericUDTF</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> StructObjectInspector <span class="token function">initialize</span><span class="token punctuation">(</span>ObjectInspector<span class="token punctuation">[</span><span class="token punctuation">]</span> argOIs<span class="token punctuation">)</span> <span class="token keyword">throws</span> UDFArgumentException <span class="token punctuation">{</span>
    
        <span class="token comment" spellcheck="true">// 1 参数合法性检查</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argOIs<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UDFArgumentException</span><span class="token punctuation">(</span><span class="token string">"explode_json_array 只需要一个参数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token comment" spellcheck="true">// 2 第一个参数必须为string</span>
        <span class="token comment" spellcheck="true">//判断参数是否为基础数据类型</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argOIs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getCategory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> ObjectInspector<span class="token punctuation">.</span>Category<span class="token punctuation">.</span>PRIMITIVE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UDFArgumentException</span><span class="token punctuation">(</span><span class="token string">"explode_json_array 只接受基础类型参数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token comment" spellcheck="true">//将参数对象检查器强转为基础类型对象检查器</span>
        PrimitiveObjectInspector argumentOI <span class="token operator">=</span> <span class="token punctuation">(</span>PrimitiveObjectInspector<span class="token punctuation">)</span> argOIs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
        <span class="token comment" spellcheck="true">//判断参数是否为String类型</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argumentOI<span class="token punctuation">.</span><span class="token function">getPrimitiveCategory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> PrimitiveObjectInspector<span class="token punctuation">.</span>PrimitiveCategory<span class="token punctuation">.</span>STRING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UDFArgumentException</span><span class="token punctuation">(</span><span class="token string">"explode_json_array 只接受string类型的参数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token comment" spellcheck="true">// 3 定义返回值名称和类型</span>
        List<span class="token operator">&lt;</span>String<span class="token operator">></span> fieldNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span>ObjectInspector<span class="token operator">></span> fieldOIs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>ObjectInspector<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        fieldNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"items"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fieldOIs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>PrimitiveObjectInspectorFactory<span class="token punctuation">.</span>javaStringObjectInspector<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">return</span> ObjectInspectorFactory<span class="token punctuation">.</span><span class="token function">getStandardStructObjectInspector</span><span class="token punctuation">(</span>fieldNames<span class="token punctuation">,</span> fieldOIs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span> objects<span class="token punctuation">)</span> <span class="token keyword">throws</span> HiveException <span class="token punctuation">{</span>
    
        <span class="token comment" spellcheck="true">// 1 获取传入的数据</span>
        String jsonArray <span class="token operator">=</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment" spellcheck="true">// 2 将string转换为json数组</span>
        JSONArray actions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONArray</span><span class="token punctuation">(</span>jsonArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment" spellcheck="true">// 3 循环一次，取出数组中的一个json，并写出</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> actions<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> actions<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">forward</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> HiveException <span class="token punctuation">{</span>
    
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<p>4）创建函数<br>（1）打包<br>（2）将hivefunction-1.0-SNAPSHOT.jar上传到hadoop102的/opt/module，然后再将该jar包上传到HDFS的/user/hive/jars路径下</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 module]$ hadoop fs -mkdir -p /user/hive/jars
[atguigu@hadoop102 module]$ hadoop fs -put hivefunction-1.0-SNAPSHOT.jar /user/hive/jars
</code></pre>
<p>（3）创建永久函数与开发好的java class关联</p>
<pre class=" language-shell"><code class="language-shell">create function explode_json_array as 'com.atguigu.hive.udtf.ExplodeJSONArray' using jar 'hdfs://hadoop102:8020/user/hive/jars/hivefunction-1.0-SNAPSHOT.jar';
</code></pre>
<p>（4）注意：如果修改了自定义函数重新生成jar包怎么处理？只需要替换HDFS路径上的旧jar包，然后重启Hive客户端即可。<br>5）数据导入</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_action_log <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ar'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ba'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ch'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.is_new'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.md'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.mid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.os'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.uid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.vc'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.during_time'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.item'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.item_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.last_page_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.page_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.source_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span><span class="token keyword">action</span><span class="token punctuation">,</span><span class="token string">'$.action_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span><span class="token keyword">action</span><span class="token punctuation">,</span><span class="token string">'$.item'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span><span class="token keyword">action</span><span class="token punctuation">,</span><span class="token string">'$.item_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span><span class="token keyword">action</span><span class="token punctuation">,</span><span class="token string">'$.ts'</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> ods_log lateral <span class="token keyword">view</span> explode_json_array<span class="token punctuation">(</span>get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.actions'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> tmp <span class="token keyword">as</span> <span class="token keyword">action</span>
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token operator">and</span> get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.actions'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span>
</code></pre>
<p>3）查看数据</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_action_log <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span> <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="6-1-6-曝光日志表"><a href="#6-1-6-曝光日志表" class="headerlink" title="6.1.6 曝光日志表"></a>6.1.6 曝光日志表</h3><p>曝光日志解析思路：曝光日志表中每行数据对应一个曝光记录，一个曝光记录应当包含公共信息、页面信息以及曝光信息。先将包含display字段的日志过滤出来，然后通过UDTF函数，将display数组“炸开”（类似于explode函数的效果），然后使用get_json_object函数解析每个字段。</p>
<img src="/2022/02/07/10237/%E6%9B%9D%E5%85%89%E6%97%A5%E5%BF%97%E8%A7%A3%E6%9E%90%E6%80%9D%E8%B7%AF.png" class title="This is an example image">

<p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_display_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_display_log<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机品牌'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>channel<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'渠道'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>is_new<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否首次启动'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机型号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>os<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作系统'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'会员id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'app版本号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>during_time<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'app版本号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>page_item<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标id '</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>page_item_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>last_page_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'上页类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>page_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'页面ID '</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>source_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>ts<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'app版本号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>display_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'曝光类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>item<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'曝光对象id '</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>item_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'app版本号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span><span class="token keyword">order</span><span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'曝光顺序'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>pos_id<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'曝光位置'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'曝光日志表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_display_log'</span>
TBLPROPERTIES<span class="token punctuation">(</span><span class="token string">'parquet.compression'</span><span class="token operator">=</span><span class="token string">'lzo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre>
<p>2）数据导入</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_display_log <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ar'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ba'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ch'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.is_new'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.md'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.mid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.os'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.uid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.vc'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.during_time'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.item'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.item_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.last_page_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.page_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.source_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.ts'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>display<span class="token punctuation">,</span><span class="token string">'$.display_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>display<span class="token punctuation">,</span><span class="token string">'$.item'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>display<span class="token punctuation">,</span><span class="token string">'$.item_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>display<span class="token punctuation">,</span><span class="token string">'$.order'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>display<span class="token punctuation">,</span><span class="token string">'$.pos_id'</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> ods_log lateral <span class="token keyword">view</span> explode_json_array<span class="token punctuation">(</span>get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.displays'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> tmp <span class="token keyword">as</span> display
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token operator">and</span> get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.displays'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span>
</code></pre>
<p>3）查看数据</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_display_log <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span> <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="6-1-7-错误日志表"><a href="#6-1-7-错误日志表" class="headerlink" title="6.1.7 错误日志表"></a>6.1.7 错误日志表</h3><p>错误日志解析思路：错误日志表中每行数据对应一个错误记录，为方便定位错误，一个错误记录应当包含与之对应的公共信息、页面信息、曝光信息、动作信息、启动信息以及错误信息。先将包含err字段的日志过滤出来，然后使用get_json_object函数解析所有字段。</p>
<img src="/2022/02/07/10237/%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%E8%A7%A3%E6%9E%90%E6%80%9D%E8%B7%AF.png" class title="This is an example image">

<p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_error_log<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_error_log<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机品牌'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>channel<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'渠道'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>is_new<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否首次启动'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机型号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>os<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作系统'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'会员id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'app版本号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>page_item<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标id '</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>page_item_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'目标类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>last_page_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'上页类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>page_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'页面ID '</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>source_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>entry<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">' icon手机图标  notice 通知 install 安装后启动'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>loading_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'启动加载时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>open_ad_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'广告页ID '</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>open_ad_ms<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'广告总共播放时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>open_ad_skip_ms<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户跳过广告时点'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>actions<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'动作'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>displays<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'曝光'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>ts<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>error_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'错误码'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>msg<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'错误信息'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'错误日志表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_error_log'</span>
TBLPROPERTIES<span class="token punctuation">(</span><span class="token string">'parquet.compression'</span><span class="token operator">=</span><span class="token string">'lzo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>说明：此处为对动作数组和曝光数组做处理，如需分析错误与单个动作或曝光的关联，可先使用explode_json_array函数将数组“炸开”，再使用get_json_object函数获取具体字段。<br>4）数据导入</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_error_log <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ar'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ba'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.ch'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.is_new'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.md'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.mid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.os'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.uid'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.common.vc'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.item'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.item_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.last_page_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.page_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.page.source_type'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.start.entry'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.start.loading_time'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.start.open_ad_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.start.open_ad_ms'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.start.open_ad_skip_ms'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.actions'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.displays'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.ts'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.err.error_code'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.err.msg'</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> ods_log
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token operator">and</span> get_json_object<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">'$.err'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span>
</code></pre>
<p>5）查看数据</p>
<pre class=" language-sql"><code class="language-sql">hive <span class="token punctuation">(</span>gmall<span class="token punctuation">)</span><span class="token operator">></span> 
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dwd_error_log <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span> <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="6-1-8-DWD层用户行为数据加载脚本"><a href="#6-1-8-DWD层用户行为数据加载脚本" class="headerlink" title="6.1.8 DWD层用户行为数据加载脚本"></a>6.1.8 DWD层用户行为数据加载脚本</h3><p>1）编写脚本<br>（1）在hadoop102的/home/atguigu/bin目录下创建脚本</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim ods_to_dwd_log.sh
</code></pre>
<p>​    在脚本中编写如下内容</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash

APP=gmall

如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天

if [ -n "$2" ] ;then
    do_date=$2
else 
    do_date=`date -d "-1 day" +%F`
fi

dwd_start_log="
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_start_log partition(dt='$do_date')
select
    get_json_object(line,'$.common.ar'),
    get_json_object(line,'$.common.ba'),
    get_json_object(line,'$.common.ch'),
    get_json_object(line,'$.common.is_new'),
    get_json_object(line,'$.common.md'),
    get_json_object(line,'$.common.mid'),
    get_json_object(line,'$.common.os'),
    get_json_object(line,'$.common.uid'),
    get_json_object(line,'$.common.vc'),
    get_json_object(line,'$.start.entry'),
    get_json_object(line,'$.start.loading_time'),
    get_json_object(line,'$.start.open_ad_id'),
    get_json_object(line,'$.start.open_ad_ms'),
    get_json_object(line,'$.start.open_ad_skip_ms'),
    get_json_object(line,'$.ts')
from ${APP}.ods_log
where dt='$do_date'
and get_json_object(line,'$.start') is not null;"

dwd_page_log="
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_page_log partition(dt='$do_date')
select
    get_json_object(line,'$.common.ar'),
    get_json_object(line,'$.common.ba'),
    get_json_object(line,'$.common.ch'),
    get_json_object(line,'$.common.is_new'),
    get_json_object(line,'$.common.md'),
    get_json_object(line,'$.common.mid'),
    get_json_object(line,'$.common.os'),
    get_json_object(line,'$.common.uid'),
    get_json_object(line,'$.common.vc'),
    get_json_object(line,'$.page.during_time'),
    get_json_object(line,'$.page.item'),
    get_json_object(line,'$.page.item_type'),
    get_json_object(line,'$.page.last_page_id'),
    get_json_object(line,'$.page.page_id'),
    get_json_object(line,'$.page.source_type'),
    get_json_object(line,'$.ts')
from ${APP}.ods_log
where dt='$do_date'
and get_json_object(line,'$.page') is not null;"

dwd_action_log="
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_action_log partition(dt='$do_date')
select
    get_json_object(line,'$.common.ar'),
    get_json_object(line,'$.common.ba'),
    get_json_object(line,'$.common.ch'),
    get_json_object(line,'$.common.is_new'),
    get_json_object(line,'$.common.md'),
    get_json_object(line,'$.common.mid'),
    get_json_object(line,'$.common.os'),
    get_json_object(line,'$.common.uid'),
    get_json_object(line,'$.common.vc'),
    get_json_object(line,'$.page.during_time'),
    get_json_object(line,'$.page.item'),
    get_json_object(line,'$.page.item_type'),
    get_json_object(line,'$.page.last_page_id'),
    get_json_object(line,'$.page.page_id'),
    get_json_object(line,'$.page.source_type'),
    get_json_object(action,'$.action_id'),
    get_json_object(action,'$.item'),
    get_json_object(action,'$.item_type'),
    get_json_object(action,'$.ts')
from ${APP}.ods_log lateral view ${APP}.explode_json_array(get_json_object(line,'$.actions')) tmp as action
where dt='$do_date'
and get_json_object(line,'$.actions') is not null;"


dwd_display_log="
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_display_log partition(dt='$do_date')
select
    get_json_object(line,'$.common.ar'),
    get_json_object(line,'$.common.ba'),
    get_json_object(line,'$.common.ch'),
    get_json_object(line,'$.common.is_new'),
    get_json_object(line,'$.common.md'),
    get_json_object(line,'$.common.mid'),
    get_json_object(line,'$.common.os'),
    get_json_object(line,'$.common.uid'),
    get_json_object(line,'$.common.vc'),
    get_json_object(line,'$.page.during_time'),
    get_json_object(line,'$.page.item'),
    get_json_object(line,'$.page.item_type'),
    get_json_object(line,'$.page.last_page_id'),
    get_json_object(line,'$.page.page_id'),
    get_json_object(line,'$.page.source_type'),
    get_json_object(line,'$.ts'),
    get_json_object(display,'$.display_type'),
    get_json_object(display,'$.item'),
    get_json_object(display,'$.item_type'),
    get_json_object(display,'$.order'),
    get_json_object(display,'$.pos_id')
from ${APP}.ods_log lateral view ${APP}.explode_json_array(get_json_object(line,'$.displays')) tmp as display
where dt='$do_date'
and get_json_object(line,'$.displays') is not null;"


dwd_error_log="
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_error_log partition(dt='$do_date')
select
    get_json_object(line,'$.common.ar'),
    get_json_object(line,'$.common.ba'),
    get_json_object(line,'$.common.ch'),
    get_json_object(line,'$.common.is_new'),
    get_json_object(line,'$.common.md'),
    get_json_object(line,'$.common.mid'),
    get_json_object(line,'$.common.os'),
    get_json_object(line,'$.common.uid'),
    get_json_object(line,'$.common.vc'),
    get_json_object(line,'$.page.item'),
    get_json_object(line,'$.page.item_type'),
    get_json_object(line,'$.page.last_page_id'),
    get_json_object(line,'$.page.page_id'),
    get_json_object(line,'$.page.source_type'),
    get_json_object(line,'$.start.entry'),
    get_json_object(line,'$.start.loading_time'),
    get_json_object(line,'$.start.open_ad_id'),
    get_json_object(line,'$.start.open_ad_ms'),
    get_json_object(line,'$.start.open_ad_skip_ms'),
    get_json_object(line,'$.actions'),
    get_json_object(line,'$.displays'),
    get_json_object(line,'$.ts'),
    get_json_object(line,'$.err.error_code'),
    get_json_object(line,'$.err.msg')
from ${APP}.ods_log
where dt='$do_date'
and get_json_object(line,'$.err') is not null;"


case $1 in
    dwd_start_log )
        hive -e "$dwd_start_log"
    ;;
    dwd_page_log )
        hive -e "$dwd_page_log"
    ;;
    dwd_action_log )
        hive -e "$dwd_action_log"
    ;;
    dwd_display_log )
        hive -e "$dwd_display_log"
    ;;
    dwd_error_log )
        hive -e "$dwd_error_log"
    ;;
    all )
        hive -e "$dwd_start_log$dwd_page_log$dwd_action_log$dwd_display_log$dwd_error_log"
    ;;
esac
</code></pre>
<p>（2）增加脚本执行权限</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 ods_to_dwd_log.sh
</code></pre>
<p>2）脚本使用<br>（1）执行脚本</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 module]$ ods_to_dwd_log.sh all 2020-06-14
</code></pre>
<p>（2）查询导入结果</p>
<h2 id="6-2-DWD层（业务数据）"><a href="#6-2-DWD层（业务数据）" class="headerlink" title="6.2 DWD层（业务数据）"></a>6.2 DWD层（业务数据）</h2><p>业务数据方面DWD层的搭建主要注意点在于维度建模。</p>
<h3 id="6-2-1-评价事实表（事务型事实表）"><a href="#6-2-1-评价事实表（事务型事实表）" class="headerlink" title="6.2.1 评价事实表（事务型事实表）"></a>6.2.1 评价事实表（事务型事实表）</h3><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_comment_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_comment_info<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品sku'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品spu'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'评价(好评、中评、差评、默认评价)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'评价时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'评价事实表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_comment_info/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）分区规划</p>
<img src="/2022/02/07/10237/%E8%AF%84%E4%BB%B7%E4%BA%8B%E5%AE%9E%E8%A1%A8%E5%88%86%E5%8C%BA%E8%AE%BE%E8%AE%A1.png" class title="This is an example image">

<p>3）数据装载</p>


<p>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_comment_info <span class="token keyword">partition</span> <span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">select</span>
    id<span class="token punctuation">,</span>
    user_id<span class="token punctuation">,</span>
    sku_id<span class="token punctuation">,</span>
    spu_id<span class="token punctuation">,</span>
    order_id<span class="token punctuation">,</span>
    appraise<span class="token punctuation">,</span>
    create_time<span class="token punctuation">,</span>
    date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> ods_comment_info
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">;</span>
</code></pre>
<p>（2）每日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_comment_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    id<span class="token punctuation">,</span>
    user_id<span class="token punctuation">,</span>
    sku_id<span class="token punctuation">,</span>
    spu_id<span class="token punctuation">,</span>
    order_id<span class="token punctuation">,</span>
    appraise<span class="token punctuation">,</span>
    create_time
<span class="token keyword">from</span> ods_comment_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="6-2-2-订单明细事实表（事务型事实表）"><a href="#6-2-2-订单明细事实表（事务型事实表）" class="headerlink" title="6.2.2 订单明细事实表（事务型事实表）"></a>6.2.2 订单明细事实表（事务型事实表）</h3><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_order_detail<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_order_detail <span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'sku商品id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'省份ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>activity_rule_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动规则ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>source_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>source_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品数量'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'原始价格'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>split_activity_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动优惠分摊'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>split_coupon_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券优惠分摊'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>split_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最终价格分摊'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单明细事实表表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_order_detail/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）分区规划</p>


<p>3）数据装载</p>


<p>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_order_detail <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">select</span>
    od<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>
    oi<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>sku_id<span class="token punctuation">,</span>
    oi<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>
    oda<span class="token punctuation">.</span>activity_id<span class="token punctuation">,</span>
    oda<span class="token punctuation">.</span>activity_rule_id<span class="token punctuation">,</span>
    odc<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>source_type<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>source_id<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>sku_num<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>order_price<span class="token operator">*</span>od<span class="token punctuation">.</span>sku_num<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>split_activity_amount<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>split_coupon_amount<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>split_final_amount<span class="token punctuation">,</span>
    date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        <span class="token operator">*</span>
    <span class="token keyword">from</span> ods_order_detail
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>od
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        province_id
    <span class="token keyword">from</span> ods_order_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>oi
<span class="token keyword">on</span> od<span class="token punctuation">.</span>order_id<span class="token operator">=</span>oi<span class="token punctuation">.</span>id
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        order_detail_id<span class="token punctuation">,</span>
        activity_id<span class="token punctuation">,</span>
        activity_rule_id
    <span class="token keyword">from</span> ods_order_detail_activity
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>oda
<span class="token keyword">on</span> od<span class="token punctuation">.</span>id<span class="token operator">=</span>oda<span class="token punctuation">.</span>order_detail_id
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        order_detail_id<span class="token punctuation">,</span>
        coupon_id
    <span class="token keyword">from</span> ods_order_detail_coupon
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>odc
<span class="token keyword">on</span> od<span class="token punctuation">.</span>id<span class="token operator">=</span>odc<span class="token punctuation">.</span>order_detail_id<span class="token punctuation">;</span>
</code></pre>
<p>（2）每日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_order_detail <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    od<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>
    oi<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>sku_id<span class="token punctuation">,</span>
    oi<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>
    oda<span class="token punctuation">.</span>activity_id<span class="token punctuation">,</span>
    oda<span class="token punctuation">.</span>activity_rule_id<span class="token punctuation">,</span>
    odc<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>source_type<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>source_id<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>sku_num<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>order_price<span class="token operator">*</span>od<span class="token punctuation">.</span>sku_num<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>split_activity_amount<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>split_coupon_amount<span class="token punctuation">,</span>
    od<span class="token punctuation">.</span>split_final_amount
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        <span class="token operator">*</span>
    <span class="token keyword">from</span> ods_order_detail
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
<span class="token punctuation">)</span>od
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        province_id
    <span class="token keyword">from</span> ods_order_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
<span class="token punctuation">)</span>oi
<span class="token keyword">on</span> od<span class="token punctuation">.</span>order_id<span class="token operator">=</span>oi<span class="token punctuation">.</span>id
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        order_detail_id<span class="token punctuation">,</span>
        activity_id<span class="token punctuation">,</span>
        activity_rule_id
    <span class="token keyword">from</span> ods_order_detail_activity
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
<span class="token punctuation">)</span>oda
<span class="token keyword">on</span> od<span class="token punctuation">.</span>id<span class="token operator">=</span>oda<span class="token punctuation">.</span>order_detail_id
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        order_detail_id<span class="token punctuation">,</span>
        coupon_id
    <span class="token keyword">from</span> ods_order_detail_coupon
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
<span class="token punctuation">)</span>odc
<span class="token keyword">on</span> od<span class="token punctuation">.</span>id<span class="token operator">=</span>odc<span class="token punctuation">.</span>order_detail_id<span class="token punctuation">;</span>
</code></pre>
<h3 id="6-2-3-退单事实表（事务型事实表）"><a href="#6-2-3-退单事实表（事务型事实表）" class="headerlink" title="6.2.3 退单事实表（事务型事实表）"></a>6.2.3 退单事实表（事务型事实表）</h3><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_order_refund_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_order_refund_info<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退单类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_reason_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退单原因类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退单时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单事实表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_order_refund_info/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）分区规划</p>


<p>3）数据装载</p>


<p>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_order_refund_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">select</span>
    ri<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    ri<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
    ri<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>
    ri<span class="token punctuation">.</span>sku_id<span class="token punctuation">,</span>
    oi<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>
    ri<span class="token punctuation">.</span>refund_type<span class="token punctuation">,</span>
    ri<span class="token punctuation">.</span>refund_num<span class="token punctuation">,</span>
    ri<span class="token punctuation">.</span>refund_amount<span class="token punctuation">,</span>
    ri<span class="token punctuation">.</span>refund_reason_type<span class="token punctuation">,</span>
    ri<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>
    date_format<span class="token punctuation">(</span>ri<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ods_order_refund_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>ri
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> id<span class="token punctuation">,</span>province_id <span class="token keyword">from</span> ods_order_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>oi
<span class="token keyword">on</span> ri<span class="token punctuation">.</span>order_id<span class="token operator">=</span>oi<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre>
<p>（2）每日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_order_refund_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    ri<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    ri<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
    ri<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>
    ri<span class="token punctuation">.</span>sku_id<span class="token punctuation">,</span>
    oi<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>
    ri<span class="token punctuation">.</span>refund_type<span class="token punctuation">,</span>
    ri<span class="token punctuation">.</span>refund_num<span class="token punctuation">,</span>
    ri<span class="token punctuation">.</span>refund_amount<span class="token punctuation">,</span>
    ri<span class="token punctuation">.</span>refund_reason_type<span class="token punctuation">,</span>
    ri<span class="token punctuation">.</span>create_time
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ods_order_refund_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
<span class="token punctuation">)</span>ri
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> id<span class="token punctuation">,</span>province_id <span class="token keyword">from</span> ods_order_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
<span class="token punctuation">)</span>oi
<span class="token keyword">on</span> ri<span class="token punctuation">.</span>order_id<span class="token operator">=</span>oi<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre>
<p>3）查询加载结果</p>
<h3 id="6-2-4-加购事实表（周期型快照事实表，每日快照）"><a href="#6-2-4-加购事实表（周期型快照事实表，每日快照）" class="headerlink" title="6.2.4 加购事实表（周期型快照事实表，每日快照）"></a>6.2.4 加购事实表（周期型快照事实表，每日快照）</h3><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_cart_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_cart_info<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>source_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>source_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'来源编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>cart_price<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'加入购物车时的价格'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>is_ordered<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否已下单'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'下单时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'加购数量'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'加购事实表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_cart_info/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）分区规划</p>
<img src="/2022/02/07/10237/%E5%8A%A0%E8%B4%AD%E4%BA%8B%E5%AE%9E%E8%A1%A8%E5%88%86%E5%8C%BA.png" class title="This is an example image">

<p>3）数据装载</p>
<img src="/2022/02/07/10237/%E5%8A%A0%E8%B4%AD%E4%BA%8B%E5%AE%9E%E8%A1%A8%E6%95%B0%E6%8D%AE%E8%A3%85%E8%BD%BD.png" class title="This is an example image">

<p>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_cart_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    id<span class="token punctuation">,</span>
    user_id<span class="token punctuation">,</span>
    sku_id<span class="token punctuation">,</span>
    source_type<span class="token punctuation">,</span>
    source_id<span class="token punctuation">,</span>
    cart_price<span class="token punctuation">,</span>
    is_ordered<span class="token punctuation">,</span>
    create_time<span class="token punctuation">,</span>
    operate_time<span class="token punctuation">,</span>
    order_time<span class="token punctuation">,</span>
    sku_num
<span class="token keyword">from</span> ods_cart_info
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">;</span>
</code></pre>
<p>（2）每日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_cart_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    id<span class="token punctuation">,</span>
    user_id<span class="token punctuation">,</span>
    sku_id<span class="token punctuation">,</span>
    source_type<span class="token punctuation">,</span>
    source_id<span class="token punctuation">,</span>
    cart_price<span class="token punctuation">,</span>
    is_ordered<span class="token punctuation">,</span>
    create_time<span class="token punctuation">,</span>
    operate_time<span class="token punctuation">,</span>
    order_time<span class="token punctuation">,</span>
    sku_num
<span class="token keyword">from</span> ods_cart_info
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="6-2-5-收藏事实表（周期型快照事实表，每日快照）"><a href="#6-2-5-收藏事实表（周期型快照事实表，每日快照）" class="headerlink" title="6.2.5 收藏事实表（周期型快照事实表，每日快照）"></a>6.2.5 收藏事实表（周期型快照事实表，每日快照）</h3><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_favor_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_favor_info<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'skuid'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'spuid'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>is_cancel<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'是否取消'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'收藏时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>cancel_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'取消时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'收藏事实表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_favor_info/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）分区规划</p>
<img src="/2022/02/07/10237/%E6%94%B6%E8%97%8F%E4%BA%8B%E5%AE%9E%E8%A1%A8%E5%88%86%E5%8C%BA.png" class title="This is an example image">

<p>3）数据装载</p>
<img src="/2022/02/07/10237/%E6%94%B6%E8%97%8F%E4%BA%8B%E5%AE%9E%E8%A1%A8%E6%95%B0%E6%8D%AE%E8%A3%85%E8%BD%BD.png" class title="This is an example image">

<p>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_favor_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    id<span class="token punctuation">,</span>
    user_id<span class="token punctuation">,</span>
    sku_id<span class="token punctuation">,</span>
    spu_id<span class="token punctuation">,</span>
    is_cancel<span class="token punctuation">,</span>
    create_time<span class="token punctuation">,</span>
    cancel_time
<span class="token keyword">from</span> ods_favor_info
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">;</span>
</code></pre>
<p>（2）每日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_favor_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    id<span class="token punctuation">,</span>
    user_id<span class="token punctuation">,</span>
    sku_id<span class="token punctuation">,</span>
    spu_id<span class="token punctuation">,</span>
    is_cancel<span class="token punctuation">,</span>
    create_time<span class="token punctuation">,</span>
    cancel_time
<span class="token keyword">from</span> ods_favor_info
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="6-2-6-优惠券领用事实表（累积型快照事实表）"><a href="#6-2-6-优惠券领用事实表（累积型快照事实表）" class="headerlink" title="6.2.6 优惠券领用事实表（累积型快照事实表）"></a>6.2.6 优惠券领用事实表（累积型快照事实表）</h3><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_coupon_use<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_coupon_use<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'优惠券ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'userid'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'订单id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_status<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'优惠券状态'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>get_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'领取时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>using_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'使用时间(下单)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>used_time<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'使用时间(支付)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>expire_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'过期时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券领用事实表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_coupon_use/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）分区规划</p>
<img src="/2022/02/07/10237/%E4%BC%98%E6%83%A0%E5%88%B8%E9%A2%86%E7%94%A8%E4%BA%8B%E5%AE%9E%E8%A1%A8%E5%88%86%E5%8C%BA.png" class title="This is an example image">

<p>3）数据装载</p>
<img src="/2022/02/07/10237/%E4%BC%98%E6%83%A0%E5%88%B8%E9%A2%86%E7%94%A8%E4%BA%8B%E5%AE%9E%E8%A1%A8%E6%95%B0%E6%8D%AE%E8%A3%85%E8%BD%BD.png" class title="This is an example image">

<p>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_coupon_use <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">select</span>
    id<span class="token punctuation">,</span>
    coupon_id<span class="token punctuation">,</span>
    user_id<span class="token punctuation">,</span>
    order_id<span class="token punctuation">,</span>
    coupon_status<span class="token punctuation">,</span>
    get_time<span class="token punctuation">,</span>
    using_time<span class="token punctuation">,</span>
    used_time<span class="token punctuation">,</span>
    expire_time<span class="token punctuation">,</span>
    <span class="token keyword">coalesce</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>used_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>date_format<span class="token punctuation">(</span>expire_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> ods_coupon_use
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">;</span>
</code></pre>
<p>（2）每日装载<br>a.装载逻辑</p>
<img src="/2022/02/07/10237/%E4%BC%98%E6%83%A0%E5%88%B8%E9%A2%86%E7%94%A8%E4%BA%8B%E5%AE%9E%E8%A1%A8%E6%AF%8F%E5%A4%A9%E8%A3%85%E8%BD%BD%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF.png" class title="This is an example image">

<p>b.转载语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_coupon_use <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">select</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>coupon_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>order_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>coupon_status<span class="token punctuation">,</span>old<span class="token punctuation">.</span>coupon_status<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>get_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>get_time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>using_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>using_time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>used_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>used_time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>expire_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>expire_time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">coalesce</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>used_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>used_time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>date_format<span class="token punctuation">(</span>nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>expire_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>expire_time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        coupon_id<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        order_id<span class="token punctuation">,</span>
        coupon_status<span class="token punctuation">,</span>
        get_time<span class="token punctuation">,</span>
        using_time<span class="token punctuation">,</span>
        used_time<span class="token punctuation">,</span>
        expire_time
    <span class="token keyword">from</span> dwd_coupon_use
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span>
<span class="token punctuation">)</span>old
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        coupon_id<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        order_id<span class="token punctuation">,</span>
        coupon_status<span class="token punctuation">,</span>
        get_time<span class="token punctuation">,</span>
        using_time<span class="token punctuation">,</span>
        used_time<span class="token punctuation">,</span>
        expire_time
    <span class="token keyword">from</span> ods_coupon_use
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
<span class="token punctuation">)</span>new
<span class="token keyword">on</span> old<span class="token punctuation">.</span>id<span class="token operator">=</span>new<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre>
<h3 id="6-2-7-支付事实表（累积型快照事实表）"><a href="#6-2-7-支付事实表（累积型快照事实表）" class="headerlink" title="6.2.7 支付事实表（累积型快照事实表）"></a>6.2.7 支付事实表（累积型快照事实表）</h3><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_payment_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_payment_info <span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'交易编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>out_trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'对外交易编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_status<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付状态'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">--调用第三方支付接口的时间</span>
    <span class="token punctuation">`</span>callback_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'完成时间'</span><span class="token comment" spellcheck="true">--支付完成时间，即支付成功回调时间</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付事实表表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_payment_info/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）分区规划</p>
<img src="/2022/02/07/10237/%E6%94%AF%E4%BB%98%E4%BA%8B%E5%AE%9E%E8%A1%A8%E5%88%86%E5%8C%BA.png" class title="This is an example image">

<p>3）数据装载</p>
<img src="/2022/02/07/10237/%E6%94%AF%E4%BB%98%E4%BA%8B%E5%AE%9E%E8%A1%A8%E6%95%B0%E6%8D%AE%E8%A3%85%E8%BD%BD.png" class title="This is an example image">

<p>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_payment_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">select</span>
    pi<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    pi<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>
    pi<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
    oi<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>
    pi<span class="token punctuation">.</span>trade_no<span class="token punctuation">,</span>
    pi<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">,</span>
    pi<span class="token punctuation">.</span>payment_type<span class="token punctuation">,</span>
    pi<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span>
    pi<span class="token punctuation">.</span>payment_status<span class="token punctuation">,</span>
    pi<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>
    pi<span class="token punctuation">.</span>callback_time<span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>pi<span class="token punctuation">.</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ods_payment_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>pi
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> id<span class="token punctuation">,</span>province_id <span class="token keyword">from</span> ods_order_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>oi
<span class="token keyword">on</span> pi<span class="token punctuation">.</span>order_id<span class="token operator">=</span>oi<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre>
<p>（2）每日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_payment_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">select</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>order_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>province_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>trade_no<span class="token punctuation">,</span>old<span class="token punctuation">.</span>trade_no<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">,</span>old<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>payment_type<span class="token punctuation">,</span>old<span class="token punctuation">.</span>payment_type<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span>old<span class="token punctuation">.</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>payment_status<span class="token punctuation">,</span>old<span class="token punctuation">.</span>payment_status<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>create_time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>callback_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>callback_time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>callback_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>callback_time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> id<span class="token punctuation">,</span>
       order_id<span class="token punctuation">,</span>
       user_id<span class="token punctuation">,</span>
       province_id<span class="token punctuation">,</span>
       trade_no<span class="token punctuation">,</span>
       out_trade_no<span class="token punctuation">,</span>
       payment_type<span class="token punctuation">,</span>
       payment_amount<span class="token punctuation">,</span>
       payment_status<span class="token punctuation">,</span>
       create_time<span class="token punctuation">,</span>
       callback_time
    <span class="token keyword">from</span> dwd_payment_info
    <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'9999-99-99'</span>
<span class="token punctuation">)</span>old
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        pi<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        pi<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">,</span>
        pi<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>
        pi<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
        oi<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>
        pi<span class="token punctuation">.</span>payment_type<span class="token punctuation">,</span>
        pi<span class="token punctuation">.</span>trade_no<span class="token punctuation">,</span>
        pi<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span>
        pi<span class="token punctuation">.</span>payment_status<span class="token punctuation">,</span>
        pi<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>
        pi<span class="token punctuation">.</span>callback_time
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ods_payment_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token punctuation">)</span>pi
    <span class="token keyword">left</span> <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span> id<span class="token punctuation">,</span>province_id <span class="token keyword">from</span> ods_order_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token punctuation">)</span>oi
    <span class="token keyword">on</span> pi<span class="token punctuation">.</span>order_id<span class="token operator">=</span>oi<span class="token punctuation">.</span>id
<span class="token punctuation">)</span>new
<span class="token keyword">on</span> old<span class="token punctuation">.</span>id<span class="token operator">=</span>new<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre>
<h3 id="6-2-8-退款事实表（累积型快照事实表）"><a href="#6-2-8-退款事实表（累积型快照事实表）" class="headerlink" title="6.2.8 退款事实表（累积型快照事实表）"></a>6.2.8 退款事实表（累积型快照事实表）</h3><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_refund_payment<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_refund_payment <span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'SKU编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'交易编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>out_trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'对外交易编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_type<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付类型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_status<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退款状态'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">--调用第三方支付接口的时间</span>
    <span class="token punctuation">`</span>callback_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'回调时间'</span><span class="token comment" spellcheck="true">--支付接口回调时间，即支付成功时间</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款事实表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_refund_payment/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）分区规划</p>
<img src="/2022/02/07/10237/%E9%80%80%E6%AC%BE%E4%BA%8B%E5%AE%9E%E8%A1%A8%E5%88%86%E5%8C%BA.png" class title="This is an example image">

<p>3）数据装载</p>
<img src="/2022/02/07/10237/%E9%80%80%E6%AC%BE%E4%BA%8B%E5%AE%9E%E8%A1%A8%E6%95%B0%E6%8D%AE%E8%A3%85%E8%BD%BD.png" class title="This is an example image">

<p>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_refund_payment <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">select</span>
    rp<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    user_id<span class="token punctuation">,</span>
    order_id<span class="token punctuation">,</span>
    sku_id<span class="token punctuation">,</span>
    province_id<span class="token punctuation">,</span>
    trade_no<span class="token punctuation">,</span>
    out_trade_no<span class="token punctuation">,</span>
    payment_type<span class="token punctuation">,</span>
    refund_amount<span class="token punctuation">,</span>
    refund_status<span class="token punctuation">,</span>
    create_time<span class="token punctuation">,</span>
    callback_time<span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        out_trade_no<span class="token punctuation">,</span>
        order_id<span class="token punctuation">,</span>
        sku_id<span class="token punctuation">,</span>
        payment_type<span class="token punctuation">,</span>
        trade_no<span class="token punctuation">,</span>
        refund_amount<span class="token punctuation">,</span>
        refund_status<span class="token punctuation">,</span>
        create_time<span class="token punctuation">,</span>
        callback_time
    <span class="token keyword">from</span> ods_refund_payment
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>rp
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        province_id
    <span class="token keyword">from</span> ods_order_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>oi
<span class="token keyword">on</span> rp<span class="token punctuation">.</span>order_id<span class="token operator">=</span>oi<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre>
<p>（2）每日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_refund_payment <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">select</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>order_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>sku_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>sku_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>province_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>trade_no<span class="token punctuation">,</span>old<span class="token punctuation">.</span>trade_no<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">,</span>old<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>payment_type<span class="token punctuation">,</span>old<span class="token punctuation">.</span>payment_type<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>refund_amount<span class="token punctuation">,</span>old<span class="token punctuation">.</span>refund_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>refund_status<span class="token punctuation">,</span>old<span class="token punctuation">.</span>refund_status<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>create_time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>callback_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>callback_time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>callback_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>callback_time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        order_id<span class="token punctuation">,</span>
        sku_id<span class="token punctuation">,</span>
        province_id<span class="token punctuation">,</span>
        trade_no<span class="token punctuation">,</span>
        out_trade_no<span class="token punctuation">,</span>
        payment_type<span class="token punctuation">,</span>
        refund_amount<span class="token punctuation">,</span>
        refund_status<span class="token punctuation">,</span>
        create_time<span class="token punctuation">,</span>
        callback_time
    <span class="token keyword">from</span> dwd_refund_payment
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span>
<span class="token punctuation">)</span>old
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        rp<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        order_id<span class="token punctuation">,</span>
        sku_id<span class="token punctuation">,</span>
        province_id<span class="token punctuation">,</span>
        trade_no<span class="token punctuation">,</span>
        out_trade_no<span class="token punctuation">,</span>
        payment_type<span class="token punctuation">,</span>
        refund_amount<span class="token punctuation">,</span>
        refund_status<span class="token punctuation">,</span>
        create_time<span class="token punctuation">,</span>
        callback_time
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            id<span class="token punctuation">,</span>
            out_trade_no<span class="token punctuation">,</span>
            order_id<span class="token punctuation">,</span>
            sku_id<span class="token punctuation">,</span>
            payment_type<span class="token punctuation">,</span>
            trade_no<span class="token punctuation">,</span>
            refund_amount<span class="token punctuation">,</span>
            refund_status<span class="token punctuation">,</span>
            create_time<span class="token punctuation">,</span>
            callback_time
        <span class="token keyword">from</span> ods_refund_payment
        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token punctuation">)</span>rp
    <span class="token keyword">left</span> <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            id<span class="token punctuation">,</span>
            user_id<span class="token punctuation">,</span>
            province_id
        <span class="token keyword">from</span> ods_order_info
        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token punctuation">)</span>oi
    <span class="token keyword">on</span> rp<span class="token punctuation">.</span>order_id<span class="token operator">=</span>oi<span class="token punctuation">.</span>id
<span class="token punctuation">)</span>new
<span class="token keyword">on</span> old<span class="token punctuation">.</span>id<span class="token operator">=</span>new<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre>
<p>3）查询加载结果</p>
<h3 id="6-2-9-订单事实表（累积型快照事实表）"><a href="#6-2-9-订单事实表（累积型快照事实表）" class="headerlink" title="6.2.9 订单事实表（累积型快照事实表）"></a>6.2.9 订单事实表（累积型快照事实表）</h3><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwd_order_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwd_order_info<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_status<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'订单状态'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_way<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付方式'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>delivery_address<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'邮寄地址'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>out_trade_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'对外交易编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>tracking_no<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'物流单号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间(未支付状态)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'支付时间(已支付状态)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>cancel_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'取消时间(已取消状态)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>finish_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'完成时间(已完成状态)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退款时间(退款中状态)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_finish_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'退款完成时间(退款完成状态)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>expire_time<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'过期时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>feight_fee<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'运费'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>feight_fee_reduce<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'运费减免'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>activity_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动减免'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券减免'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单原始价格'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单最终价格'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单事实表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwd/dwd_order_info/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）分区规划</p>
<img src="/2022/02/07/10237/%E8%AE%A2%E5%8D%95%E4%BA%8B%E5%AE%9E%E8%A1%A8%E5%88%86%E5%8C%BA.png" class title="This is an example image">

<p>3）数据装载</p>
<img src="/2022/02/07/10237/%E8%AE%A2%E5%8D%95%E4%BA%8B%E5%AE%9E%E8%A1%A8%E6%95%B0%E6%8D%AE%E8%A3%85%E8%BD%BD.png" class title="This is an example image">

<p>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_order_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">select</span>
    oi<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    oi<span class="token punctuation">.</span>order_status<span class="token punctuation">,</span>
    oi<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
    oi<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>
    oi<span class="token punctuation">.</span>payment_way<span class="token punctuation">,</span>
    oi<span class="token punctuation">.</span>delivery_address<span class="token punctuation">,</span>
    oi<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">,</span>
    oi<span class="token punctuation">.</span>tracking_no<span class="token punctuation">,</span>
    oi<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>
    times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1002'</span><span class="token punctuation">]</span> payment_time<span class="token punctuation">,</span>
    times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1003'</span><span class="token punctuation">]</span> cancel_time<span class="token punctuation">,</span>
    times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1004'</span><span class="token punctuation">]</span> finish_time<span class="token punctuation">,</span>
    times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1005'</span><span class="token punctuation">]</span> refund_time<span class="token punctuation">,</span>
    times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1006'</span><span class="token punctuation">]</span> refund_finish_time<span class="token punctuation">,</span>
    oi<span class="token punctuation">.</span>expire_time<span class="token punctuation">,</span>
    feight_fee<span class="token punctuation">,</span>
    feight_fee_reduce<span class="token punctuation">,</span>
    activity_reduce_amount<span class="token punctuation">,</span>
    coupon_reduce_amount<span class="token punctuation">,</span>
    original_amount<span class="token punctuation">,</span>
    final_amount<span class="token punctuation">,</span>
    <span class="token keyword">case</span>
        <span class="token keyword">when</span> times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1003'</span><span class="token punctuation">]</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> date_format<span class="token punctuation">(</span>times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1003'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span>
        <span class="token keyword">when</span> times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1004'</span><span class="token punctuation">]</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token operator">and</span> date_add<span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1004'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token string">'2020-06-14'</span> <span class="token operator">and</span> times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1005'</span><span class="token punctuation">]</span> <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span> date_add<span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1004'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span>
        <span class="token keyword">when</span> times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1006'</span><span class="token punctuation">]</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> date_format<span class="token punctuation">(</span>times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1006'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span>
        <span class="token keyword">when</span> oi<span class="token punctuation">.</span>expire_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> date_format<span class="token punctuation">(</span>oi<span class="token punctuation">.</span>expire_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span> <span class="token string">'9999-99-99'</span>
    <span class="token keyword">end</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        <span class="token operator">*</span>
    <span class="token keyword">from</span> ods_order_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>oi
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        order_id<span class="token punctuation">,</span>
        str_to_map<span class="token punctuation">(</span>concat_ws<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span>collect_set<span class="token punctuation">(</span>concat<span class="token punctuation">(</span>order_status<span class="token punctuation">,</span><span class="token string">'='</span><span class="token punctuation">,</span>operate_time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">,</span><span class="token string">'='</span><span class="token punctuation">)</span> ts
    <span class="token keyword">from</span> ods_order_status_log
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> order_id
<span class="token punctuation">)</span>times
<span class="token keyword">on</span> oi<span class="token punctuation">.</span>id<span class="token operator">=</span>times<span class="token punctuation">.</span>order_id<span class="token punctuation">;</span>
</code></pre>
<p>（2）每日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwd_order_info <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">select</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>order_status<span class="token punctuation">,</span>old<span class="token punctuation">.</span>order_status<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>province_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>payment_way<span class="token punctuation">,</span>old<span class="token punctuation">.</span>payment_way<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>delivery_address<span class="token punctuation">,</span>old<span class="token punctuation">.</span>delivery_address<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">,</span>old<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>tracking_no<span class="token punctuation">,</span>old<span class="token punctuation">.</span>tracking_no<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>create_time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>payment_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>payment_time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>cancel_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>cancel_time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>finish_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>finish_time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>refund_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>refund_time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>refund_finish_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>refund_finish_time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>expire_time<span class="token punctuation">,</span>old<span class="token punctuation">.</span>expire_time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>feight_fee<span class="token punctuation">,</span>old<span class="token punctuation">.</span>feight_fee<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>feight_fee_reduce<span class="token punctuation">,</span>old<span class="token punctuation">.</span>feight_fee_reduce<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>activity_reduce_amount<span class="token punctuation">,</span>old<span class="token punctuation">.</span>activity_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>coupon_reduce_amount<span class="token punctuation">,</span>old<span class="token punctuation">.</span>coupon_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>original_amount<span class="token punctuation">,</span>old<span class="token punctuation">.</span>original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>new<span class="token punctuation">.</span>final_amount<span class="token punctuation">,</span>old<span class="token punctuation">.</span>final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">case</span>
        <span class="token keyword">when</span> new<span class="token punctuation">.</span>cancel_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> date_format<span class="token punctuation">(</span>new<span class="token punctuation">.</span>cancel_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span>
        <span class="token keyword">when</span> new<span class="token punctuation">.</span>finish_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token operator">and</span> date_add<span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>new<span class="token punctuation">.</span>finish_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2020-06-15'</span> <span class="token operator">and</span> new<span class="token punctuation">.</span>refund_time <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token string">'2020-06-15'</span>
        <span class="token keyword">when</span> new<span class="token punctuation">.</span>refund_finish_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> date_format<span class="token punctuation">(</span>new<span class="token punctuation">.</span>refund_finish_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span>
        <span class="token keyword">when</span> new<span class="token punctuation">.</span>expire_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> date_format<span class="token punctuation">(</span>new<span class="token punctuation">.</span>expire_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span> <span class="token string">'9999-99-99'</span>
    <span class="token keyword">end</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        order_status<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        province_id<span class="token punctuation">,</span>
        payment_way<span class="token punctuation">,</span>
        delivery_address<span class="token punctuation">,</span>
        out_trade_no<span class="token punctuation">,</span>
        tracking_no<span class="token punctuation">,</span>
        create_time<span class="token punctuation">,</span>
        payment_time<span class="token punctuation">,</span>
        cancel_time<span class="token punctuation">,</span>
        finish_time<span class="token punctuation">,</span>
        refund_time<span class="token punctuation">,</span>
        refund_finish_time<span class="token punctuation">,</span>
        expire_time<span class="token punctuation">,</span>
        feight_fee<span class="token punctuation">,</span>
        feight_fee_reduce<span class="token punctuation">,</span>
        activity_reduce_amount<span class="token punctuation">,</span>
        coupon_reduce_amount<span class="token punctuation">,</span>
        original_amount<span class="token punctuation">,</span>
        final_amount
    <span class="token keyword">from</span> dwd_order_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span>
<span class="token punctuation">)</span>old
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        oi<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        oi<span class="token punctuation">.</span>order_status<span class="token punctuation">,</span>
        oi<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
        oi<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span>
        oi<span class="token punctuation">.</span>payment_way<span class="token punctuation">,</span>
        oi<span class="token punctuation">.</span>delivery_address<span class="token punctuation">,</span>
        oi<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">,</span>
        oi<span class="token punctuation">.</span>tracking_no<span class="token punctuation">,</span>
        oi<span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>
        times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1002'</span><span class="token punctuation">]</span> payment_time<span class="token punctuation">,</span>
        times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1003'</span><span class="token punctuation">]</span> cancel_time<span class="token punctuation">,</span>
        times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1004'</span><span class="token punctuation">]</span> finish_time<span class="token punctuation">,</span>
        times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1005'</span><span class="token punctuation">]</span> refund_time<span class="token punctuation">,</span>
        times<span class="token punctuation">.</span>ts<span class="token punctuation">[</span><span class="token string">'1006'</span><span class="token punctuation">]</span> refund_finish_time<span class="token punctuation">,</span>
        oi<span class="token punctuation">.</span>expire_time<span class="token punctuation">,</span>
        feight_fee<span class="token punctuation">,</span>
        feight_fee_reduce<span class="token punctuation">,</span>
        activity_reduce_amount<span class="token punctuation">,</span>
        coupon_reduce_amount<span class="token punctuation">,</span>
        original_amount<span class="token punctuation">,</span>
        final_amount
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            <span class="token operator">*</span>
        <span class="token keyword">from</span> ods_order_info
        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token punctuation">)</span>oi
    <span class="token keyword">left</span> <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            order_id<span class="token punctuation">,</span>
            str_to_map<span class="token punctuation">(</span>concat_ws<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span>collect_set<span class="token punctuation">(</span>concat<span class="token punctuation">(</span>order_status<span class="token punctuation">,</span><span class="token string">'='</span><span class="token punctuation">,</span>operate_time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">,</span><span class="token string">'='</span><span class="token punctuation">)</span> ts
        <span class="token keyword">from</span> ods_order_status_log
        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
        <span class="token keyword">group</span> <span class="token keyword">by</span> order_id
    <span class="token punctuation">)</span>times
    <span class="token keyword">on</span> oi<span class="token punctuation">.</span>id<span class="token operator">=</span>times<span class="token punctuation">.</span>order_id
<span class="token punctuation">)</span>new
<span class="token keyword">on</span> old<span class="token punctuation">.</span>id<span class="token operator">=</span>new<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre>
<h3 id="6-2-10-DWD层业务数据首日装载脚本"><a href="#6-2-10-DWD层业务数据首日装载脚本" class="headerlink" title="6.2.10 DWD层业务数据首日装载脚本"></a>6.2.10 DWD层业务数据首日装载脚本</h3><p>1）编写脚本<br>（1）在/home/atguigu/bin目录下创建脚本ods_to_dwd_db_init.sh</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim ods_to_dwd_db_init.sh
</code></pre>
<p>在脚本中填写如下内容</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash
APP=gmall

if [ -n "$2" ] ;then
   do_date=$2
else 
   echo "请传入日期参数"
   exit
fi 

dwd_order_info="
set hive.exec.dynamic.partition.mode=nonstrict;
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_order_info partition(dt)
select
    oi.id,
    oi.order_status,
    oi.user_id,
    oi.province_id,
    oi.payment_way,
    oi.delivery_address,
    oi.out_trade_no,
    oi.tracking_no,
    oi.create_time,
    times.ts['1002'] payment_time,
    times.ts['1003'] cancel_time,
    times.ts['1004'] finish_time,
    times.ts['1005'] refund_time,
    times.ts['1006'] refund_finish_time,
    oi.expire_time,
    feight_fee,
    feight_fee_reduce,
    activity_reduce_amount,
    coupon_reduce_amount,
    original_amount,
    final_amount,
    case
        when times.ts['1003'] is not null then date_format(times.ts['1003'],'yyyy-MM-dd')
        when times.ts['1004'] is not null and date_add(date_format(times.ts['1004'],'yyyy-MM-dd'),7)<='$do_date' and times.ts['1005'] is null then date_add(date_format(times.ts['1004'],'yyyy-MM-dd'),7)
        when times.ts['1006'] is not null then date_format(times.ts['1006'],'yyyy-MM-dd')
        when oi.expire_time is not null then date_format(oi.expire_time,'yyyy-MM-dd')
        else '9999-99-99'
    end
from
(
    select
        *
    from ${APP}.ods_order_info
    where dt='$do_date'
)oi
left join
(
    select
        order_id,
        str_to_map(concat_ws(',',collect_set(concat(order_status,'=',operate_time))),',','=') ts
    from ${APP}.ods_order_status_log
    where dt='$do_date'
    group by order_id
)times
on oi.id=times.order_id;"

dwd_order_detail="
set hive.exec.dynamic.partition.mode=nonstrict;
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_order_detail partition(dt)
select
    od.id,
    od.order_id,
    oi.user_id,
    od.sku_id,
    oi.province_id,
    oda.activity_id,
    oda.activity_rule_id,
    odc.coupon_id,
    od.create_time,
    od.source_type,
    od.source_id,
    od.sku_num,
    od.order_price*od.sku_num,
    od.split_activity_amount,
    od.split_coupon_amount,
    od.split_final_amount,
    date_format(create_time,'yyyy-MM-dd')
from
(
    select
        *
    from ${APP}.ods_order_detail
    where dt='$do_date'
)od
left join
(
    select
        id,
        user_id,
        province_id
    from ${APP}.ods_order_info
    where dt='$do_date'
)oi
on od.order_id=oi.id
left join
(
    select
        order_detail_id,
        activity_id,
        activity_rule_id
    from ${APP}.ods_order_detail_activity
    where dt='$do_date'
)oda
on od.id=oda.order_detail_id
left join
(
    select
        order_detail_id,
        coupon_id
    from ${APP}.ods_order_detail_coupon
    where dt='$do_date'
)odc
on od.id=odc.order_detail_id;"

dwd_payment_info="
set hive.exec.dynamic.partition.mode=nonstrict;
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_payment_info partition(dt)
select
    pi.id,
    pi.order_id,
    pi.user_id,
    oi.province_id,
    pi.trade_no,
    pi.out_trade_no,
    pi.payment_type,
    pi.payment_amount,
    pi.payment_status,
    pi.create_time,
    pi.callback_time,
    nvl(date_format(pi.callback_time,'yyyy-MM-dd'),'9999-99-99')
from
(
    select * from ${APP}.ods_payment_info where dt='$do_date'
)pi
left join
(
    select id,province_id from ${APP}.ods_order_info where dt='$do_date'
)oi
on pi.order_id=oi.id;"

dwd_cart_info="
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_cart_info partition(dt='$do_date')
select
    id,
    user_id,
    sku_id,
    source_type,
    source_id,
    cart_price,
    is_ordered,
    create_time,
    operate_time,
    order_time,
    sku_num
from ${APP}.ods_cart_info
where dt='$do_date';"

dwd_comment_info="
set hive.exec.dynamic.partition.mode=nonstrict;
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_comment_info partition(dt)
select
    id,
    user_id,
    sku_id,
    spu_id,
    order_id,
    appraise,
    create_time,
    date_format(create_time,'yyyy-MM-dd')
from ${APP}.ods_comment_info
where dt='$do_date';
"

dwd_favor_info="
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_favor_info partition(dt='$do_date')
select
    id,
    user_id,
    sku_id,
    spu_id,
    is_cancel,
    create_time,
    cancel_time
from ${APP}.ods_favor_info
where dt='$do_date';"

dwd_coupon_use="
set hive.exec.dynamic.partition.mode=nonstrict;
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_coupon_use partition(dt)
select
    id,
    coupon_id,
    user_id,
    order_id,
    coupon_status,
    get_time,
    using_time,
    used_time,
    expire_time,
    coalesce(date_format(used_time,'yyyy-MM-dd'),date_format(expire_time,'yyyy-MM-dd'),'9999-99-99')
from ${APP}.ods_coupon_use
where dt='$do_date';"

dwd_order_refund_info="
set hive.exec.dynamic.partition.mode=nonstrict;
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_order_refund_info partition(dt)
select
    ri.id,
    ri.user_id,
    ri.order_id,
    ri.sku_id,
    oi.province_id,
    ri.refund_type,
    ri.refund_num,
    ri.refund_amount,
    ri.refund_reason_type,
    ri.create_time,
    date_format(ri.create_time,'yyyy-MM-dd')
from
(
    select * from ${APP}.ods_order_refund_info where dt='$do_date'
)ri
left join
(
    select id,province_id from ${APP}.ods_order_info where dt='$do_date'
)oi
on ri.order_id=oi.id;"

dwd_refund_payment="
set hive.exec.dynamic.partition.mode=nonstrict;
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_refund_payment partition(dt)
select
    rp.id,
    user_id,
    order_id,
    sku_id,
    province_id,
    trade_no,
    out_trade_no,
    payment_type,
    refund_amount,
    refund_status,
    create_time,
    callback_time,
    nvl(date_format(callback_time,'yyyy-MM-dd'),'9999-99-99')
from
(
    select
        id,
        out_trade_no,
        order_id,
        sku_id,
        payment_type,
        trade_no,
        refund_amount,
        refund_status,
        create_time,
        callback_time
    from ${APP}.ods_refund_payment
    where dt='$do_date'
)rp
left join
(
    select
        id,
        user_id,
        province_id
    from ${APP}.ods_order_info
    where dt='$do_date'
)oi
on rp.order_id=oi.id;"

case $1 in
    dwd_order_info )
        hive -e "$dwd_order_info"
    ;;
    dwd_order_detail )
        hive -e "$dwd_order_detail"
    ;;
    dwd_payment_info )
        hive -e "$dwd_payment_info"
    ;;
    dwd_cart_info )
        hive -e "$dwd_cart_info"
    ;;
    dwd_comment_info )
        hive -e "$dwd_comment_info"
    ;;
    dwd_favor_info )
        hive -e "$dwd_favor_info"
    ;;
    dwd_coupon_use )
        hive -e "$dwd_coupon_use"
    ;;
    dwd_order_refund_info )
        hive -e "$dwd_order_refund_info"
    ;;
    dwd_refund_payment )
        hive -e "$dwd_refund_payment"
    ;;
    all )
        hive -e "$dwd_order_info$dwd_order_detail$dwd_payment_info$dwd_cart_info$dwd_comment_info$dwd_favor_info$dwd_coupon_use$dwd_order_refund_info$dwd_refund_payment"
    ;;
esac
</code></pre>
<p>（2）增加执行权限</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod +x ods_to_dwd_db_init.sh
</code></pre>
<p>2）脚本使用<br>（1）执行脚本</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ ods_to_dwd_db_init.sh all 2020-06-14
</code></pre>
<p>（2）查看数据是否导入成功</p>
<h3 id="6-2-11-DWD层业务数据每日装载脚本"><a href="#6-2-11-DWD层业务数据每日装载脚本" class="headerlink" title="6.2.11 DWD层业务数据每日装载脚本"></a>6.2.11 DWD层业务数据每日装载脚本</h3><p>1）编写脚本<br>（1）在/home/atguigu/bin目录下创建脚本ods_to_dwd_db.sh</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim ods_to_dwd_db.sh
</code></pre>
<p>在脚本中填写如下内容</p>
<pre class=" language-shell"><code class="language-shell">#!/bin/bash

APP=gmall

# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天

if [ -n "$2" ] ;then
    do_date=$2
else 
    do_date=`date -d "-1 day" +%F`
fi


# 假设某累积型快照事实表，某天所有的业务记录全部完成，则会导致9999-99-99分区的数据未被覆盖，从而导致数据重复，该函数根据9999-99-99分区的数据的末次修改时间判断其是否被覆盖了，如果未被覆盖，就手动清理

clear_data(){
    current_date=`date +%F`
    current_date_timestamp=`date -d "$current_date" +%s`

    last_modified_date=`hadoop fs -ls /warehouse/gmall/dwd/$1 | grep '9999-99-99' | awk '{print $6}'`
    last_modified_date_timestamp=`date -d "$last_modified_date" +%s`
    
    if [[ $last_modified_date_timestamp -lt $current_date_timestamp ]]; then
        echo "clear table $1 partition(dt=9999-99-99)"
        hadoop fs -rm -r -f /warehouse/gmall/dwd/$1/dt=9999-99-99/*
    fi

}

dwd_order_info="
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
set hive.exec.dynamic.partition.mode=nonstrict;
insert overwrite table ${APP}.dwd_order_info partition(dt)
select
    nvl(new.id,old.id),
    nvl(new.order_status,old.order_status),
    nvl(new.user_id,old.user_id),
    nvl(new.province_id,old.province_id),
    nvl(new.payment_way,old.payment_way),
    nvl(new.delivery_address,old.delivery_address),
    nvl(new.out_trade_no,old.out_trade_no),
    nvl(new.tracking_no,old.tracking_no),
    nvl(new.create_time,old.create_time),
    nvl(new.payment_time,old.payment_time),
    nvl(new.cancel_time,old.cancel_time),
    nvl(new.finish_time,old.finish_time),
    nvl(new.refund_time,old.refund_time),
    nvl(new.refund_finish_time,old.refund_finish_time),
    nvl(new.expire_time,old.expire_time),
    nvl(new.feight_fee,old.feight_fee),
    nvl(new.feight_fee_reduce,old.feight_fee_reduce),
    nvl(new.activity_reduce_amount,old.activity_reduce_amount),
    nvl(new.coupon_reduce_amount,old.coupon_reduce_amount),
    nvl(new.original_amount,old.original_amount),
    nvl(new.final_amount,old.final_amount),
    case
        when new.cancel_time is not null then date_format(new.cancel_time,'yyyy-MM-dd')
        when new.finish_time is not null and date_add(date_format(new.finish_time,'yyyy-MM-dd'),7)='$do_date' and new.refund_time is null then '$do_date'
        when new.refund_finish_time is not null then date_format(new.refund_finish_time,'yyyy-MM-dd')
        when new.expire_time is not null then date_format(new.expire_time,'yyyy-MM-dd')
        else '9999-99-99'
    end
from
(
    select
        id,
        order_status,
        user_id,
        province_id,
        payment_way,
        delivery_address,
        out_trade_no,
        tracking_no,
        create_time,
        payment_time,
        cancel_time,
        finish_time,
        refund_time,
        refund_finish_time,
        expire_time,
        feight_fee,
        feight_fee_reduce,
        activity_reduce_amount,
        coupon_reduce_amount,
        original_amount,
        final_amount
    from ${APP}.dwd_order_info
    where dt='9999-99-99'
)old
full outer join
(
    select
        oi.id,
        oi.order_status,
        oi.user_id,
        oi.province_id,
        oi.payment_way,
        oi.delivery_address,
        oi.out_trade_no,
        oi.tracking_no,
        oi.create_time,
        times.ts['1002'] payment_time,
        times.ts['1003'] cancel_time,
        times.ts['1004'] finish_time,
        times.ts['1005'] refund_time,
        times.ts['1006'] refund_finish_time,
        oi.expire_time,
        feight_fee,
        feight_fee_reduce,
        activity_reduce_amount,
        coupon_reduce_amount,
        original_amount,
        final_amount
    from
    (
        select
            *
        from ${APP}.ods_order_info
        where dt='$do_date'
    )oi
    left join
    (
        select
            order_id,
            str_to_map(concat_ws(',',collect_set(concat(order_status,'=',operate_time))),',','=') ts
        from ${APP}.ods_order_status_log
        where dt='$do_date'
        group by order_id
    )times
    on oi.id=times.order_id
)new
on old.id=new.id;"

dwd_order_detail="
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_order_detail partition(dt='$do_date')
select
    od.id,
    od.order_id,
    oi.user_id,
    od.sku_id,
    oi.province_id,
    oda.activity_id,
    oda.activity_rule_id,
    odc.coupon_id,
    od.create_time,
    od.source_type,
    od.source_id,
    od.sku_num,
    od.order_price*od.sku_num,
    od.split_activity_amount,
    od.split_coupon_amount,
    od.split_final_amount
from
(
    select
        *
    from ${APP}.ods_order_detail
    where dt='$do_date'
)od
left join
(
    select
        id,
        user_id,
        province_id
    from ${APP}.ods_order_info
    where dt='$do_date'
)oi
on od.order_id=oi.id
left join
(
    select
        order_detail_id,
        activity_id,
        activity_rule_id
    from ${APP}.ods_order_detail_activity
    where dt='$do_date'
)oda
on od.id=oda.order_detail_id
left join
(
    select
        order_detail_id,
        coupon_id
    from ${APP}.ods_order_detail_coupon
    where dt='$do_date'
)odc
on od.id=odc.order_detail_id;"


dwd_payment_info="
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
set hive.exec.dynamic.partition.mode=nonstrict;
insert overwrite table ${APP}.dwd_payment_info partition(dt)
select
    nvl(new.id,old.id),
    nvl(new.order_id,old.order_id),
    nvl(new.user_id,old.user_id),
    nvl(new.province_id,old.province_id),
    nvl(new.trade_no,old.trade_no),
    nvl(new.out_trade_no,old.out_trade_no),
    nvl(new.payment_type,old.payment_type),
    nvl(new.payment_amount,old.payment_amount),
    nvl(new.payment_status,old.payment_status),
    nvl(new.create_time,old.create_time),
    nvl(new.callback_time,old.callback_time),
    nvl(date_format(nvl(new.callback_time,old.callback_time),'yyyy-MM-dd'),'9999-99-99')
from
(
    select id,
       order_id,
       user_id,
       province_id,
       trade_no,
       out_trade_no,
       payment_type,
       payment_amount,
       payment_status,
       create_time,
       callback_time
    from ${APP}.dwd_payment_info
    where dt = '9999-99-99'
)old
full outer join
(
    select
        pi.id,
        pi.out_trade_no,
        pi.order_id,
        pi.user_id,
        oi.province_id,
        pi.payment_type,
        pi.trade_no,
        pi.payment_amount,
        pi.payment_status,
        pi.create_time,
        pi.callback_time
    from
    (
        select * from ${APP}.ods_payment_info where dt='$do_date'
    )pi
    left join
    (
        select id,province_id from ${APP}.ods_order_info where dt='$do_date'
    )oi
    on pi.order_id=oi.id
)new
on old.id=new.id;"

dwd_cart_info="
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_cart_info partition(dt='$do_date')
select
    id,
    user_id,
    sku_id,
    source_type,
    source_id,
    cart_price,
    is_ordered,
    create_time,
    operate_time,
    order_time,
    sku_num
from ${APP}.ods_cart_info
where dt='$do_date';"


dwd_comment_info="
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_comment_info partition(dt='$do_date')
select
    id,
    user_id,
    sku_id,
    spu_id,
    order_id,
    appraise,
    create_time
from ${APP}.ods_comment_info where dt='$do_date';"


dwd_favor_info="
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_favor_info partition(dt='$do_date')
select
    id,
    user_id,
    sku_id,
    spu_id,
    is_cancel,
    create_time,
    cancel_time
from ${APP}.ods_favor_info
where dt='$do_date';"


dwd_coupon_use="
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
set hive.exec.dynamic.partition.mode=nonstrict;
insert overwrite table ${APP}.dwd_coupon_use partition(dt)
select
    nvl(new.id,old.id),
    nvl(new.coupon_id,old.coupon_id),
    nvl(new.user_id,old.user_id),
    nvl(new.order_id,old.order_id),
    nvl(new.coupon_status,old.coupon_status),
    nvl(new.get_time,old.get_time),
    nvl(new.using_time,old.using_time),
    nvl(new.used_time,old.used_time),
    nvl(new.expire_time,old.expire_time),
    coalesce(date_format(nvl(new.used_time,old.used_time),'yyyy-MM-dd'),date_format(nvl(new.expire_time,old.expire_time),'yyyy-MM-dd'),'9999-99-99')
from
(
    select
        id,
        coupon_id,
        user_id,
        order_id,
        coupon_status,
        get_time,
        using_time,
        used_time,
        expire_time
    from ${APP}.dwd_coupon_use
    where dt='9999-99-99'
)old
full outer join
(
    select
        id,
        coupon_id,
        user_id,
        order_id,
        coupon_status,
        get_time,
        using_time,
        used_time,
        expire_time
    from ${APP}.ods_coupon_use
    where dt='$do_date'
)new
on old.id=new.id;"

dwd_order_refund_info="
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
insert overwrite table ${APP}.dwd_order_refund_info partition(dt='$do_date')
select
    ri.id,
    ri.user_id,
    ri.order_id,
    ri.sku_id,
    oi.province_id,
    ri.refund_type,
    ri.refund_num,
    ri.refund_amount,
    ri.refund_reason_type,
    ri.create_time
from
(
    select * from ${APP}.ods_order_refund_info where dt='$do_date'
)ri
left join
(
    select id,province_id from ${APP}.ods_order_info where dt='$do_date'
)oi
on ri.order_id=oi.id;"


dwd_refund_payment="
set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
set hive.exec.dynamic.partition.mode=nonstrict;
insert overwrite table ${APP}.dwd_refund_payment partition(dt)
select
    nvl(new.id,old.id),
    nvl(new.user_id,old.user_id),
    nvl(new.order_id,old.order_id),
    nvl(new.sku_id,old.sku_id),
    nvl(new.province_id,old.province_id),
    nvl(new.trade_no,old.trade_no),
    nvl(new.out_trade_no,old.out_trade_no),
    nvl(new.payment_type,old.payment_type),
    nvl(new.refund_amount,old.refund_amount),
    nvl(new.refund_status,old.refund_status),
    nvl(new.create_time,old.create_time),
    nvl(new.callback_time,old.callback_time),
    nvl(date_format(nvl(new.callback_time,old.callback_time),'yyyy-MM-dd'),'9999-99-99')
from
(
    select
        id,
        user_id,
        order_id,
        sku_id,
        province_id,
        trade_no,
        out_trade_no,
        payment_type,
        refund_amount,
        refund_status,
        create_time,
        callback_time
    from ${APP}.dwd_refund_payment
    where dt='9999-99-99'
)old
full outer join
(
    select
        rp.id,
        user_id,
        order_id,
        sku_id,
        province_id,
        trade_no,
        out_trade_no,
        payment_type,
        refund_amount,
        refund_status,
        create_time,
        callback_time
    from
    (
        select
            id,
            out_trade_no,
            order_id,
            sku_id,
            payment_type,
            trade_no,
            refund_amount,
            refund_status,
            create_time,
            callback_time
        from ${APP}.ods_refund_payment
        where dt='$do_date'
    )rp
    left join
    (
        select
            id,
            user_id,
            province_id
        from ${APP}.ods_order_info
        where dt='$do_date'
    )oi
    on rp.order_id=oi.id
)new
on old.id=new.id;"

case $1 in
    dwd_order_info )
        hive -e "$dwd_order_info"
        clear_data dwd_order_info
    ;;
    dwd_order_detail )
        hive -e "$dwd_order_detail"
    ;;
    dwd_payment_info )
        hive -e "$dwd_payment_info"
        clear_data dwd_payment_info
    ;;
    dwd_cart_info )
        hive -e "$dwd_cart_info"
    ;;
    dwd_comment_info )
        hive -e "$dwd_comment_info"
    ;;
    dwd_favor_info )
        hive -e "$dwd_favor_info"
    ;;
    dwd_coupon_use )
        hive -e "$dwd_coupon_use"
        clear_data dwd_coupon_use
    ;;
    dwd_order_refund_info )
        hive -e "$dwd_order_refund_info"
    ;;
    dwd_refund_payment )
        hive -e "$dwd_refund_payment"
        clear_data dwd_refund_payment
    ;;
    all )
        hive -e "$dwd_order_info$dwd_order_detail$dwd_payment_info$dwd_cart_info$dwd_comment_info$dwd_favor_info$dwd_coupon_use$dwd_order_refund_info$dwd_refund_payment"
        clear_data dwd_order_info
        clear_data dwd_payment_info
        clear_data dwd_coupon_use
        clear_data dwd_refund_payment
    ;;
esac
</code></pre>
<p>（2）增加脚本执行权限</p>
<pre class=" language-sh"><code class="language-sh">[atguigu@hadoop102 bin]$ chmod 777 ods_to_dwd_db.sh
</code></pre>
<p>2）脚本使用<br>（1）执行脚本</p>
<pre><code>[atguigu@hadoop102 bin]$ ods_to_dwd_db.sh all 2020-06-14
</code></pre>
<p>（2）查看数据是否导入成功</p>
<h1 id="第7章-数仓搭建-DWS层"><a href="#第7章-数仓搭建-DWS层" class="headerlink" title="第7章 数仓搭建-DWS层"></a>第7章 数仓搭建-DWS层</h1><h2 id="7-1-系统函数"><a href="#7-1-系统函数" class="headerlink" title="7.1 系统函数"></a>7.1 系统函数</h2><h3 id="7-1-1-nvl函数"><a href="#7-1-1-nvl函数" class="headerlink" title="7.1.1 nvl函数"></a>7.1.1 nvl函数</h3><p>1）基本语法<br>NVL（表达式1，表达式2）<br>如果表达式1为空值，NVL返回值为表达式2的值，否则返回表达式1的值。<br>该函数的目的是把一个空值（null）转换成一个实际的值。其表达式的值可以是数字型、字符型和日期型。但是表达式1和表达式2的数据类型必须为同一个类型。<br>2）案例实操</p>
<pre class=" language-shell"><code class="language-shell">hive (gmall)> select nvl(1,0);
1
hive (gmall)> select nvl(null,"hello");
hello
</code></pre>
<h3 id="7-1-2-日期处理函数"><a href="#7-1-2-日期处理函数" class="headerlink" title="7.1.2 日期处理函数"></a>7.1.2 日期处理函数</h3><p>1）date_format函数（根据格式整理日期）</p>
<pre class=" language-shell"><code class="language-shell">hive (gmall)> select date_format('2020-06-14','yyyy-MM');
2020-06
</code></pre>
<p>2）date_add函数（加减日期）</p>
<pre class=" language-shell"><code class="language-shell">hive (gmall)> select date_add('2020-06-14',-1);
2020-06-13
hive (gmall)> select date_add('2020-06-14',1);
2020-06-15
</code></pre>
<p>3）next_day函数<br>    （1）取当前天的下一个周一</p>
<pre class=" language-shell"><code class="language-shell">hive (gmall)> select next_day('2020-06-14','MO');
2020-06-15
</code></pre>
<p>说明：星期一到星期日的英文（Monday，Tuesday、Wednesday、Thursday、Friday、Saturday、Sunday）<br>（2）取当前周的周一</p>
<pre class=" language-shell"><code class="language-shell">hive (gmall)> select date_add(next_day('2020-06-14','MO'),-7);
2020-06-8
</code></pre>
<p>4）last_day函数（求当月最后一天日期）</p>
<pre class=" language-shell"><code class="language-shell">hive (gmall)> select last_day('2020-06-14');
2020-06-30
</code></pre>
<h3 id="7-1-3-复杂数据类型定义"><a href="#7-1-3-复杂数据类型定义" class="headerlink" title="7.1.3 复杂数据类型定义"></a>7.1.3 复杂数据类型定义</h3><p>1）map结构数据定义</p>
<pre class=" language-sql"><code class="language-sql">map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span>string<span class="token operator">></span>
</code></pre>
<p>2）array结构数据定义</p>
<pre class=" language-sql"><code class="language-sql">array<span class="token operator">&lt;</span>string<span class="token operator">></span>
</code></pre>
<p>3）struct结构数据定义</p>
<pre class=" language-sql"><code class="language-sql">struct<span class="token operator">&lt;</span>id:<span class="token keyword">int</span><span class="token punctuation">,</span>name:string<span class="token punctuation">,</span>age:<span class="token keyword">int</span><span class="token operator">></span>
</code></pre>
<p>4）struct和array嵌套定义</p>
<pre class=" language-sql"><code class="language-sql">array<span class="token operator">&lt;</span>struct<span class="token operator">&lt;</span>id:<span class="token keyword">int</span><span class="token punctuation">,</span>name:string<span class="token punctuation">,</span>age:<span class="token keyword">int</span><span class="token operator">>></span>
</code></pre>
<h2 id="7-2-DWS层"><a href="#7-2-DWS层" class="headerlink" title="7.2 DWS层"></a>7.2 DWS层</h2><img src="/2022/02/07/10237/DWS%E5%B1%82.png" class title="This is an example image">

<img src="/2022/02/07/10237/DWS%E5%B1%82%E8%A1%A8%E6%95%B0%E6%8D%AE%E8%A3%85%E8%BD%BD.png" class title="This is an example image">



<h3 id="7-2-1-访客主题"><a href="#7-2-1-访客主题" class="headerlink" title="7.2.1 访客主题"></a>7.2.1 访客主题</h3><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dws_visitor_action_daycount<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dws_visitor_action_daycount
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备品牌'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备型号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>is_new<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否首次访问'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>channel<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRING<span class="token operator">></span> <span class="token keyword">COMMENT</span> <span class="token string">'渠道'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>os<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRING<span class="token operator">></span> <span class="token keyword">COMMENT</span> <span class="token string">'操作系统'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRING<span class="token operator">></span> <span class="token keyword">COMMENT</span> <span class="token string">'地区ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRING<span class="token operator">></span> <span class="token keyword">COMMENT</span> <span class="token string">'应用版本'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visit_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'访问次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>page_stats<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRUCT<span class="token operator">&lt;</span>page_id:STRING<span class="token punctuation">,</span>page_count:<span class="token keyword">BIGINT</span><span class="token punctuation">,</span>during_time:<span class="token keyword">BIGINT</span><span class="token operator">>></span> <span class="token keyword">COMMENT</span> <span class="token string">'页面访问统计'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'每日设备行为表'</span>
PARTITIONED <span class="token keyword">BY</span><span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dws/dws_visitor_action_daycount'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）数据装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_visitor_action_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    t1<span class="token punctuation">.</span>mid_id<span class="token punctuation">,</span>
    t1<span class="token punctuation">.</span>brand<span class="token punctuation">,</span>
    t1<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
    t1<span class="token punctuation">.</span>is_new<span class="token punctuation">,</span>
    t1<span class="token punctuation">.</span>channel<span class="token punctuation">,</span>
    t1<span class="token punctuation">.</span>os<span class="token punctuation">,</span>
    t1<span class="token punctuation">.</span>area_code<span class="token punctuation">,</span>
    t1<span class="token punctuation">.</span>version_code<span class="token punctuation">,</span>
    t1<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span>
    t3<span class="token punctuation">.</span>page_stats
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        mid_id<span class="token punctuation">,</span>
        brand<span class="token punctuation">,</span>
        model<span class="token punctuation">,</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>array_contains<span class="token punctuation">(</span>collect_set<span class="token punctuation">(</span>is_new<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span> is_new<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--ods_page_log中，同一天内，同一设备的is_new字段，可能全部为1，可能全部为0，也可能部分为0，部分为1(卸载重装),故做该处理</span>
        collect_set<span class="token punctuation">(</span>channel<span class="token punctuation">)</span> channel<span class="token punctuation">,</span>
        collect_set<span class="token punctuation">(</span>os<span class="token punctuation">)</span> os<span class="token punctuation">,</span>
        collect_set<span class="token punctuation">(</span>area_code<span class="token punctuation">)</span> area_code<span class="token punctuation">,</span>
        collect_set<span class="token punctuation">(</span>version_code<span class="token punctuation">)</span> version_code<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>last_page_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> visit_count
    <span class="token keyword">from</span> dwd_page_log
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
    <span class="token operator">and</span> last_page_id <span class="token operator">is</span> <span class="token boolean">null</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> mid_id<span class="token punctuation">,</span>model<span class="token punctuation">,</span>brand
<span class="token punctuation">)</span>t1
<span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        mid_id<span class="token punctuation">,</span>
        brand<span class="token punctuation">,</span>
        model<span class="token punctuation">,</span>
        collect_set<span class="token punctuation">(</span>named_struct<span class="token punctuation">(</span><span class="token string">'page_id'</span><span class="token punctuation">,</span>page_id<span class="token punctuation">,</span><span class="token string">'page_count'</span><span class="token punctuation">,</span>page_count<span class="token punctuation">,</span><span class="token string">'during_time'</span><span class="token punctuation">,</span>during_time<span class="token punctuation">)</span><span class="token punctuation">)</span> page_stats
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            mid_id<span class="token punctuation">,</span>
            brand<span class="token punctuation">,</span>
            model<span class="token punctuation">,</span>
            page_id<span class="token punctuation">,</span>
            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> page_count<span class="token punctuation">,</span>
            <span class="token function">sum</span><span class="token punctuation">(</span>during_time<span class="token punctuation">)</span> during_time
        <span class="token keyword">from</span> dwd_page_log
        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
        <span class="token keyword">group</span> <span class="token keyword">by</span> mid_id<span class="token punctuation">,</span>model<span class="token punctuation">,</span>brand<span class="token punctuation">,</span>page_id
    <span class="token punctuation">)</span>t2
    <span class="token keyword">group</span> <span class="token keyword">by</span> mid_id<span class="token punctuation">,</span>model<span class="token punctuation">,</span>brand
<span class="token punctuation">)</span>t3
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>t3<span class="token punctuation">.</span>mid_id
<span class="token operator">and</span> t1<span class="token punctuation">.</span>brand<span class="token operator">=</span>t3<span class="token punctuation">.</span>brand
<span class="token operator">and</span> t1<span class="token punctuation">.</span>model<span class="token operator">=</span>t3<span class="token punctuation">.</span>model<span class="token punctuation">;</span><span class="token operator">*</span>
</code></pre>
<p>3）查询加载结果</p>
<h3 id="7-2-2-用户主题"><a href="#7-2-2-用户主题" class="headerlink" title="7.2.2 用户主题"></a>7.2.2 用户主题</h3><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dws_user_action_daycount<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dws_user_action_daycount
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>login_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'登录次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>cart_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'加入购物车次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>favor_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'收藏次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单参与活动次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单减免金额(活动)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单用券次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单减免金额(优惠券)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'订单单原始金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单总金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_get_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券领取次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_using_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券使用(下单)次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_used_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券使用(支付)次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'好评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'中评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'差评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'默认评价数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_detail_stats<span class="token punctuation">`</span> array<span class="token operator">&lt;</span>struct<span class="token operator">&lt;</span>sku_id:string<span class="token punctuation">,</span>sku_num:<span class="token keyword">bigint</span><span class="token punctuation">,</span>order_count:<span class="token keyword">bigint</span><span class="token punctuation">,</span>activity_reduce_amount:<span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_reduce_amount:<span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>original_amount:<span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>final_amount:<span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">>></span> <span class="token keyword">COMMENT</span> <span class="token string">'下单明细统计'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'每日用户行为'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dws/dws_user_action_daycount/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）数据装载<br>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span>
tmp_login <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> login_count
    <span class="token keyword">from</span> dwd_page_log
    <span class="token keyword">where</span> user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
    <span class="token operator">and</span> last_page_id <span class="token operator">is</span> <span class="token boolean">null</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>user_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_cf <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'favor_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_count
    <span class="token keyword">from</span> dwd_action_log
    <span class="token keyword">where</span> user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
    <span class="token operator">and</span> action_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token string">'favor_add'</span><span class="token punctuation">)</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>user_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_order <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>activity_reduce_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>coupon_reduce_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>activity_reduce_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>coupon_reduce_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>final_amount<span class="token punctuation">)</span> order_final_amount
    <span class="token keyword">from</span> dwd_order_info
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>user_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_pay <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount
    <span class="token keyword">from</span> dwd_payment_info
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>user_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_ri <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_order_amount
    <span class="token keyword">from</span> dwd_order_refund_info
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>user_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_rp <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        rp<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>ri<span class="token punctuation">.</span>refund_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>rp<span class="token punctuation">.</span>refund_amount<span class="token punctuation">)</span> refund_payment_amount
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            user_id<span class="token punctuation">,</span>
            order_id<span class="token punctuation">,</span>
            sku_id<span class="token punctuation">,</span>
            refund_amount<span class="token punctuation">,</span>
            callback_time
        <span class="token keyword">from</span> dwd_refund_payment
    <span class="token punctuation">)</span>rp
    <span class="token keyword">left</span> <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            user_id<span class="token punctuation">,</span>
            order_id<span class="token punctuation">,</span>
            sku_id<span class="token punctuation">,</span>
            refund_num
        <span class="token keyword">from</span> dwd_order_refund_info
    <span class="token punctuation">)</span>ri
    <span class="token keyword">on</span> rp<span class="token punctuation">.</span>order_id<span class="token operator">=</span>ri<span class="token punctuation">.</span>order_id
    <span class="token operator">and</span> rp<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>rp<span class="token punctuation">.</span>sku_id
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rp<span class="token punctuation">.</span>user_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_coupon <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        <span class="token keyword">coalesce</span><span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_used<span class="token punctuation">.</span>dt<span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        <span class="token keyword">coalesce</span><span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>coupon_used<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span> user_id<span class="token punctuation">,</span>
        nvl<span class="token punctuation">(</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> coupon_get_count<span class="token punctuation">,</span>
        nvl<span class="token punctuation">(</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> coupon_using_count<span class="token punctuation">,</span>
        nvl<span class="token punctuation">(</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> coupon_used_count
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            date_format<span class="token punctuation">(</span>get_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
            user_id<span class="token punctuation">,</span>
            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> coupon_get_count
        <span class="token keyword">from</span> dwd_coupon_use
        <span class="token keyword">where</span> get_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
        <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>date_format<span class="token punctuation">(</span>get_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>coupon_get
    <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            date_format<span class="token punctuation">(</span>using_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
            user_id<span class="token punctuation">,</span>
            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> coupon_using_count
        <span class="token keyword">from</span> dwd_coupon_use
        <span class="token keyword">where</span> using_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
        <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>date_format<span class="token punctuation">(</span>using_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>coupon_using
    <span class="token keyword">on</span> coupon_get<span class="token punctuation">.</span>dt<span class="token operator">=</span>coupon_using<span class="token punctuation">.</span>dt
    <span class="token operator">and</span> coupon_get<span class="token punctuation">.</span>user_id<span class="token operator">=</span>coupon_using<span class="token punctuation">.</span>user_id
    <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            date_format<span class="token punctuation">(</span>used_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
            user_id<span class="token punctuation">,</span>
            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> coupon_used_count
        <span class="token keyword">from</span> dwd_coupon_use
        <span class="token keyword">where</span> used_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
        <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>date_format<span class="token punctuation">(</span>used_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>coupon_used
    <span class="token keyword">on</span> nvl<span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>dt<span class="token punctuation">)</span><span class="token operator">=</span>coupon_used<span class="token punctuation">.</span>dt
    <span class="token operator">and</span> nvl<span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token operator">=</span>coupon_used<span class="token punctuation">.</span>user_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_comment <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1201'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1202'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1203'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1204'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_default_count
    <span class="token keyword">from</span> dwd_comment_info
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>user_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_od <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        collect_set<span class="token punctuation">(</span>named_struct<span class="token punctuation">(</span><span class="token string">'sku_id'</span><span class="token punctuation">,</span>sku_id<span class="token punctuation">,</span><span class="token string">'sku_num'</span><span class="token punctuation">,</span>sku_num<span class="token punctuation">,</span><span class="token string">'order_count'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token string">'activity_reduce_amount'</span><span class="token punctuation">,</span>activity_reduce_amount<span class="token punctuation">,</span><span class="token string">'coupon_reduce_amount'</span><span class="token punctuation">,</span>coupon_reduce_amount<span class="token punctuation">,</span><span class="token string">'original_amount'</span><span class="token punctuation">,</span>original_amount<span class="token punctuation">,</span><span class="token string">'final_amount'</span><span class="token punctuation">,</span>final_amount<span class="token punctuation">)</span><span class="token punctuation">)</span> order_detail_stats
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
            user_id<span class="token punctuation">,</span>
            sku_id<span class="token punctuation">,</span>
            <span class="token function">sum</span><span class="token punctuation">(</span>sku_num<span class="token punctuation">)</span> sku_num<span class="token punctuation">,</span>
            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
            cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> activity_reduce_amount<span class="token punctuation">,</span>
            cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_reduce_amount<span class="token punctuation">,</span>
            cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> original_amount<span class="token punctuation">,</span>
            cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> final_amount
        <span class="token keyword">from</span> dwd_order_detail
        <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>sku_id
    <span class="token punctuation">)</span>t1
    <span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>user_id
<span class="token punctuation">)</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_user_action_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">select</span>
    <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_ri<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_rp<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_comment<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_coupon<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_od<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    order_detail_stats<span class="token punctuation">,</span>
    <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_ri<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_rp<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_comment<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_coupon<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_od<span class="token punctuation">.</span>dt<span class="token punctuation">)</span>
<span class="token keyword">from</span> tmp_login
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_cf
<span class="token keyword">on</span> tmp_login<span class="token punctuation">.</span>user_id<span class="token operator">=</span>tmp_cf<span class="token punctuation">.</span>user_id
<span class="token operator">and</span> tmp_login<span class="token punctuation">.</span>dt<span class="token operator">=</span>tmp_cf<span class="token punctuation">.</span>dt
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_order
<span class="token keyword">on</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token operator">=</span>tmp_order<span class="token punctuation">.</span>user_id
<span class="token operator">and</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>dt<span class="token punctuation">)</span><span class="token operator">=</span>tmp_order<span class="token punctuation">.</span>dt
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_pay
<span class="token keyword">on</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token operator">=</span>tmp_pay<span class="token punctuation">.</span>user_id
<span class="token operator">and</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>dt<span class="token punctuation">)</span><span class="token operator">=</span>tmp_pay<span class="token punctuation">.</span>dt
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_ri
<span class="token keyword">on</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token operator">=</span>tmp_ri<span class="token punctuation">.</span>user_id
<span class="token operator">and</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>dt<span class="token punctuation">)</span><span class="token operator">=</span>tmp_ri<span class="token punctuation">.</span>dt
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_rp
<span class="token keyword">on</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_ri<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token operator">=</span>tmp_rp<span class="token punctuation">.</span>user_id
<span class="token operator">and</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_ri<span class="token punctuation">.</span>dt<span class="token punctuation">)</span><span class="token operator">=</span>tmp_rp<span class="token punctuation">.</span>dt
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_comment
<span class="token keyword">on</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_ri<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_rp<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token operator">=</span>tmp_comment<span class="token punctuation">.</span>user_id
<span class="token operator">and</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_ri<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_rp<span class="token punctuation">.</span>dt<span class="token punctuation">)</span><span class="token operator">=</span>tmp_comment<span class="token punctuation">.</span>dt
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_coupon
<span class="token keyword">on</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_ri<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_rp<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_comment<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token operator">=</span>tmp_coupon<span class="token punctuation">.</span>user_id
<span class="token operator">and</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_ri<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_rp<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_comment<span class="token punctuation">.</span>dt<span class="token punctuation">)</span><span class="token operator">=</span>tmp_coupon<span class="token punctuation">.</span>dt
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_od
<span class="token keyword">on</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_ri<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_rp<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_comment<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_coupon<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token operator">=</span>tmp_od<span class="token punctuation">.</span>user_id
<span class="token operator">and</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_ri<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_rp<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_comment<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>tmp_coupon<span class="token punctuation">.</span>dt<span class="token punctuation">)</span><span class="token operator">=</span>tmp_od<span class="token punctuation">.</span>dt<span class="token punctuation">;</span><span class="token operator">*</span>
</code></pre>
<p>（2）每日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span>
tmp_login <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        user_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> login_count
    <span class="token keyword">from</span> dwd_page_log
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token operator">and</span> user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
    <span class="token operator">and</span> last_page_id <span class="token operator">is</span> <span class="token boolean">null</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_cf <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        user_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'favor_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_count
    <span class="token keyword">from</span> dwd_action_log
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token operator">and</span> user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
    <span class="token operator">and</span> action_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token string">'favor_add'</span><span class="token punctuation">)</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_order <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        user_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>activity_reduce_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>coupon_reduce_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>activity_reduce_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>coupon_reduce_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>final_amount<span class="token punctuation">)</span> order_final_amount
    <span class="token keyword">from</span> dwd_order_info
    <span class="token keyword">where</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token operator">or</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span>
    <span class="token operator">and</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_pay <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        user_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount
    <span class="token keyword">from</span> dwd_payment_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_ri <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        user_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_order_amount
    <span class="token keyword">from</span> dwd_order_refund_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_rp <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        rp<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>ri<span class="token punctuation">.</span>refund_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>rp<span class="token punctuation">.</span>refund_amount<span class="token punctuation">)</span> refund_payment_amount
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            user_id<span class="token punctuation">,</span>
            order_id<span class="token punctuation">,</span>
            sku_id<span class="token punctuation">,</span>
            refund_amount
        <span class="token keyword">from</span> dwd_refund_payment
        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token punctuation">)</span>rp
    <span class="token keyword">left</span> <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            user_id<span class="token punctuation">,</span>
            order_id<span class="token punctuation">,</span>
            sku_id<span class="token punctuation">,</span>
            refund_num
        <span class="token keyword">from</span> dwd_order_refund_info
        <span class="token keyword">where</span> dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">15</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>ri
    <span class="token keyword">on</span> rp<span class="token punctuation">.</span>order_id<span class="token operator">=</span>ri<span class="token punctuation">.</span>order_id
    <span class="token operator">and</span> rp<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>rp<span class="token punctuation">.</span>sku_id
    <span class="token keyword">group</span> <span class="token keyword">by</span> rp<span class="token punctuation">.</span>user_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_coupon <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        user_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>get_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_get_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>using_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_using_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>used_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_used_count
    <span class="token keyword">from</span> dwd_coupon_use
    <span class="token keyword">where</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span> <span class="token operator">or</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span><span class="token punctuation">)</span>
    <span class="token operator">and</span> <span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>get_time<span class="token punctuation">,</span> <span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'2020-06-15'</span>
    <span class="token operator">or</span> date_format<span class="token punctuation">(</span>using_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token operator">or</span> date_format<span class="token punctuation">(</span>used_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">)</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_comment <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        user_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1201'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1202'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1203'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1204'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_default_count
    <span class="token keyword">from</span> dwd_comment_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_od <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        user_id<span class="token punctuation">,</span>
        collect_set<span class="token punctuation">(</span>named_struct<span class="token punctuation">(</span><span class="token string">'sku_id'</span><span class="token punctuation">,</span>sku_id<span class="token punctuation">,</span><span class="token string">'sku_num'</span><span class="token punctuation">,</span>sku_num<span class="token punctuation">,</span><span class="token string">'order_count'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token string">'activity_reduce_amount'</span><span class="token punctuation">,</span>activity_reduce_amount<span class="token punctuation">,</span><span class="token string">'coupon_reduce_amount'</span><span class="token punctuation">,</span>coupon_reduce_amount<span class="token punctuation">,</span><span class="token string">'original_amount'</span><span class="token punctuation">,</span>original_amount<span class="token punctuation">,</span><span class="token string">'final_amount'</span><span class="token punctuation">,</span>final_amount<span class="token punctuation">)</span><span class="token punctuation">)</span> order_detail_stats
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            user_id<span class="token punctuation">,</span>
            sku_id<span class="token punctuation">,</span>
            <span class="token function">sum</span><span class="token punctuation">(</span>sku_num<span class="token punctuation">)</span> sku_num<span class="token punctuation">,</span>
            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
            cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> activity_reduce_amount<span class="token punctuation">,</span>
            cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_reduce_amount<span class="token punctuation">,</span>
            cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> original_amount<span class="token punctuation">,</span>
            cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> final_amount
        <span class="token keyword">from</span> dwd_order_detail
        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
        <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>sku_id
    <span class="token punctuation">)</span>t1
    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id
<span class="token punctuation">)</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_user_action_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_ri<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_rp<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_comment<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_coupon<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_od<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    order_detail_stats
<span class="token keyword">from</span> tmp_login
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_cf <span class="token keyword">on</span> tmp_login<span class="token punctuation">.</span>user_id<span class="token operator">=</span>tmp_cf<span class="token punctuation">.</span>user_id
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_order <span class="token keyword">on</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token operator">=</span>tmp_order<span class="token punctuation">.</span>user_id
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_pay <span class="token keyword">on</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token operator">=</span>tmp_pay<span class="token punctuation">.</span>user_id
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_ri <span class="token keyword">on</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token operator">=</span>tmp_ri<span class="token punctuation">.</span>user_id
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_rp <span class="token keyword">on</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_ri<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token operator">=</span>tmp_rp<span class="token punctuation">.</span>user_id
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_comment <span class="token keyword">on</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_ri<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_rp<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token operator">=</span>tmp_comment<span class="token punctuation">.</span>user_id
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_coupon <span class="token keyword">on</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_ri<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_rp<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_comment<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token operator">=</span>tmp_coupon<span class="token punctuation">.</span>user_id
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> tmp_od <span class="token keyword">on</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>tmp_login<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_cf<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_order<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_pay<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_ri<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_rp<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_comment<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>tmp_coupon<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token operator">=</span>tmp_od<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
</code></pre>
<p>3）查询加载结果</p>
<h3 id="7-2-3-商品主题"><a href="#7-2-3-商品主题" class="headerlink" title="7.2.3 商品主题"></a>7.2.3 商品主题</h3><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dws_sku_action_daycount<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dws_sku_action_daycount
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'sku_id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被下单件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与活动被下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用优惠券被下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠金额(活动)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠金额(优惠券)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'被下单原价金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'被下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被支付件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'被支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span>  <span class="token keyword">COMMENT</span> <span class="token string">'被退单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被退单件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'被退单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span>  <span class="token keyword">COMMENT</span> <span class="token string">'被退款次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被退款件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'被退款金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>cart_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被加入购物车次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>favor_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被收藏次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'好评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'中评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'差评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'默认评价数'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'每日商品行为'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dws/dws_sku_action_daycount/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）数据装载<br>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span>
tmp_order <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>sku_num<span class="token punctuation">)</span> order_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>split_activity_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>split_coupon_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> order_final_amount
    <span class="token keyword">from</span> dwd_order_detail
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sku_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_pay <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>sku_num<span class="token punctuation">)</span> payment_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> payment_amount
    <span class="token keyword">from</span> dwd_order_detail od
    <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            order_id<span class="token punctuation">,</span>
            callback_time
        <span class="token keyword">from</span> dwd_payment_info
        <span class="token keyword">where</span> callback_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
    <span class="token punctuation">)</span>pi <span class="token keyword">on</span> pi<span class="token punctuation">.</span>order_id<span class="token operator">=</span>od<span class="token punctuation">.</span>order_id
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sku_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_ri <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_order_amount
    <span class="token keyword">from</span> dwd_order_refund_info
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sku_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_rp <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        rp<span class="token punctuation">.</span>sku_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>ri<span class="token punctuation">.</span>refund_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_payment_amount
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            order_id<span class="token punctuation">,</span>
            sku_id<span class="token punctuation">,</span>
            refund_amount<span class="token punctuation">,</span>
            callback_time
        <span class="token keyword">from</span> dwd_refund_payment
    <span class="token punctuation">)</span>rp
    <span class="token keyword">left</span> <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            order_id<span class="token punctuation">,</span>
            sku_id<span class="token punctuation">,</span>
            refund_num
        <span class="token keyword">from</span> dwd_order_refund_info
    <span class="token punctuation">)</span>ri
    <span class="token keyword">on</span> rp<span class="token punctuation">.</span>order_id<span class="token operator">=</span>ri<span class="token punctuation">.</span>order_id
    <span class="token operator">and</span> rp<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>ri<span class="token punctuation">.</span>sku_id
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rp<span class="token punctuation">.</span>sku_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_cf <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        item sku_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'favor_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_count
    <span class="token keyword">from</span> dwd_action_log
    <span class="token keyword">where</span> action_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token string">'favor_add'</span><span class="token punctuation">)</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>item
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_comment <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1201'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1202'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1203'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1204'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_default_count
    <span class="token keyword">from</span> dwd_comment_info
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sku_id
<span class="token punctuation">)</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_sku_action_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">select</span>
    sku_id<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_num<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_num<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_num<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>cart_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>favor_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    dt
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        sku_id<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_num<span class="token punctuation">,</span>
        order_activity_count<span class="token punctuation">,</span>
        order_coupon_count<span class="token punctuation">,</span>
        order_activity_reduce_amount<span class="token punctuation">,</span>
        order_coupon_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>
        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_default_count
    <span class="token keyword">from</span> tmp_order
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_num<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>
        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_default_count
    <span class="token keyword">from</span> tmp_pay
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        refund_order_count<span class="token punctuation">,</span>
        refund_order_num<span class="token punctuation">,</span>
        refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>
        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_default_count
    <span class="token keyword">from</span> tmp_ri
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        refund_payment_count<span class="token punctuation">,</span>
        refund_payment_num<span class="token punctuation">,</span>
        refund_payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>
        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_default_count
    <span class="token keyword">from</span> tmp_rp
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>
        cart_count<span class="token punctuation">,</span>
        favor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_default_count
    <span class="token keyword">from</span> tmp_cf
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>
        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>
        appraise_good_count<span class="token punctuation">,</span>
        appraise_mid_count<span class="token punctuation">,</span>
        appraise_bad_count<span class="token punctuation">,</span>
        appraise_default_count
    <span class="token keyword">from</span> tmp_comment
<span class="token punctuation">)</span>t1
<span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>sku_id<span class="token punctuation">;</span>
</code></pre>
<p>（2）每日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span>
tmp_order <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>sku_num<span class="token punctuation">)</span> order_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>split_activity_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>split_coupon_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> order_final_amount
    <span class="token keyword">from</span> dwd_order_detail
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_pay <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>sku_num<span class="token punctuation">)</span> payment_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> payment_amount
    <span class="token keyword">from</span> dwd_order_detail
    <span class="token keyword">where</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token operator">or</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">and</span> order_id <span class="token operator">in</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span> order_id <span class="token keyword">from</span> dwd_payment_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_ri <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_order_amount
    <span class="token keyword">from</span> dwd_order_refund_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_rp <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        rp<span class="token punctuation">.</span>sku_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>ri<span class="token punctuation">.</span>refund_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_payment_amount
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            order_id<span class="token punctuation">,</span>
            sku_id<span class="token punctuation">,</span>
            refund_amount
        <span class="token keyword">from</span> dwd_refund_payment
        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token punctuation">)</span>rp
    <span class="token keyword">left</span> <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            order_id<span class="token punctuation">,</span>
            sku_id<span class="token punctuation">,</span>
            refund_num
        <span class="token keyword">from</span> dwd_order_refund_info
        <span class="token keyword">where</span> dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">15</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>ri
    <span class="token keyword">on</span> rp<span class="token punctuation">.</span>order_id<span class="token operator">=</span>ri<span class="token punctuation">.</span>order_id
    <span class="token operator">and</span> rp<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>ri<span class="token punctuation">.</span>sku_id
    <span class="token keyword">group</span> <span class="token keyword">by</span> rp<span class="token punctuation">.</span>sku_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_cf <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        item sku_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>action_id<span class="token operator">=</span><span class="token string">'favor_add'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_count
    <span class="token keyword">from</span> dwd_action_log
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token operator">and</span> action_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'cart_add'</span><span class="token punctuation">,</span><span class="token string">'favor_add'</span><span class="token punctuation">)</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> item
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_comment <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1201'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1202'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1203'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>appraise<span class="token operator">=</span><span class="token string">'1204'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_default_count
    <span class="token keyword">from</span> dwd_comment_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id
<span class="token punctuation">)</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_sku_action_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    sku_id<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_num<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_num<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_num<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>cart_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>favor_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        sku_id<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_num<span class="token punctuation">,</span>
        order_activity_count<span class="token punctuation">,</span>
        order_coupon_count<span class="token punctuation">,</span>
        order_activity_reduce_amount<span class="token punctuation">,</span>
        order_coupon_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>
        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_default_count
    <span class="token keyword">from</span> tmp_order
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_num<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>
        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_default_count
    <span class="token keyword">from</span> tmp_pay
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        refund_order_count<span class="token punctuation">,</span>
        refund_order_num<span class="token punctuation">,</span>
        refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>
        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_default_count
    <span class="token keyword">from</span> tmp_ri
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        refund_payment_count<span class="token punctuation">,</span>
        refund_payment_num<span class="token punctuation">,</span>
        refund_payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>
        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_default_count
    <span class="token keyword">from</span> tmp_rp
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>
        cart_count<span class="token punctuation">,</span>
        favor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_good_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_mid_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_bad_count<span class="token punctuation">,</span>
        <span class="token number">0</span> appraise_default_count
    <span class="token keyword">from</span> tmp_cf
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_activity_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_coupon_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_num<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> cart_count<span class="token punctuation">,</span>
        <span class="token number">0</span> favor_count<span class="token punctuation">,</span>
        appraise_good_count<span class="token punctuation">,</span>
        appraise_mid_count<span class="token punctuation">,</span>
        appraise_bad_count<span class="token punctuation">,</span>
        appraise_default_count
    <span class="token keyword">from</span> tmp_comment
<span class="token punctuation">)</span>t1
<span class="token keyword">group</span> <span class="token keyword">by</span> sku_id<span class="token punctuation">;</span>
</code></pre>
<p>3）查询加载结果</p>
<h3 id="7-2-4-优惠券主题"><a href="#7-2-4-优惠券主题" class="headerlink" title="7.2.4 优惠券主题"></a>7.2.4 优惠券主题</h3><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dws_coupon_info_daycount<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dws_coupon_info_daycount<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>coupon_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>get_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被领取次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被使用(下单)次数'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>order_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用券下单优惠金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用券订单原价金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用券下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'被使用(支付)次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用券支付优惠金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用券支付总金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>expire_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'过期次数'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'每日活动统计'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dws/dws_coupon_info_daycount/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）数据装载<br>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span>
tmp_cu <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        <span class="token keyword">coalesce</span><span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_used<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_exprie<span class="token punctuation">.</span>dt<span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        <span class="token keyword">coalesce</span><span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>coupon_used<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>coupon_exprie<span class="token punctuation">.</span>coupon_id<span class="token punctuation">)</span> coupon_id<span class="token punctuation">,</span>
        nvl<span class="token punctuation">(</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> get_count<span class="token punctuation">,</span>
        nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>
        nvl<span class="token punctuation">(</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> expire_count
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            date_format<span class="token punctuation">(</span>get_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
            coupon_id<span class="token punctuation">,</span>
            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> get_count
        <span class="token keyword">from</span> dwd_coupon_use
        <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>get_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_id
    <span class="token punctuation">)</span>coupon_get
    <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            date_format<span class="token punctuation">(</span>using_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
            coupon_id<span class="token punctuation">,</span>
            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count
        <span class="token keyword">from</span> dwd_coupon_use
        <span class="token keyword">where</span> using_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
        <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>using_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_id
    <span class="token punctuation">)</span>coupon_using
    <span class="token keyword">on</span> coupon_get<span class="token punctuation">.</span>dt<span class="token operator">=</span>coupon_using<span class="token punctuation">.</span>dt
    <span class="token operator">and</span> coupon_get<span class="token punctuation">.</span>coupon_id<span class="token operator">=</span>coupon_using<span class="token punctuation">.</span>coupon_id
    <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            date_format<span class="token punctuation">(</span>used_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
            coupon_id<span class="token punctuation">,</span>
            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count
        <span class="token keyword">from</span> dwd_coupon_use
        <span class="token keyword">where</span> used_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
        <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>used_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_id
    <span class="token punctuation">)</span>coupon_used
    <span class="token keyword">on</span> nvl<span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>dt<span class="token punctuation">)</span><span class="token operator">=</span>coupon_used<span class="token punctuation">.</span>dt
    <span class="token operator">and</span> nvl<span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>coupon_id<span class="token punctuation">)</span><span class="token operator">=</span>coupon_used<span class="token punctuation">.</span>coupon_id
    <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            date_format<span class="token punctuation">(</span>expire_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
            coupon_id<span class="token punctuation">,</span>
            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> expire_count
        <span class="token keyword">from</span> dwd_coupon_use
        <span class="token keyword">where</span> expire_time <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
        <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>expire_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_id
    <span class="token punctuation">)</span>coupon_exprie
    <span class="token keyword">on</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>coupon_used<span class="token punctuation">.</span>dt<span class="token punctuation">)</span><span class="token operator">=</span>coupon_exprie<span class="token punctuation">.</span>dt
    <span class="token operator">and</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>coupon_get<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>coupon_using<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>coupon_used<span class="token punctuation">.</span>coupon_id<span class="token punctuation">)</span><span class="token operator">=</span>coupon_exprie<span class="token punctuation">.</span>coupon_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_order <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        coupon_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> order_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> order_final_amount
    <span class="token keyword">from</span> dwd_order_detail
    <span class="token keyword">where</span> coupon_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_pay <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        coupon_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> payment_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> payment_amount
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            order_id<span class="token punctuation">,</span>
            coupon_id<span class="token punctuation">,</span>
            split_coupon_amount<span class="token punctuation">,</span>
            split_final_amount
        <span class="token keyword">from</span> dwd_order_detail
        <span class="token keyword">where</span> coupon_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
    <span class="token punctuation">)</span>od
    <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            order_id<span class="token punctuation">,</span>
            callback_time
        <span class="token keyword">from</span> dwd_payment_info
    <span class="token punctuation">)</span>pi
    <span class="token keyword">on</span> od<span class="token punctuation">.</span>order_id<span class="token operator">=</span>pi<span class="token punctuation">.</span>order_id
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_id
<span class="token punctuation">)</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_coupon_info_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">select</span>
    coupon_id<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>get_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>expire_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    dt
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        coupon_id<span class="token punctuation">,</span>
        get_count<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        expire_count
    <span class="token keyword">from</span> tmp_cu
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        coupon_id<span class="token punctuation">,</span>
        <span class="token number">0</span> get_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        order_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> expire_count
    <span class="token keyword">from</span> tmp_order
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        coupon_id<span class="token punctuation">,</span>
        <span class="token number">0</span> get_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        payment_reduce_amount<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> expire_count
    <span class="token keyword">from</span> tmp_pay
<span class="token punctuation">)</span>t1
<span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>coupon_id<span class="token punctuation">;</span>
</code></pre>
<p>（2）每日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span>
tmp_cu <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        coupon_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>get_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> get_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>using_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>used_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>date_format<span class="token punctuation">(</span>expire_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> expire_count
    <span class="token keyword">from</span> dwd_coupon_use
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span>
    <span class="token operator">or</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> coupon_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_order <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        coupon_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> order_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> order_final_amount
    <span class="token keyword">from</span> dwd_order_detail
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token operator">and</span> coupon_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> coupon_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_pay <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        coupon_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_coupon_amount<span class="token punctuation">)</span> payment_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> payment_amount
    <span class="token keyword">from</span> dwd_order_detail
    <span class="token keyword">where</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token operator">or</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">and</span> coupon_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
    <span class="token operator">and</span> order_id <span class="token operator">in</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span> order_id <span class="token keyword">from</span> dwd_payment_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> coupon_id
<span class="token punctuation">)</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_coupon_info_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    coupon_id<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>get_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>expire_count<span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        coupon_id<span class="token punctuation">,</span>
        get_count<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        expire_count
    <span class="token keyword">from</span> tmp_cu
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        coupon_id<span class="token punctuation">,</span>
        <span class="token number">0</span> get_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        order_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> expire_count
    <span class="token keyword">from</span> tmp_order
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        coupon_id<span class="token punctuation">,</span>
        <span class="token number">0</span> get_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        payment_reduce_amount<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> expire_count
    <span class="token keyword">from</span> tmp_pay
<span class="token punctuation">)</span>t1
<span class="token keyword">group</span> <span class="token keyword">by</span> coupon_id<span class="token punctuation">;</span>
</code></pre>
<p>3）查询加载结果</p>
<h3 id="7-2-5-活动主题"><a href="#7-2-5-活动主题" class="headerlink" title="7.2.5 活动主题"></a>7.2.5 活动主题</h3><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dws_activity_info_daycount<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dws_activity_info_daycount<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>activity_rule_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动规则ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则下单次数'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>order_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则下单减免金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则下单原始金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则支付减免金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则支付金额'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'每日活动统计'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dws/dws_activity_info_daycount/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）数据装载<br>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span>
tmp_order <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        activity_rule_id<span class="token punctuation">,</span>
        activity_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> order_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> order_final_amount
    <span class="token keyword">from</span> dwd_order_detail
    <span class="token keyword">where</span> activity_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>activity_rule_id<span class="token punctuation">,</span>activity_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_pay <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        activity_rule_id<span class="token punctuation">,</span>
        activity_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> payment_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> payment_amount
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            activity_rule_id<span class="token punctuation">,</span>
            activity_id<span class="token punctuation">,</span>
            order_id<span class="token punctuation">,</span>
            split_activity_amount<span class="token punctuation">,</span>
            split_final_amount
        <span class="token keyword">from</span> dwd_order_detail
        <span class="token keyword">where</span> activity_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
    <span class="token punctuation">)</span>od
    <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            order_id<span class="token punctuation">,</span>
            callback_time
        <span class="token keyword">from</span> dwd_payment_info
    <span class="token punctuation">)</span>pi
    <span class="token keyword">on</span> od<span class="token punctuation">.</span>order_id<span class="token operator">=</span>pi<span class="token punctuation">.</span>order_id
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>activity_rule_id<span class="token punctuation">,</span>activity_id
<span class="token punctuation">)</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_activity_info_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">select</span>
    activity_rule_id<span class="token punctuation">,</span>
    activity_id<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    dt
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        activity_rule_id<span class="token punctuation">,</span>
        activity_id<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount
    <span class="token keyword">from</span> tmp_order
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        activity_rule_id<span class="token punctuation">,</span>
        activity_id<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_reduce_amount<span class="token punctuation">,</span>
        payment_amount
    <span class="token keyword">from</span> tmp_pay
<span class="token punctuation">)</span>t1
<span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>activity_rule_id<span class="token punctuation">,</span>activity_id<span class="token punctuation">;</span>
</code></pre>
<p>（2）每日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span>
tmp_order <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        activity_rule_id<span class="token punctuation">,</span>
        activity_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> order_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> order_final_amount
    <span class="token keyword">from</span> dwd_order_detail
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token operator">and</span> activity_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> activity_rule_id<span class="token punctuation">,</span>activity_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_pay <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        activity_rule_id<span class="token punctuation">,</span>
        activity_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_activity_amount<span class="token punctuation">)</span> payment_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>split_final_amount<span class="token punctuation">)</span> payment_amount
    <span class="token keyword">from</span> dwd_order_detail
    <span class="token keyword">where</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token operator">or</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">and</span> activity_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
    <span class="token operator">and</span> order_id <span class="token operator">in</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span> order_id <span class="token keyword">from</span> dwd_payment_info <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> activity_rule_id<span class="token punctuation">,</span>activity_id
<span class="token punctuation">)</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_activity_info_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    activity_rule_id<span class="token punctuation">,</span>
    activity_id<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        activity_rule_id<span class="token punctuation">,</span>
        activity_id<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount
    <span class="token keyword">from</span> tmp_order
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        activity_rule_id<span class="token punctuation">,</span>
        activity_id<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_reduce_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_reduce_amount<span class="token punctuation">,</span>
        payment_amount
    <span class="token keyword">from</span> tmp_pay
<span class="token punctuation">)</span>t1
<span class="token keyword">group</span> <span class="token keyword">by</span> activity_rule_id<span class="token punctuation">,</span>activity_id<span class="token punctuation">;</span>
</code></pre>
<p>3）查询加载结果</p>
<h3 id="7-2-6-地区主题"><a href="#7-2-6-地区主题" class="headerlink" title="7.2.6 地区主题"></a>7.2.6 地区主题</h3><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dws_area_stats_daycount<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dws_area_stats_daycount<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visit_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'访问次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>login_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'登录次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visitor_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'访客人数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户人数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单原始金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款金额'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'每日地区统计表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dws/dws_area_stats_daycount/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）数据装载<br>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span>
tmp_vu <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        id province_id<span class="token punctuation">,</span>
        visit_count<span class="token punctuation">,</span>
        login_count<span class="token punctuation">,</span>
        visitor_count<span class="token punctuation">,</span>
        user_count
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            dt<span class="token punctuation">,</span>
            area_code<span class="token punctuation">,</span>
            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> visit_count<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--访客访问次数</span>
            <span class="token function">count</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> login_count<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--用户访问次数,等价于sum(if(user_id is not null,1,0))</span>
            <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span><span class="token punctuation">(</span>mid_id<span class="token punctuation">)</span><span class="token punctuation">)</span> visitor_count<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--访客人数</span>
            <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span> user_count<span class="token comment" spellcheck="true">--用户人数</span>
        <span class="token keyword">from</span> dwd_page_log
        <span class="token keyword">where</span> last_page_id <span class="token operator">is</span> <span class="token boolean">null</span>
        <span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>area_code
    <span class="token punctuation">)</span>tmp
    <span class="token keyword">left</span> <span class="token keyword">join</span> dim_base_province area
    <span class="token keyword">on</span> tmp<span class="token punctuation">.</span>area_code<span class="token operator">=</span>area<span class="token punctuation">.</span>area_code
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_order <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        province_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>final_amount<span class="token punctuation">)</span> order_final_amount
    <span class="token keyword">from</span> dwd_order_info
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>province_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_pay <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        province_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount
    <span class="token keyword">from</span> dwd_payment_info
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>province_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_ro <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        province_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_order_amount
    <span class="token keyword">from</span> dwd_order_refund_info
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>province_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_rp <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> dt<span class="token punctuation">,</span>
        province_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_payment_amount
    <span class="token keyword">from</span> dwd_refund_payment
    <span class="token keyword">group</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>callback_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>province_id
<span class="token punctuation">)</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_area_stats_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">select</span>
    province_id<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>visit_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>login_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>visitor_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>user_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    dt
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        province_id<span class="token punctuation">,</span>
        visit_count<span class="token punctuation">,</span>
        login_count<span class="token punctuation">,</span>
        visitor_count<span class="token punctuation">,</span>
        user_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount
    <span class="token keyword">from</span> tmp_vu
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        province_id<span class="token punctuation">,</span>
        <span class="token number">0</span> visit_count<span class="token punctuation">,</span>
        <span class="token number">0</span> login_count<span class="token punctuation">,</span>
        <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> user_count<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount
    <span class="token keyword">from</span> tmp_order
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        province_id<span class="token punctuation">,</span>
        <span class="token number">0</span> visit_count<span class="token punctuation">,</span>
        <span class="token number">0</span> login_count<span class="token punctuation">,</span>
        <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> user_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount
    <span class="token keyword">from</span> tmp_pay
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        province_id<span class="token punctuation">,</span>
        <span class="token number">0</span> visit_count<span class="token punctuation">,</span>
        <span class="token number">0</span> login_count<span class="token punctuation">,</span>
        <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> user_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        refund_order_count<span class="token punctuation">,</span>
        refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount
    <span class="token keyword">from</span> tmp_ro
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        dt<span class="token punctuation">,</span>
        province_id<span class="token punctuation">,</span>
        <span class="token number">0</span> visit_count<span class="token punctuation">,</span>
        <span class="token number">0</span> login_count<span class="token punctuation">,</span>
        <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> user_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        refund_payment_count<span class="token punctuation">,</span>
        refund_payment_amount
    <span class="token keyword">from</span> tmp_rp
<span class="token punctuation">)</span>t1
<span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">,</span>province_id<span class="token punctuation">;</span>
</code></pre>
<p>（2）每日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span>
tmp_vu <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id province_id<span class="token punctuation">,</span>
        visit_count<span class="token punctuation">,</span>
        login_count<span class="token punctuation">,</span>
        visitor_count<span class="token punctuation">,</span>
        user_count
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            area_code<span class="token punctuation">,</span>
            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span>

<span class="token punctuation">)</span> visit_count<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--访客访问次数</span>
            <span class="token function">count</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> login_count<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--用户访问次数,等价于sum(if(user_id is not null,1,0))</span>
            <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span><span class="token punctuation">(</span>mid_id<span class="token punctuation">)</span><span class="token punctuation">)</span> visitor_count<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--访客人数</span>
            <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span> user_count<span class="token comment" spellcheck="true">--用户人数</span>
        <span class="token keyword">from</span> dwd_page_log
        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
        <span class="token operator">and</span> last_page_id <span class="token operator">is</span> <span class="token boolean">null</span>
        <span class="token keyword">group</span> <span class="token keyword">by</span> area_code
    <span class="token punctuation">)</span>tmp
    <span class="token keyword">left</span> <span class="token keyword">join</span> dim_base_province area
    <span class="token keyword">on</span> tmp<span class="token punctuation">.</span>area_code<span class="token operator">=</span>area<span class="token punctuation">.</span>area_code
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_order <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        province_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>final_amount<span class="token punctuation">)</span> order_final_amount
    <span class="token keyword">from</span> dwd_order_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token operator">or</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span>
    <span class="token operator">and</span> date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> province_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_pay <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        province_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount
    <span class="token keyword">from</span> dwd_payment_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> province_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_ro <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        province_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_order_amount
    <span class="token keyword">from</span> dwd_order_refund_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> province_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_rp <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        province_id<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_amount<span class="token punctuation">)</span> refund_payment_amount
    <span class="token keyword">from</span> dwd_refund_payment
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> province_id
<span class="token punctuation">)</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dws_area_stats_daycount <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    province_id<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>visit_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>login_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>visitor_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>user_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        province_id<span class="token punctuation">,</span>
        visit_count<span class="token punctuation">,</span>
        login_count<span class="token punctuation">,</span>
        visitor_count<span class="token punctuation">,</span>
        user_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount
    <span class="token keyword">from</span> tmp_vu
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        province_id<span class="token punctuation">,</span>
        <span class="token number">0</span> visit_count<span class="token punctuation">,</span>
        <span class="token number">0</span> login_count<span class="token punctuation">,</span>
        <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> user_count<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount
    <span class="token keyword">from</span> tmp_order
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        province_id<span class="token punctuation">,</span>
        <span class="token number">0</span> visit_count<span class="token punctuation">,</span>
        <span class="token number">0</span> login_count<span class="token punctuation">,</span>
        <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> user_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount
    <span class="token keyword">from</span> tmp_pay
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        province_id<span class="token punctuation">,</span>
        <span class="token number">0</span> visit_count<span class="token punctuation">,</span>
        <span class="token number">0</span> login_count<span class="token punctuation">,</span>
        <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> user_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        refund_order_count<span class="token punctuation">,</span>
        refund_order_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_payment_amount
    <span class="token keyword">from</span> tmp_ro
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span>
        province_id<span class="token punctuation">,</span>
        <span class="token number">0</span> visit_count<span class="token punctuation">,</span>
        <span class="token number">0</span> login_count<span class="token punctuation">,</span>
        <span class="token number">0</span> visitor_count<span class="token punctuation">,</span>
        <span class="token number">0</span> user_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_count<span class="token punctuation">,</span>
        <span class="token number">0</span> payment_amount<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token number">0</span> refund_order_amount<span class="token punctuation">,</span>
        refund_payment_count<span class="token punctuation">,</span>
        refund_payment_amount
    <span class="token keyword">from</span> tmp_rp
<span class="token punctuation">)</span>t1
<span class="token keyword">group</span> <span class="token keyword">by</span> province_id<span class="token punctuation">;</span>
</code></pre>
<p>3）查询加载结果</p>
<h3 id="7-2-7-DWS层首日数据装载脚本"><a href="#7-2-7-DWS层首日数据装载脚本" class="headerlink" title="7.2.7 DWS层首日数据装载脚本"></a>7.2.7 DWS层首日数据装载脚本</h3><p>1）编写脚本<br>（1）在/home/atguigu/bin目录下创建脚本dwd_to_dws_init.sh</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash

APP=gmall

if [ -n "$2" ] ;then
   do_date=$2
else 
   echo "请传入日期参数"
   exit
fi

dws_visitor_action_daycount="
insert overwrite table ${APP}.dws_visitor_action_daycount partition(dt='$do_date')
select
    t1.mid_id,
    t1.brand,
    t1.model,
    t1.is_new,
    t1.channel,
    t1.os,
    t1.area_code,
    t1.version_code,
    t1.visit_count,
    t3.page_stats
from
(
    select
        mid_id,
        brand,
        model,
        if(array_contains(collect_set(is_new),'0'),'0','1') is_new,--ods_page_log中，同一天内，同一设备的is_new字段，可能全部为1，可能全部为0，也可能部分为0，部分为1(卸载重装),故做该处理
        collect_set(channel) channel,
        collect_set(os) os,
        collect_set(area_code) area_code,
        collect_set(version_code) version_code,
        sum(if(last_page_id is null,1,0)) visit_count
    from ${APP}.dwd_page_log
    where dt='$do_date'
    and last_page_id is null
    group by mid_id,model,brand
)t1
join
(
    select
        mid_id,
        brand,
        model,
        collect_set(named_struct('page_id',page_id,'page_count',page_count,'during_time',during_time)) page_stats
    from
    (
        select
            mid_id,
            brand,
            model,
            page_id,
            count(*) page_count,
            sum(during_time) during_time
        from ${APP}.dwd_page_log
        where dt='$do_date'
        group by mid_id,model,brand,page_id
    )t2
    group by mid_id,model,brand
)t3
on t1.mid_id=t3.mid_id
and t1.brand=t3.brand
and t1.model=t3.model;
"

dws_area_stats_daycount="
set hive.exec.dynamic.partition.mode=nonstrict;
with
tmp_vu as
(
    select
        dt,
        id province_id,
        visit_count,
        login_count,
        visitor_count,
        user_count
    from
    (
        select
            dt,
            area_code,
            count(*) visit_count,--访客访问次数
            count(user_id) login_count,--用户访问次数,等价于sum(if(user_id is not null,1,0))
            count(distinct(mid_id)) visitor_count,--访客人数
            count(distinct(user_id)) user_count--用户人数
        from ${APP}.dwd_page_log
        where last_page_id is null
        group by dt,area_code
    )tmp
    left join ${APP}.dim_base_province area
    on tmp.area_code=area.area_code
),
tmp_order as
(
    select
        date_format(create_time,'yyyy-MM-dd') dt,
        province_id,
        count(*) order_count,
        sum(original_amount) order_original_amount,
        sum(final_amount) order_final_amount
    from ${APP}.dwd_order_info
    group by date_format(create_time,'yyyy-MM-dd'),province_id
),
tmp_pay as
(
    select
        date_format(callback_time,'yyyy-MM-dd') dt,
        province_id,
        count(*) payment_count,
        sum(payment_amount) payment_amount
    from ${APP}.dwd_payment_info
    group by date_format(callback_time,'yyyy-MM-dd'),province_id
),
tmp_ro as
(
    select
        date_format(create_time,'yyyy-MM-dd') dt,
        province_id,
        count(*) refund_order_count,
        sum(refund_amount) refund_order_amount
    from ${APP}.dwd_order_refund_info
    group by date_format(create_time,'yyyy-MM-dd'),province_id
),
tmp_rp as
(
    select
        date_format(callback_time,'yyyy-MM-dd') dt,
        province_id,
        count(*) refund_payment_count,
        sum(refund_amount) refund_payment_amount
    from ${APP}.dwd_refund_payment
    group by date_format(callback_time,'yyyy-MM-dd'),province_id
)
insert overwrite table ${APP}.dws_area_stats_daycount partition(dt)
select
    province_id,
    sum(visit_count),
    sum(login_count),
    sum(visitor_count),
    sum(user_count),
    sum(order_count),
    sum(order_original_amount),
    sum(order_final_amount),
    sum(payment_count),
    sum(payment_amount),
    sum(refund_order_count),
    sum(refund_order_amount),
    sum(refund_payment_count),
    sum(refund_payment_amount),
    dt
from
(
    select
        dt,
        province_id,
        visit_count,
        login_count,
        visitor_count,
        user_count,
        0 order_count,
        0 order_original_amount,
        0 order_final_amount,
        0 payment_count,
        0 payment_amount,
        0 refund_order_count,
        0 refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_amount
    from tmp_vu
    union all
    select
        dt,
        province_id,
        0 visit_count,
        0 login_count,
        0 visitor_count,
        0 user_count,
        order_count,
        order_original_amount,
        order_final_amount,
        0 payment_count,
        0 payment_amount,
        0 refund_order_count,
        0 refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_amount
    from tmp_order
    union all
    select
        dt,
        province_id,
        0 visit_count,
        0 login_count,
        0 visitor_count,
        0 user_count,
        0 order_count,
        0 order_original_amount,
        0 order_final_amount,
        payment_count,
        payment_amount,
        0 refund_order_count,
        0 refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_amount
    from tmp_pay
    union all
    select
        dt,
        province_id,
        0 visit_count,
        0 login_count,
        0 visitor_count,
        0 user_count,
        0 order_count,
        0 order_original_amount,
        0 order_final_amount,
        0 payment_count,
        0 payment_amount,
        refund_order_count,
        refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_amount
    from tmp_ro
    union all
    select
        dt,
        province_id,
        0 visit_count,
        0 login_count,
        0 visitor_count,
        0 user_count,
        0 order_count,
        0 order_original_amount,
        0 order_final_amount,
        0 payment_count,
        0 payment_amount,
        0 refund_order_count,
        0 refund_order_amount,
        refund_payment_count,
        refund_payment_amount
    from tmp_rp
)t1
group by dt,province_id;
"

dws_user_action_daycount="
set hive.exec.dynamic.partition.mode=nonstrict;
with
tmp_login as
(
    select
        dt,
        user_id,
        count(*) login_count
    from ${APP}.dwd_page_log
    where user_id is not null
    and last_page_id is null
    group by dt,user_id
),
tmp_cf as
(
    select
        dt,
        user_id,
        sum(if(action_id='cart_add',1,0)) cart_count,
        sum(if(action_id='favor_add',1,0)) favor_count
    from ${APP}.dwd_action_log
    where user_id is not null
    and action_id in ('cart_add','favor_add')
    group by dt,user_id
),
tmp_order as
(
    select
        date_format(create_time,'yyyy-MM-dd') dt,
        user_id,
        count(*) order_count,
        sum(if(activity_reduce_amount>0,1,0)) order_activity_count,
        sum(if(coupon_reduce_amount>0,1,0)) order_coupon_count,
        sum(activity_reduce_amount) order_activity_reduce_amount,
        sum(coupon_reduce_amount) order_coupon_reduce_amount,
        sum(original_amount) order_original_amount,
        sum(final_amount) order_final_amount
    from ${APP}.dwd_order_info
    group by date_format(create_time,'yyyy-MM-dd'),user_id
),
tmp_pay as
(
    select
        date_format(callback_time,'yyyy-MM-dd') dt,
        user_id,
        count(*) payment_count,
        sum(payment_amount) payment_amount
    from ${APP}.dwd_payment_info
    group by date_format(callback_time,'yyyy-MM-dd'),user_id
),
tmp_ri as
(
    select
        date_format(create_time,'yyyy-MM-dd') dt,
        user_id,
        count(*) refund_order_count,
        sum(refund_num) refund_order_num,
        sum(refund_amount) refund_order_amount
    from ${APP}.dwd_order_refund_info
    group by date_format(create_time,'yyyy-MM-dd'),user_id
),
tmp_rp as
(
    select
        date_format(callback_time,'yyyy-MM-dd') dt,
        rp.user_id,
        count(*) refund_payment_count,
        sum(ri.refund_num) refund_payment_num,
        sum(rp.refund_amount) refund_payment_amount
    from
    (
        select
            user_id,
            order_id,
            sku_id,
            refund_amount,
            callback_time
        from ${APP}.dwd_refund_payment
    )rp
    left join
    (
        select
            user_id,
            order_id,
            sku_id,
            refund_num
        from ${APP}.dwd_order_refund_info
    )ri
    on rp.order_id=ri.order_id
    and rp.sku_id=rp.sku_id
    group by date_format(callback_time,'yyyy-MM-dd'),rp.user_id
),
tmp_coupon as
(
    select
        coalesce(coupon_get.dt,coupon_using.dt,coupon_used.dt) dt,
        coalesce(coupon_get.user_id,coupon_using.user_id,coupon_used.user_id) user_id,
        nvl(coupon_get_count,0) coupon_get_count,
        nvl(coupon_using_count,0) coupon_using_count,
        nvl(coupon_used_count,0) coupon_used_count
    from
    (
        select
            date_format(get_time,'yyyy-MM-dd') dt,
            user_id,
            count(*) coupon_get_count
        from ${APP}.dwd_coupon_use
        where get_time is not null
        group by user_id,date_format(get_time,'yyyy-MM-dd')
    )coupon_get
    full outer join
    (
        select
            date_format(using_time,'yyyy-MM-dd') dt,
            user_id,
            count(*) coupon_using_count
        from ${APP}.dwd_coupon_use
        where using_time is not null
        group by user_id,date_format(using_time,'yyyy-MM-dd')
    )coupon_using
    on coupon_get.dt=coupon_using.dt
    and coupon_get.user_id=coupon_using.user_id
    full outer join
    (
        select
            date_format(used_time,'yyyy-MM-dd') dt,
            user_id,
            count(*) coupon_used_count
        from ${APP}.dwd_coupon_use
        where used_time is not null
        group by user_id,date_format(used_time,'yyyy-MM-dd')
    )coupon_used
    on nvl(coupon_get.dt,coupon_using.dt)=coupon_used.dt
    and nvl(coupon_get.user_id,coupon_using.user_id)=coupon_used.user_id
),
tmp_comment as
(
    select
        date_format(create_time,'yyyy-MM-dd') dt,
        user_id,
        sum(if(appraise='1201',1,0)) appraise_good_count,
        sum(if(appraise='1202',1,0)) appraise_mid_count,
        sum(if(appraise='1203',1,0)) appraise_bad_count,
        sum(if(appraise='1204',1,0)) appraise_default_count
    from ${APP}.dwd_comment_info
    group by date_format(create_time,'yyyy-MM-dd'),user_id
),
tmp_od as
(
    select
        dt,
        user_id,
        collect_set(named_struct('sku_id',sku_id,'sku_num',sku_num,'order_count',order_count,'activity_reduce_amount',activity_reduce_amount,'coupon_reduce_amount',coupon_reduce_amount,'original_amount',original_amount,'final_amount',final_amount)) order_detail_stats
    from
    (
        select
            date_format(create_time,'yyyy-MM-dd') dt,
            user_id,
            sku_id,
            sum(sku_num) sku_num,
            count(*) order_count,
            cast(sum(split_activity_amount) as decimal(16,2)) activity_reduce_amount,
            cast(sum(split_coupon_amount) as decimal(16,2)) coupon_reduce_amount,
            cast(sum(original_amount) as decimal(16,2)) original_amount,
            cast(sum(split_final_amount) as decimal(16,2)) final_amount
        from ${APP}.dwd_order_detail
        group by date_format(create_time,'yyyy-MM-dd'),user_id,sku_id
    )t1
    group by dt,user_id
)
insert overwrite table ${APP}.dws_user_action_daycount partition(dt)
select
    coalesce(tmp_login.user_id,tmp_cf.user_id,tmp_order.user_id,tmp_pay.user_id,tmp_ri.user_id,tmp_rp.user_id,tmp_comment.user_id,tmp_coupon.user_id,tmp_od.user_id),
    nvl(login_count,0),
    nvl(cart_count,0),
    nvl(favor_count,0),
    nvl(order_count,0),
    nvl(order_activity_count,0),
    nvl(order_activity_reduce_amount,0),
    nvl(order_coupon_count,0),
    nvl(order_coupon_reduce_amount,0),
    nvl(order_original_amount,0),
    nvl(order_final_amount,0),
    nvl(payment_count,0),
    nvl(payment_amount,0),
    nvl(refund_order_count,0),
    nvl(refund_order_num,0),
    nvl(refund_order_amount,0),
    nvl(refund_payment_count,0),
    nvl(refund_payment_num,0),
    nvl(refund_payment_amount,0),
    nvl(coupon_get_count,0),
    nvl(coupon_using_count,0),
    nvl(coupon_used_count,0),
    nvl(appraise_good_count,0),
    nvl(appraise_mid_count,0),
    nvl(appraise_bad_count,0),
    nvl(appraise_default_count,0),
    order_detail_stats,
    coalesce(tmp_login.dt,tmp_cf.dt,tmp_order.dt,tmp_pay.dt,tmp_ri.dt,tmp_rp.dt,tmp_comment.dt,tmp_coupon.dt,tmp_od.dt)
from tmp_login
full outer join tmp_cf
on tmp_login.user_id=tmp_cf.user_id
and tmp_login.dt=tmp_cf.dt
full outer join tmp_order
on coalesce(tmp_login.user_id,tmp_cf.user_id)=tmp_order.user_id
and coalesce(tmp_login.dt,tmp_cf.dt)=tmp_order.dt
full outer join tmp_pay
on coalesce(tmp_login.user_id,tmp_cf.user_id,tmp_order.user_id)=tmp_pay.user_id
and coalesce(tmp_login.dt,tmp_cf.dt,tmp_order.dt)=tmp_pay.dt
full outer join tmp_ri
on coalesce(tmp_login.user_id,tmp_cf.user_id,tmp_order.user_id,tmp_pay.user_id)=tmp_ri.user_id
and coalesce(tmp_login.dt,tmp_cf.dt,tmp_order.dt,tmp_pay.dt)=tmp_ri.dt
full outer join tmp_rp
on coalesce(tmp_login.user_id,tmp_cf.user_id,tmp_order.user_id,tmp_pay.user_id,tmp_ri.user_id)=tmp_rp.user_id
and coalesce(tmp_login.dt,tmp_cf.dt,tmp_order.dt,tmp_pay.dt,tmp_ri.dt)=tmp_rp.dt
full outer join tmp_comment
on coalesce(tmp_login.user_id,tmp_cf.user_id,tmp_order.user_id,tmp_pay.user_id,tmp_ri.user_id,tmp_rp.user_id)=tmp_comment.user_id
and coalesce(tmp_login.dt,tmp_cf.dt,tmp_order.dt,tmp_pay.dt,tmp_ri.dt,tmp_rp.dt)=tmp_comment.dt
full outer join tmp_coupon
on coalesce(tmp_login.user_id,tmp_cf.user_id,tmp_order.user_id,tmp_pay.user_id,tmp_ri.user_id,tmp_rp.user_id,tmp_comment.user_id)=tmp_coupon.user_id
and coalesce(tmp_login.dt,tmp_cf.dt,tmp_order.dt,tmp_pay.dt,tmp_ri.dt,tmp_rp.dt,tmp_comment.dt)=tmp_coupon.dt
full outer join tmp_od
on coalesce(tmp_login.user_id,tmp_cf.user_id,tmp_order.user_id,tmp_pay.user_id,tmp_ri.user_id,tmp_rp.user_id,tmp_comment.user_id,tmp_coupon.user_id)=tmp_od.user_id
and coalesce(tmp_login.dt,tmp_cf.dt,tmp_order.dt,tmp_pay.dt,tmp_ri.dt,tmp_rp.dt,tmp_comment.dt,tmp_coupon.dt)=tmp_od.dt;
"

dws_activity_info_daycount="
set hive.exec.dynamic.partition.mode=nonstrict;
with
tmp_order as
(
    select
        date_format(create_time,'yyyy-MM-dd') dt,
        activity_rule_id,
        activity_id,
        count(*) order_count,
        sum(split_activity_amount) order_reduce_amount,
        sum(original_amount) order_original_amount,
        sum(split_final_amount) order_final_amount
    from ${APP}.dwd_order_detail
    where activity_id is not null
    group by date_format(create_time,'yyyy-MM-dd'),activity_rule_id,activity_id
),
tmp_pay as
(
    select
        date_format(callback_time,'yyyy-MM-dd') dt,
        activity_rule_id,
        activity_id,
        count(*) payment_count,
        sum(split_activity_amount) payment_reduce_amount,
        sum(split_final_amount) payment_amount
    from
    (
        select
            activity_rule_id,
            activity_id,
            order_id,
            split_activity_amount,
            split_final_amount
        from ${APP}.dwd_order_detail
        where activity_id is not null
    )od
    join
    (
        select
            order_id,
            callback_time
        from ${APP}.dwd_payment_info
    )pi
    on od.order_id=pi.order_id
    group by date_format(callback_time,'yyyy-MM-dd'),activity_rule_id,activity_id
)
insert overwrite table ${APP}.dws_activity_info_daycount partition(dt)
select
    activity_rule_id,
    activity_id,
    sum(order_count),
    sum(order_reduce_amount),
    sum(order_original_amount),
    sum(order_final_amount),
    sum(payment_count),
    sum(payment_reduce_amount),
    sum(payment_amount),
    dt
from
(
    select
        dt,
        activity_rule_id,
        activity_id,
        order_count,
        order_reduce_amount,
        order_original_amount,
        order_final_amount,
        0 payment_count,
        0 payment_reduce_amount,
        0 payment_amount
    from tmp_order
    union all
    select
        dt,
        activity_rule_id,
        activity_id,
        0 order_count,
        0 order_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        payment_count,
        payment_reduce_amount,
        payment_amount
    from tmp_pay
)t1
group by dt,activity_rule_id,activity_id;"

dws_sku_action_daycount="
set hive.exec.dynamic.partition.mode=nonstrict;
with
tmp_order as
(
    select
        date_format(create_time,'yyyy-MM-dd') dt,
        sku_id,
        count(*) order_count,
        sum(sku_num) order_num,
        sum(if(split_activity_amount>0,1,0)) order_activity_count,
        sum(if(split_coupon_amount>0,1,0)) order_coupon_count,
        sum(split_activity_amount) order_activity_reduce_amount,
        sum(split_coupon_amount) order_coupon_reduce_amount,
        sum(original_amount) order_original_amount,
        sum(split_final_amount) order_final_amount
    from ${APP}.dwd_order_detail
    group by date_format(create_time,'yyyy-MM-dd'),sku_id
),
tmp_pay as
(
    select
        date_format(callback_time,'yyyy-MM-dd') dt,
        sku_id,
        count(*) payment_count,
        sum(sku_num) payment_num,
        sum(split_final_amount) payment_amount
    from ${APP}.dwd_order_detail od
    join
    (
        select
            order_id,
            callback_time
        from ${APP}.dwd_payment_info
        where callback_time is not null
    )pi on pi.order_id=od.order_id
    group by date_format(callback_time,'yyyy-MM-dd'),sku_id
),
tmp_ri as
(
    select
        date_format(create_time,'yyyy-MM-dd') dt,
        sku_id,
        count(*) refund_order_count,
        sum(refund_num) refund_order_num,
        sum(refund_amount) refund_order_amount
    from ${APP}.dwd_order_refund_info
    group by date_format(create_time,'yyyy-MM-dd'),sku_id
),
tmp_rp as
(
    select
        date_format(callback_time,'yyyy-MM-dd') dt,
        rp.sku_id,
        count(*) refund_payment_count,
        sum(ri.refund_num) refund_payment_num,
        sum(refund_amount) refund_payment_amount
    from
    (
        select
            order_id,
            sku_id,
            refund_amount,
            callback_time
        from ${APP}.dwd_refund_payment
    )rp
    left join
    (
        select
            order_id,
            sku_id,
            refund_num
        from ${APP}.dwd_order_refund_info
    )ri
    on rp.order_id=ri.order_id
    and rp.sku_id=ri.sku_id
    group by date_format(callback_time,'yyyy-MM-dd'),rp.sku_id
),
tmp_cf as
(
    select
        dt,
        item sku_id,
        sum(if(action_id='cart_add',1,0)) cart_count,
        sum(if(action_id='favor_add',1,0)) favor_count
    from ${APP}.dwd_action_log
    where action_id in ('cart_add','favor_add')
    group by dt,item
),
tmp_comment as
(
    select
        date_format(create_time,'yyyy-MM-dd') dt,
        sku_id,
        sum(if(appraise='1201',1,0)) appraise_good_count,
        sum(if(appraise='1202',1,0)) appraise_mid_count,
        sum(if(appraise='1203',1,0)) appraise_bad_count,
        sum(if(appraise='1204',1,0)) appraise_default_count
    from ${APP}.dwd_comment_info
    group by date_format(create_time,'yyyy-MM-dd'),sku_id
)
insert overwrite table ${APP}.dws_sku_action_daycount partition(dt)
select
    sku_id,
    sum(order_count),
    sum(order_num),
    sum(order_activity_count),
    sum(order_coupon_count),
    sum(order_activity_reduce_amount),
    sum(order_coupon_reduce_amount),
    sum(order_original_amount),
    sum(order_final_amount),
    sum(payment_count),
    sum(payment_num),
    sum(payment_amount),
    sum(refund_order_count),
    sum(refund_order_num),
    sum(refund_order_amount),
    sum(refund_payment_count),
    sum(refund_payment_num),
    sum(refund_payment_amount),
    sum(cart_count),
    sum(favor_count),
    sum(appraise_good_count),
    sum(appraise_mid_count),
    sum(appraise_bad_count),
    sum(appraise_default_count),
    dt
from
(
    select
        dt,
        sku_id,
        order_count,
        order_num,
        order_activity_count,
        order_coupon_count,
        order_activity_reduce_amount,
        order_coupon_reduce_amount,
        order_original_amount,
        order_final_amount,
        0 payment_count,
        0 payment_num,
        0 payment_amount,
        0 refund_order_count,
        0 refund_order_num,
        0 refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_num,
        0 refund_payment_amount,
        0 cart_count,
        0 favor_count,
        0 appraise_good_count,
        0 appraise_mid_count,
        0 appraise_bad_count,
        0 appraise_default_count
    from tmp_order
    union all
    select
        dt,
        sku_id,
        0 order_count,
        0 order_num,
        0 order_activity_count,
        0 order_coupon_count,
        0 order_activity_reduce_amount,
        0 order_coupon_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        payment_count,
        payment_num,
        payment_amount,
        0 refund_order_count,
        0 refund_order_num,
        0 refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_num,
        0 refund_payment_amount,
        0 cart_count,
        0 favor_count,
        0 appraise_good_count,
        0 appraise_mid_count,
        0 appraise_bad_count,
        0 appraise_default_count
    from tmp_pay
    union all
    select
        dt,
        sku_id,
        0 order_count,
        0 order_num,
        0 order_activity_count,
        0 order_coupon_count,
        0 order_activity_reduce_amount,
        0 order_coupon_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        0 payment_count,
        0 payment_num,
        0 payment_amount,
        refund_order_count,
        refund_order_num,
        refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_num,
        0 refund_payment_amount,
        0 cart_count,
        0 favor_count,
        0 appraise_good_count,
        0 appraise_mid_count,
        0 appraise_bad_count,
        0 appraise_default_count
    from tmp_ri
    union all
    select
        dt,
        sku_id,
        0 order_count,
        0 order_num,
        0 order_activity_count,
        0 order_coupon_count,
        0 order_activity_reduce_amount,
        0 order_coupon_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        0 payment_count,
        0 payment_num,
        0 payment_amount,
        0 refund_order_count,
        0 refund_order_num,
        0 refund_order_amount,
        refund_payment_count,
        refund_payment_num,
        refund_payment_amount,
        0 cart_count,
        0 favor_count,
        0 appraise_good_count,
        0 appraise_mid_count,
        0 appraise_bad_count,
        0 appraise_default_count
    from tmp_rp
    union all
    select
        dt,
        sku_id,
        0 order_count,
        0 order_num,
        0 order_activity_count,
        0 order_coupon_count,
        0 order_activity_reduce_amount,
        0 order_coupon_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        0 payment_count,
        0 payment_num,
        0 payment_amount,
        0 refund_order_count,
        0 refund_order_num,
        0 refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_num,
        0 refund_payment_amount,
        cart_count,
        favor_count,
        0 appraise_good_count,
        0 appraise_mid_count,
        0 appraise_bad_count,
        0 appraise_default_count
    from tmp_cf
    union all
    select
        dt,
        sku_id,
        0 order_count,
        0 order_num,
        0 order_activity_count,
        0 order_coupon_count,
        0 order_activity_reduce_amount,
        0 order_coupon_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        0 payment_count,
        0 payment_num,
        0 payment_amount,
        0 refund_order_count,
        0 refund_order_num,
        0 refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_num,
        0 refund_payment_amount,
        0 cart_count,
        0 favor_count,
        appraise_good_count,
        appraise_mid_count,
        appraise_bad_count,
        appraise_default_count
    from tmp_comment
)t1
group by dt,sku_id;"

dws_coupon_info_daycount="
set hive.exec.dynamic.partition.mode=nonstrict;
with
tmp_cu as
(
    select
        coalesce(coupon_get.dt,coupon_using.dt,coupon_used.dt,coupon_exprie.dt) dt,
        coalesce(coupon_get.coupon_id,coupon_using.coupon_id,coupon_used.coupon_id,coupon_exprie.coupon_id) coupon_id,
        nvl(get_count,0) get_count,
        nvl(order_count,0) order_count,
        nvl(payment_count,0) payment_count,
        nvl(expire_count,0) expire_count
    from
    (
        select
            date_format(get_time,'yyyy-MM-dd') dt,
            coupon_id,
            count(*) get_count
        from ${APP}.dwd_coupon_use
        group by date_format(get_time,'yyyy-MM-dd'),coupon_id
    )coupon_get
    full outer join
    (
        select
            date_format(using_time,'yyyy-MM-dd') dt,
            coupon_id,
            count(*) order_count
        from ${APP}.dwd_coupon_use
        where using_time is not null
        group by date_format(using_time,'yyyy-MM-dd'),coupon_id
    )coupon_using
    on coupon_get.dt=coupon_using.dt
    and coupon_get.coupon_id=coupon_using.coupon_id
    full outer join
    (
        select
            date_format(used_time,'yyyy-MM-dd') dt,
            coupon_id,
            count(*) payment_count
        from ${APP}.dwd_coupon_use
        where used_time is not null
        group by date_format(used_time,'yyyy-MM-dd'),coupon_id
    )coupon_used
    on nvl(coupon_get.dt,coupon_using.dt)=coupon_used.dt
    and nvl(coupon_get.coupon_id,coupon_using.coupon_id)=coupon_used.coupon_id
    full outer join
    (
        select
            date_format(expire_time,'yyyy-MM-dd') dt,
            coupon_id,
            count(*) expire_count
        from ${APP}.dwd_coupon_use
        where expire_time is not null
        group by date_format(expire_time,'yyyy-MM-dd'),coupon_id
    )coupon_exprie
    on coalesce(coupon_get.dt,coupon_using.dt,coupon_used.dt)=coupon_exprie.dt
    and coalesce(coupon_get.coupon_id,coupon_using.coupon_id,coupon_used.coupon_id)=coupon_exprie.coupon_id
),
tmp_order as
(
    select
        date_format(create_time,'yyyy-MM-dd') dt,
        coupon_id,
        sum(split_coupon_amount) order_reduce_amount,
        sum(original_amount) order_original_amount,
        sum(split_final_amount) order_final_amount
    from ${APP}.dwd_order_detail
    where coupon_id is not null
    group by date_format(create_time,'yyyy-MM-dd'),coupon_id
),
tmp_pay as
(
    select
        date_format(callback_time,'yyyy-MM-dd') dt,
        coupon_id,
        sum(split_coupon_amount) payment_reduce_amount,
        sum(split_final_amount) payment_amount
    from
    (
        select
            order_id,
            coupon_id,
            split_coupon_amount,
            split_final_amount
        from ${APP}.dwd_order_detail
        where coupon_id is not null
    )od
    join
    (
        select
            order_id,
            callback_time
        from ${APP}.dwd_payment_info
    )pi
    on od.order_id=pi.order_id
    group by date_format(callback_time,'yyyy-MM-dd'),coupon_id
)
insert overwrite table ${APP}.dws_coupon_info_daycount partition(dt)
select
    coupon_id,
    sum(get_count),
    sum(order_count),
    sum(order_reduce_amount),
    sum(order_original_amount),
    sum(order_final_amount),
    sum(payment_count),
    sum(payment_reduce_amount),
    sum(payment_amount),
    sum(expire_count),
    dt
from
(
    select
        dt,
        coupon_id,
        get_count,
        order_count,
        0 order_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        payment_count,
        0 payment_reduce_amount,
        0 payment_amount,
        expire_count
    from tmp_cu
    union all
    select
        dt,
        coupon_id,
        0 get_count,
        0 order_count,
        order_reduce_amount,
        order_original_amount,
        order_final_amount,
        0 payment_count,
        0 payment_reduce_amount,
        0 payment_amount,
        0 expire_count
    from tmp_order
    union all
    select
        dt,
        coupon_id,
        0 get_count,
        0 order_count,
        0 order_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        0 payment_count,
        payment_reduce_amount,
        payment_amount,
        0 expire_count
    from tmp_pay
)t1
group by dt,coupon_id;
"

case $1 in
    "dws_visitor_action_daycount" )
        hive -e "$dws_visitor_action_daycount"
    ;;
    "dws_user_action_daycount" )
        hive -e "$dws_user_action_daycount"
    ;;
    "dws_activity_info_daycount" )
        hive -e "$dws_activity_info_daycount"
    ;;
    "dws_area_stats_daycount" )
        hive -e "$dws_area_stats_daycount"
    ;;
    "dws_sku_action_daycount" )
        hive -e "$dws_sku_action_daycount"
    ;;
    "dws_coupon_info_daycount" )
        hive -e "$dws_coupon_info_daycount"
    ;;
    "all" )
        hive -e "$dws_visitor_action_daycount$dws_user_action_daycount$dws_activity_info_daycount$dws_area_stats_daycount$dws_sku_action_daycount$dws_coupon_info_daycount"
    ;;
esac
</code></pre>
<p>（2）增加执行权限</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod +x dwd_to_dws_init.sh
</code></pre>
<p>2）脚本使用<br>（1）执行脚本</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ dwd_to_dws_init.sh all 2020-06-14
</code></pre>
<p>（2）查看数据是否导入成功</p>
<h3 id="7-2-8-DWS层每日数据装载脚本"><a href="#7-2-8-DWS层每日数据装载脚本" class="headerlink" title="7.2.8 DWS层每日数据装载脚本"></a>7.2.8 DWS层每日数据装载脚本</h3><p>1）编写脚本<br>（1）在/home/atguigu/bin目录下创建脚本dwd_to_dws.sh</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash

APP=gmall

# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天

if [ -n "$2" ] ;then
    do_date=$2
else 
    do_date=`date -d "-1 day" +%F`
fi

dws_visitor_action_daycount="insert overwrite table ${APP}.dws_visitor_action_daycount partition(dt='$do_date')
select
    t1.mid_id,
    t1.brand,
    t1.model,
    t1.is_new,
    t1.channel,
    t1.os,
    t1.area_code,
    t1.version_code,
    t1.visit_count,
    t3.page_stats
from
(
    select
        mid_id,
        brand,
        model,
        if(array_contains(collect_set(is_new),'0'),'0','1') is_new,--ods_page_log中，同一天内，同一设备的is_new字段，可能全部为1，可能全部为0，也可能部分为0，部分为1(卸载重装),故做该处理
        collect_set(channel) channel,
        collect_set(os) os,
        collect_set(area_code) area_code,
        collect_set(version_code) version_code,
        sum(if(last_page_id is null,1,0)) visit_count
    from ${APP}.dwd_page_log
    where dt='$do_date'
    and last_page_id is null
    group by mid_id,model,brand
)t1
join
(
    select
        mid_id,
        brand,
        model,
        collect_set(named_struct('page_id',page_id,'page_count',page_count,'during_time',during_time)) page_stats
    from
    (
        select
            mid_id,
            brand,
            model,
            page_id,
            count(*) page_count,
            sum(during_time) during_time
        from ${APP}.dwd_page_log
        where dt='$do_date'
        group by mid_id,model,brand,page_id
    )t2
    group by mid_id,model,brand
)t3
on t1.mid_id=t3.mid_id
and t1.brand=t3.brand
and t1.model=t3.model;"

dws_user_action_daycount="
with
tmp_login as
(
    select
        user_id,
        count(*) login_count
    from ${APP}.dwd_page_log
    where dt='$do_date'
    and user_id is not null
    and last_page_id is null
    group by user_id
),
tmp_cf as
(
    select
        user_id,
        sum(if(action_id='cart_add',1,0)) cart_count,
        sum(if(action_id='favor_add',1,0)) favor_count
    from ${APP}.dwd_action_log
    where dt='$do_date'
    and user_id is not null
    and action_id in ('cart_add','favor_add')
    group by user_id
),
tmp_order as
(
    select
        user_id,
        count(*) order_count,
        sum(if(activity_reduce_amount>0,1,0)) order_activity_count,
        sum(if(coupon_reduce_amount>0,1,0)) order_coupon_count,
        sum(activity_reduce_amount) order_activity_reduce_amount,
        sum(coupon_reduce_amount) order_coupon_reduce_amount,
        sum(original_amount) order_original_amount,
        sum(final_amount) order_final_amount
    from ${APP}.dwd_order_info
    where (dt='$do_date'
    or dt='9999-99-99')
    and date_format(create_time,'yyyy-MM-dd')='$do_date'
    group by user_id
),
tmp_pay as
(
    select
        user_id,
        count(*) payment_count,
        sum(payment_amount) payment_amount
    from ${APP}.dwd_payment_info
    where dt='$do_date'
    group by user_id
),
tmp_ri as
(
    select
        user_id,
        count(*) refund_order_count,
        sum(refund_num) refund_order_num,
        sum(refund_amount) refund_order_amount
    from ${APP}.dwd_order_refund_info
    where dt='$do_date'
    group by user_id
),
tmp_rp as
(
    select
        rp.user_id,
        count(*) refund_payment_count,
        sum(ri.refund_num) refund_payment_num,
        sum(rp.refund_amount) refund_payment_amount
    from
    (
        select
            user_id,
            order_id,
            sku_id,
            refund_amount
        from ${APP}.dwd_refund_payment
        where dt='$do_date'
    )rp
    left join
    (
        select
            user_id,
            order_id,
            sku_id,
            refund_num
        from ${APP}.dwd_order_refund_info
        where dt>=date_add('$do_date',-15)
    )ri
    on rp.order_id=ri.order_id
    and rp.sku_id=rp.sku_id
    group by rp.user_id
),
tmp_coupon as
(
    select
        user_id,
        sum(if(date_format(get_time,'yyyy-MM-dd')='$do_date',1,0)) coupon_get_count,
        sum(if(date_format(using_time,'yyyy-MM-dd')='$do_date',1,0)) coupon_using_count,
        sum(if(date_format(used_time,'yyyy-MM-dd')='$do_date',1,0)) coupon_used_count
    from ${APP}.dwd_coupon_use
    where (dt='$do_date' or dt='9999-99-99')
    and (date_format(get_time, 'yyyy-MM-dd') = '$do_date'
    or date_format(using_time,'yyyy-MM-dd')='$do_date'
    or date_format(used_time,'yyyy-MM-dd')='$do_date')
    group by user_id
),
tmp_comment as
(
    select
        user_id,
        sum(if(appraise='1201',1,0)) appraise_good_count,
        sum(if(appraise='1202',1,0)) appraise_mid_count,
        sum(if(appraise='1203',1,0)) appraise_bad_count,
        sum(if(appraise='1204',1,0)) appraise_default_count
    from ${APP}.dwd_comment_info
    where dt='$do_date'
    group by user_id
),
tmp_od as
(
    select
        user_id,
        collect_set(named_struct('sku_id',sku_id,'sku_num',sku_num,'order_count',order_count,'activity_reduce_amount',activity_reduce_amount,'coupon_reduce_amount',coupon_reduce_amount,'original_amount',original_amount,'final_amount',final_amount)) order_detail_stats
    from
    (
        select
            user_id,
            sku_id,
            sum(sku_num) sku_num,
            count(*) order_count,
            cast(sum(split_activity_amount) as decimal(16,2)) activity_reduce_amount,
            cast(sum(split_coupon_amount) as decimal(16,2)) coupon_reduce_amount,
            cast(sum(original_amount) as decimal(16,2)) original_amount,
            cast(sum(split_final_amount) as decimal(16,2)) final_amount
        from ${APP}.dwd_order_detail
        where dt='$do_date'
        group by user_id,sku_id
    )t1
    group by user_id
)
insert overwrite table ${APP}.dws_user_action_daycount partition(dt='$do_date')
select
    coalesce(tmp_login.user_id,tmp_cf.user_id,tmp_order.user_id,tmp_pay.user_id,tmp_ri.user_id,tmp_rp.user_id,tmp_comment.user_id,tmp_coupon.user_id,tmp_od.user_id),
    nvl(login_count,0),
    nvl(cart_count,0),
    nvl(favor_count,0),
    nvl(order_count,0),
    nvl(order_activity_count,0),
    nvl(order_activity_reduce_amount,0),
    nvl(order_coupon_count,0),
    nvl(order_coupon_reduce_amount,0),
    nvl(order_original_amount,0),
    nvl(order_final_amount,0),
    nvl(payment_count,0),
    nvl(payment_amount,0),
    nvl(refund_order_count,0),
    nvl(refund_order_num,0),
    nvl(refund_order_amount,0),
    nvl(refund_payment_count,0),
    nvl(refund_payment_num,0),
    nvl(refund_payment_amount,0),
    nvl(coupon_get_count,0),
    nvl(coupon_using_count,0),
    nvl(coupon_used_count,0),
    nvl(appraise_good_count,0),
    nvl(appraise_mid_count,0),
    nvl(appraise_bad_count,0),
    nvl(appraise_default_count,0),
    order_detail_stats
from tmp_login
full outer join tmp_cf on tmp_login.user_id=tmp_cf.user_id
full outer join tmp_order on coalesce(tmp_login.user_id,tmp_cf.user_id)=tmp_order.user_id
full outer join tmp_pay on coalesce(tmp_login.user_id,tmp_cf.user_id,tmp_order.user_id)=tmp_pay.user_id
full outer join tmp_ri on coalesce(tmp_login.user_id,tmp_cf.user_id,tmp_order.user_id,tmp_pay.user_id)=tmp_ri.user_id
full outer join tmp_rp on coalesce(tmp_login.user_id,tmp_cf.user_id,tmp_order.user_id,tmp_pay.user_id,tmp_ri.user_id)=tmp_rp.user_id
full outer join tmp_comment on coalesce(tmp_login.user_id,tmp_cf.user_id,tmp_order.user_id,tmp_pay.user_id,tmp_ri.user_id,tmp_rp.user_id)=tmp_comment.user_id
full outer join tmp_coupon on coalesce(tmp_login.user_id,tmp_cf.user_id,tmp_order.user_id,tmp_pay.user_id,tmp_ri.user_id,tmp_rp.user_id,tmp_comment.user_id)=tmp_coupon.user_id
full outer join tmp_od on coalesce(tmp_login.user_id,tmp_cf.user_id,tmp_order.user_id,tmp_pay.user_id,tmp_ri.user_id,tmp_rp.user_id,tmp_comment.user_id,tmp_coupon.user_id)=tmp_od.user_id;
"


dws_activity_info_daycount="
with
tmp_order as
(
    select
        activity_rule_id,
        activity_id,
        count(*) order_count,
        sum(split_activity_amount) order_reduce_amount,
        sum(original_amount) order_original_amount,
        sum(split_final_amount) order_final_amount
    from ${APP}.dwd_order_detail
    where dt='$do_date'
    and activity_id is not null
    group by activity_rule_id,activity_id
),
tmp_pay as
(
    select
        activity_rule_id,
        activity_id,
        count(*) payment_count,
        sum(split_activity_amount) payment_reduce_amount,
        sum(split_final_amount) payment_amount
    from ${APP}.dwd_order_detail
    where (dt='$do_date'
    or dt=date_add('$do_date',-1))
    and activity_id is not null
    and order_id in
    (
        select order_id from ${APP}.dwd_payment_info where dt='$do_date'
    )
    group by activity_rule_id,activity_id
)
insert overwrite table ${APP}.dws_activity_info_daycount partition(dt='$do_date')
select
    activity_rule_id,
    activity_id,
    sum(order_count),
    sum(order_reduce_amount),
    sum(order_original_amount),
    sum(order_final_amount),
    sum(payment_count),
    sum(payment_reduce_amount),
    sum(payment_amount)
from
(
    select
        activity_rule_id,
        activity_id,
        order_count,
        order_reduce_amount,
        order_original_amount,
        order_final_amount,
        0 payment_count,
        0 payment_reduce_amount,
        0 payment_amount
    from tmp_order
    union all
    select
        activity_rule_id,
        activity_id,
        0 order_count,
        0 order_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        payment_count,
        payment_reduce_amount,
        payment_amount
    from tmp_pay
)t1
group by activity_rule_id,activity_id;"

dws_sku_action_daycount="
with
tmp_order as
(
    select
        sku_id,
        count(*) order_count,
        sum(sku_num) order_num,
        sum(if(split_activity_amount>0,1,0)) order_activity_count,
        sum(if(split_coupon_amount>0,1,0)) order_coupon_count,
        sum(split_activity_amount) order_activity_reduce_amount,
        sum(split_coupon_amount) order_coupon_reduce_amount,
        sum(original_amount) order_original_amount,
        sum(split_final_amount) order_final_amount
    from ${APP}.dwd_order_detail
    where dt='$do_date'
    group by sku_id
),
tmp_pay as
(
    select
        sku_id,
        count(*) payment_count,
        sum(sku_num) payment_num,
        sum(split_final_amount) payment_amount
    from ${APP}.dwd_order_detail
    where (dt='$do_date'
    or dt=date_add('$do_date',-1))
    and order_id in
    (
        select order_id from ${APP}.dwd_payment_info where dt='$do_date'
    )
    group by sku_id
),
tmp_ri as
(
    select
        sku_id,
        count(*) refund_order_count,
        sum(refund_num) refund_order_num,
        sum(refund_amount) refund_order_amount
    from ${APP}.dwd_order_refund_info
    where dt='$do_date'
    group by sku_id
),
tmp_rp as
(
    select
        rp.sku_id,
        count(*) refund_payment_count,
        sum(ri.refund_num) refund_payment_num,
        sum(refund_amount) refund_payment_amount
    from
    (
        select
            order_id,
            sku_id,
            refund_amount
        from ${APP}.dwd_refund_payment
        where dt='$do_date'
    )rp
    left join
    (
        select
            order_id,
            sku_id,
            refund_num
        from ${APP}.dwd_order_refund_info
        where dt>=date_add('$do_date',-15)
    )ri
    on rp.order_id=ri.order_id
    and rp.sku_id=ri.sku_id
    group by rp.sku_id
),
tmp_cf as
(
    select
        item sku_id,
        sum(if(action_id='cart_add',1,0)) cart_count,
        sum(if(action_id='favor_add',1,0)) favor_count
    from ${APP}.dwd_action_log
    where dt='$do_date'
    and action_id in ('cart_add','favor_add')
    group by item
),
tmp_comment as
(
    select
        sku_id,
        sum(if(appraise='1201',1,0)) appraise_good_count,
        sum(if(appraise='1202',1,0)) appraise_mid_count,
        sum(if(appraise='1203',1,0)) appraise_bad_count,
        sum(if(appraise='1204',1,0)) appraise_default_count
    from ${APP}.dwd_comment_info
    where dt='$do_date'
    group by sku_id
)
insert overwrite table ${APP}.dws_sku_action_daycount partition(dt='$do_date')
select
    sku_id,
    sum(order_count),
    sum(order_num),
    sum(order_activity_count),
    sum(order_coupon_count),
    sum(order_activity_reduce_amount),
    sum(order_coupon_reduce_amount),
    sum(order_original_amount),
    sum(order_final_amount),
    sum(payment_count),
    sum(payment_num),
    sum(payment_amount),
    sum(refund_order_count),
    sum(refund_order_num),
    sum(refund_order_amount),
    sum(refund_payment_count),
    sum(refund_payment_num),
    sum(refund_payment_amount),
    sum(cart_count),
    sum(favor_count),
    sum(appraise_good_count),
    sum(appraise_mid_count),
    sum(appraise_bad_count),
    sum(appraise_default_count)
from
(
    select
        sku_id,
        order_count,
        order_num,
        order_activity_count,
        order_coupon_count,
        order_activity_reduce_amount,
        order_coupon_reduce_amount,
        order_original_amount,
        order_final_amount,
        0 payment_count,
        0 payment_num,
        0 payment_amount,
        0 refund_order_count,
        0 refund_order_num,
        0 refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_num,
        0 refund_payment_amount,
        0 cart_count,
        0 favor_count,
        0 appraise_good_count,
        0 appraise_mid_count,
        0 appraise_bad_count,
        0 appraise_default_count
    from tmp_order
    union all
    select
        sku_id,
        0 order_count,
        0 order_num,
        0 order_activity_count,
        0 order_coupon_count,
        0 order_activity_reduce_amount,
        0 order_coupon_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        payment_count,
        payment_num,
        payment_amount,
        0 refund_order_count,
        0 refund_order_num,
        0 refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_num,
        0 refund_payment_amount,
        0 cart_count,
        0 favor_count,
        0 appraise_good_count,
        0 appraise_mid_count,
        0 appraise_bad_count,
        0 appraise_default_count
    from tmp_pay
    union all
    select
        sku_id,
        0 order_count,
        0 order_num,
        0 order_activity_count,
        0 order_coupon_count,
        0 order_activity_reduce_amount,
        0 order_coupon_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        0 payment_count,
        0 payment_num,
        0 payment_amount,
        refund_order_count,
        refund_order_num,
        refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_num,
        0 refund_payment_amount,
        0 cart_count,
        0 favor_count,
        0 appraise_good_count,
        0 appraise_mid_count,
        0 appraise_bad_count,
        0 appraise_default_count
    from tmp_ri
    union all
    select
        sku_id,
        0 order_count,
        0 order_num,
        0 order_activity_count,
        0 order_coupon_count,
        0 order_activity_reduce_amount,
        0 order_coupon_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        0 payment_count,
        0 payment_num,
        0 payment_amount,
        0 refund_order_count,
        0 refund_order_num,
        0 refund_order_amount,
        refund_payment_count,
        refund_payment_num,
        refund_payment_amount,
        0 cart_count,
        0 favor_count,
        0 appraise_good_count,
        0 appraise_mid_count,
        0 appraise_bad_count,
        0 appraise_default_count
    from tmp_rp
    union all
    select
        sku_id,
        0 order_count,
        0 order_num,
        0 order_activity_count,
        0 order_coupon_count,
        0 order_activity_reduce_amount,
        0 order_coupon_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        0 payment_count,
        0 payment_num,
        0 payment_amount,
        0 refund_order_count,
        0 refund_order_num,
        0 refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_num,
        0 refund_payment_amount,
        cart_count,
        favor_count,
        0 appraise_good_count,
        0 appraise_mid_count,
        0 appraise_bad_count,
        0 appraise_default_count
    from tmp_cf
    union all
    select
        sku_id,
        0 order_count,
        0 order_num,
        0 order_activity_count,
        0 order_coupon_count,
        0 order_activity_reduce_amount,
        0 order_coupon_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        0 payment_count,
        0 payment_num,
        0 payment_amount,
        0 refund_order_count,
        0 refund_order_num,
        0 refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_num,
        0 refund_payment_amount,
        0 cart_count,
        0 favor_count,
        appraise_good_count,
        appraise_mid_count,
        appraise_bad_count,
        appraise_default_count
    from tmp_comment
)t1
group by sku_id;"

dws_coupon_info_daycount="
with
tmp_cu as
(
    select
        coupon_id,
        sum(if(date_format(get_time,'yyyy-MM-dd')='$do_date',1,0)) get_count,
        sum(if(date_format(using_time,'yyyy-MM-dd')='$do_date',1,0)) order_count,
        sum(if(date_format(used_time,'yyyy-MM-dd')='$do_date',1,0)) payment_count,
        sum(if(date_format(expire_time,'yyyy-MM-dd')='$do_date',1,0)) expire_count
    from ${APP}.dwd_coupon_use
    where dt='9999-99-99'
    or dt='$do_date'
    group by coupon_id
),
tmp_order as
(
    select
        coupon_id,
        sum(split_coupon_amount) order_reduce_amount,
        sum(original_amount) order_original_amount,
        sum(split_final_amount) order_final_amount
    from ${APP}.dwd_order_detail
    where dt='$do_date'
    and coupon_id is not null
    group by coupon_id
),
tmp_pay as
(
    select
        coupon_id,
        sum(split_coupon_amount) payment_reduce_amount,
        sum(split_final_amount) payment_amount
    from ${APP}.dwd_order_detail
    where (dt='$do_date'
    or dt=date_add('$do_date',-1))
    and coupon_id is not null
    and order_id in
    (
        select order_id from ${APP}.dwd_payment_info where dt='$do_date'
    )
    group by coupon_id
)
insert overwrite table ${APP}.dws_coupon_info_daycount partition(dt='$do_date')
select
    coupon_id,
    sum(get_count),
    sum(order_count),
    sum(order_reduce_amount),
    sum(order_original_amount),
    sum(order_final_amount),
    sum(payment_count),
    sum(payment_reduce_amount),
    sum(payment_amount),
    sum(expire_count)
from
(
    select
        coupon_id,
        get_count,
        order_count,
        0 order_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        payment_count,
        0 payment_reduce_amount,
        0 payment_amount,
        expire_count
    from tmp_cu
    union all
    select
        coupon_id,
        0 get_count,
        0 order_count,
        order_reduce_amount,
        order_original_amount,
        order_final_amount,
        0 payment_count,
        0 payment_reduce_amount,
        0 payment_amount,
        0 expire_count
    from tmp_order
    union all
    select
        coupon_id,
        0 get_count,
        0 order_count,
        0 order_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        0 payment_count,
        payment_reduce_amount,
        payment_amount,
        0 expire_count
    from tmp_pay
)t1
group by coupon_id;"


dws_area_stats_daycount="
with
tmp_vu as
(
    select
        id province_id,
        visit_count,
        login_count,
        visitor_count,
        user_count
    from
    (
        select
            area_code,
            count(*) visit_count,--访客访问次数
            count(user_id) login_count,--用户访问次数,等价于sum(if(user_id is not null,1,0))
            count(distinct(mid_id)) visitor_count,--访客人数
            count(distinct(user_id)) user_count--用户人数
        from ${APP}.dwd_page_log
        where dt='$do_date'
        and last_page_id is null
        group by area_code
    )tmp
    left join ${APP}.dim_base_province area
    on tmp.area_code=area.area_code
),
tmp_order as
(
    select
        province_id,
        count(*) order_count,
        sum(original_amount) order_original_amount,
        sum(final_amount) order_final_amount
    from ${APP}.dwd_order_info
    where dt='$do_date'
    or dt='9999-99-99'
    and date_format(create_time,'yyyy-MM-dd')='$do_date'
    group by province_id
),
tmp_pay as
(
    select
        province_id,
        count(*) payment_count,
        sum(payment_amount) payment_amount
    from ${APP}.dwd_payment_info
    where dt='$do_date'
    group by province_id
),
tmp_ro as
(
    select
        province_id,
        count(*) refund_order_count,
        sum(refund_amount) refund_order_amount
    from ${APP}.dwd_order_refund_info
    where dt='$do_date'
    group by province_id
),
tmp_rp as
(
    select
        province_id,
        count(*) refund_payment_count,
        sum(refund_amount) refund_payment_amount
    from ${APP}.dwd_refund_payment
    where dt='$do_date'
    group by province_id
)
insert overwrite table ${APP}.dws_area_stats_daycount partition(dt='$do_date')
select
    province_id,
    sum(visit_count),
    sum(login_count),
    sum(visitor_count),
    sum(user_count),
    sum(order_count),
    sum(order_original_amount),
    sum(order_final_amount),
    sum(payment_count),
    sum(payment_amount),
    sum(refund_order_count),
    sum(refund_order_amount),
    sum(refund_payment_count),
    sum(refund_payment_amount)
from
(
    select
        province_id,
        visit_count,
        login_count,
        visitor_count,
        user_count,
        0 order_count,
        0 order_original_amount,
        0 order_final_amount,
        0 payment_count,
        0 payment_amount,
        0 refund_order_count,
        0 refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_amount
    from tmp_vu
    union all
    select
        province_id,
        0 visit_count,
        0 login_count,
        0 visitor_count,
        0 user_count,
        order_count,
        order_original_amount,
        order_final_amount,
        0 payment_count,
        0 payment_amount,
        0 refund_order_count,
        0 refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_amount
    from tmp_order
    union all
    select
        province_id,
        0 visit_count,
        0 login_count,
        0 visitor_count,
        0 user_count,
        0 order_count,
        0 order_original_amount,
        0 order_final_amount,
        payment_count,
        payment_amount,
        0 refund_order_count,
        0 refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_amount
    from tmp_pay
    union all
    select
        province_id,
        0 visit_count,
        0 login_count,
        0 visitor_count,
        0 user_count,
        0 order_count,
        0 order_original_amount,
        0 order_final_amount,
        0 payment_count,
        0 payment_amount,
        refund_order_count,
        refund_order_amount,
        0 refund_payment_count,
        0 refund_payment_amount
    from tmp_ro
    union all
    select
        province_id,
        0 visit_count,
        0 login_count,
        0 visitor_count,
        0 user_count,
        0 order_count,
        0 order_original_amount,
        0 order_final_amount,
        0 payment_count,
        0 payment_amount,
        0 refund_order_count,
        0 refund_order_amount,
        refund_payment_count,
        refund_payment_amount
    from tmp_rp
)t1
group by province_id;"

case $1 in
    "dws_visitor_action_daycount" )
        hive -e "$dws_visitor_action_daycount"
    ;;
    "dws_user_action_daycount" )
        hive -e "$dws_user_action_daycount"
    ;;
    "dws_activity_info_daycount" )
        hive -e "$dws_activity_info_daycount"
    ;;
    "dws_area_stats_daycount" )
        hive -e "$dws_area_stats_daycount"
    ;;
    "dws_sku_action_daycount" )
        hive -e "$dws_sku_action_daycount"
    ;;
    "dws_coupon_info_daycount" )
        hive -e "$dws_coupon_info_daycount"
    ;;
    "all" )
        hive -e "$dws_visitor_action_daycount$dws_user_action_daycount$dws_activity_info_daycount$dws_area_stats_daycount$dws_sku_action_daycount$dws_coupon_info_daycount"
    ;;
esac
</code></pre>
<p>（2）增加执行权限</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod +x dwd_to_dws.sh
</code></pre>
<p>2）脚本使用<br>（1）执行脚本</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ dwd_to_dws.sh all 2020-06-14
</code></pre>
<p>（2）查看数据是否导入成功</p>
<h1 id="第8章-数仓搭建-DWT层"><a href="#第8章-数仓搭建-DWT层" class="headerlink" title="第8章 数仓搭建-DWT层"></a>第8章 数仓搭建-DWT层</h1><h2 id="8-1-访客主题"><a href="#8-1-访客主题" class="headerlink" title="8.1 访客主题"></a>8.1 访客主题</h2><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwt_visitor_topic<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwt_visitor_topic
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>mid_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'设备id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>brand<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机品牌'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机型号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>channel<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRING<span class="token operator">></span> <span class="token keyword">COMMENT</span> <span class="token string">'渠道'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>os<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRING<span class="token operator">></span> <span class="token keyword">COMMENT</span> <span class="token string">'操作系统'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRING<span class="token operator">></span> <span class="token keyword">COMMENT</span> <span class="token string">'地区ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>version_code<span class="token punctuation">`</span> ARRAY<span class="token operator">&lt;</span>STRING<span class="token operator">></span> <span class="token keyword">COMMENT</span> <span class="token string">'应用版本'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visit_date_first<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'首次访问时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visit_date_last<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'末次访问时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visit_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日访问次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visit_last_1d_day_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日访问天数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visit_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日访问次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visit_last_7d_day_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日访问天数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visit_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日访问次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visit_last_30d_day_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日访问天数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visit_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积访问次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visit_day_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积访问天数'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'设备主题宽表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwt/dwt_visitor_topic'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）数据装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_visitor_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>mid_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>brand<span class="token punctuation">,</span>old<span class="token punctuation">.</span>brand<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>model<span class="token punctuation">,</span>old<span class="token punctuation">.</span>model<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>channel<span class="token punctuation">,</span>old<span class="token punctuation">.</span>channel<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>os<span class="token punctuation">,</span>old<span class="token punctuation">.</span>os<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>area_code<span class="token punctuation">,</span>old<span class="token punctuation">.</span>area_code<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>version_code<span class="token punctuation">,</span>old<span class="token punctuation">.</span>version_code<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">case</span> <span class="token keyword">when</span> old<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> 1d_ago<span class="token punctuation">.</span>is_new<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'2020-06-14'</span>
         <span class="token keyword">when</span> old<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> 1d_ago<span class="token punctuation">.</span>is_new<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">then</span> <span class="token string">'2020-06-13'</span><span class="token comment" spellcheck="true">--无法获取准确的首次登录日期，给定一个数仓搭建日之前的日期</span>
         <span class="token keyword">else</span> old<span class="token punctuation">.</span>visit_date_first <span class="token keyword">end</span><span class="token punctuation">,</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>visit_date_last<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_7d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span> <span class="token keyword">if</span><span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_30d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span> <span class="token keyword">if</span><span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>mid_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        mid_id<span class="token punctuation">,</span>
        brand<span class="token punctuation">,</span>
        model<span class="token punctuation">,</span>
        channel<span class="token punctuation">,</span>
        os<span class="token punctuation">,</span>
        area_code<span class="token punctuation">,</span>
        version_code<span class="token punctuation">,</span>
        visit_date_first<span class="token punctuation">,</span>
        visit_date_last<span class="token punctuation">,</span>
        visit_last_1d_count<span class="token punctuation">,</span>
        visit_last_1d_day_count<span class="token punctuation">,</span>
        visit_last_7d_count<span class="token punctuation">,</span>
        visit_last_7d_day_count<span class="token punctuation">,</span>
        visit_last_30d_count<span class="token punctuation">,</span>
        visit_last_30d_day_count<span class="token punctuation">,</span>
        visit_count<span class="token punctuation">,</span>
        visit_day_count
    <span class="token keyword">from</span> dwt_visitor_topic
    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>old
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        mid_id<span class="token punctuation">,</span>
        brand<span class="token punctuation">,</span>
        model<span class="token punctuation">,</span>
        is_new<span class="token punctuation">,</span>
        channel<span class="token punctuation">,</span>
        os<span class="token punctuation">,</span>
        area_code<span class="token punctuation">,</span>
        version_code<span class="token punctuation">,</span>
        visit_count
    <span class="token keyword">from</span> dws_visitor_action_daycount
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>1d_ago
<span class="token keyword">on</span> old<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>mid_id
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        mid_id<span class="token punctuation">,</span>
        brand<span class="token punctuation">,</span>
        model<span class="token punctuation">,</span>
        is_new<span class="token punctuation">,</span>
        channel<span class="token punctuation">,</span>
        os<span class="token punctuation">,</span>
        area_code<span class="token punctuation">,</span>
        version_code<span class="token punctuation">,</span>
        visit_count
    <span class="token keyword">from</span> dws_visitor_action_daycount
    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>7d_ago
<span class="token keyword">on</span> old<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>7d_ago<span class="token punctuation">.</span>mid_id
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        mid_id<span class="token punctuation">,</span>
        brand<span class="token punctuation">,</span>
        model<span class="token punctuation">,</span>
        is_new<span class="token punctuation">,</span>
        channel<span class="token punctuation">,</span>
        os<span class="token punctuation">,</span>
        area_code<span class="token punctuation">,</span>
        version_code<span class="token punctuation">,</span>
        visit_count
    <span class="token keyword">from</span> dws_visitor_action_daycount
    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>30d_ago
<span class="token keyword">on</span> old<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>30d_ago<span class="token punctuation">.</span>mid_id<span class="token punctuation">;</span>
</code></pre>
<p>3）查询加载结果</p>
<h2 id="8-2-用户主题"><a href="#8-2-用户主题" class="headerlink" title="8.2 用户主题"></a>8.2 用户主题</h2><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwt_user_topic<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwt_user_topic
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>login_date_first<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'首次活跃日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>login_date_last<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'末次活跃日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>login_date_1d_count<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'最近1日登录次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>login_last_1d_day_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日登录天数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>login_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日登录次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>login_last_7d_day_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日登录天数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>login_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日登录次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>login_last_30d_day_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日登录天数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>login_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积登录次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>login_day_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积登录天数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_date_first<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'首次下单时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_date_last<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'末次下单时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日订单参与活动次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_reduce_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日订单减免金额(活动)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日下单用券次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_reduce_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日订单减免金额(优惠券)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日原始下单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日最终下单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日订单参与活动次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_reduce_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日订单减免金额(活动)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日下单用券次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_reduce_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日订单减免金额(优惠券)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_7d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日原始下单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_7d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日最终下单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日订单参与活动次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_reduce_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日订单减免金额(活动)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日下单用券次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_reduce_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日订单减免金额(优惠券)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_30d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日原始下单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_30d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日最终下单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积订单参与活动次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积订单减免金额(活动)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积下单用券次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积订单减免金额(优惠券)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积原始下单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积最终下单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_date_first<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'首次支付时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_date_last<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'末次支付时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_1d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退单件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_7d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退单件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_30d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退单件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退单件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退款次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_1d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退款件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退款金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退款次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_7d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退款件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退款金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退款次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_30d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退款件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退款金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退款次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退款件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退款金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>cart_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日加入购物车次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>cart_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日加入购物车次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>cart_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日加入购物车次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>cart_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积加入购物车次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>favor_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日收藏次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>favor_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日收藏次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>favor_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日收藏次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>favor_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积收藏次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_last_1d_get_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日领券次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_last_1d_using_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日用券(下单)次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_last_1d_used_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日用券(支付)次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_last_7d_get_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日领券次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_last_7d_using_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日用券(下单)次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_last_7d_used_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日用券(支付)次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_last_30d_get_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日领券次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_last_30d_using_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日用券(下单)次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_last_30d_used_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日用券(支付)次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_get_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积领券次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_using_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积用券(下单)次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>coupon_used_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积用券(支付)次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_1d_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日好评次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_1d_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日中评次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_1d_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日差评次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_1d_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日默认评价次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_7d_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日好评次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_7d_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日中评次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_7d_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日差评次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_7d_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日默认评价次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_30d_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日好评次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_30d_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日中评次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_30d_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日差评次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_30d_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日默认评价次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积好评次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积中评次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积差评次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积默认评价次数'</span>
<span class="token punctuation">)</span><span class="token keyword">COMMENT</span> <span class="token string">'会员主题宽表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwt/dwt_user_topic/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）数据装载</p>
<p>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_user_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    id<span class="token punctuation">,</span>
    login_date_first<span class="token punctuation">,</span><span class="token comment" spellcheck="true">--以用户的创建日期作为首次登录日期</span>
    nvl<span class="token punctuation">(</span>login_date_last<span class="token punctuation">,</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">--若有历史登录记录，则根据历史记录获取末次登录日期，否则统一指定一个日期</span>
    nvl<span class="token punctuation">(</span>login_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>login_last_1d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>login_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>login_last_7d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>login_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>login_last_30d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>login_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    order_date_first<span class="token punctuation">,</span>
    order_date_last<span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_reduce_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    payment_date_first<span class="token punctuation">,</span>
    payment_date_last<span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>cart_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>cart_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>cart_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>favor_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>favor_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>favor_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_last_1d_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_last_1d_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_last_1d_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_last_7d_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_last_7d_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_last_7d_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_last_30d_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_last_30d_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_last_30d_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_1d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_1d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_1d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_1d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_7d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_7d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_7d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_7d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_30d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_30d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_30d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_30d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        date_format<span class="token punctuation">(</span>create_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> login_date_first
    <span class="token keyword">from</span> dim_user_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'9999-99-99'</span>
<span class="token punctuation">)</span>t1
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        user_id user_id<span class="token punctuation">,</span>
        <span class="token function">max</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span> login_date_last<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span> <span class="token operator">and</span> login_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_1d_day_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">and</span> login_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_7d_day_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span> <span class="token operator">and</span> login_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_30d_day_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>login_count<span class="token punctuation">)</span> login_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>login_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_day_count<span class="token punctuation">,</span>
        <span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span>dt<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_date_first<span class="token punctuation">,</span>
        <span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span>dt<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_date_last<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_1d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_7d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_30d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_count<span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>payment_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span>dt<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_date_first<span class="token punctuation">,</span>
        <span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>payment_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span>dt<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_date_last<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span> refund_order_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span> refund_payment_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>cart_count<span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>favor_count<span class="token punctuation">)</span> favor_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_1d_get_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_1d_using_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_1d_used_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_7d_get_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_7d_using_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_7d_used_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_30d_get_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_30d_using_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> coupon_last_30d_used_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>coupon_get_count<span class="token punctuation">)</span> coupon_get_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>coupon_using_count<span class="token punctuation">)</span> coupon_using_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>coupon_used_count<span class="token punctuation">)</span> coupon_used_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_good_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_mid_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_bad_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_default_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_good_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_mid_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_bad_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_default_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_good_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_mid_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_bad_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_default_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">)</span> appraise_default_count
    <span class="token keyword">from</span> dws_user_action_daycount
    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id
<span class="token punctuation">)</span>t2
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>id<span class="token operator">=</span>t2<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
（<span class="token number">2</span>）每日装载


<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_user_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_date_first<span class="token punctuation">,</span><span class="token string">'2020-06-15'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>login_date_last<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_last_7d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span> <span class="token keyword">if</span><span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_last_30d_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span> <span class="token keyword">if</span><span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_day_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_date_first <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> 1d_ago<span class="token punctuation">.</span>order_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'2020-06-15'</span><span class="token punctuation">,</span> old<span class="token punctuation">.</span>order_date_first<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>order_date_last<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_date_first <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> 1d_ago<span class="token punctuation">.</span>payment_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'2020-06-15'</span><span class="token punctuation">,</span> old<span class="token punctuation">.</span>payment_date_first<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>payment_date_last<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_7d_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_7d_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_7d_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_30d_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_30d_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_last_30d_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_using_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_used_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span>nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        user_id<span class="token punctuation">,</span>
        login_date_first<span class="token punctuation">,</span>
        login_date_last<span class="token punctuation">,</span>
        login_date_1d_count<span class="token punctuation">,</span>
        login_last_1d_day_count<span class="token punctuation">,</span>
        login_last_7d_count<span class="token punctuation">,</span>
        login_last_7d_day_count<span class="token punctuation">,</span>
        login_last_30d_count<span class="token punctuation">,</span>
        login_last_30d_day_count<span class="token punctuation">,</span>
        login_count<span class="token punctuation">,</span>
        login_day_count<span class="token punctuation">,</span>
        order_date_first<span class="token punctuation">,</span>
        order_date_last<span class="token punctuation">,</span>
        order_last_1d_count<span class="token punctuation">,</span>
        order_activity_last_1d_count<span class="token punctuation">,</span>
        order_activity_reduce_last_1d_amount<span class="token punctuation">,</span>
        order_coupon_last_1d_count<span class="token punctuation">,</span>
        order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span>
        order_last_1d_original_amount<span class="token punctuation">,</span>
        order_last_1d_final_amount<span class="token punctuation">,</span>
        order_last_7d_count<span class="token punctuation">,</span>
        order_activity_last_7d_count<span class="token punctuation">,</span>
        order_activity_reduce_last_7d_amount<span class="token punctuation">,</span>
        order_coupon_last_7d_count<span class="token punctuation">,</span>
        order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span>
        order_last_7d_original_amount<span class="token punctuation">,</span>
        order_last_7d_final_amount<span class="token punctuation">,</span>
        order_last_30d_count<span class="token punctuation">,</span>
        order_activity_last_30d_count<span class="token punctuation">,</span>
        order_activity_reduce_last_30d_amount<span class="token punctuation">,</span>
        order_coupon_last_30d_count<span class="token punctuation">,</span>
        order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span>
        order_last_30d_original_amount<span class="token punctuation">,</span>
        order_last_30d_final_amount<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_activity_count<span class="token punctuation">,</span>
        order_activity_reduce_amount<span class="token punctuation">,</span>
        order_coupon_count<span class="token punctuation">,</span>
        order_coupon_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        payment_date_first<span class="token punctuation">,</span>
        payment_date_last<span class="token punctuation">,</span>
        payment_last_1d_count<span class="token punctuation">,</span>
        payment_last_1d_amount<span class="token punctuation">,</span>
        payment_last_7d_count<span class="token punctuation">,</span>
        payment_last_7d_amount<span class="token punctuation">,</span>
        payment_last_30d_count<span class="token punctuation">,</span>
        payment_last_30d_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        refund_order_last_1d_count<span class="token punctuation">,</span>
        refund_order_last_1d_num<span class="token punctuation">,</span>
        refund_order_last_1d_amount<span class="token punctuation">,</span>
        refund_order_last_7d_count<span class="token punctuation">,</span>
        refund_order_last_7d_num<span class="token punctuation">,</span>
        refund_order_last_7d_amount<span class="token punctuation">,</span>
        refund_order_last_30d_count<span class="token punctuation">,</span>
        refund_order_last_30d_num<span class="token punctuation">,</span>
        refund_order_last_30d_amount<span class="token punctuation">,</span>
        refund_order_count<span class="token punctuation">,</span>
        refund_order_num<span class="token punctuation">,</span>
        refund_order_amount<span class="token punctuation">,</span>
        refund_payment_last_1d_count<span class="token punctuation">,</span>
        refund_payment_last_1d_num<span class="token punctuation">,</span>
        refund_payment_last_1d_amount<span class="token punctuation">,</span>
        refund_payment_last_7d_count<span class="token punctuation">,</span>
        refund_payment_last_7d_num<span class="token punctuation">,</span>
        refund_payment_last_7d_amount<span class="token punctuation">,</span>
        refund_payment_last_30d_count<span class="token punctuation">,</span>
        refund_payment_last_30d_num<span class="token punctuation">,</span>
        refund_payment_last_30d_amount<span class="token punctuation">,</span>
        refund_payment_count<span class="token punctuation">,</span>
        refund_payment_num<span class="token punctuation">,</span>
        refund_payment_amount<span class="token punctuation">,</span>
        cart_last_1d_count<span class="token punctuation">,</span>
        cart_last_7d_count<span class="token punctuation">,</span>
        cart_last_30d_count<span class="token punctuation">,</span>
        cart_count<span class="token punctuation">,</span>
        favor_last_1d_count<span class="token punctuation">,</span>
        favor_last_7d_count<span class="token punctuation">,</span>
        favor_last_30d_count<span class="token punctuation">,</span>
        favor_count<span class="token punctuation">,</span>
        coupon_last_1d_get_count<span class="token punctuation">,</span>
        coupon_last_1d_using_count<span class="token punctuation">,</span>
        coupon_last_1d_used_count<span class="token punctuation">,</span>
        coupon_last_7d_get_count<span class="token punctuation">,</span>
        coupon_last_7d_using_count<span class="token punctuation">,</span>
        coupon_last_7d_used_count<span class="token punctuation">,</span>
        coupon_last_30d_get_count<span class="token punctuation">,</span>
        coupon_last_30d_using_count<span class="token punctuation">,</span>
        coupon_last_30d_used_count<span class="token punctuation">,</span>
        coupon_get_count<span class="token punctuation">,</span>
        coupon_using_count<span class="token punctuation">,</span>
        coupon_used_count<span class="token punctuation">,</span>
        appraise_last_1d_good_count<span class="token punctuation">,</span>
        appraise_last_1d_mid_count<span class="token punctuation">,</span>
        appraise_last_1d_bad_count<span class="token punctuation">,</span>
        appraise_last_1d_default_count<span class="token punctuation">,</span>
        appraise_last_7d_good_count<span class="token punctuation">,</span>
        appraise_last_7d_mid_count<span class="token punctuation">,</span>
        appraise_last_7d_bad_count<span class="token punctuation">,</span>
        appraise_last_7d_default_count<span class="token punctuation">,</span>
        appraise_last_30d_good_count<span class="token punctuation">,</span>
        appraise_last_30d_mid_count<span class="token punctuation">,</span>
        appraise_last_30d_bad_count<span class="token punctuation">,</span>
        appraise_last_30d_default_count<span class="token punctuation">,</span>
        appraise_good_count<span class="token punctuation">,</span>
        appraise_mid_count<span class="token punctuation">,</span>
        appraise_bad_count<span class="token punctuation">,</span>
        appraise_default_count
    <span class="token keyword">from</span> dwt_user_topic
    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>old
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        user_id<span class="token punctuation">,</span>
        login_count<span class="token punctuation">,</span>
        cart_count<span class="token punctuation">,</span>
        favor_count<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_activity_count<span class="token punctuation">,</span>
        order_activity_reduce_amount<span class="token punctuation">,</span>
        order_coupon_count<span class="token punctuation">,</span>
        order_coupon_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        refund_order_count<span class="token punctuation">,</span>
        refund_order_num<span class="token punctuation">,</span>
        refund_order_amount<span class="token punctuation">,</span>
        refund_payment_count<span class="token punctuation">,</span>
        refund_payment_num<span class="token punctuation">,</span>
        refund_payment_amount<span class="token punctuation">,</span>
        coupon_get_count<span class="token punctuation">,</span>
        coupon_using_count<span class="token punctuation">,</span>
        coupon_used_count<span class="token punctuation">,</span>
        appraise_good_count<span class="token punctuation">,</span>
        appraise_mid_count<span class="token punctuation">,</span>
        appraise_bad_count<span class="token punctuation">,</span>
        appraise_default_count
    <span class="token keyword">from</span> dws_user_action_daycount
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
<span class="token punctuation">)</span>1d_ago
<span class="token keyword">on</span> old<span class="token punctuation">.</span>user_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>user_id
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        user_id<span class="token punctuation">,</span>
        login_count<span class="token punctuation">,</span>
        cart_count<span class="token punctuation">,</span>
        favor_count<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_activity_count<span class="token punctuation">,</span>
        order_activity_reduce_amount<span class="token punctuation">,</span>
        order_coupon_count<span class="token punctuation">,</span>
        order_coupon_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        refund_order_count<span class="token punctuation">,</span>
        refund_order_num<span class="token punctuation">,</span>
        refund_order_amount<span class="token punctuation">,</span>
        refund_payment_count<span class="token punctuation">,</span>
        refund_payment_num<span class="token punctuation">,</span>
        refund_payment_amount<span class="token punctuation">,</span>
        coupon_get_count<span class="token punctuation">,</span>
        coupon_using_count<span class="token punctuation">,</span>
        coupon_used_count<span class="token punctuation">,</span>
        appraise_good_count<span class="token punctuation">,</span>
        appraise_mid_count<span class="token punctuation">,</span>
        appraise_bad_count<span class="token punctuation">,</span>
        appraise_default_count
    <span class="token keyword">from</span> dws_user_action_daycount
    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>7d_ago
<span class="token keyword">on</span> old<span class="token punctuation">.</span>user_id<span class="token operator">=</span>7d_ago<span class="token punctuation">.</span>user_id
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        user_id<span class="token punctuation">,</span>
        login_count<span class="token punctuation">,</span>
        cart_count<span class="token punctuation">,</span>
        favor_count<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_activity_count<span class="token punctuation">,</span>
        order_activity_reduce_amount<span class="token punctuation">,</span>
        order_coupon_count<span class="token punctuation">,</span>
        order_coupon_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        refund_order_count<span class="token punctuation">,</span>
        refund_order_num<span class="token punctuation">,</span>
        refund_order_amount<span class="token punctuation">,</span>
        refund_payment_count<span class="token punctuation">,</span>
        refund_payment_num<span class="token punctuation">,</span>
        refund_payment_amount<span class="token punctuation">,</span>
        coupon_get_count<span class="token punctuation">,</span>
        coupon_using_count<span class="token punctuation">,</span>
        coupon_used_count<span class="token punctuation">,</span>
        appraise_good_count<span class="token punctuation">,</span>
        appraise_mid_count<span class="token punctuation">,</span>
        appraise_bad_count<span class="token punctuation">,</span>
        appraise_default_count
    <span class="token keyword">from</span> dws_user_action_daycount
    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>30d_ago
<span class="token keyword">on</span> old<span class="token punctuation">.</span>user_id<span class="token operator">=</span>30d_ago<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
</code></pre>
<p>3）查询加载结果</p>
<h2 id="8-3-商品主题"><a href="#8-3-商品主题" class="headerlink" title="8.3 商品主题"></a>8.3 商品主题</h2><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwt_sku_topic<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwt_sku_topic
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'sku_id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被下单件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日参与活动被下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日使用优惠券被下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_reduce_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日优惠金额(活动)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_reduce_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日优惠金额(优惠券)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被下单原始金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_7d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被下单件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日参与活动被下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日使用优惠券被下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_reduce_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日优惠金额(活动)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_reduce_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日优惠金额(优惠券)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_7d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被下单原始金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_7d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_30d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被下单件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日参与活动被下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日使用优惠券被下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_reduce_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日优惠金额(活动)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_reduce_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日优惠金额(优惠券)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_30d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被下单原始金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_30d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被下单件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积参与活动被下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积使用优惠券被下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_activity_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积优惠金额(活动)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_coupon_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积优惠金额(优惠券)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被下单原始金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_1d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被支付件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_7d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被支付件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_30d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被支付件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被支付件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_1d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退单件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_7d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退单件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_30d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退单件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退单件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退款次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_1d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退款件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日退款金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退款次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_7d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退款件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日退款金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退款次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_30d_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退款件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日退款金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退款次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_num<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退款件数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退款金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>cart_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被加入购物车次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>cart_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被加入购物车次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>cart_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被加入购物车次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>cart_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被加入购物车次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>favor_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日被收藏次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>favor_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日被收藏次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>favor_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日被收藏次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>favor_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积被收藏次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_1d_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日好评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_1d_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日中评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_1d_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日差评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_1d_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日默认评价数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_7d_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日好评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_7d_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日中评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_7d_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日差评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_7d_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日默认评价数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_30d_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日好评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_30d_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日中评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_30d_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日差评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_last_30d_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日默认评价数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_good_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积好评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_mid_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积中评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_bad_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积差评数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>appraise_default_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积默认评价数'</span>
 <span class="token punctuation">)</span><span class="token keyword">COMMENT</span> <span class="token string">'商品主题宽表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwt/dwt_sku_topic/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）数据装载<br>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_sku_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    id<span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_reduce_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>cart_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>cart_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>cart_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>favor_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>favor_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>favor_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_1d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_1d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_1d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_1d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_7d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_7d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_7d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_7d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_30d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_30d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_30d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_last_30d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id
    <span class="token keyword">from</span> dim_sku_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>t1
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_1d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_7d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_activity_reduce_last_30d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_num<span class="token punctuation">)</span> order_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_count<span class="token punctuation">)</span> order_activity_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_count<span class="token punctuation">)</span> order_coupon_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_activity_reduce_amount<span class="token punctuation">)</span> order_activity_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_coupon_reduce_amount<span class="token punctuation">)</span> order_coupon_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>payment_num<span class="token punctuation">)</span> payment_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_num<span class="token punctuation">)</span> refund_order_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span> refund_order_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_num<span class="token punctuation">)</span> refund_payment_num<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span> refund_payment_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>cart_count<span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> favor_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>favor_count<span class="token punctuation">)</span> favor_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_good_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_mid_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_bad_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_1d_default_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_good_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_mid_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_bad_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_7d_default_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_good_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_mid_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_bad_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> appraise_last_30d_default_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_good_count<span class="token punctuation">)</span> appraise_good_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_mid_count<span class="token punctuation">)</span> appraise_mid_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_bad_count<span class="token punctuation">)</span> appraise_bad_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>appraise_default_count<span class="token punctuation">)</span> appraise_default_count
    <span class="token keyword">from</span> dws_sku_action_daycount
    <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id
<span class="token punctuation">)</span>t2
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>id<span class="token operator">=</span>t2<span class="token punctuation">.</span>sku_id<span class="token punctuation">;</span>
</code></pre>
<p>（2）每日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_sku_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>sku_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>sku_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_activity_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_coupon_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_1d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_1d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>cart_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>favor_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_7d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_last_30d_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_good_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_mid_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_bad_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>appraise_default_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        sku_id<span class="token punctuation">,</span>
        order_last_1d_count<span class="token punctuation">,</span>
        order_last_1d_num<span class="token punctuation">,</span>
        order_activity_last_1d_count<span class="token punctuation">,</span>
        order_coupon_last_1d_count<span class="token punctuation">,</span>
        order_activity_reduce_last_1d_amount<span class="token punctuation">,</span>
        order_coupon_reduce_last_1d_amount<span class="token punctuation">,</span>
        order_last_1d_original_amount<span class="token punctuation">,</span>
        order_last_1d_final_amount<span class="token punctuation">,</span>
        order_last_7d_count<span class="token punctuation">,</span>
        order_last_7d_num<span class="token punctuation">,</span>
        order_activity_last_7d_count<span class="token punctuation">,</span>
        order_coupon_last_7d_count<span class="token punctuation">,</span>
        order_activity_reduce_last_7d_amount<span class="token punctuation">,</span>
        order_coupon_reduce_last_7d_amount<span class="token punctuation">,</span>
        order_last_7d_original_amount<span class="token punctuation">,</span>
        order_last_7d_final_amount<span class="token punctuation">,</span>
        order_last_30d_count<span class="token punctuation">,</span>
        order_last_30d_num<span class="token punctuation">,</span>
        order_activity_last_30d_count<span class="token punctuation">,</span>
        order_coupon_last_30d_count<span class="token punctuation">,</span>
        order_activity_reduce_last_30d_amount<span class="token punctuation">,</span>
        order_coupon_reduce_last_30d_amount<span class="token punctuation">,</span>
        order_last_30d_original_amount<span class="token punctuation">,</span>
        order_last_30d_final_amount<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_num<span class="token punctuation">,</span>
        order_activity_count<span class="token punctuation">,</span>
        order_coupon_count<span class="token punctuation">,</span>
        order_activity_reduce_amount<span class="token punctuation">,</span>
        order_coupon_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        payment_last_1d_count<span class="token punctuation">,</span>
        payment_last_1d_num<span class="token punctuation">,</span>
        payment_last_1d_amount<span class="token punctuation">,</span>
        payment_last_7d_count<span class="token punctuation">,</span>
        payment_last_7d_num<span class="token punctuation">,</span>
        payment_last_7d_amount<span class="token punctuation">,</span>
        payment_last_30d_count<span class="token punctuation">,</span>
        payment_last_30d_num<span class="token punctuation">,</span>
        payment_last_30d_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_num<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        refund_order_last_1d_count<span class="token punctuation">,</span>
        refund_order_last_1d_num<span class="token punctuation">,</span>
        refund_order_last_1d_amount<span class="token punctuation">,</span>
        refund_order_last_7d_count<span class="token punctuation">,</span>
        refund_order_last_7d_num<span class="token punctuation">,</span>
        refund_order_last_7d_amount<span class="token punctuation">,</span>
        refund_order_last_30d_count<span class="token punctuation">,</span>
        refund_order_last_30d_num<span class="token punctuation">,</span>
        refund_order_last_30d_amount<span class="token punctuation">,</span>
        refund_order_count<span class="token punctuation">,</span>
        refund_order_num<span class="token punctuation">,</span>
        refund_order_amount<span class="token punctuation">,</span>
        refund_payment_last_1d_count<span class="token punctuation">,</span>
        refund_payment_last_1d_num<span class="token punctuation">,</span>
        refund_payment_last_1d_amount<span class="token punctuation">,</span>
        refund_payment_last_7d_count<span class="token punctuation">,</span>
        refund_payment_last_7d_num<span class="token punctuation">,</span>
        refund_payment_last_7d_amount<span class="token punctuation">,</span>
        refund_payment_last_30d_count<span class="token punctuation">,</span>
        refund_payment_last_30d_num<span class="token punctuation">,</span>
        refund_payment_last_30d_amount<span class="token punctuation">,</span>
        refund_payment_count<span class="token punctuation">,</span>
        refund_payment_num<span class="token punctuation">,</span>
        refund_payment_amount<span class="token punctuation">,</span>
        cart_last_1d_count<span class="token punctuation">,</span>
        cart_last_7d_count<span class="token punctuation">,</span>
        cart_last_30d_count<span class="token punctuation">,</span>
        cart_count<span class="token punctuation">,</span>
        favor_last_1d_count<span class="token punctuation">,</span>
        favor_last_7d_count<span class="token punctuation">,</span>
        favor_last_30d_count<span class="token punctuation">,</span>
        favor_count<span class="token punctuation">,</span>
        appraise_last_1d_good_count<span class="token punctuation">,</span>
        appraise_last_1d_mid_count<span class="token punctuation">,</span>
        appraise_last_1d_bad_count<span class="token punctuation">,</span>
        appraise_last_1d_default_count<span class="token punctuation">,</span>
        appraise_last_7d_good_count<span class="token punctuation">,</span>
        appraise_last_7d_mid_count<span class="token punctuation">,</span>
        appraise_last_7d_bad_count<span class="token punctuation">,</span>
        appraise_last_7d_default_count<span class="token punctuation">,</span>
        appraise_last_30d_good_count<span class="token punctuation">,</span>
        appraise_last_30d_mid_count<span class="token punctuation">,</span>
        appraise_last_30d_bad_count<span class="token punctuation">,</span>
        appraise_last_30d_default_count<span class="token punctuation">,</span>
        appraise_good_count<span class="token punctuation">,</span>
        appraise_mid_count<span class="token punctuation">,</span>
        appraise_bad_count<span class="token punctuation">,</span>
        appraise_default_count
    <span class="token keyword">from</span> dwt_sku_topic
    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>old
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        sku_id<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_num<span class="token punctuation">,</span>
        order_activity_count<span class="token punctuation">,</span>
        order_coupon_count<span class="token punctuation">,</span>
        order_activity_reduce_amount<span class="token punctuation">,</span>
        order_coupon_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_num<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        refund_order_count<span class="token punctuation">,</span>
        refund_order_num<span class="token punctuation">,</span>
        refund_order_amount<span class="token punctuation">,</span>
        refund_payment_count<span class="token punctuation">,</span>
        refund_payment_num<span class="token punctuation">,</span>
        refund_payment_amount<span class="token punctuation">,</span>
        cart_count<span class="token punctuation">,</span>
        favor_count<span class="token punctuation">,</span>
        appraise_good_count<span class="token punctuation">,</span>
        appraise_mid_count<span class="token punctuation">,</span>
        appraise_bad_count<span class="token punctuation">,</span>
        appraise_default_count
    <span class="token keyword">from</span> dws_sku_action_daycount
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
<span class="token punctuation">)</span>1d_ago
<span class="token keyword">on</span> old<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>sku_id
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        sku_id<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_num<span class="token punctuation">,</span>
        order_activity_count<span class="token punctuation">,</span>
        order_coupon_count<span class="token punctuation">,</span>
        order_activity_reduce_amount<span class="token punctuation">,</span>
        order_coupon_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_num<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        refund_order_count<span class="token punctuation">,</span>
        refund_order_num<span class="token punctuation">,</span>
        refund_order_amount<span class="token punctuation">,</span>
        refund_payment_count<span class="token punctuation">,</span>
        refund_payment_num<span class="token punctuation">,</span>
        refund_payment_amount<span class="token punctuation">,</span>
        cart_count<span class="token punctuation">,</span>
        favor_count<span class="token punctuation">,</span>
        appraise_good_count<span class="token punctuation">,</span>
        appraise_mid_count<span class="token punctuation">,</span>
        appraise_bad_count<span class="token punctuation">,</span>
        appraise_default_count
    <span class="token keyword">from</span> dws_sku_action_daycount
    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>7d_ago
<span class="token keyword">on</span> old<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>7d_ago<span class="token punctuation">.</span>sku_id
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        sku_id<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_num<span class="token punctuation">,</span>
        order_activity_count<span class="token punctuation">,</span>
        order_coupon_count<span class="token punctuation">,</span>
        order_activity_reduce_amount<span class="token punctuation">,</span>
        order_coupon_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_num<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        refund_order_count<span class="token punctuation">,</span>
        refund_order_num<span class="token punctuation">,</span>
        refund_order_amount<span class="token punctuation">,</span>
        refund_payment_count<span class="token punctuation">,</span>
        refund_payment_num<span class="token punctuation">,</span>
        refund_payment_amount<span class="token punctuation">,</span>
        cart_count<span class="token punctuation">,</span>
        favor_count<span class="token punctuation">,</span>
        appraise_good_count<span class="token punctuation">,</span>
        appraise_mid_count<span class="token punctuation">,</span>
        appraise_bad_count<span class="token punctuation">,</span>
        appraise_default_count
    <span class="token keyword">from</span> dws_sku_action_daycount
    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>30d_ago
<span class="token keyword">on</span> old<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>30d_ago<span class="token punctuation">.</span>sku_id<span class="token punctuation">;</span>
</code></pre>
<p>3）查询加载结果</p>
<h2 id="8-4-优惠券主题"><a href="#8-4-优惠券主题" class="headerlink" title="8.4 优惠券主题"></a>8.4 优惠券主题</h2><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwt_coupon_topic<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwt_coupon_topic<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>coupon_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>get_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日领取次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>get_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日领取次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>get_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日领取次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>get_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积领取次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日使用某券下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日使用某券下单优惠金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日使用某券下单原始金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日使用某券下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日使用某券下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_7d_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日使用某券下单优惠金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_7d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日使用某券下单原始金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_7d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日使用某券下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日使用某券下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_30d_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日使用某券下单优惠金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_30d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日使用某券下单原始金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_30d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日使用某券下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积使用(下单)次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用某券累积下单优惠金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用某券累积下单原始金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用某券累积下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日使用某券支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_1d_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日使用某券优惠金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日使用某券支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日使用某券支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_7d_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日使用某券优惠金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日使用某券支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日使用某券支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_30d_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日使用某券优惠金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日使用某券支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积使用(支付)次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用某券累积优惠金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用某券累积支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>expire_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日过期次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>expire_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日过期次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>expire_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日过期次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>expire_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积过期次数'</span>
<span class="token punctuation">)</span><span class="token keyword">comment</span> <span class="token string">'优惠券主题表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwt/dwt_coupon_topic/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）数据装载<br>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_coupon_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    id<span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>get_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>get_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>get_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_7d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_30d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_1d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_7d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_30d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>expire_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>expire_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>expire_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id
    <span class="token keyword">from</span> dim_coupon_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>t1
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        coupon_id coupon_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> get_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> get_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> get_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>get_count<span class="token punctuation">)</span> get_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span> order_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">)</span> payment_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> expire_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> expire_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> expire_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>expire_count<span class="token punctuation">)</span> expire_count
    <span class="token keyword">from</span> dws_coupon_info_daycount
    <span class="token keyword">group</span> <span class="token keyword">by</span> coupon_id
<span class="token punctuation">)</span>t2
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>id<span class="token operator">=</span>t2<span class="token punctuation">.</span>coupon_id<span class="token punctuation">;</span>
</code></pre>
<p>（2）每日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_coupon_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>coupon_id<span class="token punctuation">,</span>old<span class="token punctuation">.</span>coupon_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>get_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>get_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>get_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_1d_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>expire_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>expire_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>expire_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        coupon_id<span class="token punctuation">,</span>
        get_last_1d_count<span class="token punctuation">,</span>
        get_last_7d_count<span class="token punctuation">,</span>
        get_last_30d_count<span class="token punctuation">,</span>
        get_count<span class="token punctuation">,</span>
        order_last_1d_count<span class="token punctuation">,</span>
        order_last_1d_reduce_amount<span class="token punctuation">,</span>
        order_last_1d_original_amount<span class="token punctuation">,</span>
        order_last_1d_final_amount<span class="token punctuation">,</span>
        order_last_7d_count<span class="token punctuation">,</span>
        order_last_7d_reduce_amount<span class="token punctuation">,</span>
        order_last_7d_original_amount<span class="token punctuation">,</span>
        order_last_7d_final_amount<span class="token punctuation">,</span>
        order_last_30d_count<span class="token punctuation">,</span>
        order_last_30d_reduce_amount<span class="token punctuation">,</span>
        order_last_30d_original_amount<span class="token punctuation">,</span>
        order_last_30d_final_amount<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        payment_last_1d_count<span class="token punctuation">,</span>
        payment_last_1d_reduce_amount<span class="token punctuation">,</span>
        payment_last_1d_amount<span class="token punctuation">,</span>
        payment_last_7d_count<span class="token punctuation">,</span>
        payment_last_7d_reduce_amount<span class="token punctuation">,</span>
        payment_last_7d_amount<span class="token punctuation">,</span>
        payment_last_30d_count<span class="token punctuation">,</span>
        payment_last_30d_reduce_amount<span class="token punctuation">,</span>
        payment_last_30d_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_reduce_amount<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        expire_last_1d_count<span class="token punctuation">,</span>
        expire_last_7d_count<span class="token punctuation">,</span>
        expire_last_30d_count<span class="token punctuation">,</span>
        expire_count
    <span class="token keyword">from</span> dwt_coupon_topic
    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>old
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        coupon_id<span class="token punctuation">,</span>
        get_count<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_reduce_amount<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        expire_count
    <span class="token keyword">from</span> dws_coupon_info_daycount
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
<span class="token punctuation">)</span>1d_ago
<span class="token keyword">on</span> old<span class="token punctuation">.</span>coupon_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>coupon_id
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        coupon_id<span class="token punctuation">,</span>
        get_count<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_reduce_amount<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        expire_count
    <span class="token keyword">from</span> dws_coupon_info_daycount
    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>7d_ago
<span class="token keyword">on</span> old<span class="token punctuation">.</span>coupon_id<span class="token operator">=</span>7d_ago<span class="token punctuation">.</span>coupon_id
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        coupon_id<span class="token punctuation">,</span>
        get_count<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_reduce_amount<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_reduce_amount<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        expire_count
    <span class="token keyword">from</span> dws_coupon_info_daycount
    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>30d_ago
<span class="token keyword">on</span> old<span class="token punctuation">.</span>coupon_id<span class="token operator">=</span>30d_ago<span class="token punctuation">.</span>coupon_id<span class="token punctuation">;</span>
</code></pre>
<p>3）查询加载结果</p>
<h2 id="8-5-活动主题"><a href="#8-5-活动主题" class="headerlink" title="8.5 活动主题"></a>8.5 活动主题</h2><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwt_activity_topic<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwt_activity_topic<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>activity_rule_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动规则ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING  <span class="token keyword">COMMENT</span> <span class="token string">'活动ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日参与某活动某规则下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日参与某活动某规则下单优惠金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日参与某活动某规则下单原始金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日参与某活动某规则下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则累积下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则累积下单优惠金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则累积下单原始金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则累积下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日参与某活动某规则支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_1d_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日参与某活动某规则支付优惠金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日参与某活动某规则支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则累积支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则累积支付优惠金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与某活动某规则累积支付金额'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动主题宽表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwt/dwt_activity_topic/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）数据装载<br>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_activity_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    t1<span class="token punctuation">.</span>activity_rule_id<span class="token punctuation">,</span>
    t1<span class="token punctuation">.</span>activity_id<span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_1d_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        activity_rule_id<span class="token punctuation">,</span>
        activity_id
    <span class="token keyword">from</span> dim_activity_rule_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>t1
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        activity_rule_id<span class="token punctuation">,</span>
        activity_id<span class="token punctuation">,</span>

        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span> order_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_reduce_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>payment_reduce_amount<span class="token punctuation">)</span> payment_reduce_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount
    <span class="token keyword">from</span> dws_activity_info_daycount
    <span class="token keyword">group</span> <span class="token keyword">by</span> activity_rule_id<span class="token punctuation">,</span>activity_id

<span class="token punctuation">)</span>t2
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>activity_rule_id<span class="token operator">=</span>t2<span class="token punctuation">.</span>activity_rule_id
<span class="token operator">and</span> t1<span class="token punctuation">.</span>activity_id<span class="token operator">=</span>t2<span class="token punctuation">.</span>activity_id<span class="token punctuation">;</span>
</code></pre>
<p>（2）每日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_activity_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-
insert overwrite table dwt_activity_topic partition(dt='</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">15</span><span class="token string">')
select
    nvl(1d_ago.activity_rule_id,old.activity_rule_id),
    nvl(1d_ago.activity_id,old.activity_id),
    nvl(1d_ago.order_count,0),
    nvl(1d_ago.order_reduce_amount,0.0),
    nvl(1d_ago.order_original_amount,0.0),
    nvl(1d_ago.order_final_amount,0.0),
    nvl(old.order_count,0)+nvl(1d_ago.order_count,0),
    nvl(old.order_reduce_amount,0.0)+nvl(1d_ago.order_reduce_amount,0.0),
    nvl(old.order_original_amount,0.0)+nvl(1d_ago.order_original_amount,0.0),
    nvl(old.order_final_amount,0.0)+nvl(1d_ago.order_final_amount,0.0),
    nvl(1d_ago.payment_count,0),
    nvl(1d_ago.payment_reduce_amount,0.0),
    nvl(1d_ago.payment_amount,0.0),
    nvl(old.payment_count,0)+nvl(1d_ago.payment_count,0),
    nvl(old.payment_reduce_amount,0.0)+nvl(1d_ago.payment_reduce_amount,0.0),
    nvl(old.payment_amount,0.0)+nvl(1d_ago.payment_amount,0.0)
from
(
    select
        activity_rule_id,
        activity_id,
        order_count,
        order_reduce_amount,
        order_original_amount,
        order_final_amount,
        payment_count,
        payment_reduce_amount,
        payment_amount
    from dwt_activity_topic
    where dt=date_add('</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">15</span><span class="token string">',-1)
)old
full outer join
(
    select
        activity_rule_id,
        activity_id,
        order_count,
        order_reduce_amount,
        order_original_amount,
        order_final_amount,
        payment_count,
        payment_reduce_amount,
        payment_amount
    from dws_activity_info_daycount
    where dt='</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">15</span>'
<span class="token punctuation">)</span>1d_ago
<span class="token keyword">on</span> old<span class="token punctuation">.</span>activity_rule_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>activity_rule_id<span class="token punctuation">;</span>
</code></pre>
<p>3）查询加载结果</p>
<h2 id="8-6-地区主题"><a href="#8-6-地区主题" class="headerlink" title="8.6 地区主题"></a>8.6 地区主题</h2><p>1）建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dwt_area_topic<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dwt_area_topic<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visit_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日访客访问次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>login_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1日用户访问次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visit_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7访客访问次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>login_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7日用户访问次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visit_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日访客访问次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>login_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30日用户访问次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>visit_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积访客访问次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>login_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积用户访问次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天下单原始金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_1d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_7d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天下单原始金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_7d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_30d_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天下单原始金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_last_30d_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积下单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积下单原始金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积下单最终金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积支付次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积支付金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天退单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天退单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天退单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天退单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天退单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天退单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退单次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退单金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_1d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天退款次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_1d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近1天退款金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_7d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天退款次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_7d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近7天退款金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_30d_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天退款次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_last_30d_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近30天退款金额'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退款次数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>refund_payment_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'累积退款金额'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'地区主题宽表'</span>
PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING<span class="token punctuation">)</span>
STORED <span class="token keyword">AS</span> PARQUET
LOCATION <span class="token string">'/warehouse/gmall/dwt/dwt_area_topic/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"parquet.compression"</span><span class="token operator">=</span><span class="token string">"lzo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>2）数据装载<br>（1）首日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_area_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    id<span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>visit_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>login_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>visit_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>login_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>visit_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>login_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_1d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_1d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_1d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id
    <span class="token keyword">from</span> dim_base_province
<span class="token punctuation">)</span>t1
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        province_id province_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> visit_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> visit_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> visit_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> login_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>visit_count<span class="token punctuation">)</span> visit_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>login_count<span class="token punctuation">)</span> login_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_1d_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_7d_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_last_30d_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_1d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_7d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_last_30d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>payment_count<span class="token punctuation">)</span> payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>payment_amount<span class="token punctuation">)</span> payment_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_1d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_7d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_order_last_30d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_count<span class="token punctuation">)</span> refund_order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_order_amount<span class="token punctuation">)</span> refund_order_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_1d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_7d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> refund_payment_last_30d_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_count<span class="token punctuation">)</span> refund_payment_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>refund_payment_amount<span class="token punctuation">)</span> refund_payment_amount
    <span class="token keyword">from</span> dws_area_stats_daycount
    <span class="token keyword">group</span> <span class="token keyword">by</span> province_id
<span class="token punctuation">)</span>t2
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>id<span class="token operator">=</span>t2<span class="token punctuation">.</span>province_id<span class="token punctuation">;</span>
</code></pre>
<p>（2）每日装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dwt_area_topic <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>province_id<span class="token punctuation">,</span> 1d_ago<span class="token punctuation">.</span>province_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>visit_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>login_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_7d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_last_30d_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_original_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>order_final_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_order_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_7d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>7d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_last_30d_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">-</span> nvl<span class="token punctuation">(</span>30d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nvl<span class="token punctuation">(</span>old<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">+</span>nvl<span class="token punctuation">(</span>1d_ago<span class="token punctuation">.</span>refund_payment_amount<span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span>

<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        province_id<span class="token punctuation">,</span>
        visit_last_1d_count<span class="token punctuation">,</span>
        login_last_1d_count<span class="token punctuation">,</span>
        visit_last_7d_count<span class="token punctuation">,</span>
        login_last_7d_count<span class="token punctuation">,</span>
        visit_last_30d_count<span class="token punctuation">,</span>
        login_last_30d_count<span class="token punctuation">,</span>
        visit_count<span class="token punctuation">,</span>
        login_count<span class="token punctuation">,</span>
        order_last_1d_count<span class="token punctuation">,</span>
        order_last_1d_original_amount<span class="token punctuation">,</span>
        order_last_1d_final_amount<span class="token punctuation">,</span>
        order_last_7d_count<span class="token punctuation">,</span>
        order_last_7d_original_amount<span class="token punctuation">,</span>
        order_last_7d_final_amount<span class="token punctuation">,</span>
        order_last_30d_count<span class="token punctuation">,</span>
        order_last_30d_original_amount<span class="token punctuation">,</span>
        order_last_30d_final_amount<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        payment_last_1d_count<span class="token punctuation">,</span>
        payment_last_1d_amount<span class="token punctuation">,</span>
        payment_last_7d_count<span class="token punctuation">,</span>
        payment_last_7d_amount<span class="token punctuation">,</span>
        payment_last_30d_count<span class="token punctuation">,</span>
        payment_last_30d_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        refund_order_last_1d_count<span class="token punctuation">,</span>
        refund_order_last_1d_amount<span class="token punctuation">,</span>
        refund_order_last_7d_count<span class="token punctuation">,</span>
        refund_order_last_7d_amount<span class="token punctuation">,</span>
        refund_order_last_30d_count<span class="token punctuation">,</span>
        refund_order_last_30d_amount<span class="token punctuation">,</span>
        refund_order_count<span class="token punctuation">,</span>
        refund_order_amount<span class="token punctuation">,</span>
        refund_payment_last_1d_count<span class="token punctuation">,</span>
        refund_payment_last_1d_amount<span class="token punctuation">,</span>
        refund_payment_last_7d_count<span class="token punctuation">,</span>
        refund_payment_last_7d_amount<span class="token punctuation">,</span>
        refund_payment_last_30d_count<span class="token punctuation">,</span>
        refund_payment_last_30d_amount<span class="token punctuation">,</span>
        refund_payment_count<span class="token punctuation">,</span>
        refund_payment_amount
    <span class="token keyword">from</span> dwt_area_topic
    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>old
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        province_id<span class="token punctuation">,</span>
        visit_count<span class="token punctuation">,</span>
        login_count<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        refund_order_count<span class="token punctuation">,</span>
        refund_order_amount<span class="token punctuation">,</span>
        refund_payment_count<span class="token punctuation">,</span>
        refund_payment_amount
    <span class="token keyword">from</span> dws_area_stats_daycount
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-15'</span>
<span class="token punctuation">)</span>1d_ago
<span class="token keyword">on</span> old<span class="token punctuation">.</span>province_id<span class="token operator">=</span>1d_ago<span class="token punctuation">.</span>province_id
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        province_id<span class="token punctuation">,</span>
        visit_count<span class="token punctuation">,</span>
        login_count<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        refund_order_count<span class="token punctuation">,</span>
        refund_order_amount<span class="token punctuation">,</span>
        refund_payment_count<span class="token punctuation">,</span>
        refund_payment_amount
    <span class="token keyword">from</span> dws_area_stats_daycount
    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>7d_ago
<span class="token keyword">on</span> old<span class="token punctuation">.</span>province_id<span class="token operator">=</span> 7d_ago<span class="token punctuation">.</span>province_id
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        province_id<span class="token punctuation">,</span>
        visit_count<span class="token punctuation">,</span>
        login_count<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        payment_count<span class="token punctuation">,</span>
        payment_amount<span class="token punctuation">,</span>
        refund_order_count<span class="token punctuation">,</span>
        refund_order_amount<span class="token punctuation">,</span>
        refund_payment_count<span class="token punctuation">,</span>
        refund_payment_amount
    <span class="token keyword">from</span> dws_area_stats_daycount
    <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-15'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>30d_ago
<span class="token keyword">on</span> old<span class="token punctuation">.</span>province_id<span class="token operator">=</span> 30d_ago<span class="token punctuation">.</span>province_id<span class="token punctuation">;</span>
</code></pre>
<p>3）查询加载结果</p>
<h2 id="8-7-DWT层首日数据导入脚本"><a href="#8-7-DWT层首日数据导入脚本" class="headerlink" title="8.7 DWT层首日数据导入脚本"></a>8.7 DWT层首日数据导入脚本</h2><p>1）编写脚本<br>（1）在/home/atguigu/bin目录下创建脚本dws_to_dwt_init.sh</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim dws_to_dwt_init.sh
</code></pre>
<p>在脚本中填写如下内容</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash

APP=gmall

if [ -n "$2" ] ;then
   do_date=$2
else 
   echo "请传入日期参数"
   exit
fi 

dwt_visitor_topic="
insert overwrite table ${APP}.dwt_visitor_topic partition(dt='$do_date')
select
    nvl(1d_ago.mid_id,old.mid_id),
    nvl(1d_ago.brand,old.brand),
    nvl(1d_ago.model,old.model),
    nvl(1d_ago.channel,old.channel),
    nvl(1d_ago.os,old.os),
    nvl(1d_ago.area_code,old.area_code),
    nvl(1d_ago.version_code,old.version_code),
    case when old.mid_id is null and 1d_ago.is_new=1 then '$do_date'
         when old.mid_id is null and 1d_ago.is_new=0 then '2020-06-13'--无法获取准确的首次登录日期，给定一个数仓搭建日之前的日期
         else old.visit_date_first end,
    if(1d_ago.mid_id is not null,'$do_date',old.visit_date_last),
    nvl(1d_ago.visit_count,0),
    if(1d_ago.mid_id is null,0,1),
    nvl(old.visit_last_7d_count,0)+nvl(1d_ago.visit_count,0)- nvl(7d_ago.visit_count,0),
    nvl(old.visit_last_7d_day_count,0)+if(1d_ago.mid_id is null,0,1)- if(7d_ago.mid_id is null,0,1),
    nvl(old.visit_last_30d_count,0)+nvl(1d_ago.visit_count,0)- nvl(30d_ago.visit_count,0),
    nvl(old.visit_last_30d_day_count,0)+if(1d_ago.mid_id is null,0,1)- if(30d_ago.mid_id is null,0,1),
    nvl(old.visit_count,0)+nvl(1d_ago.visit_count,0),
    nvl(old.visit_day_count,0)+if(1d_ago.mid_id is null,0,1)
from
(
    select
        mid_id,
        brand,
        model,
        channel,
        os,
        area_code,
        version_code,
        visit_date_first,
        visit_date_last,
        visit_last_1d_count,
        visit_last_1d_day_count,
        visit_last_7d_count,
        visit_last_7d_day_count,
        visit_last_30d_count,
        visit_last_30d_day_count,
        visit_count,
        visit_day_count
    from ${APP}.dwt_visitor_topic
    where dt=date_add('$do_date',-1)
)old
full outer join
(
    select
        mid_id,
        brand,
        model,
        is_new,
        channel,
        os,
        area_code,
        version_code,
        visit_count
    from ${APP}.dws_visitor_action_daycount
    where dt='$do_date'
)1d_ago
on old.mid_id=1d_ago.mid_id
left join
(
    select
        mid_id,
        brand,
        model,
        is_new,
        channel,
        os,
        area_code,
        version_code,
        visit_count
    from ${APP}.dws_visitor_action_daycount
    where dt=date_add('$do_date',-7)
)7d_ago
on old.mid_id=7d_ago.mid_id
left join
(
    select
        mid_id,
        brand,
        model,
        is_new,
        channel,
        os,
        area_code,
        version_code,
        visit_count
    from ${APP}.dws_visitor_action_daycount
    where dt=date_add('$do_date',-30)
)30d_ago
on old.mid_id=30d_ago.mid_id;
"

dwt_user_topic="
insert overwrite table ${APP}.dwt_user_topic partition(dt='$do_date')
select
    id,
    login_date_first,--以用户的创建日期作为首次登录日期
    nvl(login_date_last,date_add('$do_date',-1)),--若有历史登录记录，则根据历史记录获取末次登录日期，否则统一指定一个日期
    nvl(login_last_1d_count,0),
    nvl(login_last_1d_day_count,0),
    nvl(login_last_7d_count,0),
    nvl(login_last_7d_day_count,0),
    nvl(login_last_30d_count,0),
    nvl(login_last_30d_day_count,0),
    nvl(login_count,0),
    nvl(login_day_count,0),
    order_date_first,
    order_date_last,
    nvl(order_last_1d_count,0),
    nvl(order_activity_last_1d_count,0),
    nvl(order_activity_reduce_last_1d_amount,0),
    nvl(order_coupon_last_1d_count,0),
    nvl(order_coupon_reduce_last_1d_amount,0),
    nvl(order_last_1d_original_amount,0),
    nvl(order_last_1d_final_amount,0),
    nvl(order_last_7d_count,0),
    nvl(order_activity_last_7d_count,0),
    nvl(order_activity_reduce_last_7d_amount,0),
    nvl(order_coupon_last_7d_count,0),
    nvl(order_coupon_reduce_last_7d_amount,0),
    nvl(order_last_7d_original_amount,0),
    nvl(order_last_7d_final_amount,0),
    nvl(order_last_30d_count,0),
    nvl(order_activity_last_30d_count,0),
    nvl(order_activity_reduce_last_30d_amount,0),
    nvl(order_coupon_last_30d_count,0),
    nvl(order_coupon_reduce_last_30d_amount,0),
    nvl(order_last_30d_original_amount,0),
    nvl(order_last_30d_final_amount,0),
    nvl(order_count,0),
    nvl(order_activity_count,0),
    nvl(order_activity_reduce_amount,0),
    nvl(order_coupon_count,0),
    nvl(order_coupon_reduce_amount,0),
    nvl(order_original_amount,0),
    nvl(order_final_amount,0),
    payment_date_first,
    payment_date_last,
    nvl(payment_last_1d_count,0),
    nvl(payment_last_1d_amount,0),
    nvl(payment_last_7d_count,0),
    nvl(payment_last_7d_amount,0),
    nvl(payment_last_30d_count,0),
    nvl(payment_last_30d_amount,0),
    nvl(payment_count,0),
    nvl(payment_amount,0),
    nvl(refund_order_last_1d_count,0),
    nvl(refund_order_last_1d_num,0),
    nvl(refund_order_last_1d_amount,0),
    nvl(refund_order_last_7d_count,0),
    nvl(refund_order_last_7d_num,0),
    nvl(refund_order_last_7d_amount,0),
    nvl(refund_order_last_30d_count,0),
    nvl(refund_order_last_30d_num,0),
    nvl(refund_order_last_30d_amount,0),
    nvl(refund_order_count,0),
    nvl(refund_order_num,0),
    nvl(refund_order_amount,0),
    nvl(refund_payment_last_1d_count,0),
    nvl(refund_payment_last_1d_num,0),
    nvl(refund_payment_last_1d_amount,0),
    nvl(refund_payment_last_7d_count,0),
    nvl(refund_payment_last_7d_num,0),
    nvl(refund_payment_last_7d_amount,0),
    nvl(refund_payment_last_30d_count,0),
    nvl(refund_payment_last_30d_num,0),
    nvl(refund_payment_last_30d_amount,0),
    nvl(refund_payment_count,0),
    nvl(refund_payment_num,0),
    nvl(refund_payment_amount,0),
    nvl(cart_last_1d_count,0),
    nvl(cart_last_7d_count,0),
    nvl(cart_last_30d_count,0),
    nvl(cart_count,0),
    nvl(favor_last_1d_count,0),
    nvl(favor_last_7d_count,0),
    nvl(favor_last_30d_count,0),
    nvl(favor_count,0),
    nvl(coupon_last_1d_get_count,0),
    nvl(coupon_last_1d_using_count,0),
    nvl(coupon_last_1d_used_count,0),
    nvl(coupon_last_7d_get_count,0),
    nvl(coupon_last_7d_using_count,0),
    nvl(coupon_last_7d_used_count,0),
    nvl(coupon_last_30d_get_count,0),
    nvl(coupon_last_30d_using_count,0),
    nvl(coupon_last_30d_used_count,0),
    nvl(coupon_get_count,0),
    nvl(coupon_using_count,0),
    nvl(coupon_used_count,0),
    nvl(appraise_last_1d_good_count,0),
    nvl(appraise_last_1d_mid_count,0),
    nvl(appraise_last_1d_bad_count,0),
    nvl(appraise_last_1d_default_count,0),
    nvl(appraise_last_7d_good_count,0),
    nvl(appraise_last_7d_mid_count,0),
    nvl(appraise_last_7d_bad_count,0),
    nvl(appraise_last_7d_default_count,0),
    nvl(appraise_last_30d_good_count,0),
    nvl(appraise_last_30d_mid_count,0),
    nvl(appraise_last_30d_bad_count,0),
    nvl(appraise_last_30d_default_count,0),
    nvl(appraise_good_count,0),
    nvl(appraise_mid_count,0),
    nvl(appraise_bad_count,0),
    nvl(appraise_default_count,0)
from
(
    select
        id,
        date_format(create_time,'yyyy-MM-dd') login_date_first
    from ${APP}.dim_user_info
    where dt='9999-99-99'
)t1
left join
(
    select
        user_id user_id,
        max(dt) login_date_last,
        sum(if(dt='$do_date',login_count,0)) login_last_1d_count,
        sum(if(dt='$do_date' and login_count>0,1,0)) login_last_1d_day_count,
        sum(if(dt>=date_add('$do_date',-6),login_count,0)) login_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6) and login_count>0,1,0)) login_last_7d_day_count,
        sum(if(dt>=date_add('$do_date',-29),login_count,0)) login_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29) and login_count>0,1,0)) login_last_30d_day_count,
        sum(login_count) login_count,
        sum(if(login_count>0,1,0)) login_day_count,
        min(if(order_count>0,dt,null)) order_date_first,
        max(if(order_count>0,dt,null)) order_date_last,
        sum(if(dt='$do_date',order_count,0)) order_last_1d_count,
        sum(if(dt='$do_date',order_activity_count,0)) order_activity_last_1d_count,
        sum(if(dt='$do_date',order_activity_reduce_amount,0)) order_activity_reduce_last_1d_amount,
        sum(if(dt='$do_date',order_coupon_count,0)) order_coupon_last_1d_count,
        sum(if(dt='$do_date',order_coupon_reduce_amount,0)) order_coupon_reduce_last_1d_amount,
        sum(if(dt='$do_date',order_original_amount,0)) order_last_1d_original_amount,
        sum(if(dt='$do_date',order_final_amount,0)) order_last_1d_final_amount,
        sum(if(dt>=date_add('$do_date',-6),order_count,0)) order_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),order_activity_count,0)) order_activity_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),order_activity_reduce_amount,0)) order_activity_reduce_last_7d_amount,
        sum(if(dt>=date_add('$do_date',-6),order_coupon_count,0)) order_coupon_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),order_coupon_reduce_amount,0)) order_coupon_reduce_last_7d_amount,
        sum(if(dt>=date_add('$do_date',-6),order_original_amount,0)) order_last_7d_original_amount,
        sum(if(dt>=date_add('$do_date',-6),order_final_amount,0)) order_last_7d_final_amount,
        sum(if(dt>=date_add('$do_date',-29),order_count,0)) order_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),order_activity_count,0)) order_activity_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),order_activity_reduce_amount,0)) order_activity_reduce_last_30d_amount,
        sum(if(dt>=date_add('$do_date',-29),order_coupon_count,0)) order_coupon_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),order_coupon_reduce_amount,0)) order_coupon_reduce_last_30d_amount,
        sum(if(dt>=date_add('$do_date',-29),order_original_amount,0)) order_last_30d_original_amount,
        sum(if(dt>=date_add('$do_date',-29),order_final_amount,0)) order_last_30d_final_amount,
        sum(order_count) order_count,
        sum(order_activity_count) order_activity_count,
        sum(order_activity_reduce_amount) order_activity_reduce_amount,
        sum(order_coupon_count) order_coupon_count,
        sum(order_coupon_reduce_amount) order_coupon_reduce_amount,
        sum(order_original_amount) order_original_amount,
        sum(order_final_amount) order_final_amount,
        min(if(payment_count>0,dt,null)) payment_date_first,
        max(if(payment_count>0,dt,null)) payment_date_last,
        sum(if(dt='$do_date',payment_count,0)) payment_last_1d_count,
        sum(if(dt='$do_date',payment_amount,0)) payment_last_1d_amount,
        sum(if(dt>=date_add('$do_date',-6),payment_count,0)) payment_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),payment_amount,0)) payment_last_7d_amount,
        sum(if(dt>=date_add('$do_date',-29),payment_count,0)) payment_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),payment_amount,0)) payment_last_30d_amount,
        sum(payment_count) payment_count,
        sum(payment_amount) payment_amount,
        sum(if(dt='$do_date',refund_order_count,0)) refund_order_last_1d_count,
        sum(if(dt='$do_date',refund_order_num,0)) refund_order_last_1d_num,
        sum(if(dt='$do_date',refund_order_amount,0)) refund_order_last_1d_amount,
        sum(if(dt>=date_add('$do_date',-6),refund_order_count,0)) refund_order_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),refund_order_num,0)) refund_order_last_7d_num,
        sum(if(dt>=date_add('$do_date',-6),refund_order_amount,0)) refund_order_last_7d_amount,
        sum(if(dt>=date_add('$do_date',-29),refund_order_count,0)) refund_order_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),refund_order_num,0)) refund_order_last_30d_num,
        sum(if(dt>=date_add('$do_date',-29),refund_order_amount,0)) refund_order_last_30d_amount,
        sum(refund_order_count) refund_order_count,
        sum(refund_order_num) refund_order_num,
        sum(refund_order_amount) refund_order_amount,
        sum(if(dt='$do_date',refund_payment_count,0)) refund_payment_last_1d_count,
        sum(if(dt='$do_date',refund_payment_num,0)) refund_payment_last_1d_num,
        sum(if(dt='$do_date',refund_payment_amount,0)) refund_payment_last_1d_amount,
        sum(if(dt>=date_add('$do_date',-6),refund_payment_count,0)) refund_payment_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),refund_payment_num,0)) refund_payment_last_7d_num,
        sum(if(dt>=date_add('$do_date',-6),refund_payment_amount,0)) refund_payment_last_7d_amount,
        sum(if(dt>=date_add('$do_date',-29),refund_payment_count,0)) refund_payment_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),refund_payment_num,0)) refund_payment_last_30d_num,
        sum(if(dt>=date_add('$do_date',-29),refund_payment_amount,0)) refund_payment_last_30d_amount,
        sum(refund_payment_count) refund_payment_count,
        sum(refund_payment_num) refund_payment_num,
        sum(refund_payment_amount) refund_payment_amount,
        sum(if(dt='$do_date',cart_count,0)) cart_last_1d_count,
        sum(if(dt>=date_add('$do_date',-6),cart_count,0)) cart_last_7d_count,
        sum(if(dt>=date_add('$do_date',-29),cart_count,0)) cart_last_30d_count,
        sum(cart_count) cart_count,
        sum(if(dt='$do_date',favor_count,0)) favor_last_1d_count,
        sum(if(dt>=date_add('$do_date',-6),favor_count,0)) favor_last_7d_count,
        sum(if(dt>=date_add('$do_date',-29),favor_count,0)) favor_last_30d_count,
        sum(favor_count) favor_count,
        sum(if(dt='$do_date',coupon_get_count,0)) coupon_last_1d_get_count,
        sum(if(dt='$do_date',coupon_using_count,0)) coupon_last_1d_using_count,
        sum(if(dt='$do_date',coupon_used_count,0)) coupon_last_1d_used_count,
        sum(if(dt>=date_add('$do_date',-6),coupon_get_count,0)) coupon_last_7d_get_count,
        sum(if(dt>=date_add('$do_date',-6),coupon_using_count,0)) coupon_last_7d_using_count,
        sum(if(dt>=date_add('$do_date',-6),coupon_used_count,0)) coupon_last_7d_used_count,
        sum(if(dt>=date_add('$do_date',-29),coupon_get_count,0)) coupon_last_30d_get_count,
        sum(if(dt>=date_add('$do_date',-29),coupon_using_count,0)) coupon_last_30d_using_count,
        sum(if(dt>=date_add('$do_date',-29),coupon_used_count,0)) coupon_last_30d_used_count,
        sum(coupon_get_count) coupon_get_count,
        sum(coupon_using_count) coupon_using_count,
        sum(coupon_used_count) coupon_used_count,
        sum(if(dt='$do_date',appraise_good_count,0)) appraise_last_1d_good_count,
        sum(if(dt='$do_date',appraise_mid_count,0)) appraise_last_1d_mid_count,
        sum(if(dt='$do_date',appraise_bad_count,0)) appraise_last_1d_bad_count,
        sum(if(dt='$do_date',appraise_default_count,0)) appraise_last_1d_default_count,
        sum(if(dt>=date_add('$do_date',-6),appraise_good_count,0)) appraise_last_7d_good_count,
        sum(if(dt>=date_add('$do_date',-6),appraise_mid_count,0)) appraise_last_7d_mid_count,
        sum(if(dt>=date_add('$do_date',-6),appraise_bad_count,0)) appraise_last_7d_bad_count,
        sum(if(dt>=date_add('$do_date',-6),appraise_default_count,0)) appraise_last_7d_default_count,
        sum(if(dt>=date_add('$do_date',-29),appraise_good_count,0)) appraise_last_30d_good_count,
        sum(if(dt>=date_add('$do_date',-29),appraise_mid_count,0)) appraise_last_30d_mid_count,
        sum(if(dt>=date_add('$do_date',-29),appraise_bad_count,0)) appraise_last_30d_bad_count,
        sum(if(dt>=date_add('$do_date',-29),appraise_default_count,0)) appraise_last_30d_default_count,
        sum(appraise_good_count) appraise_good_count,
        sum(appraise_mid_count) appraise_mid_count,
        sum(appraise_bad_count) appraise_bad_count,
        sum(appraise_default_count) appraise_default_count
    from ${APP}.dws_user_action_daycount
    group by user_id
)t2
on t1.id=t2.user_id;
"

dwt_sku_topic="
insert overwrite table ${APP}.dwt_sku_topic partition(dt='$do_date')
select
    id,
    nvl(order_last_1d_count,0),
    nvl(order_last_1d_num,0),
    nvl(order_activity_last_1d_count,0),
    nvl(order_coupon_last_1d_count,0),
    nvl(order_activity_reduce_last_1d_amount,0),
    nvl(order_coupon_reduce_last_1d_amount,0),
    nvl(order_last_1d_original_amount,0),
    nvl(order_last_1d_final_amount,0),
    nvl(order_last_7d_count,0),
    nvl(order_last_7d_num,0),
    nvl(order_activity_last_7d_count,0),
    nvl(order_coupon_last_7d_count,0),
    nvl(order_activity_reduce_last_7d_amount,0),
    nvl(order_coupon_reduce_last_7d_amount,0),
    nvl(order_last_7d_original_amount,0),
    nvl(order_last_7d_final_amount,0),
    nvl(order_last_30d_count,0),
    nvl(order_last_30d_num,0),
    nvl(order_activity_last_30d_count,0),
    nvl(order_coupon_last_30d_count,0),
    nvl(order_activity_reduce_last_30d_amount,0),
    nvl(order_coupon_reduce_last_30d_amount,0),
    nvl(order_last_30d_original_amount,0),
    nvl(order_last_30d_final_amount,0),
    nvl(order_count,0),
    nvl(order_num,0),
    nvl(order_activity_count,0),
    nvl(order_coupon_count,0),
    nvl(order_activity_reduce_amount,0),
    nvl(order_coupon_reduce_amount,0),
    nvl(order_original_amount,0),
    nvl(order_final_amount,0),
    nvl(payment_last_1d_count,0),
    nvl(payment_last_1d_num,0),
    nvl(payment_last_1d_amount,0),
    nvl(payment_last_7d_count,0),
    nvl(payment_last_7d_num,0),
    nvl(payment_last_7d_amount,0),
    nvl(payment_last_30d_count,0),
    nvl(payment_last_30d_num,0),
    nvl(payment_last_30d_amount,0),
    nvl(payment_count,0),
    nvl(payment_num,0),
    nvl(payment_amount,0),
    nvl(refund_order_last_1d_count,0),
    nvl(refund_order_last_1d_num,0),
    nvl(refund_order_last_1d_amount,0),
    nvl(refund_order_last_7d_count,0),
    nvl(refund_order_last_7d_num,0),
    nvl(refund_order_last_7d_amount,0),
    nvl(refund_order_last_30d_count,0),
    nvl(refund_order_last_30d_num,0),
    nvl(refund_order_last_30d_amount,0),
    nvl(refund_order_count,0),
    nvl(refund_order_num,0),
    nvl(refund_order_amount,0),
    nvl(refund_payment_last_1d_count,0),
    nvl(refund_payment_last_1d_num,0),
    nvl(refund_payment_last_1d_amount,0),
    nvl(refund_payment_last_7d_count,0),
    nvl(refund_payment_last_7d_num,0),
    nvl(refund_payment_last_7d_amount,0),
    nvl(refund_payment_last_30d_count,0),
    nvl(refund_payment_last_30d_num,0),
    nvl(refund_payment_last_30d_amount,0),
    nvl(refund_payment_count,0),
    nvl(refund_payment_num,0),
    nvl(refund_payment_amount,0),
    nvl(cart_last_1d_count,0),
    nvl(cart_last_7d_count,0),
    nvl(cart_last_30d_count,0),
    nvl(cart_count,0),
    nvl(favor_last_1d_count,0),
    nvl(favor_last_7d_count,0),
    nvl(favor_last_30d_count,0),
    nvl(favor_count,0),
    nvl(appraise_last_1d_good_count,0),
    nvl(appraise_last_1d_mid_count,0),
    nvl(appraise_last_1d_bad_count,0),
    nvl(appraise_last_1d_default_count,0),
    nvl(appraise_last_7d_good_count,0),
    nvl(appraise_last_7d_mid_count,0),
    nvl(appraise_last_7d_bad_count,0),
    nvl(appraise_last_7d_default_count,0),
    nvl(appraise_last_30d_good_count,0),
    nvl(appraise_last_30d_mid_count,0),
    nvl(appraise_last_30d_bad_count,0),
    nvl(appraise_last_30d_default_count,0),
    nvl(appraise_good_count,0),
    nvl(appraise_mid_count,0),
    nvl(appraise_bad_count,0),
    nvl(appraise_default_count,0)
from
(
    select
        id
    from ${APP}.dim_sku_info
    where dt='$do_date'
)t1
left join
(
    select
        sku_id,
        sum(if(dt='$do_date',order_count,0)) order_last_1d_count,
        sum(if(dt='$do_date',order_num,0)) order_last_1d_num,
        sum(if(dt='$do_date',order_activity_count,0)) order_activity_last_1d_count,
        sum(if(dt='$do_date',order_coupon_count,0)) order_coupon_last_1d_count,
        sum(if(dt='$do_date',order_activity_reduce_amount,0)) order_activity_reduce_last_1d_amount,
        sum(if(dt='$do_date',order_coupon_reduce_amount,0)) order_coupon_reduce_last_1d_amount,
        sum(if(dt='$do_date',order_original_amount,0)) order_last_1d_original_amount,
        sum(if(dt='$do_date',order_final_amount,0)) order_last_1d_final_amount,
        sum(if(dt>=date_add('$do_date',-6),order_count,0)) order_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),order_num,0)) order_last_7d_num,
        sum(if(dt>=date_add('$do_date',-6),order_activity_count,0)) order_activity_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),order_coupon_count,0)) order_coupon_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),order_activity_reduce_amount,0)) order_activity_reduce_last_7d_amount,
        sum(if(dt>=date_add('$do_date',-6),order_coupon_reduce_amount,0)) order_coupon_reduce_last_7d_amount,
        sum(if(dt>=date_add('$do_date',-6),order_original_amount,0)) order_last_7d_original_amount,
        sum(if(dt>=date_add('$do_date',-6),order_final_amount,0)) order_last_7d_final_amount,
        sum(if(dt>=date_add('$do_date',-29),order_count,0)) order_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),order_num,0)) order_last_30d_num,
        sum(if(dt>=date_add('$do_date',-29),order_activity_count,0)) order_activity_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),order_coupon_count,0)) order_coupon_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),order_activity_reduce_amount,0)) order_activity_reduce_last_30d_amount,
        sum(if(dt>=date_add('$do_date',-29),order_coupon_reduce_amount,0)) order_coupon_reduce_last_30d_amount,
        sum(if(dt>=date_add('$do_date',-29),order_original_amount,0)) order_last_30d_original_amount,
        sum(if(dt>=date_add('$do_date',-29),order_final_amount,0)) order_last_30d_final_amount,
        sum(order_count) order_count,
        sum(order_num) order_num,
        sum(order_activity_count) order_activity_count,
        sum(order_coupon_count) order_coupon_count,
        sum(order_activity_reduce_amount) order_activity_reduce_amount,
        sum(order_coupon_reduce_amount) order_coupon_reduce_amount,
        sum(order_original_amount) order_original_amount,
        sum(order_final_amount) order_final_amount,
        sum(if(dt='$do_date',payment_count,0)) payment_last_1d_count,
        sum(if(dt='$do_date',payment_num,0)) payment_last_1d_num,
        sum(if(dt='$do_date',payment_amount,0)) payment_last_1d_amount,
        sum(if(dt>=date_add('$do_date',-6),payment_count,0)) payment_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),payment_num,0)) payment_last_7d_num,
        sum(if(dt>=date_add('$do_date',-6),payment_amount,0)) payment_last_7d_amount,
        sum(if(dt>=date_add('$do_date',-29),payment_count,0)) payment_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),payment_num,0)) payment_last_30d_num,
        sum(if(dt>=date_add('$do_date',-29),payment_amount,0)) payment_last_30d_amount,
        sum(payment_count) payment_count,
        sum(payment_num) payment_num,
        sum(payment_amount) payment_amount,
        sum(if(dt='$do_date',refund_order_count,0)) refund_order_last_1d_count,
        sum(if(dt='$do_date',refund_order_num,0)) refund_order_last_1d_num,
        sum(if(dt='$do_date',refund_order_amount,0)) refund_order_last_1d_amount,
        sum(if(dt>=date_add('$do_date',-6),refund_order_count,0)) refund_order_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),refund_order_num,0)) refund_order_last_7d_num,
        sum(if(dt>=date_add('$do_date',-6),refund_order_amount,0)) refund_order_last_7d_amount,
        sum(if(dt>=date_add('$do_date',-29),refund_order_count,0)) refund_order_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),refund_order_num,0)) refund_order_last_30d_num,
        sum(if(dt>=date_add('$do_date',-29),refund_order_amount,0)) refund_order_last_30d_amount,
        sum(refund_order_count) refund_order_count,
        sum(refund_order_num) refund_order_num,
        sum(refund_order_amount) refund_order_amount,
        sum(if(dt='$do_date',refund_payment_count,0)) refund_payment_last_1d_count,
        sum(if(dt='$do_date',refund_payment_num,0)) refund_payment_last_1d_num,
        sum(if(dt='$do_date',refund_payment_amount,0)) refund_payment_last_1d_amount,
        sum(if(dt>=date_add('$do_date',-6),refund_payment_count,0)) refund_payment_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),refund_payment_num,0)) refund_payment_last_7d_num,
        sum(if(dt>=date_add('$do_date',-6),refund_payment_amount,0)) refund_payment_last_7d_amount,
        sum(if(dt>=date_add('$do_date',-29),refund_payment_count,0)) refund_payment_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),refund_payment_num,0)) refund_payment_last_30d_num,
        sum(if(dt>=date_add('$do_date',-29),refund_payment_amount,0)) refund_payment_last_30d_amount,
        sum(refund_payment_count) refund_payment_count,
        sum(refund_payment_num) refund_payment_num,
        sum(refund_payment_amount) refund_payment_amount,
        sum(if(dt='$do_date',cart_count,0)) cart_last_1d_count,
        sum(if(dt>=date_add('$do_date',-6),cart_count,0)) cart_last_7d_count,
        sum(if(dt>=date_add('$do_date',-29),cart_count,0)) cart_last_30d_count,
        sum(cart_count) cart_count,
        sum(if(dt='$do_date',favor_count,0)) favor_last_1d_count,
        sum(if(dt>=date_add('$do_date',-6),favor_count,0)) favor_last_7d_count,
        sum(if(dt>=date_add('$do_date',-29),favor_count,0)) favor_last_30d_count,
        sum(favor_count) favor_count,
        sum(if(dt='$do_date',appraise_good_count,0)) appraise_last_1d_good_count,
        sum(if(dt='$do_date',appraise_mid_count,0)) appraise_last_1d_mid_count,
        sum(if(dt='$do_date',appraise_bad_count,0)) appraise_last_1d_bad_count,
        sum(if(dt='$do_date',appraise_default_count,0)) appraise_last_1d_default_count,
        sum(if(dt>=date_add('$do_date',-6),appraise_good_count,0)) appraise_last_7d_good_count,
        sum(if(dt>=date_add('$do_date',-6),appraise_mid_count,0)) appraise_last_7d_mid_count,
        sum(if(dt>=date_add('$do_date',-6),appraise_bad_count,0)) appraise_last_7d_bad_count,
        sum(if(dt>=date_add('$do_date',-6),appraise_default_count,0)) appraise_last_7d_default_count,
        sum(if(dt>=date_add('$do_date',-29),appraise_good_count,0)) appraise_last_30d_good_count,
        sum(if(dt>=date_add('$do_date',-29),appraise_mid_count,0)) appraise_last_30d_mid_count,
        sum(if(dt>=date_add('$do_date',-29),appraise_bad_count,0)) appraise_last_30d_bad_count,
        sum(if(dt>=date_add('$do_date',-29),appraise_default_count,0)) appraise_last_30d_default_count,
        sum(appraise_good_count) appraise_good_count,
        sum(appraise_mid_count) appraise_mid_count,
        sum(appraise_bad_count) appraise_bad_count,
        sum(appraise_default_count) appraise_default_count
    from ${APP}.dws_sku_action_daycount
    group by sku_id
)t2
on t1.id=t2.sku_id;
"

dwt_coupon_topic="
insert overwrite table ${APP}.dwt_coupon_topic partition(dt='$do_date')
select
    id,
    nvl(get_last_1d_count,0),
    nvl(get_last_7d_count,0),
    nvl(get_last_30d_count,0),
    nvl(get_count,0),
    nvl(order_last_1d_count,0),
    nvl(order_last_1d_reduce_amount,0),
    nvl(order_last_1d_original_amount,0),
    nvl(order_last_1d_final_amount,0),
    nvl(order_last_7d_count,0),
    nvl(order_last_7d_reduce_amount,0),
    nvl(order_last_7d_original_amount,0),
    nvl(order_last_7d_final_amount,0),
    nvl(order_last_30d_count,0),
    nvl(order_last_30d_reduce_amount,0),
    nvl(order_last_30d_original_amount,0),
    nvl(order_last_30d_final_amount,0),
    nvl(order_count,0),
    nvl(order_reduce_amount,0),
    nvl(order_original_amount,0),
    nvl(order_final_amount,0),
    nvl(payment_last_1d_count,0),
    nvl(payment_last_1d_reduce_amount,0),
    nvl(payment_last_1d_amount,0),
    nvl(payment_last_7d_count,0),
    nvl(payment_last_7d_reduce_amount,0),
    nvl(payment_last_7d_amount,0),
    nvl(payment_last_30d_count,0),
    nvl(payment_last_30d_reduce_amount,0),
    nvl(payment_last_30d_amount,0),
    nvl(payment_count,0),
    nvl(payment_reduce_amount,0),
    nvl(payment_amount,0),
    nvl(expire_last_1d_count,0),
    nvl(expire_last_7d_count,0),
    nvl(expire_last_30d_count,0),
    nvl(expire_count,0)
from
(
    select
        id
    from ${APP}.dim_coupon_info
    where dt='$do_date'
)t1
left join
(
    select
        coupon_id coupon_id,
        sum(if(dt='$do_date',get_count,0)) get_last_1d_count,
        sum(if(dt>=date_add('$do_date',-6),get_count,0)) get_last_7d_count,
        sum(if(dt>=date_add('$do_date',-29),get_count,0)) get_last_30d_count,
        sum(get_count) get_count,
        sum(if(dt='$do_date',order_count,0)) order_last_1d_count,
        sum(if(dt='$do_date',order_reduce_amount,0)) order_last_1d_reduce_amount,
        sum(if(dt='$do_date',order_original_amount,0)) order_last_1d_original_amount,
        sum(if(dt='$do_date',order_final_amount,0)) order_last_1d_final_amount,
        sum(if(dt>=date_add('$do_date',-6),order_count,0)) order_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),order_reduce_amount,0)) order_last_7d_reduce_amount,
        sum(if(dt>=date_add('$do_date',-6),order_original_amount,0)) order_last_7d_original_amount,
        sum(if(dt>=date_add('$do_date',-6),order_final_amount,0)) order_last_7d_final_amount,
        sum(if(dt>=date_add('$do_date',-29),order_count,0)) order_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),order_reduce_amount,0)) order_last_30d_reduce_amount,
        sum(if(dt>=date_add('$do_date',-29),order_original_amount,0)) order_last_30d_original_amount,
        sum(if(dt>=date_add('$do_date',-29),order_final_amount,0)) order_last_30d_final_amount,
        sum(order_count) order_count,
        sum(order_reduce_amount) order_reduce_amount,
        sum(order_original_amount) order_original_amount,
        sum(order_final_amount) order_final_amount,
        sum(if(dt='$do_date',payment_count,0)) payment_last_1d_count,
        sum(if(dt='$do_date',payment_reduce_amount,0)) payment_last_1d_reduce_amount,
        sum(if(dt='$do_date',payment_amount,0)) payment_last_1d_amount,
        sum(if(dt>=date_add('$do_date',-6),payment_count,0)) payment_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),payment_reduce_amount,0)) payment_last_7d_reduce_amount,
        sum(if(dt>=date_add('$do_date',-6),payment_amount,0)) payment_last_7d_amount,
        sum(if(dt>=date_add('$do_date',-29),payment_count,0)) payment_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),payment_reduce_amount,0)) payment_last_30d_reduce_amount,
        sum(if(dt>=date_add('$do_date',-29),payment_amount,0)) payment_last_30d_amount,
        sum(payment_count) payment_count,
        sum(payment_reduce_amount) payment_reduce_amount,
        sum(payment_amount) payment_amount,
        sum(if(dt='$do_date',expire_count,0)) expire_last_1d_count,
        sum(if(dt>=date_add('$do_date',-6),expire_count,0)) expire_last_7d_count,
        sum(if(dt>=date_add('$do_date',-29),expire_count,0)) expire_last_30d_count,
        sum(expire_count) expire_count
    from ${APP}.dws_coupon_info_daycount
    group by coupon_id
)t2
on t1.id=t2.coupon_id;
"

dwt_activity_topic="
insert overwrite table ${APP}.dwt_activity_topic partition(dt='$do_date')
select
    t1.activity_rule_id,
    t1.activity_id,
    nvl(order_last_1d_count,0),
    nvl(order_last_1d_reduce_amount,0),
    nvl(order_last_1d_original_amount,0),
    nvl(order_last_1d_final_amount,0),
    nvl(order_count,0),
    nvl(order_reduce_amount,0),
    nvl(order_original_amount,0),
    nvl(order_final_amount,0),
    nvl(payment_last_1d_count,0),
    nvl(payment_last_1d_reduce_amount,0),
    nvl(payment_last_1d_amount,0),
    nvl(payment_count,0),
    nvl(payment_reduce_amount,0),
    nvl(payment_amount,0)
from
(
    select
        activity_rule_id,
        activity_id
    from ${APP}.dim_activity_rule_info
    where dt='$do_date'
)t1
left join
(
    select
        activity_rule_id,
        activity_id,
        sum(if(dt='$do_date',order_count,0)) order_last_1d_count,
        sum(if(dt='$do_date',order_reduce_amount,0)) order_last_1d_reduce_amount,
        sum(if(dt='$do_date',order_original_amount,0)) order_last_1d_original_amount,
        sum(if(dt='$do_date',order_final_amount,0)) order_last_1d_final_amount,
        sum(order_count) order_count,
        sum(order_reduce_amount) order_reduce_amount,
        sum(order_original_amount) order_original_amount,
        sum(order_final_amount) order_final_amount,
        sum(if(dt='$do_date',payment_count,0)) payment_last_1d_count,
        sum(if(dt='$do_date',payment_reduce_amount,0)) payment_last_1d_reduce_amount,
        sum(if(dt='$do_date',payment_amount,0)) payment_last_1d_amount,
        sum(payment_count) payment_count,
        sum(payment_reduce_amount) payment_reduce_amount,
        sum(payment_amount) payment_amount
    from ${APP}.dws_activity_info_daycount
    group by activity_rule_id,activity_id
)t2
on t1.activity_rule_id=t2.activity_rule_id
and t1.activity_id=t2.activity_id;
"

dwt_area_topic="
insert overwrite table ${APP}.dwt_area_topic partition(dt='$do_date')
select
    id,
    nvl(visit_last_1d_count,0),
    nvl(login_last_1d_count,0),
    nvl(visit_last_7d_count,0),
    nvl(login_last_7d_count,0),
    nvl(visit_last_30d_count,0),
    nvl(login_last_30d_count,0),
    nvl(visit_count,0),
    nvl(login_count,0),
    nvl(order_last_1d_count,0),
    nvl(order_last_1d_original_amount,0),
    nvl(order_last_1d_final_amount,0),
    nvl(order_last_7d_count,0),
    nvl(order_last_7d_original_amount,0),
    nvl(order_last_7d_final_amount,0),
    nvl(order_last_30d_count,0),
    nvl(order_last_30d_original_amount,0),
    nvl(order_last_30d_final_amount,0),
    nvl(order_count,0),
    nvl(order_original_amount,0),
    nvl(order_final_amount,0),
    nvl(payment_last_1d_count,0),
    nvl(payment_last_1d_amount,0),
    nvl(payment_last_7d_count,0),
    nvl(payment_last_7d_amount,0),
    nvl(payment_last_30d_count,0),
    nvl(payment_last_30d_amount,0),
    nvl(payment_count,0),
    nvl(payment_amount,0),
    nvl(refund_order_last_1d_count,0),
    nvl(refund_order_last_1d_amount,0),
    nvl(refund_order_last_7d_count,0),
    nvl(refund_order_last_7d_amount,0),
    nvl(refund_order_last_30d_count,0),
    nvl(refund_order_last_30d_amount,0),
    nvl(refund_order_count,0),
    nvl(refund_order_amount,0),
    nvl(refund_payment_last_1d_count,0),
    nvl(refund_payment_last_1d_amount,0),
    nvl(refund_payment_last_7d_count,0),
    nvl(refund_payment_last_7d_amount,0),
    nvl(refund_payment_last_30d_count,0),
    nvl(refund_payment_last_30d_amount,0),
    nvl(refund_payment_count,0),
    nvl(refund_payment_amount,0)
from
(
    select
        id
    from ${APP}.dim_base_province
)t1
left join
(
    select
        province_id province_id,
        sum(if(dt='$do_date',visit_count,0)) visit_last_1d_count,
        sum(if(dt='$do_date',login_count,0)) login_last_1d_count,
        sum(if(dt>=date_add('$do_date',-6),visit_count,0)) visit_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),login_count,0)) login_last_7d_count,
        sum(if(dt>=date_add('$do_date',-29),visit_count,0)) visit_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),login_count,0)) login_last_30d_count,
        sum(visit_count) visit_count,
        sum(login_count) login_count,
        sum(if(dt='$do_date',order_count,0)) order_last_1d_count,
        sum(if(dt='$do_date',order_original_amount,0)) order_last_1d_original_amount,
        sum(if(dt='$do_date',order_final_amount,0)) order_last_1d_final_amount,
        sum(if(dt>=date_add('$do_date',-6),order_count,0)) order_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),order_original_amount,0)) order_last_7d_original_amount,
        sum(if(dt>=date_add('$do_date',-6),order_final_amount,0)) order_last_7d_final_amount,
        sum(if(dt>=date_add('$do_date',-29),order_count,0)) order_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),order_original_amount,0)) order_last_30d_original_amount,
        sum(if(dt>=date_add('$do_date',-29),order_final_amount,0)) order_last_30d_final_amount,
        sum(order_count) order_count,
        sum(order_original_amount) order_original_amount,
        sum(order_final_amount) order_final_amount,
        sum(if(dt='$do_date',payment_count,0)) payment_last_1d_count,
        sum(if(dt='$do_date',payment_amount,0)) payment_last_1d_amount,
        sum(if(dt>=date_add('$do_date',-6),payment_count,0)) payment_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),payment_amount,0)) payment_last_7d_amount,
        sum(if(dt>=date_add('$do_date',-29),payment_count,0)) payment_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),payment_amount,0)) payment_last_30d_amount,
        sum(payment_count) payment_count,
        sum(payment_amount) payment_amount,
        sum(if(dt='$do_date',refund_order_count,0)) refund_order_last_1d_count,
        sum(if(dt='$do_date',refund_order_amount,0)) refund_order_last_1d_amount,
        sum(if(dt>=date_add('$do_date',-6),refund_order_count,0)) refund_order_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),refund_order_amount,0)) refund_order_last_7d_amount,
        sum(if(dt>=date_add('$do_date',-29),refund_order_count,0)) refund_order_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),refund_order_amount,0)) refund_order_last_30d_amount,
        sum(refund_order_count) refund_order_count,
        sum(refund_order_amount) refund_order_amount,
        sum(if(dt='$do_date',refund_payment_count,0)) refund_payment_last_1d_count,
        sum(if(dt='$do_date',refund_payment_amount,0)) refund_payment_last_1d_amount,
        sum(if(dt>=date_add('$do_date',-6),refund_payment_count,0)) refund_payment_last_7d_count,
        sum(if(dt>=date_add('$do_date',-6),refund_payment_amount,0)) refund_payment_last_7d_amount,
        sum(if(dt>=date_add('$do_date',-29),refund_payment_count,0)) refund_payment_last_30d_count,
        sum(if(dt>=date_add('$do_date',-29),refund_payment_amount,0)) refund_payment_last_30d_amount,
        sum(refund_payment_count) refund_payment_count,
        sum(refund_payment_amount) refund_payment_amount
    from ${APP}.dws_area_stats_daycount
    group by province_id
)t2
on t1.id=t2.province_id;
"


case $1 in
    "dwt_visitor_topic" )
        hive -e "$dwt_visitor_topic"
    ;;
    "dwt_user_topic" )
        hive -e "$dwt_user_topic"
    ;;
    "dwt_sku_topic" )
        hive -e "$dwt_sku_topic"
    ;;
    "dwt_activity_topic" )
        hive -e "$dwt_activity_topic"
    ;;
    "dwt_coupon_topic" )
        hive -e "$dwt_coupon_topic"
    ;;
    "dwt_area_topic" )
        hive -e "$dwt_area_topic"
    ;;
    "all" )
        hive -e "$dwt_visitor_topic$dwt_user_topic$dwt_sku_topic$dwt_activity_topic$dwt_coupon_topic$dwt_area_topic"
    ;;
esac
</code></pre>
<p>（2）增加执行权限</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod +x dws_to_dwt_init.sh
</code></pre>
<p>2）脚本使用<br>（1）执行脚本</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ dws_to_dwt_init.sh all 2020-06-14
</code></pre>
<p>（2）查看数据是否导入成功</p>
<h2 id="8-8-DWT层每日数据导入脚本"><a href="#8-8-DWT层每日数据导入脚本" class="headerlink" title="8.8 DWT层每日数据导入脚本"></a>8.8 DWT层每日数据导入脚本</h2><p>1）编写脚本<br>（1）在/home/atguigu/bin目录下创建脚本dws_to_dwt.sh</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim dws_to_dwt.sh
</code></pre>
<p>在脚本中填写如下内容</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash

APP=gmall

# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天

if [ -n "$2" ] ;then
    do_date=$2
else 
    do_date=`date -d "-1 day" +%F`
fi

clear_date=`date -d "$do_date -2 day" +%F`

dwt_visitor_topic="
insert overwrite table ${APP}.dwt_visitor_topic partition(dt='$do_date')
select
    nvl(1d_ago.mid_id,old.mid_id),
    nvl(1d_ago.brand,old.brand),
    nvl(1d_ago.model,old.model),
    nvl(1d_ago.channel,old.channel),
    nvl(1d_ago.os,old.os),
    nvl(1d_ago.area_code,old.area_code),
    nvl(1d_ago.version_code,old.version_code),
    case when old.mid_id is null and 1d_ago.is_new=1 then '$do_date'
         when old.mid_id is null and 1d_ago.is_new=0 then '2020-06-13'--无法获取准确的首次登录日期，给定一个数仓搭建日之前的日期
         else old.visit_date_first end,
    if(1d_ago.mid_id is not null,'$do_date',old.visit_date_last),
    nvl(1d_ago.visit_count,0),
    if(1d_ago.mid_id is null,0,1),
    nvl(old.visit_last_7d_count,0)+nvl(1d_ago.visit_count,0)- nvl(7d_ago.visit_count,0),
    nvl(old.visit_last_7d_day_count,0)+if(1d_ago.mid_id is null,0,1)- if(7d_ago.mid_id is null,0,1),
    nvl(old.visit_last_30d_count,0)+nvl(1d_ago.visit_count,0)- nvl(30d_ago.visit_count,0),
    nvl(old.visit_last_30d_day_count,0)+if(1d_ago.mid_id is null,0,1)- if(30d_ago.mid_id is null,0,1),
    nvl(old.visit_count,0)+nvl(1d_ago.visit_count,0),
    nvl(old.visit_day_count,0)+if(1d_ago.mid_id is null,0,1)
from
(
    select
        mid_id,
        brand,
        model,
        channel,
        os,
        area_code,
        version_code,
        visit_date_first,
        visit_date_last,
        visit_last_1d_count,
        visit_last_1d_day_count,
        visit_last_7d_count,
        visit_last_7d_day_count,
        visit_last_30d_count,
        visit_last_30d_day_count,
        visit_count,
        visit_day_count
    from ${APP}.dwt_visitor_topic
    where dt=date_add('$do_date',-1)
)old
full outer join
(
    select
        mid_id,
        brand,
        model,
        is_new,
        channel,
        os,
        area_code,
        version_code,
        visit_count
    from ${APP}.dws_visitor_action_daycount
    where dt='$do_date'
)1d_ago
on old.mid_id=1d_ago.mid_id
left join
(
    select
        mid_id,
        brand,
        model,
        is_new,
        channel,
        os,
        area_code,
        version_code,
        visit_count
    from ${APP}.dws_visitor_action_daycount
    where dt=date_add('$do_date',-7)
)7d_ago
on old.mid_id=7d_ago.mid_id
left join
(
    select
        mid_id,
        brand,
        model,
        is_new,
        channel,
        os,
        area_code,
        version_code,
        visit_count
    from ${APP}.dws_visitor_action_daycount
    where dt=date_add('$do_date',-30)
)30d_ago
on old.mid_id=30d_ago.mid_id;
alter table ${APP}.dwt_visitor_topic drop partition(dt='$clear_date');
"

dwt_user_topic="
insert overwrite table ${APP}.dwt_user_topic partition(dt='$do_date')
select
    nvl(1d_ago.user_id,old.user_id),
    nvl(old.login_date_first,'$do_date'),
    if(1d_ago.user_id is not null,'$do_date',old.login_date_last),
    nvl(1d_ago.login_count,0),
    if(1d_ago.user_id is not null,1,0),
    nvl(old.login_last_7d_count,0)+nvl(1d_ago.login_count,0)- nvl(7d_ago.login_count,0),
    nvl(old.login_last_7d_day_count,0)+if(1d_ago.user_id is null,0,1)- if(7d_ago.user_id is null,0,1),
    nvl(old.login_last_30d_count,0)+nvl(1d_ago.login_count,0)- nvl(30d_ago.login_count,0),
    nvl(old.login_last_30d_day_count,0)+if(1d_ago.user_id is null,0,1)- if(30d_ago.user_id is null,0,1),
    nvl(old.login_count,0)+nvl(1d_ago.login_count,0),
    nvl(old.login_day_count,0)+if(1d_ago.user_id is not null,1,0),
    if(old.order_date_first is null and 1d_ago.order_count>0, '$do_date', old.order_date_first),
    if(1d_ago.order_count>0,'$do_date',old.order_date_last),
    nvl(1d_ago.order_count,0),
    nvl(1d_ago.order_activity_count,0),
    nvl(1d_ago.order_activity_reduce_amount,0.0),
    nvl(1d_ago.order_coupon_count,0),
    nvl(1d_ago.order_coupon_reduce_amount,0.0),
    nvl(1d_ago.order_original_amount,0.0),
    nvl(1d_ago.order_final_amount,0.0),
    nvl(old.order_last_7d_count,0)+nvl(1d_ago.order_count,0)- nvl(7d_ago.order_count,0),
    nvl(old.order_activity_last_7d_count,0)+nvl(1d_ago.order_activity_count,0)- nvl(7d_ago.order_activity_count,0),
    nvl(old.order_activity_reduce_last_7d_amount,0.0)+nvl(1d_ago.order_activity_reduce_amount,0.0)- nvl(7d_ago.order_activity_reduce_amount,0.0),
    nvl(old.order_coupon_last_7d_count,0)+nvl(1d_ago.order_coupon_count,0)- nvl(7d_ago.order_coupon_count,0),
    nvl(old.order_coupon_reduce_last_7d_amount,0.0)+nvl(1d_ago.order_coupon_reduce_amount,0.0)- nvl(7d_ago.order_coupon_reduce_amount,0.0),
    nvl(old.order_last_7d_original_amount,0.0)+nvl(1d_ago.order_original_amount,0.0)- nvl(7d_ago.order_original_amount,0.0),
    nvl(old.order_last_7d_final_amount,0.0)+nvl(1d_ago.order_final_amount,0.0)- nvl(7d_ago.order_final_amount,0.0),
    nvl(old.order_last_30d_count,0)+nvl(1d_ago.order_count,0)- nvl(30d_ago.order_count,0),
    nvl(old.order_activity_last_30d_count,0)+nvl(1d_ago.order_activity_count,0)- nvl(30d_ago.order_activity_count,0),
    nvl(old.order_activity_reduce_last_30d_amount,0.0)+nvl(1d_ago.order_activity_reduce_amount,0.0)- nvl(30d_ago.order_activity_reduce_amount,0.0),
    nvl(old.order_coupon_last_30d_count,0)+nvl(1d_ago.order_coupon_count,0)- nvl(30d_ago.order_coupon_count,0),
    nvl(old.order_coupon_reduce_last_30d_amount,0.0)+nvl(1d_ago.order_coupon_reduce_amount,0.0)- nvl(30d_ago.order_coupon_reduce_amount,0.0),
    nvl(old.order_last_30d_original_amount,0.0)+nvl(1d_ago.order_original_amount,0.0)- nvl(30d_ago.order_original_amount,0.0),
    nvl(old.order_last_30d_final_amount,0.0)+nvl(1d_ago.order_final_amount,0.0)- nvl(30d_ago.order_final_amount,0.0),
    nvl(old.order_count,0)+nvl(1d_ago.order_count,0),
    nvl(old.order_activity_count,0)+nvl(1d_ago.order_activity_count,0),
    nvl(old.order_activity_reduce_amount,0.0)+nvl(1d_ago.order_activity_reduce_amount,0.0),
    nvl(old.order_coupon_count,0)+nvl(1d_ago.order_coupon_count,0),
    nvl(old.order_coupon_reduce_amount,0.0)+nvl(1d_ago.order_coupon_reduce_amount,0.0),
    nvl(old.order_original_amount,0.0)+nvl(1d_ago.order_original_amount,0.0),
    nvl(old.order_final_amount,0.0)+nvl(1d_ago.order_final_amount,0.0),
    if(old.payment_date_first is null and 1d_ago.payment_count>0, '$do_date', old.payment_date_first),
    if(1d_ago.payment_count>0,'$do_date',old.payment_date_last),
    nvl(1d_ago.payment_count,0),
    nvl(1d_ago.payment_amount,0.0),
    nvl(old.payment_last_7d_count,0)+nvl(1d_ago.payment_count,0)-nvl(7d_ago.payment_count,0),
    nvl(old.payment_last_7d_amount,0.0)+nvl(1d_ago.payment_amount,0.0)-nvl(7d_ago.payment_amount,0.0),
    nvl(old.payment_last_30d_count,0)+nvl(1d_ago.payment_count,0)-nvl(30d_ago.payment_count,0),
    nvl(old.payment_last_30d_amount,0.0)+nvl(1d_ago.payment_amount,0.0)- nvl(30d_ago.payment_amount,0.0),
    nvl(old.payment_count,0)+nvl(1d_ago.payment_count,0),
    nvl(old.payment_amount,0.0)+nvl(1d_ago.payment_amount,0.0),
    nvl(1d_ago.refund_order_count,0),
    nvl(1d_ago.refund_order_num,0),
    nvl(1d_ago.refund_order_amount,0.0),
    nvl(old.refund_order_last_7d_count,0)+nvl(1d_ago.refund_order_count,0)- nvl(7d_ago.refund_order_count,0),
    nvl(old.refund_order_last_7d_num,0)+nvl(1d_ago.refund_order_num, 0)- nvl(7d_ago.refund_order_num,0),
    nvl(old.refund_order_last_7d_amount,0.0)+ nvl(1d_ago.refund_order_amount,0.0)- nvl(7d_ago.refund_order_amount,0.0),
    nvl(old.refund_order_last_30d_count,0)+nvl(1d_ago.refund_order_count,0)- nvl(30d_ago.refund_order_count,0),
    nvl(old.refund_order_last_30d_num,0)+nvl(1d_ago.refund_order_num, 0)- nvl(30d_ago.refund_order_num,0),
    nvl(old.refund_order_last_30d_amount,0.0)+ nvl(1d_ago.refund_order_amount,0.0)- nvl(30d_ago.refund_order_amount,0.0),
    nvl(old.refund_order_count,0)+nvl(1d_ago.refund_order_count,0),
    nvl(old.refund_order_num,0)+nvl(1d_ago.refund_order_num,0),
    nvl(old.refund_order_amount,0.0)+ nvl(1d_ago.refund_order_amount,0.0),
    nvl(1d_ago.refund_payment_count,0),
    nvl(1d_ago.refund_payment_num,0),
    nvl(1d_ago.refund_payment_amount,0.0),
    nvl(old.refund_payment_last_7d_count,0)+nvl(1d_ago.refund_payment_count,0)-nvl(7d_ago.refund_payment_count,0),
    nvl(old.refund_payment_last_7d_num,0)+nvl(1d_ago.refund_payment_num,0)- nvl(7d_ago.refund_payment_num,0),
    nvl(old.refund_payment_last_7d_amount,0.0)+ nvl(1d_ago.refund_payment_amount,0.0)- nvl(7d_ago.refund_payment_amount,0.0),
    nvl(old.refund_payment_last_30d_count,0)+nvl(1d_ago.refund_payment_count,0)-nvl(30d_ago.refund_payment_count,0),
    nvl(old.refund_payment_last_30d_num,0)+nvl(1d_ago.refund_payment_num,0)- nvl(30d_ago.refund_payment_num,0),
    nvl(old.refund_payment_last_30d_amount,0.0)+ nvl(1d_ago.refund_payment_amount,0.0)- nvl(30d_ago.refund_payment_amount,0.0),
    nvl(old.refund_payment_count,0)+nvl(1d_ago.refund_payment_count,0),
    nvl(old.refund_payment_num,0)+nvl(1d_ago.refund_payment_num,0),
    nvl(old.refund_payment_amount,0.0)+nvl(1d_ago.refund_payment_amount,0.0),
    nvl(1d_ago.cart_count,0),
    nvl(old.cart_last_7d_count,0)+nvl(1d_ago.cart_count,0)-nvl(7d_ago.cart_count,0),
    nvl(old.cart_last_30d_count,0)+nvl(1d_ago.cart_count,0)-nvl(30d_ago.cart_count,0),
    nvl(old.cart_count,0)+nvl(1d_ago.cart_count,0),
    nvl(1d_ago.favor_count,0),
    nvl(old.favor_last_7d_count,0)+nvl(1d_ago.favor_count,0)- nvl(7d_ago.favor_count,0),
    nvl(old.favor_last_30d_count,0)+nvl(1d_ago.favor_count,0)- nvl(30d_ago.favor_count,0),
    nvl(old.favor_count,0)+nvl(1d_ago.favor_count,0),
    nvl(1d_ago.coupon_get_count,0),
    nvl(1d_ago.coupon_using_count,0),
    nvl(1d_ago.coupon_used_count,0),
    nvl(old.coupon_last_7d_get_count,0)+nvl(1d_ago.coupon_get_count,0)- nvl(7d_ago.coupon_get_count,0),
    nvl(old.coupon_last_7d_using_count,0)+nvl(1d_ago.coupon_using_count,0)- nvl(7d_ago.coupon_using_count,0),
    nvl(old.coupon_last_7d_used_count,0)+ nvl(1d_ago.coupon_used_count,0)- nvl(7d_ago.coupon_used_count,0),
    nvl(old.coupon_last_30d_get_count,0)+nvl(1d_ago.coupon_get_count,0)- nvl(30d_ago.coupon_get_count,0),
    nvl(old.coupon_last_30d_using_count,0)+nvl(1d_ago.coupon_using_count,0)- nvl(30d_ago.coupon_using_count,0),
    nvl(old.coupon_last_30d_used_count,0)+ nvl(1d_ago.coupon_used_count,0)- nvl(30d_ago.coupon_used_count,0),
    nvl(old.coupon_get_count,0)+nvl(1d_ago.coupon_get_count,0),
    nvl(old.coupon_using_count,0)+nvl(1d_ago.coupon_using_count,0),
    nvl(old.coupon_used_count,0)+nvl(1d_ago.coupon_used_count,0),
    nvl(1d_ago.appraise_good_count,0),
    nvl(1d_ago.appraise_mid_count,0),
    nvl(1d_ago.appraise_bad_count,0),
    nvl(old.appraise_last_7d_default_count,0)+nvl(1d_ago.appraise_default_count,0)-nvl(7d_ago.appraise_default_count,0),
    nvl(old.appraise_last_7d_good_count,0)+nvl(1d_ago.appraise_good_count,0)- nvl(7d_ago.appraise_good_count,0),
    nvl(old.appraise_last_7d_mid_count,0)+nvl(1d_ago.appraise_mid_count,0)-nvl(7d_ago.appraise_mid_count,0),
    nvl(old.appraise_last_7d_bad_count,0)+nvl(1d_ago.appraise_bad_count,0)-nvl(7d_ago.appraise_bad_count,0),
    nvl(old.appraise_last_7d_default_count,0)+nvl(1d_ago.appraise_default_count,0)-nvl(7d_ago.appraise_default_count,0),
    nvl(old.appraise_last_30d_good_count,0)+nvl(1d_ago.appraise_good_count,0)- nvl(30d_ago.appraise_good_count,0),
    nvl(old.appraise_last_30d_mid_count,0)+nvl(1d_ago.appraise_mid_count,0)-nvl(30d_ago.appraise_mid_count,0),
    nvl(old.appraise_last_30d_bad_count,0)+nvl(1d_ago.appraise_bad_count,0)-nvl(30d_ago.appraise_bad_count,0),
    nvl(old.appraise_last_30d_default_count,0)+nvl(1d_ago.appraise_default_count,0)-nvl(30d_ago.appraise_default_count,0),
    nvl(old.appraise_good_count,0)+nvl(1d_ago.appraise_good_count,0),
    nvl(old.appraise_mid_count,0)+nvl(1d_ago.appraise_mid_count, 0),
    nvl(old.appraise_bad_count,0)+nvl(1d_ago.appraise_bad_count,0),
    nvl(old.appraise_default_count,0)+nvl(1d_ago.appraise_default_count,0)
from
(
    select
        user_id,
        login_date_first,
        login_date_last,
        login_date_1d_count,
        login_last_1d_day_count,
        login_last_7d_count,
        login_last_7d_day_count,
        login_last_30d_count,
        login_last_30d_day_count,
        login_count,
        login_day_count,
        order_date_first,
        order_date_last,
        order_last_1d_count,
        order_activity_last_1d_count,
        order_activity_reduce_last_1d_amount,
        order_coupon_last_1d_count,
        order_coupon_reduce_last_1d_amount,
        order_last_1d_original_amount,
        order_last_1d_final_amount,
        order_last_7d_count,
        order_activity_last_7d_count,
        order_activity_reduce_last_7d_amount,
        order_coupon_last_7d_count,
        order_coupon_reduce_last_7d_amount,
        order_last_7d_original_amount,
        order_last_7d_final_amount,
        order_last_30d_count,
        order_activity_last_30d_count,
        order_activity_reduce_last_30d_amount,
        order_coupon_last_30d_count,
        order_coupon_reduce_last_30d_amount,
        order_last_30d_original_amount,
        order_last_30d_final_amount,
        order_count,
        order_activity_count,
        order_activity_reduce_amount,
        order_coupon_count,
        order_coupon_reduce_amount,
        order_original_amount,
        order_final_amount,
        payment_date_first,
        payment_date_last,
        payment_last_1d_count,
        payment_last_1d_amount,
        payment_last_7d_count,
        payment_last_7d_amount,
        payment_last_30d_count,
        payment_last_30d_amount,
        payment_count,
        payment_amount,
        refund_order_last_1d_count,
        refund_order_last_1d_num,
        refund_order_last_1d_amount,
        refund_order_last_7d_count,
        refund_order_last_7d_num,
        refund_order_last_7d_amount,
        refund_order_last_30d_count,
        refund_order_last_30d_num,
        refund_order_last_30d_amount,
        refund_order_count,
        refund_order_num,
        refund_order_amount,
        refund_payment_last_1d_count,
        refund_payment_last_1d_num,
        refund_payment_last_1d_amount,
        refund_payment_last_7d_count,
        refund_payment_last_7d_num,
        refund_payment_last_7d_amount,
        refund_payment_last_30d_count,
        refund_payment_last_30d_num,
        refund_payment_last_30d_amount,
        refund_payment_count,
        refund_payment_num,
        refund_payment_amount,
        cart_last_1d_count,
        cart_last_7d_count,
        cart_last_30d_count,
        cart_count,
        favor_last_1d_count,
        favor_last_7d_count,
        favor_last_30d_count,
        favor_count,
        coupon_last_1d_get_count,
        coupon_last_1d_using_count,
        coupon_last_1d_used_count,
        coupon_last_7d_get_count,
        coupon_last_7d_using_count,
        coupon_last_7d_used_count,
        coupon_last_30d_get_count,
        coupon_last_30d_using_count,
        coupon_last_30d_used_count,
        coupon_get_count,
        coupon_using_count,
        coupon_used_count,
        appraise_last_1d_good_count,
        appraise_last_1d_mid_count,
        appraise_last_1d_bad_count,
        appraise_last_1d_default_count,
        appraise_last_7d_good_count,
        appraise_last_7d_mid_count,
        appraise_last_7d_bad_count,
        appraise_last_7d_default_count,
        appraise_last_30d_good_count,
        appraise_last_30d_mid_count,
        appraise_last_30d_bad_count,
        appraise_last_30d_default_count,
        appraise_good_count,
        appraise_mid_count,
        appraise_bad_count,
        appraise_default_count
    from ${APP}.dwt_user_topic
    where dt=date_add('$do_date',-1)
)old
full outer join
(
    select
        user_id,
        login_count,
        cart_count,
        favor_count,
        order_count,
        order_activity_count,
        order_activity_reduce_amount,
        order_coupon_count,
        order_coupon_reduce_amount,
        order_original_amount,
        order_final_amount,
        payment_count,
        payment_amount,
        refund_order_count,
        refund_order_num,
        refund_order_amount,
        refund_payment_count,
        refund_payment_num,
        refund_payment_amount,
        coupon_get_count,
        coupon_using_count,
        coupon_used_count,
        appraise_good_count,
        appraise_mid_count,
        appraise_bad_count,
        appraise_default_count
    from ${APP}.dws_user_action_daycount
    where dt='$do_date'
)1d_ago
on old.user_id=1d_ago.user_id
left join
(
    select
        user_id,
        login_count,
        cart_count,
        favor_count,
        order_count,
        order_activity_count,
        order_activity_reduce_amount,
        order_coupon_count,
        order_coupon_reduce_amount,
        order_original_amount,
        order_final_amount,
        payment_count,
        payment_amount,
        refund_order_count,
        refund_order_num,
        refund_order_amount,
        refund_payment_count,
        refund_payment_num,
        refund_payment_amount,
        coupon_get_count,
        coupon_using_count,
        coupon_used_count,
        appraise_good_count,
        appraise_mid_count,
        appraise_bad_count,
        appraise_default_count
    from ${APP}.dws_user_action_daycount
    where dt=date_add('$do_date',-7)
)7d_ago
on old.user_id=7d_ago.user_id
left join
(
    select
        user_id,
        login_count,
        cart_count,
        favor_count,
        order_count,
        order_activity_count,
        order_activity_reduce_amount,
        order_coupon_count,
        order_coupon_reduce_amount,
        order_original_amount,
        order_final_amount,
        payment_count,
        payment_amount,
        refund_order_count,
        refund_order_num,
        refund_order_amount,
        refund_payment_count,
        refund_payment_num,
        refund_payment_amount,
        coupon_get_count,
        coupon_using_count,
        coupon_used_count,
        appraise_good_count,
        appraise_mid_count,
        appraise_bad_count,
        appraise_default_count
    from ${APP}.dws_user_action_daycount
    where dt=date_add('$do_date',-30)
)30d_ago
on old.user_id=30d_ago.user_id;
alter table ${APP}.dwt_user_topic drop partition(dt='$clear_date');
"

dwt_sku_topic="
insert overwrite table ${APP}.dwt_sku_topic partition(dt='$do_date')
select
    nvl(1d_ago.sku_id,old.sku_id),
    nvl(1d_ago.order_count,0),
    nvl(1d_ago.order_num,0),
    nvl(1d_ago.order_activity_count,0),
    nvl(1d_ago.order_coupon_count,0),
    nvl(1d_ago.order_activity_reduce_amount,0.0),
    nvl(1d_ago.order_coupon_reduce_amount,0.0),
    nvl(1d_ago.order_original_amount,0.0),
    nvl(1d_ago.order_final_amount,0.0),
    nvl(old.order_last_7d_count,0)+nvl(1d_ago.order_count,0)- nvl(7d_ago.order_count,0),
    nvl(old.order_last_7d_num,0)+nvl(1d_ago.order_num,0)- nvl(7d_ago.order_num,0),
    nvl(old.order_activity_last_7d_count,0)+nvl(1d_ago.order_activity_count,0)- nvl(7d_ago.order_activity_count,0),
    nvl(old.order_coupon_last_7d_count,0)+nvl(1d_ago.order_coupon_count,0)- nvl(7d_ago.order_coupon_count,0),
    nvl(old.order_activity_reduce_last_7d_amount,0.0)+nvl(1d_ago.order_activity_reduce_amount,0.0)- nvl(7d_ago.order_activity_reduce_amount,0.0),
    nvl(old.order_coupon_reduce_last_7d_amount,0.0)+nvl(1d_ago.order_coupon_reduce_amount,0.0)- nvl(7d_ago.order_coupon_reduce_amount,0.0),
    nvl(old.order_last_7d_original_amount,0.0)+nvl(1d_ago.order_original_amount,0.0)- nvl(7d_ago.order_original_amount,0.0),
    nvl(old.order_last_7d_final_amount,0.0)+nvl(1d_ago.order_final_amount,0.0)- nvl(7d_ago.order_final_amount,0.0),
    nvl(old.order_last_30d_count,0)+nvl(1d_ago.order_count,0)- nvl(30d_ago.order_count,0),
    nvl(old.order_last_30d_num,0)+nvl(1d_ago.order_num,0)- nvl(30d_ago.order_num,0),
    nvl(old.order_activity_last_30d_count,0)+nvl(1d_ago.order_activity_count,0)- nvl(30d_ago.order_activity_count,0),
    nvl(old.order_coupon_last_30d_count,0)+nvl(1d_ago.order_coupon_count,0)- nvl(30d_ago.order_coupon_count,0),
    nvl(old.order_activity_reduce_last_30d_amount,0.0)+nvl(1d_ago.order_activity_reduce_amount,0.0)- nvl(30d_ago.order_activity_reduce_amount,0.0),
    nvl(old.order_coupon_reduce_last_30d_amount,0.0)+nvl(1d_ago.order_coupon_reduce_amount,0.0)- nvl(30d_ago.order_coupon_reduce_amount,0.0),
    nvl(old.order_last_30d_original_amount,0.0)+nvl(1d_ago.order_original_amount,0.0)- nvl(30d_ago.order_original_amount,0.0),
    nvl(old.order_last_30d_final_amount,0.0)+nvl(1d_ago.order_final_amount,0.0)- nvl(30d_ago.order_final_amount,0.0),
    nvl(old.order_count,0)+nvl(1d_ago.order_count,0),
    nvl(old.order_num,0)+nvl(1d_ago.order_num,0),
    nvl(old.order_activity_count,0)+nvl(1d_ago.order_activity_count,0),
    nvl(old.order_coupon_count,0)+nvl(1d_ago.order_coupon_count,0),
    nvl(old.order_activity_reduce_amount,0.0)+nvl(1d_ago.order_activity_reduce_amount,0.0),
    nvl(old.order_coupon_reduce_amount,0.0)+nvl(1d_ago.order_coupon_reduce_amount,0.0),
    nvl(old.order_original_amount,0.0)+nvl(1d_ago.order_original_amount,0.0),
    nvl(old.order_final_amount,0.0)+nvl(1d_ago.order_final_amount,0.0),
    nvl(1d_ago.payment_count,0),
    nvl(1d_ago.payment_num,0),
    nvl(1d_ago.payment_amount,0.0),
    nvl(old.payment_last_7d_count,0)+nvl(1d_ago.payment_count,0)- nvl(7d_ago.payment_count,0),
    nvl(old.payment_last_7d_num,0)+nvl(1d_ago.payment_num,0)- nvl(7d_ago.payment_num,0),
    nvl(old.payment_last_7d_amount,0.0)+nvl(1d_ago.payment_amount,0.0)- nvl(7d_ago.payment_amount,0.0),
    nvl(old.payment_last_30d_count,0)+nvl(1d_ago.payment_count,0)- nvl(30d_ago.payment_count,0),
    nvl(old.payment_last_30d_num,0)+nvl(1d_ago.payment_num,0)- nvl(30d_ago.payment_num,0),
    nvl(old.payment_last_30d_amount,0.0)+nvl(1d_ago.payment_amount,0.0)- nvl(30d_ago.payment_amount,0.0),
    nvl(old.payment_count,0)+nvl(1d_ago.payment_count,0),
    nvl(old.payment_num,0)+nvl(1d_ago.payment_num,0),
    nvl(old.payment_amount,0.0)+nvl(1d_ago.payment_amount,0.0),
    nvl(old.refund_order_last_1d_count,0)+nvl(1d_ago.refund_order_count,0)- nvl(1d_ago.refund_order_count,0),
    nvl(old.refund_order_last_1d_num,0)+nvl(1d_ago.refund_order_num,0)- nvl(1d_ago.refund_order_num,0),
    nvl(old.refund_order_last_1d_amount,0.0)+nvl(1d_ago.refund_order_amount,0.0)- nvl(1d_ago.refund_order_amount,0.0),
    nvl(old.refund_order_last_7d_count,0)+nvl(1d_ago.refund_order_count,0)- nvl(7d_ago.refund_order_count,0),
    nvl(old.refund_order_last_7d_num,0)+nvl(1d_ago.refund_order_num,0)- nvl(7d_ago.refund_order_num,0),
    nvl(old.refund_order_last_7d_amount,0.0)+nvl(1d_ago.refund_order_amount,0.0)- nvl(7d_ago.refund_order_amount,0.0),
    nvl(old.refund_order_last_30d_count,0)+nvl(1d_ago.refund_order_count,0)- nvl(30d_ago.refund_order_count,0),
    nvl(old.refund_order_last_30d_num,0)+nvl(1d_ago.refund_order_num,0)- nvl(30d_ago.refund_order_num,0),
    nvl(old.refund_order_last_30d_amount,0.0)+nvl(1d_ago.refund_order_amount,0.0)- nvl(30d_ago.refund_order_amount,0.0),
    nvl(old.refund_order_count,0)+nvl(1d_ago.refund_order_count,0),
    nvl(old.refund_order_num,0)+nvl(1d_ago.refund_order_num,0),
    nvl(old.refund_order_amount,0.0)+nvl(1d_ago.refund_order_amount,0.0),
    nvl(1d_ago.refund_payment_count,0),
    nvl(1d_ago.refund_payment_num,0),
    nvl(1d_ago.refund_payment_amount,0.0),
    nvl(old.refund_payment_last_7d_count,0)+nvl(1d_ago.refund_payment_count,0)- nvl(7d_ago.refund_payment_count,0),
    nvl(old.refund_payment_last_7d_num,0)+nvl(1d_ago.refund_payment_num,0)- nvl(7d_ago.refund_payment_num,0),
    nvl(old.refund_payment_last_7d_amount,0.0)+nvl(1d_ago.refund_payment_amount,0.0)- nvl(7d_ago.refund_payment_amount,0.0),
    nvl(old.refund_payment_last_30d_count,0)+nvl(1d_ago.refund_payment_count,0)- nvl(30d_ago.refund_payment_count,0),
    nvl(old.refund_payment_last_30d_num,0)+nvl(1d_ago.refund_payment_num,0)- nvl(30d_ago.refund_payment_num,0),
    nvl(old.refund_payment_last_30d_amount,0.0)+nvl(1d_ago.refund_payment_amount,0.0)- nvl(30d_ago.refund_payment_amount,0.0),
    nvl(old.refund_payment_count,0)+nvl(1d_ago.refund_payment_count,0),
    nvl(old.refund_payment_num,0)+nvl(1d_ago.refund_payment_num,0),
    nvl(old.refund_payment_amount,0.0)+nvl(1d_ago.refund_payment_amount,0.0),
    nvl(1d_ago.cart_count,0),
    nvl(old.cart_last_7d_count,0)+nvl(1d_ago.cart_count,0)- nvl(7d_ago.cart_count,0),
    nvl(old.cart_last_30d_count,0)+nvl(1d_ago.cart_count,0)- nvl(30d_ago.cart_count,0),
    nvl(old.cart_count,0)+nvl(1d_ago.cart_count,0),
    nvl(1d_ago.favor_count,0),
    nvl(old.favor_last_7d_count,0)+nvl(1d_ago.favor_count,0)- nvl(7d_ago.favor_count,0),
    nvl(old.favor_last_30d_count,0)+nvl(1d_ago.favor_count,0)- nvl(30d_ago.favor_count,0),
    nvl(old.favor_count,0)+nvl(1d_ago.favor_count,0),
    nvl(1d_ago.appraise_good_count,0),
    nvl(1d_ago.appraise_mid_count,0),
    nvl(1d_ago.appraise_bad_count,0),
    nvl(1d_ago.appraise_default_count,0),
    nvl(old.appraise_last_7d_good_count,0)+nvl(1d_ago.appraise_good_count,0)- nvl(7d_ago.appraise_good_count,0),
    nvl(old.appraise_last_7d_mid_count,0)+nvl(1d_ago.appraise_mid_count,0)- nvl(7d_ago.appraise_mid_count,0),
    nvl(old.appraise_last_7d_bad_count,0)+nvl(1d_ago.appraise_bad_count,0)- nvl(7d_ago.appraise_bad_count,0),
    nvl(old.appraise_last_7d_default_count,0)+nvl(1d_ago.appraise_default_count,0)- nvl(7d_ago.appraise_default_count,0),
    nvl(old.appraise_last_30d_good_count,0)+nvl(1d_ago.appraise_good_count,0)- nvl(30d_ago.appraise_good_count,0),
    nvl(old.appraise_last_30d_mid_count,0)+nvl(1d_ago.appraise_mid_count,0)- nvl(30d_ago.appraise_mid_count,0),
    nvl(old.appraise_last_30d_bad_count,0)+nvl(1d_ago.appraise_bad_count,0)- nvl(30d_ago.appraise_bad_count,0),
    nvl(old.appraise_last_30d_default_count,0)+nvl(1d_ago.appraise_default_count,0)- nvl(30d_ago.appraise_default_count,0),
    nvl(old.appraise_good_count,0)+nvl(1d_ago.appraise_good_count,0),
    nvl(old.appraise_mid_count,0)+nvl(1d_ago.appraise_mid_count,0),
    nvl(old.appraise_bad_count,0)+nvl(1d_ago.appraise_bad_count,0),
    nvl(old.appraise_default_count,0)+nvl(1d_ago.appraise_default_count,0)
from
(
    select
        sku_id,
        order_last_1d_count,
        order_last_1d_num,
        order_activity_last_1d_count,
        order_coupon_last_1d_count,
        order_activity_reduce_last_1d_amount,
        order_coupon_reduce_last_1d_amount,
        order_last_1d_original_amount,
        order_last_1d_final_amount,
        order_last_7d_count,
        order_last_7d_num,
        order_activity_last_7d_count,
        order_coupon_last_7d_count,
        order_activity_reduce_last_7d_amount,
        order_coupon_reduce_last_7d_amount,
        order_last_7d_original_amount,
        order_last_7d_final_amount,
        order_last_30d_count,
        order_last_30d_num,
        order_activity_last_30d_count,
        order_coupon_last_30d_count,
        order_activity_reduce_last_30d_amount,
        order_coupon_reduce_last_30d_amount,
        order_last_30d_original_amount,
        order_last_30d_final_amount,
        order_count,
        order_num,
        order_activity_count,
        order_coupon_count,
        order_activity_reduce_amount,
        order_coupon_reduce_amount,
        order_original_amount,
        order_final_amount,
        payment_last_1d_count,
        payment_last_1d_num,
        payment_last_1d_amount,
        payment_last_7d_count,
        payment_last_7d_num,
        payment_last_7d_amount,
        payment_last_30d_count,
        payment_last_30d_num,
        payment_last_30d_amount,
        payment_count,
        payment_num,
        payment_amount,
        refund_order_last_1d_count,
        refund_order_last_1d_num,
        refund_order_last_1d_amount,
        refund_order_last_7d_count,
        refund_order_last_7d_num,
        refund_order_last_7d_amount,
        refund_order_last_30d_count,
        refund_order_last_30d_num,
        refund_order_last_30d_amount,
        refund_order_count,
        refund_order_num,
        refund_order_amount,
        refund_payment_last_1d_count,
        refund_payment_last_1d_num,
        refund_payment_last_1d_amount,
        refund_payment_last_7d_count,
        refund_payment_last_7d_num,
        refund_payment_last_7d_amount,
        refund_payment_last_30d_count,
        refund_payment_last_30d_num,
        refund_payment_last_30d_amount,
        refund_payment_count,
        refund_payment_num,
        refund_payment_amount,
        cart_last_1d_count,
        cart_last_7d_count,
        cart_last_30d_count,
        cart_count,
        favor_last_1d_count,
        favor_last_7d_count,
        favor_last_30d_count,
        favor_count,
        appraise_last_1d_good_count,
        appraise_last_1d_mid_count,
        appraise_last_1d_bad_count,
        appraise_last_1d_default_count,
        appraise_last_7d_good_count,
        appraise_last_7d_mid_count,
        appraise_last_7d_bad_count,
        appraise_last_7d_default_count,
        appraise_last_30d_good_count,
        appraise_last_30d_mid_count,
        appraise_last_30d_bad_count,
        appraise_last_30d_default_count,
        appraise_good_count,
        appraise_mid_count,
        appraise_bad_count,
        appraise_default_count
    from ${APP}.dwt_sku_topic
    where dt=date_add('$do_date',-1)
)old
full outer join
(
    select
        sku_id,
        order_count,
        order_num,
        order_activity_count,
        order_coupon_count,
        order_activity_reduce_amount,
        order_coupon_reduce_amount,
        order_original_amount,
        order_final_amount,
        payment_count,
        payment_num,
        payment_amount,
        refund_order_count,
        refund_order_num,
        refund_order_amount,
        refund_payment_count,
        refund_payment_num,
        refund_payment_amount,
        cart_count,
        favor_count,
        appraise_good_count,
        appraise_mid_count,
        appraise_bad_count,
        appraise_default_count
    from ${APP}.dws_sku_action_daycount
    where dt='$do_date'
)1d_ago
on old.sku_id=1d_ago.sku_id
left join
(
    select
        sku_id,
        order_count,
        order_num,
        order_activity_count,
        order_coupon_count,
        order_activity_reduce_amount,
        order_coupon_reduce_amount,
        order_original_amount,
        order_final_amount,
        payment_count,
        payment_num,
        payment_amount,
        refund_order_count,
        refund_order_num,
        refund_order_amount,
        refund_payment_count,
        refund_payment_num,
        refund_payment_amount,
        cart_count,
        favor_count,
        appraise_good_count,
        appraise_mid_count,
        appraise_bad_count,
        appraise_default_count
    from ${APP}.dws_sku_action_daycount
    where dt=date_add('$do_date',-7)
)7d_ago
on old.sku_id=7d_ago.sku_id
left join
(
    select
        sku_id,
        order_count,
        order_num,
        order_activity_count,
        order_coupon_count,
        order_activity_reduce_amount,
        order_coupon_reduce_amount,
        order_original_amount,
        order_final_amount,
        payment_count,
        payment_num,
        payment_amount,
        refund_order_count,
        refund_order_num,
        refund_order_amount,
        refund_payment_count,
        refund_payment_num,
        refund_payment_amount,
        cart_count,
        favor_count,
        appraise_good_count,
        appraise_mid_count,
        appraise_bad_count,
        appraise_default_count
    from ${APP}.dws_sku_action_daycount
    where dt=date_add('$do_date',-30)
)30d_ago
on old.sku_id=30d_ago.sku_id;
alter table ${APP}.dwt_sku_topic drop partition(dt='$clear_date');
"

dwt_activity_topic="
insert overwrite table ${APP}.dwt_activity_topic partition(dt='$do_date')
select
    nvl(1d_ago.activity_rule_id,old.activity_rule_id),
    nvl(1d_ago.activity_id,old.activity_id),
    nvl(1d_ago.order_count,0),
    nvl(1d_ago.order_reduce_amount,0.0),
    nvl(1d_ago.order_original_amount,0.0),
    nvl(1d_ago.order_final_amount,0.0),
    nvl(old.order_count,0)+nvl(1d_ago.order_count,0),
    nvl(old.order_reduce_amount,0.0)+nvl(1d_ago.order_reduce_amount,0.0),
    nvl(old.order_original_amount,0.0)+nvl(1d_ago.order_original_amount,0.0),
    nvl(old.order_final_amount,0.0)+nvl(1d_ago.order_final_amount,0.0),
    nvl(1d_ago.payment_count,0),
    nvl(1d_ago.payment_reduce_amount,0.0),
    nvl(1d_ago.payment_amount,0.0),
    nvl(old.payment_count,0)+nvl(1d_ago.payment_count,0),
    nvl(old.payment_reduce_amount,0.0)+nvl(1d_ago.payment_reduce_amount,0.0),
    nvl(old.payment_amount,0.0)+nvl(1d_ago.payment_amount,0.0)
from
(
    select
        activity_rule_id,
        activity_id,
        order_count,
        order_reduce_amount,
        order_original_amount,
        order_final_amount,
        payment_count,
        payment_reduce_amount,
        payment_amount
    from ${APP}.dwt_activity_topic
    where dt=date_add('$do_date',-1)
)old
full outer join
(
    select
        activity_rule_id,
        activity_id,
        order_count,
        order_reduce_amount,
        order_original_amount,
        order_final_amount,
        payment_count,
        payment_reduce_amount,
        payment_amount
    from ${APP}.dws_activity_info_daycount
    where dt='$do_date'
)1d_ago
on old.activity_rule_id=1d_ago.activity_rule_id;
alter table ${APP}.dwt_activity_topic drop partition(dt='$clear_date');
"

dwt_coupon_topic="
insert overwrite table ${APP}.dwt_coupon_topic partition(dt='$do_date')
select
    nvl(1d_ago.coupon_id,old.coupon_id),
    nvl(1d_ago.get_count,0),
    nvl(old.get_last_7d_count,0)+nvl(1d_ago.get_count,0)- nvl(7d_ago.get_count,0),
    nvl(old.get_last_30d_count,0)+nvl(1d_ago.get_count,0)- nvl(30d_ago.get_count,0),
    nvl(old.get_count,0)+nvl(1d_ago.get_count,0),
    nvl(1d_ago.order_count,0),
    nvl(1d_ago.order_reduce_amount,0.0),
    nvl(1d_ago.order_original_amount,0.0),
    nvl(1d_ago.order_final_amount,0.0),
    nvl(old.order_last_7d_count,0)+nvl(1d_ago.order_count,0)- nvl(7d_ago.order_count,0),
    nvl(old.order_last_7d_reduce_amount,0.0)+nvl(1d_ago.order_reduce_amount,0.0)- nvl(7d_ago.order_reduce_amount,0.0),
    nvl(old.order_last_7d_original_amount,0.0)+nvl(1d_ago.order_original_amount,0.0)- nvl(7d_ago.order_original_amount,0.0),
    nvl(old.order_last_7d_final_amount,0.0)+nvl(1d_ago.order_final_amount,0.0)- nvl(7d_ago.order_final_amount,0.0),
    nvl(old.order_last_30d_count,0)+nvl(1d_ago.order_count,0)- nvl(30d_ago.order_count,0),
    nvl(old.order_last_30d_reduce_amount,0.0)+nvl(1d_ago.order_reduce_amount,0.0)- nvl(30d_ago.order_reduce_amount,0.0),
    nvl(old.order_last_30d_original_amount,0.0)+nvl(1d_ago.order_original_amount,0.0)- nvl(30d_ago.order_original_amount,0.0),
    nvl(old.order_last_30d_final_amount,0.0)+nvl(1d_ago.order_final_amount,0.0)- nvl(30d_ago.order_final_amount,0.0),
    nvl(old.order_count,0)+nvl(1d_ago.order_count,0),
    nvl(old.order_reduce_amount,0.0)+nvl(1d_ago.order_reduce_amount,0.0),
    nvl(old.order_original_amount,0.0)+nvl(1d_ago.order_original_amount,0.0),
    nvl(old.order_final_amount,0.0)+nvl(1d_ago.order_final_amount,0.0),
    nvl(old.payment_last_1d_count,0)+nvl(1d_ago.payment_count,0)- nvl(1d_ago.payment_count,0),
    nvl(old.payment_last_1d_reduce_amount,0.0)+nvl(1d_ago.payment_reduce_amount,0.0)- nvl(1d_ago.payment_reduce_amount,0.0),
    nvl(old.payment_last_1d_amount,0.0)+nvl(1d_ago.payment_amount,0.0)- nvl(1d_ago.payment_amount,0.0),
    nvl(old.payment_last_7d_count,0)+nvl(1d_ago.payment_count,0)- nvl(7d_ago.payment_count,0),
    nvl(old.payment_last_7d_reduce_amount,0.0)+nvl(1d_ago.payment_reduce_amount,0.0)- nvl(7d_ago.payment_reduce_amount,0.0),
    nvl(old.payment_last_7d_amount,0.0)+nvl(1d_ago.payment_amount,0.0)- nvl(7d_ago.payment_amount,0.0),
    nvl(old.payment_last_30d_count,0)+nvl(1d_ago.payment_count,0)- nvl(30d_ago.payment_count,0),
    nvl(old.payment_last_30d_reduce_amount,0.0)+nvl(1d_ago.payment_reduce_amount,0.0)- nvl(30d_ago.payment_reduce_amount,0.0),
    nvl(old.payment_last_30d_amount,0.0)+nvl(1d_ago.payment_amount,0.0)- nvl(30d_ago.payment_amount,0.0),
    nvl(old.payment_count,0)+nvl(1d_ago.payment_count,0),
    nvl(old.payment_reduce_amount,0.0)+nvl(1d_ago.payment_reduce_amount,0.0),
    nvl(old.payment_amount,0.0)+nvl(1d_ago.payment_amount,0.0),
    nvl(1d_ago.expire_count,0),
    nvl(old.expire_last_7d_count,0)+nvl(1d_ago.expire_count,0)- nvl(7d_ago.expire_count,0),
    nvl(old.expire_last_30d_count,0)+nvl(1d_ago.expire_count,0)- nvl(30d_ago.expire_count,0),
    nvl(old.expire_count,0)+nvl(1d_ago.expire_count,0)
from
(
    select
        coupon_id,
        get_last_1d_count,
        get_last_7d_count,
        get_last_30d_count,
        get_count,
        order_last_1d_count,
        order_last_1d_reduce_amount,
        order_last_1d_original_amount,
        order_last_1d_final_amount,
        order_last_7d_count,
        order_last_7d_reduce_amount,
        order_last_7d_original_amount,
        order_last_7d_final_amount,
        order_last_30d_count,
        order_last_30d_reduce_amount,
        order_last_30d_original_amount,
        order_last_30d_final_amount,
        order_count,
        order_reduce_amount,
        order_original_amount,
        order_final_amount,
        payment_last_1d_count,
        payment_last_1d_reduce_amount,
        payment_last_1d_amount,
        payment_last_7d_count,
        payment_last_7d_reduce_amount,
        payment_last_7d_amount,
        payment_last_30d_count,
        payment_last_30d_reduce_amount,
        payment_last_30d_amount,
        payment_count,
        payment_reduce_amount,
        payment_amount,
        expire_last_1d_count,
        expire_last_7d_count,
        expire_last_30d_count,
        expire_count
    from ${APP}.dwt_coupon_topic
    where dt=date_add('$do_date',-1)
)old
full outer join
(
    select
        coupon_id,
        get_count,
        order_count,
        order_reduce_amount,
        order_original_amount,
        order_final_amount,
        payment_count,
        payment_reduce_amount,
        payment_amount,
        expire_count
    from ${APP}.dws_coupon_info_daycount
    where dt='$do_date'
)1d_ago
on old.coupon_id=1d_ago.coupon_id
left join
(
    select
        coupon_id,
        get_count,
        order_count,
        order_reduce_amount,
        order_original_amount,
        order_final_amount,
        payment_count,
        payment_reduce_amount,
        payment_amount,
        expire_count
    from ${APP}.dws_coupon_info_daycount
    where dt=date_add('$do_date',-7)
)7d_ago
on old.coupon_id=7d_ago.coupon_id
left join
(
    select
        coupon_id,
        get_count,
        order_count,
        order_reduce_amount,
        order_original_amount,
        order_final_amount,
        payment_count,
        payment_reduce_amount,
        payment_amount,
        expire_count
    from ${APP}.dws_coupon_info_daycount
    where dt=date_add('$do_date',-30)
)30d_ago
on old.coupon_id=30d_ago.coupon_id;
alter table ${APP}.dwt_coupon_topic drop partition(dt='$clear_date');
"

dwt_area_topic="
insert overwrite table ${APP}.dwt_area_topic partition(dt='$do_date')
select
    nvl(old.province_id, 1d_ago.province_id),
    nvl(1d_ago.visit_count,0),
    nvl(1d_ago.login_count,0),
    nvl(old.visit_last_7d_count,0)+nvl(1d_ago.visit_count,0)- nvl(7d_ago.visit_count,0),
    nvl(old.login_last_7d_count,0)+nvl(1d_ago.login_count,0)- nvl(7d_ago.login_count,0),
    nvl(old.visit_last_30d_count,0)+nvl(1d_ago.visit_count,0)- nvl(30d_ago.visit_count,0),
    nvl(old.login_last_30d_count,0)+nvl(1d_ago.login_count,0)- nvl(30d_ago.login_count,0),
    nvl(old.visit_count,0)+nvl(1d_ago.visit_count,0),
    nvl(old.login_count,0)+nvl(1d_ago.login_count,0),
    nvl(1d_ago.order_count,0),
    nvl(1d_ago.order_original_amount,0.0),
    nvl(1d_ago.order_final_amount,0.0),
    nvl(old.order_last_7d_count,0)+nvl(1d_ago.order_count,0)- nvl(7d_ago.order_count,0),
    nvl(old.order_last_7d_original_amount,0.0)+nvl(1d_ago.order_original_amount,0.0)- nvl(7d_ago.order_original_amount,0.0),
    nvl(old.order_last_7d_final_amount,0.0)+nvl(1d_ago.order_final_amount,0.0)- nvl(7d_ago.order_final_amount,0.0),
    nvl(old.order_last_30d_count,0)+nvl(1d_ago.order_count,0)- nvl(30d_ago.order_count,0),
    nvl(old.order_last_30d_original_amount,0.0)+nvl(1d_ago.order_original_amount,0.0)- nvl(30d_ago.order_original_amount,0.0),
    nvl(old.order_last_30d_final_amount,0.0)+nvl(1d_ago.order_final_amount,0.0)- nvl(30d_ago.order_final_amount,0.0),
    nvl(old.order_count,0)+nvl(1d_ago.order_count,0),
    nvl(old.order_original_amount,0.0)+nvl(1d_ago.order_original_amount,0.0),
    nvl(old.order_final_amount,0.0)+nvl(1d_ago.order_final_amount,0.0),
    nvl(1d_ago.payment_count,0),
    nvl(1d_ago.payment_amount,0.0),
    nvl(old.payment_last_7d_count,0)+nvl(1d_ago.payment_count,0)- nvl(7d_ago.payment_count,0),
    nvl(old.payment_last_7d_amount,0.0)+nvl(1d_ago.payment_amount,0.0)- nvl(7d_ago.payment_amount,0.0),
    nvl(old.payment_last_30d_count,0)+nvl(1d_ago.payment_count,0)- nvl(30d_ago.payment_count,0),
    nvl(old.payment_last_30d_amount,0.0)+nvl(1d_ago.payment_amount,0.0)- nvl(30d_ago.payment_amount,0.0),
    nvl(old.payment_count,0)+nvl(1d_ago.payment_count,0),
    nvl(old.payment_amount,0.0)+nvl(1d_ago.payment_amount,0.0),
    nvl(1d_ago.refund_order_count,0),
    nvl(1d_ago.refund_order_amount,0.0),
    nvl(old.refund_order_last_7d_count,0)+nvl(1d_ago.refund_order_count,0)- nvl(7d_ago.refund_order_count,0),
    nvl(old.refund_order_last_7d_amount,0.0)+nvl(1d_ago.refund_order_amount,0.0)- nvl(7d_ago.refund_order_amount,0.0),
    nvl(old.refund_order_last_30d_count,0)+nvl(1d_ago.refund_order_count,0)- nvl(30d_ago.refund_order_count,0),
    nvl(old.refund_order_last_30d_amount,0.0)+nvl(1d_ago.refund_order_amount,0.0)- nvl(30d_ago.refund_order_amount,0.0),
    nvl(old.refund_order_count,0)+nvl(1d_ago.refund_order_count,0),
    nvl(old.refund_order_amount,0.0)+nvl(1d_ago.refund_order_amount,0.0),
    nvl(1d_ago.refund_payment_count,0),
    nvl(1d_ago.refund_payment_amount,0.0),
    nvl(old.refund_payment_last_7d_count,0)+nvl(1d_ago.refund_payment_count,0)- nvl(7d_ago.refund_payment_count,0),
    nvl(old.refund_payment_last_7d_amount,0.0)+nvl(1d_ago.refund_payment_amount,0.0)- nvl(7d_ago.refund_payment_amount,0.0),
    nvl(old.refund_payment_last_30d_count,0)+nvl(1d_ago.refund_payment_count,0)- nvl(30d_ago.refund_payment_count,0),
    nvl(old.refund_payment_last_30d_amount,0.0)+nvl(1d_ago.refund_payment_amount,0.0)- nvl(30d_ago.refund_payment_amount,0.0),
    nvl(old.refund_payment_count,0)+nvl(1d_ago.refund_payment_count,0),
    nvl(old.refund_payment_amount,0.0)+nvl(1d_ago.refund_payment_amount,0.0)

from
(
    select
        province_id,
        visit_last_1d_count,
        login_last_1d_count,
        visit_last_7d_count,
        login_last_7d_count,
        visit_last_30d_count,
        login_last_30d_count,
        visit_count,
        login_count,
        order_last_1d_count,
        order_last_1d_original_amount,
        order_last_1d_final_amount,
        order_last_7d_count,
        order_last_7d_original_amount,
        order_last_7d_final_amount,
        order_last_30d_count,
        order_last_30d_original_amount,
        order_last_30d_final_amount,
        order_count,
        order_original_amount,
        order_final_amount,
        payment_last_1d_count,
        payment_last_1d_amount,
        payment_last_7d_count,
        payment_last_7d_amount,
        payment_last_30d_count,
        payment_last_30d_amount,
        payment_count,
        payment_amount,
        refund_order_last_1d_count,
        refund_order_last_1d_amount,
        refund_order_last_7d_count,
        refund_order_last_7d_amount,
        refund_order_last_30d_count,
        refund_order_last_30d_amount,
        refund_order_count,
        refund_order_amount,
        refund_payment_last_1d_count,
        refund_payment_last_1d_amount,
        refund_payment_last_7d_count,
        refund_payment_last_7d_amount,
        refund_payment_last_30d_count,
        refund_payment_last_30d_amount,
        refund_payment_count,
        refund_payment_amount
    from ${APP}.dwt_area_topic
    where dt=date_add('$do_date',-1)
)old
full outer join
(
    select
        province_id,
        visit_count,
        login_count,
        order_count,
        order_original_amount,
        order_final_amount,
        payment_count,
        payment_amount,
        refund_order_count,
        refund_order_amount,
        refund_payment_count,
        refund_payment_amount
    from ${APP}.dws_area_stats_daycount
    where dt='$do_date'
)1d_ago
on old.province_id=1d_ago.province_id
left join
(
    select
        province_id,
        visit_count,
        login_count,
        order_count,
        order_original_amount,
        order_final_amount,
        payment_count,
        payment_amount,
        refund_order_count,
        refund_order_amount,
        refund_payment_count,
        refund_payment_amount
    from ${APP}.dws_area_stats_daycount
    where dt=date_add('$do_date',-7)
)7d_ago
on old.province_id= 7d_ago.province_id
left join
(
    select
        province_id,
        visit_count,
        login_count,
        order_count,
        order_original_amount,
        order_final_amount,
        payment_count,
        payment_amount,
        refund_order_count,
        refund_order_amount,
        refund_payment_count,
        refund_payment_amount
    from ${APP}.dws_area_stats_daycount
    where dt=date_add('$do_date',-30)
)30d_ago
on old.province_id= 30d_ago.province_id;
alter table ${APP}.dwt_area_topic drop partition(dt='$clear_date');
"

case $1 in
    "dwt_visitor_topic" )
        hive -e "$dwt_visitor_topic"
        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_visitor_topic/dt=$clear_date
    ;;
    "dwt_user_topic" )
        hive -e "$dwt_user_topic"
        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_user_topic/dt=$clear_date
    ;;
    "dwt_sku_topic" )
        hive -e "$dwt_sku_topic"
        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_sku_topic/dt=$clear_date
    ;;
    "dwt_activity_topic" )
        hive -e "$dwt_activity_topic"
        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_activity_topic/dt=$clear_date
    ;;
    "dwt_coupon_topic" )
        hive -e "$dwt_coupon_topic"
        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_coupon_topic/dt=$clear_date
    ;;
    "dwt_area_topic" )
        hive -e "$dwt_area_topic"
        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_area_topic/dt=$clear_date
    ;;
    "all" )
        hive -e "$dwt_visitor_topic$dwt_user_topic$dwt_sku_topic$dwt_activity_topic$dwt_coupon_topic$dwt_area_topic"
        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_visitor_topic/dt=$clear_date
        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_user_topic/dt=$clear_date
        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_sku_topic/dt=$clear_date
        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_activity_topic/dt=$clear_date
        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_coupon_topic/dt=$clear_date
        hadoop fs -rm -r -f /warehouse/gmall/dwt/dwt_area_topic/dt=$clear_date
    ;;
esac
</code></pre>
<p>（2）增加脚本执行权限</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 dws_to_dwt.sh
</code></pre>
<p>2）脚本使用<br>（1）执行脚本</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ dws_to_dwt.sh 2020-06-14
</code></pre>
<p>（2）查看导入数据</p>
<h1 id="第9章-数仓搭建-ADS层"><a href="#第9章-数仓搭建-ADS层" class="headerlink" title="第9章 数仓搭建-ADS层"></a>第9章 数仓搭建-ADS层</h1><h2 id="9-1-建表说明"><a href="#9-1-建表说明" class="headerlink" title="9.1 建表说明"></a>9.1 建表说明</h2><p>ADS层不涉及建模，建表根据具体需求而定。</p>
<h2 id="9-2-访客主题"><a href="#9-2-访客主题" class="headerlink" title="9.2 访客主题"></a>9.2 访客主题</h2><h3 id="9-2-1-访客统计"><a href="#9-2-1-访客统计" class="headerlink" title="9.2.1 访客统计"></a>9.2.1 访客统计</h3><p>该需求为访客综合统计，其中包含若干指标，以下为对每个指标的解释说明。</p>
<table>
<thead>
<tr>
<th>指标</th>
<th>说明</th>
<th>对应字段</th>
</tr>
</thead>
<tbody><tr>
<td>访客数</td>
<td>统计访问人数</td>
<td>uv_count</td>
</tr>
<tr>
<td>页面停留时长</td>
<td>统计所有页面访问记录总时长，以秒为单位</td>
<td>duration_sec</td>
</tr>
<tr>
<td>平均页面停留时长</td>
<td>统计每个会话平均停留时长，以秒为单位</td>
<td>avg_duration_sec</td>
</tr>
<tr>
<td>页面浏览总数</td>
<td>统计所有页面访问记录总数</td>
<td>page_count</td>
</tr>
<tr>
<td>平均页面浏览数</td>
<td>统计每个会话平均浏览页面数</td>
<td>avg_page_count</td>
</tr>
<tr>
<td>会话总数</td>
<td>统计会话总数</td>
<td>sv_count</td>
</tr>
<tr>
<td>跳出数</td>
<td>统计只浏览一个页面的会话个数</td>
<td>bounce_count</td>
</tr>
<tr>
<td>跳出率</td>
<td>只有一个页面的会话的比例</td>
<td>bounce_rate</td>
</tr>
</tbody></table>
<p>1.建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_visit_stats<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ads_visit_stats <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>is_new<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'新老标识,1:新,0:老'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近天数,1:最近1天,7:最近7天,30:最近30天'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>channel<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'渠道'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>uv_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'日活(访问人数)'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>duration_sec<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'页面停留总时长'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>avg_duration_sec<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'一次会话，页面停留平均时长,单位为描述'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>page_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'页面总浏览数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>avg_page_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'一次会话，页面平均浏览数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>sv_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'会话次数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>bounce_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'跳出数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>bounce_rate<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'跳出率'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'访客统计'</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
LOCATION <span class="token string">'/warehouse/gmall/ads/ads_visit_stats/'</span><span class="token punctuation">;</span>
</code></pre>
<p>2.数据装载<br>思路分析：该需求的关键点为会话的划分，总体实现思路可分为以下几步：<br>第一步：对所有页面访问记录进行会话的划分。<br>第二步：统计每个会话的浏览时长和浏览页面数。<br>第三步：统计上述各指标。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_visit_stats
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_visit_stats
<span class="token keyword">union</span>
<span class="token keyword">select</span>
    <span class="token string">'2020-06-14'</span> dt<span class="token punctuation">,</span>
    is_new<span class="token punctuation">,</span>
    recent_days<span class="token punctuation">,</span>
    channel<span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span><span class="token punctuation">(</span>mid_id<span class="token punctuation">)</span><span class="token punctuation">)</span> uv_count<span class="token punctuation">,</span>
    cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span> <span class="token keyword">as</span> <span class="token keyword">bigint</span><span class="token punctuation">)</span> duration_sec<span class="token punctuation">,</span>
    cast<span class="token punctuation">(</span><span class="token function">avg</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span> <span class="token keyword">as</span> <span class="token keyword">bigint</span><span class="token punctuation">)</span> avg_duration_sec<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>page_count<span class="token punctuation">)</span> page_count<span class="token punctuation">,</span>
    cast<span class="token punctuation">(</span><span class="token function">avg</span><span class="token punctuation">(</span>page_count<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">bigint</span><span class="token punctuation">)</span> avg_page_count<span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> sv_count<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>page_count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> bounce_count<span class="token punctuation">,</span>
    cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>page_count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> bounce_rate
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        session_id<span class="token punctuation">,</span>
        mid_id<span class="token punctuation">,</span>
        is_new<span class="token punctuation">,</span>
        recent_days<span class="token punctuation">,</span>
        channel<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> page_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>during_time<span class="token punctuation">)</span> duration
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            mid_id<span class="token punctuation">,</span>
            channel<span class="token punctuation">,</span>
            recent_days<span class="token punctuation">,</span>
            is_new<span class="token punctuation">,</span>
            last_page_id<span class="token punctuation">,</span>
            page_id<span class="token punctuation">,</span>
            during_time<span class="token punctuation">,</span>
            concat<span class="token punctuation">(</span>mid_id<span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">,</span>last_value<span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>last_page_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span>ts<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> recent_days<span class="token punctuation">,</span>mid_id <span class="token keyword">order</span> <span class="token keyword">by</span> ts<span class="token punctuation">)</span><span class="token punctuation">)</span> session_id
        <span class="token keyword">from</span>
        <span class="token punctuation">(</span>
            <span class="token keyword">select</span>
                mid_id<span class="token punctuation">,</span>
                channel<span class="token punctuation">,</span>
                last_page_id<span class="token punctuation">,</span>
                page_id<span class="token punctuation">,</span>
                during_time<span class="token punctuation">,</span>
                ts<span class="token punctuation">,</span>
                recent_days<span class="token punctuation">,</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>visit_date_first<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span>recent_days<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">)</span> is_new
            <span class="token keyword">from</span>
            <span class="token punctuation">(</span>
                <span class="token keyword">select</span>
                    t1<span class="token punctuation">.</span>mid_id<span class="token punctuation">,</span>
                    t1<span class="token punctuation">.</span>channel<span class="token punctuation">,</span>
                    t1<span class="token punctuation">.</span>last_page_id<span class="token punctuation">,</span>
                    t1<span class="token punctuation">.</span>page_id<span class="token punctuation">,</span>
                    t1<span class="token punctuation">.</span>during_time<span class="token punctuation">,</span>
                    t1<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>
                    t1<span class="token punctuation">.</span>ts<span class="token punctuation">,</span>
                    t2<span class="token punctuation">.</span>visit_date_first
                <span class="token keyword">from</span>
                <span class="token punctuation">(</span>
                    <span class="token keyword">select</span>
                        mid_id<span class="token punctuation">,</span>
                        channel<span class="token punctuation">,</span>
                        last_page_id<span class="token punctuation">,</span>
                        page_id<span class="token punctuation">,</span>
                        during_time<span class="token punctuation">,</span>
                        dt<span class="token punctuation">,</span>
                        ts
                    <span class="token keyword">from</span> dwd_page_log
                    <span class="token keyword">where</span> dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>t1
                <span class="token keyword">left</span> <span class="token keyword">join</span>
                <span class="token punctuation">(</span>
                    <span class="token keyword">select</span>
                        mid_id<span class="token punctuation">,</span>
                        visit_date_first
                    <span class="token keyword">from</span> dwt_visitor_topic
                    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
                <span class="token punctuation">)</span>t2
                <span class="token keyword">on</span> t1<span class="token punctuation">.</span>mid_id<span class="token operator">=</span>t2<span class="token punctuation">.</span>mid_id
            <span class="token punctuation">)</span>t3 lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> tmp <span class="token keyword">as</span> recent_days
            <span class="token keyword">where</span> dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span>recent_days<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>t4
    <span class="token punctuation">)</span>t5
    <span class="token keyword">group</span> <span class="token keyword">by</span> session_id<span class="token punctuation">,</span>mid_id<span class="token punctuation">,</span>is_new<span class="token punctuation">,</span>recent_days<span class="token punctuation">,</span>channel
<span class="token punctuation">)</span>t6
<span class="token keyword">group</span> <span class="token keyword">by</span> is_new<span class="token punctuation">,</span>recent_days<span class="token punctuation">,</span>channel<span class="token punctuation">;</span>
</code></pre>
<h3 id="9-2-2-路径分析"><a href="#9-2-2-路径分析" class="headerlink" title="9.2.2 路径分析"></a>9.2.2 路径分析</h3><p>用户路径分析，顾名思义，就是指用户在APP或网站中的访问路径。为了衡量网站优化的效果或营销推广的效果，以及了解用户行为偏好，时常要对访问路径进行分析。<br>用户访问路径的可视化通常使用桑基图。如下图所示，该图可真实还原用户的访问路径，包括页面跳转和页面访问次序。<br>桑基图需要我们提供每种页面跳转的次数，每个跳转由source/target表示，source指跳转起始页面，target表示跳转终到页面。</p>
<p>1.建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_page_path<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ads_page_path
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近天数,1:最近1天,7:最近7天,30:最近30天'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>source<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'跳转起始页面ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>target<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'跳转终到页面ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>path_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'跳转次数'</span>
<span class="token punctuation">)</span>  <span class="token keyword">COMMENT</span> <span class="token string">'页面浏览路径'</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
LOCATION <span class="token string">'/warehouse/gmall/ads/ads_page_path/'</span><span class="token punctuation">;</span>
</code></pre>
<p>2.数据装载<br>思路分析：该需求要统计的就是每种跳转的次数，故理论上对source/target进行分组count()即可。统计时需注意以下两点：<br>第一点：桑基图的source不允许为空，但target可为空。<br>第二点：桑基图所展示的流程不允许存在环。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_page_path
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_page_path
<span class="token keyword">union</span>
<span class="token keyword">select</span>
    <span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>
    recent_days<span class="token punctuation">,</span>
    source<span class="token punctuation">,</span>
    target<span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        recent_days<span class="token punctuation">,</span>
        concat<span class="token punctuation">(</span><span class="token string">'step-'</span><span class="token punctuation">,</span>step<span class="token punctuation">,</span><span class="token string">':'</span><span class="token punctuation">,</span>source<span class="token punctuation">)</span> source<span class="token punctuation">,</span>
        concat<span class="token punctuation">(</span><span class="token string">'step-'</span><span class="token punctuation">,</span>step<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">':'</span><span class="token punctuation">,</span>target<span class="token punctuation">)</span> target
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            recent_days<span class="token punctuation">,</span>
            page_id source<span class="token punctuation">,</span>
            lead<span class="token punctuation">(</span>page_id<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> recent_days<span class="token punctuation">,</span>session_id <span class="token keyword">order</span> <span class="token keyword">by</span> ts<span class="token punctuation">)</span> target<span class="token punctuation">,</span>
            row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> recent_days<span class="token punctuation">,</span>session_id <span class="token keyword">order</span> <span class="token keyword">by</span> ts<span class="token punctuation">)</span> step
        <span class="token keyword">from</span>
        <span class="token punctuation">(</span>
            <span class="token keyword">select</span>
                recent_days<span class="token punctuation">,</span>
                last_page_id<span class="token punctuation">,</span>
                page_id<span class="token punctuation">,</span>
                ts<span class="token punctuation">,</span>
                concat<span class="token punctuation">(</span>mid_id<span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">,</span>last_value<span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>last_page_id <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span>ts<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> mid_id<span class="token punctuation">,</span>recent_days <span class="token keyword">order</span> <span class="token keyword">by</span> ts<span class="token punctuation">)</span><span class="token punctuation">)</span> session_id
            <span class="token keyword">from</span> dwd_page_log lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> tmp <span class="token keyword">as</span> recent_days
            <span class="token keyword">where</span> dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span>
            <span class="token operator">and</span> dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span>recent_days<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>t2
    <span class="token punctuation">)</span>t3
<span class="token punctuation">)</span>t4
<span class="token keyword">group</span> <span class="token keyword">by</span> recent_days<span class="token punctuation">,</span>source<span class="token punctuation">,</span>target<span class="token punctuation">;</span>
</code></pre>
<h2 id="9-3-用户主题"><a href="#9-3-用户主题" class="headerlink" title="9.3 用户主题"></a>9.3 用户主题</h2><h3 id="9-3-1-用户统计"><a href="#9-3-1-用户统计" class="headerlink" title="9.3.1 用户统计"></a>9.3.1 用户统计</h3><p>该需求为用户综合统计，其中包含若干指标，以下为对每个指标的解释说明。</p>
<table>
<thead>
<tr>
<th>指标</th>
<th>说明</th>
<th>对应字段</th>
</tr>
</thead>
<tbody><tr>
<td>新增用户数</td>
<td>统计新增注册用户人数</td>
<td>new_user_count</td>
</tr>
<tr>
<td>新增下单用户数</td>
<td>统计新增下单用户人数</td>
<td>new_order_user_count</td>
</tr>
<tr>
<td>下单总金额</td>
<td>统计所有订单总额</td>
<td>order_final_amount</td>
</tr>
<tr>
<td>下单用户数</td>
<td>统计下单用户总数</td>
<td>order_user_count</td>
</tr>
<tr>
<td>未下单用户数</td>
<td>统计活跃但未下单用户数</td>
<td>no_order_user_count</td>
</tr>
</tbody></table>
<p>1.建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_user_total<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_user_total<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近天数,0:累积值,1:最近1天,7:最近7天,30:最近30天'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>new_user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'新注册用户数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>new_order_user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'新增下单用户数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单总金额'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单用户数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>no_order_user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'未下单用户数(具体指活跃用户中未下单用户)'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户统计'</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
LOCATION <span class="token string">'/warehouse/gmall/ads/ads_user_total/'</span><span class="token punctuation">;</span>
</code></pre>
<p>2.数据装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_user_total
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_user_total
<span class="token keyword">union</span>
<span class="token keyword">select</span>
    <span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>
    recent_days<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>login_date_first<span class="token operator">>=</span>recent_days_ago<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> new_user_count<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_date_first<span class="token operator">>=</span>recent_days_ago<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> new_order_user_count<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_final_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_user_count<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>login_date_last<span class="token operator">>=</span>recent_days_ago <span class="token operator">and</span> order_final_amount<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> no_order_user_count
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        recent_days<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        login_date_first<span class="token punctuation">,</span>
        login_date_last<span class="token punctuation">,</span>
        order_date_first<span class="token punctuation">,</span>
        <span class="token keyword">case</span> <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">then</span> order_final_amount
             <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> order_last_1d_final_amount
             <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">7</span> <span class="token keyword">then</span> order_last_7d_final_amount
             <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">30</span> <span class="token keyword">then</span> order_last_30d_final_amount
        <span class="token keyword">end</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>recent_days<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'1970-01-01'</span><span class="token punctuation">,</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span>recent_days<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> recent_days_ago
    <span class="token keyword">from</span> dwt_user_topic lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> tmp <span class="token keyword">as</span> recent_days
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>t1
<span class="token keyword">group</span> <span class="token keyword">by</span> recent_days<span class="token punctuation">;</span>
</code></pre>
<h3 id="9-3-2-用户变动统计"><a href="#9-3-2-用户变动统计" class="headerlink" title="9.3.2 用户变动统计"></a>9.3.2 用户变动统计</h3><p>该需求包括两个指标，分别为流失用户数和回流用户数，以下为对两个指标的解释说明。<br>指标    说明    对应字段<br>流失用户数    之前活跃过的用户，最近一段时间未活跃，就称为流失用户。此处要求统计7日前（只包含7日前当天）活跃，但最近7日未活跃的用户总数。    user_churn_count<br>回流用户数    之前的活跃用户，一段时间未活跃（流失），今日又活跃了，就称为回流用户。此处要求统计回流用户总数。    new_order_user_count<br>1.建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_user_change<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_user_change<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>user_churn_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'流失用户数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>user_back_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'回流用户数'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户变动统计'</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
LOCATION <span class="token string">'/warehouse/gmall/ads/ads_user_change/'</span><span class="token punctuation">;</span>
</code></pre>
<p>2.数据装载<br>思路分析：<br>流失用户：末次活跃时间为7日前的用户即为流失用户。<br>回流用户：末次活跃时间为今日，上次活跃时间在8日前的用户即为回流用户。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_user_change
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_user_change
<span class="token keyword">union</span>
<span class="token keyword">select</span>
    churn<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>
    user_churn_count<span class="token punctuation">,</span>
    user_back_count
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        <span class="token string">'2020-06-14'</span> dt<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> user_churn_count
    <span class="token keyword">from</span> dwt_user_topic
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
    <span class="token operator">and</span> login_date_last<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>churn
<span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        <span class="token string">'2020-06-14'</span> dt<span class="token punctuation">,</span>
        <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> user_back_count
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            user_id<span class="token punctuation">,</span>
            login_date_last
        <span class="token keyword">from</span> dwt_user_topic
        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
        <span class="token operator">and</span> login_date_last<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
    <span class="token punctuation">)</span>t1
    <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            user_id<span class="token punctuation">,</span>
            login_date_last login_date_previous
        <span class="token keyword">from</span> dwt_user_topic
        <span class="token keyword">where</span> dt<span class="token operator">=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>t2
    <span class="token keyword">on</span> t1<span class="token punctuation">.</span>user_id<span class="token operator">=</span>t2<span class="token punctuation">.</span>user_id
    <span class="token keyword">where</span> datediff<span class="token punctuation">(</span>login_date_last<span class="token punctuation">,</span>login_date_previous<span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">8</span>
<span class="token punctuation">)</span>back
<span class="token keyword">on</span> churn<span class="token punctuation">.</span>dt<span class="token operator">=</span>back<span class="token punctuation">.</span>dt<span class="token punctuation">;</span>
</code></pre>
<h3 id="9-3-3-用户行为漏斗分析"><a href="#9-3-3-用户行为漏斗分析" class="headerlink" title="9.3.3 用户行为漏斗分析"></a>9.3.3 用户行为漏斗分析</h3><p>漏斗分析是一个数据分析模型，它能够科学反映一个业务过程从起点到终点各阶段用户转化情况。由于其能将各阶段环节都展示出来，故哪个阶段存在问题，就能一目了然。</p>
<p>该需求要求统计一个完整的购物流程各个阶段的人数。<br>1.建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_user_action<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_user_action<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近天数,1:最近1天,7:最近7天,30:最近30天'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>home_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'浏览首页人数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>good_detail_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'浏览商品详情页人数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>cart_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'加入购物车人数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单人数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付人数'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'漏斗分析'</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED  <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
LOCATION <span class="token string">'/warehouse/gmall/ads/ads_user_action/'</span><span class="token punctuation">;</span>
</code></pre>
<p>2.数据装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">with</span>
tmp_page <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        <span class="token string">'2020-06-14'</span> dt<span class="token punctuation">,</span>
        recent_days<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>array_contains<span class="token punctuation">(</span>pages<span class="token punctuation">,</span><span class="token string">'home'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> home_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>array_contains<span class="token punctuation">(</span>pages<span class="token punctuation">,</span><span class="token string">'good_detail'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> good_detail_count
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            recent_days<span class="token punctuation">,</span>
            mid_id<span class="token punctuation">,</span>
            collect_set<span class="token punctuation">(</span>page_id<span class="token punctuation">)</span> pages
        <span class="token keyword">from</span>
        <span class="token punctuation">(</span>
            <span class="token keyword">select</span>
                dt<span class="token punctuation">,</span>
                mid_id<span class="token punctuation">,</span>
                page<span class="token punctuation">.</span>page_id
            <span class="token keyword">from</span> dws_visitor_action_daycount lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>page_stats<span class="token punctuation">)</span> tmp <span class="token keyword">as</span> page
            <span class="token keyword">where</span> dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span>
            <span class="token operator">and</span> page<span class="token punctuation">.</span>page_id <span class="token operator">in</span><span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">,</span><span class="token string">'good_detail'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>t1 lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> tmp <span class="token keyword">as</span> recent_days
        <span class="token keyword">where</span> dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span>recent_days<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">group</span> <span class="token keyword">by</span> recent_days<span class="token punctuation">,</span>mid_id
    <span class="token punctuation">)</span>t2
    <span class="token keyword">group</span> <span class="token keyword">by</span> recent_days
<span class="token punctuation">)</span><span class="token punctuation">,</span>
tmp_cop <span class="token keyword">as</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        <span class="token string">'2020-06-14'</span> dt<span class="token punctuation">,</span>
        recent_days<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>cart_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cart_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>payment_count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> payment_count
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            recent_days<span class="token punctuation">,</span>
            user_id<span class="token punctuation">,</span>
            <span class="token keyword">case</span>
                <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> cart_last_1d_count
                <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">7</span> <span class="token keyword">then</span> cart_last_7d_count
                <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">30</span> <span class="token keyword">then</span> cart_last_30d_count
            <span class="token keyword">end</span> cart_count<span class="token punctuation">,</span>
            <span class="token keyword">case</span>
                <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> order_last_1d_count
                <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">7</span> <span class="token keyword">then</span> order_last_7d_count
                <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">30</span> <span class="token keyword">then</span> order_last_30d_count
            <span class="token keyword">end</span> order_count<span class="token punctuation">,</span>
            <span class="token keyword">case</span>
                <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> payment_last_1d_count
                <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">7</span> <span class="token keyword">then</span> payment_last_7d_count
                <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">30</span> <span class="token keyword">then</span> payment_last_30d_count
            <span class="token keyword">end</span> payment_count
        <span class="token keyword">from</span> dwt_user_topic lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> tmp <span class="token keyword">as</span> recent_days
        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
    <span class="token punctuation">)</span>t1
    <span class="token keyword">group</span> <span class="token keyword">by</span> recent_days
<span class="token punctuation">)</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_user_action
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_user_action
<span class="token keyword">union</span>
<span class="token keyword">select</span>
    tmp_page<span class="token punctuation">.</span>dt<span class="token punctuation">,</span>
    tmp_page<span class="token punctuation">.</span>recent_days<span class="token punctuation">,</span>
    home_count<span class="token punctuation">,</span>
    good_detail_count<span class="token punctuation">,</span>
    cart_count<span class="token punctuation">,</span>
    order_count<span class="token punctuation">,</span>
    payment_count
<span class="token keyword">from</span> tmp_page
<span class="token keyword">join</span> tmp_cop
<span class="token keyword">on</span> tmp_page<span class="token punctuation">.</span>recent_days<span class="token operator">=</span>tmp_cop<span class="token punctuation">.</span>recent_days<span class="token punctuation">;</span>
</code></pre>
<h3 id="9-3-4-用户留存率"><a href="#9-3-4-用户留存率" class="headerlink" title="9.3.4 用户留存率"></a>9.3.4 用户留存率</h3><p>留存分析一般包含新增留存和活跃留存分析。<br>新增留存分析是分析某天的新增用户中，有多少人有后续的活跃行为。活跃留存分析是分析某天的活跃用户中，有多少人有后续的活跃行为。<br>留存分析是衡量产品对用户价值高低的重要指标。<br>此处要求统计新增留存率，新增留存率具体是指留存用户数与新增用户数的比值，例如2020-06-14新增100个用户，1日之后（2020-06-15）这100人中有80个人活跃了，那2020-06-14的1日留存数则为80，2020-06-14的1日留存率则为80%。<br>要求统计每天的1至7日留存率，如下图所示。</p>
<p>1.建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_user_retention<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ads_user_retention <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>create_date<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户新增日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>retention_day<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'截至当前日期留存天数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>retention_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'留存用户数量'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>new_user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'新增用户数量'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>retention_rate<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'留存率'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户留存率'</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED  <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
LOCATION <span class="token string">'/warehouse/gmall/ads/ads_user_retention/'</span><span class="token punctuation">;</span>
</code></pre>
<p>2.数据装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_user_retention
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_user_retention
<span class="token keyword">union</span>
<span class="token keyword">select</span>
    <span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>
    login_date_first create_date<span class="token punctuation">,</span>
    datediff<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>login_date_first<span class="token punctuation">)</span> retention_day<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>login_date_last<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> retention_count<span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> new_user_count<span class="token punctuation">,</span>
    cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>login_date_last<span class="token operator">=</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> retention_rate
<span class="token keyword">from</span> dwt_user_topic
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token operator">and</span> login_date_first<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token operator">and</span> login_date_first<span class="token operator">&lt;</span><span class="token string">'2020-06-14'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> login_date_first<span class="token punctuation">;</span>
</code></pre>
<h2 id="9-4-商品主题"><a href="#9-4-商品主题" class="headerlink" title="9.4 商品主题"></a>9.4 商品主题</h2><h3 id="9-4-1-商品统计"><a href="#9-4-1-商品统计" class="headerlink" title="9.4.1 商品统计"></a>9.4.1 商品统计</h3><p>该指标为商品综合统计，包含每个spu被下单总次数和被下单总金额。<br>1.建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_order_spu_stats<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_order_spu_stats<span class="token punctuation">`</span> <span class="token punctuation">(</span>
    <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近天数,1:最近1天,7:最近7天,30:最近30天'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>spu_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>tm_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>category3_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'三级品类ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>category3_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'三级品类名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>category2_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'二级品类ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>category2_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'二级品类名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>category1_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'一级品类ID'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>category1_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'一级品类名称'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单金额'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品销售统计'</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED  <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
LOCATION <span class="token string">'/warehouse/gmall/ads/ads_order_spu_stats/'</span><span class="token punctuation">;</span>
</code></pre>
<p>2.数据装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_order_spu_stats
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_order_spu_stats
<span class="token keyword">union</span>
<span class="token keyword">select</span>
    <span class="token string">'2020-06-14'</span> dt<span class="token punctuation">,</span>
    recent_days<span class="token punctuation">,</span>
    spu_id<span class="token punctuation">,</span>
    spu_name<span class="token punctuation">,</span>
    tm_id<span class="token punctuation">,</span>
    tm_name<span class="token punctuation">,</span>
    category3_id<span class="token punctuation">,</span>
    category3_name<span class="token punctuation">,</span>
    category2_id<span class="token punctuation">,</span>
    category2_name<span class="token punctuation">,</span>
    category1_id<span class="token punctuation">,</span>
    category1_name<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_amount<span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        recent_days<span class="token punctuation">,</span>
        sku_id<span class="token punctuation">,</span>
        <span class="token keyword">case</span>
            <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> order_last_1d_count
            <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">7</span> <span class="token keyword">then</span> order_last_7d_count
            <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">30</span> <span class="token keyword">then</span> order_last_30d_count
        <span class="token keyword">end</span> order_count<span class="token punctuation">,</span>
        <span class="token keyword">case</span>
            <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> order_last_1d_final_amount
            <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">7</span> <span class="token keyword">then</span> order_last_7d_final_amount
            <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">30</span> <span class="token keyword">then</span> order_last_30d_final_amount
        <span class="token keyword">end</span> order_amount
    <span class="token keyword">from</span> dwt_sku_topic lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> tmp <span class="token keyword">as</span> recent_days
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>t1
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        spu_id<span class="token punctuation">,</span>
        spu_name<span class="token punctuation">,</span>
        tm_id<span class="token punctuation">,</span>
        tm_name<span class="token punctuation">,</span>
        category3_id<span class="token punctuation">,</span>
        category3_name<span class="token punctuation">,</span>
        category2_id<span class="token punctuation">,</span>
        category2_name<span class="token punctuation">,</span>
        category1_id<span class="token punctuation">,</span>
        category1_name
    <span class="token keyword">from</span> dim_sku_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>t2
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>t2<span class="token punctuation">.</span>id
<span class="token keyword">group</span> <span class="token keyword">by</span> recent_days<span class="token punctuation">,</span>spu_id<span class="token punctuation">,</span>spu_name<span class="token punctuation">,</span>tm_id<span class="token punctuation">,</span>tm_name<span class="token punctuation">,</span>category3_id<span class="token punctuation">,</span>category3_name<span class="token punctuation">,</span>category2_id<span class="token punctuation">,</span>category2_name<span class="token punctuation">,</span>category1_id<span class="token punctuation">,</span>category1_name<span class="token punctuation">;</span>
</code></pre>
<h3 id="9-4-2-品牌复购率"><a href="#9-4-2-品牌复购率" class="headerlink" title="9.4.2 品牌复购率"></a>9.4.2 品牌复购率</h3><p>品牌复购率是指一段时间内重复购买某品牌的人数与购买过该品牌的人数的比值。重复购买即购买次数大于等于2，购买过即购买次数大于1。<br>此处要求统计最近1,7,30天的各品牌复购率。<br>1.建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_repeat_purchase<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_repeat_purchase<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近天数,1:最近1天,7:最近7天,30:最近30天'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌ID'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>tm_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌名称'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_repeat_rate<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'复购率'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'品牌复购率'</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED  <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
LOCATION <span class="token string">'/warehouse/gmall/ads/ads_repeat_purchase/'</span><span class="token punctuation">;</span>
</code></pre>
<p>2.数据装载<br>思路分析：该需求可分两步实现：<br>第一步：统计每个用户购买每个品牌的次数。<br>第二步：分别统计购买次数大于1的人数和大于2的人数。</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_repeat_purchase
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_repeat_purchase
<span class="token keyword">union</span>
<span class="token keyword">select</span>
    <span class="token string">'2020-06-14'</span> dt<span class="token punctuation">,</span>
    recent_days<span class="token punctuation">,</span>
    tm_id<span class="token punctuation">,</span>
    tm_name<span class="token punctuation">,</span>
    cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_count<span class="token operator">>=</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_count<span class="token operator">>=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        recent_days<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        tm_id<span class="token punctuation">,</span>
        tm_name<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            recent_days<span class="token punctuation">,</span>
            user_id<span class="token punctuation">,</span>
            sku_id<span class="token punctuation">,</span>
            <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> order_count
        <span class="token keyword">from</span> dwd_order_detail lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> tmp <span class="token keyword">as</span> recent_days
        <span class="token keyword">where</span> dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span>
        <span class="token operator">and</span> dt<span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span>recent_days<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">group</span> <span class="token keyword">by</span> recent_days<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span>sku_id
    <span class="token punctuation">)</span>t1
    <span class="token keyword">left</span> <span class="token keyword">join</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            id<span class="token punctuation">,</span>
            tm_id<span class="token punctuation">,</span>
            tm_name
        <span class="token keyword">from</span> dim_sku_info
        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
    <span class="token punctuation">)</span>t2
    <span class="token keyword">on</span> t1<span class="token punctuation">.</span>sku_id<span class="token operator">=</span>t2<span class="token punctuation">.</span>id
    <span class="token keyword">group</span> <span class="token keyword">by</span> recent_days<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>tm_id<span class="token punctuation">,</span>tm_name
<span class="token punctuation">)</span>t3
<span class="token keyword">group</span> <span class="token keyword">by</span> recent_days<span class="token punctuation">,</span>tm_id<span class="token punctuation">,</span>tm_name<span class="token punctuation">;</span>
</code></pre>
<h2 id="9-5-订单主题"><a href="#9-5-订单主题" class="headerlink" title="9.5 订单主题"></a>9.5 订单主题</h2><h3 id="9-5-1-订单统计"><a href="#9-5-1-订单统计" class="headerlink" title="9.5.1 订单统计"></a>9.5.1 订单统计</h3><p>该需求包含订单总数，订单总金额和下单总人数。<br>1.建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_order_total<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_order_total<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近天数,1:最近1天,7:最近7天,30:最近30天'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单金额'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单人数'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单统计'</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED  <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
LOCATION <span class="token string">'/warehouse/gmall/ads/ads_order_total/'</span><span class="token punctuation">;</span>
</code></pre>
<p>2.数据装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_order_total
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_order_total
<span class="token keyword">union</span>
<span class="token keyword">select</span>
    <span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>
    recent_days<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>order_final_amount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> order_user_count
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        recent_days<span class="token punctuation">,</span>
        user_id<span class="token punctuation">,</span>
        <span class="token keyword">case</span> <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">then</span> order_count
             <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> order_last_1d_count
             <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">7</span> <span class="token keyword">then</span> order_last_7d_count
             <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">30</span> <span class="token keyword">then</span> order_last_30d_count
        <span class="token keyword">end</span> order_count<span class="token punctuation">,</span>
        <span class="token keyword">case</span> <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">then</span> order_final_amount
             <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> order_last_1d_final_amount
             <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">7</span> <span class="token keyword">then</span> order_last_7d_final_amount
             <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">30</span> <span class="token keyword">then</span> order_last_30d_final_amount
        <span class="token keyword">end</span> order_final_amount
    <span class="token keyword">from</span> dwt_user_topic lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> tmp <span class="token keyword">as</span> recent_days
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>t1
<span class="token keyword">group</span> <span class="token keyword">by</span> recent_days<span class="token punctuation">;</span>
</code></pre>
<h3 id="9-5-2-各地区订单统计"><a href="#9-5-2-各地区订单统计" class="headerlink" title="9.5.2 各地区订单统计"></a>9.5.2 各地区订单统计</h3><p>该需求包含各省份订单总数和订单总金额。<br>1.建表语句 </p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_order_by_province<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_order_by_province<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近天数,1:最近1天,7:最近7天,30:最近30天'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'省份ID'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>province_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'省份名称'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>iso_code<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'国际标准地区编码'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>iso_code_3166_2<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'国际标准地区编码'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单金额'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'各地区订单统计'</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED  <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
LOCATION <span class="token string">'/warehouse/gmall/ads/ads_order_by_province/'</span><span class="token punctuation">;</span>
</code></pre>
<p>2.数据装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_order_by_province
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_order_by_province
<span class="token keyword">union</span>
<span class="token keyword">select</span>
    dt<span class="token punctuation">,</span>
    recent_days<span class="token punctuation">,</span>
    province_id<span class="token punctuation">,</span>
    province_name<span class="token punctuation">,</span>
    area_code<span class="token punctuation">,</span>
    iso_code<span class="token punctuation">,</span>
    iso_3166_2<span class="token punctuation">,</span>
    order_count<span class="token punctuation">,</span>
    order_amount
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        <span class="token string">'2020-06-14'</span> dt<span class="token punctuation">,</span>
        recent_days<span class="token punctuation">,</span>
        province_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_amount<span class="token punctuation">)</span> order_amount
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span>
            recent_days<span class="token punctuation">,</span>
            province_id<span class="token punctuation">,</span>
            <span class="token keyword">case</span>
                <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> order_last_1d_count
                <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">7</span> <span class="token keyword">then</span> order_last_7d_count
                <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">30</span> <span class="token keyword">then</span> order_last_30d_count
            <span class="token keyword">end</span> order_count<span class="token punctuation">,</span>
            <span class="token keyword">case</span>
                <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">then</span> order_last_1d_final_amount
                <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">7</span> <span class="token keyword">then</span> order_last_7d_final_amount
                <span class="token keyword">when</span> recent_days<span class="token operator">=</span><span class="token number">30</span> <span class="token keyword">then</span> order_last_30d_final_amount
            <span class="token keyword">end</span> order_amount
        <span class="token keyword">from</span> dwt_area_topic lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> tmp <span class="token keyword">as</span> recent_days
        <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
    <span class="token punctuation">)</span>t1
    <span class="token keyword">group</span> <span class="token keyword">by</span> recent_days<span class="token punctuation">,</span>province_id
<span class="token punctuation">)</span>t2
<span class="token keyword">join</span> dim_base_province t3
<span class="token keyword">on</span> t2<span class="token punctuation">.</span>province_id<span class="token operator">=</span>t3<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre>
<h2 id="9-6-优惠券主题"><a href="#9-6-优惠券主题" class="headerlink" title="9.6 优惠券主题"></a>9.6 优惠券主题</h2><h3 id="9-6-1-优惠券统计"><a href="#9-6-1-优惠券统计" class="headerlink" title="9.6.1 优惠券统计"></a>9.6.1 优惠券统计</h3><p>该需求要求统计最近30日发布的所有优惠券的领用情况和补贴率，补贴率是指，优惠金额与使用优惠券的订单的原价金额的比值。<br>1.建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_coupon_stats<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ads_coupon_stats <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>coupon_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券ID'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>coupon_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券名称'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>start_date<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'发布日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>rule_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠规则，例如满100元减10元'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>get_count<span class="token punctuation">`</span>  <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'领取次数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用(下单)次数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>expire_count<span class="token punctuation">`</span>  <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'过期次数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用优惠券订单原始金额'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用优惠券订单最终金额'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠金额'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>reduce_rate<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'补贴率'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品销售统计'</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED  <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
LOCATION <span class="token string">'/warehouse/gmall/ads/ads_coupon_stats/'</span><span class="token punctuation">;</span>
</code></pre>
<p>2.数据装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_coupon_stats
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_coupon_stats
<span class="token keyword">union</span>
<span class="token keyword">select</span>
    <span class="token string">'2020-06-14'</span> dt<span class="token punctuation">,</span>
    t1<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    coupon_name<span class="token punctuation">,</span>
    start_date<span class="token punctuation">,</span>
    rule_name<span class="token punctuation">,</span>
    get_count<span class="token punctuation">,</span>
    order_count<span class="token punctuation">,</span>
    expire_count<span class="token punctuation">,</span>
    order_original_amount<span class="token punctuation">,</span>
    order_final_amount<span class="token punctuation">,</span>
    reduce_amount<span class="token punctuation">,</span>
    reduce_rate
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        coupon_name<span class="token punctuation">,</span>
        date_format<span class="token punctuation">(</span>start_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> start_date<span class="token punctuation">,</span>
        <span class="token keyword">case</span>
            <span class="token keyword">when</span> coupon_type<span class="token operator">=</span><span class="token string">'3201'</span> <span class="token keyword">then</span> concat<span class="token punctuation">(</span><span class="token string">'满'</span><span class="token punctuation">,</span>condition_amount<span class="token punctuation">,</span><span class="token string">'元减'</span><span class="token punctuation">,</span>benefit_amount<span class="token punctuation">,</span><span class="token string">'元'</span><span class="token punctuation">)</span>
            <span class="token keyword">when</span> coupon_type<span class="token operator">=</span><span class="token string">'3202'</span> <span class="token keyword">then</span> concat<span class="token punctuation">(</span><span class="token string">'满'</span><span class="token punctuation">,</span>condition_num<span class="token punctuation">,</span><span class="token string">'件打'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>benefit_discount<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">'折'</span><span class="token punctuation">)</span>
            <span class="token keyword">when</span> coupon_type<span class="token operator">=</span><span class="token string">'3203'</span> <span class="token keyword">then</span> concat<span class="token punctuation">(</span><span class="token string">'减'</span><span class="token punctuation">,</span>benefit_amount<span class="token punctuation">,</span><span class="token string">'元'</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span> rule_name
    <span class="token keyword">from</span> dim_coupon_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
    <span class="token operator">and</span> date_format<span class="token punctuation">(</span>start_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>t1
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        coupon_id<span class="token punctuation">,</span>
        get_count<span class="token punctuation">,</span>
        order_count<span class="token punctuation">,</span>
        expire_count<span class="token punctuation">,</span>
        order_original_amount<span class="token punctuation">,</span>
        order_final_amount<span class="token punctuation">,</span>
        order_reduce_amount reduce_amount<span class="token punctuation">,</span>
        cast<span class="token punctuation">(</span>order_reduce_amount<span class="token operator">/</span>order_original_amount <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> reduce_rate
    <span class="token keyword">from</span> dwt_coupon_topic
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
<span class="token punctuation">)</span>t2
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>id<span class="token operator">=</span>t2<span class="token punctuation">.</span>coupon_id<span class="token punctuation">;</span>
</code></pre>
<h2 id="9-7-活动主题"><a href="#9-7-活动主题" class="headerlink" title="9.7 活动主题"></a>9.7 活动主题</h2><h3 id="9-7-1-活动统计"><a href="#9-7-1-活动统计" class="headerlink" title="9.7.1 活动统计"></a>9.7.1 活动统计</h3><p>该需求要求统计最近30日发布的所有活动的参与情况和补贴率，补贴率是指，优惠金额与参与活动的订单原价金额的比值。<br>1.建表语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_activity_stats<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_activity_stats<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动ID'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>activity_name<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动名称'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>start_date<span class="token punctuation">`</span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动开始日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与活动订单数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与活动订单原始金额'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与活动订单最终金额'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠金额'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>reduce_rate<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'补贴率'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品销售统计'</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED  <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED BY</span> <span class="token string">'\t'</span>
LOCATION <span class="token string">'/warehouse/gmall/ads/ads_activity_stats/'</span><span class="token punctuation">;</span>
</code></pre>
<p>2.数据装载</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> ads_activity_stats
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ads_activity_stats
<span class="token keyword">union</span>
<span class="token keyword">select</span>
    <span class="token string">'2020-06-14'</span> dt<span class="token punctuation">,</span>
    t4<span class="token punctuation">.</span>activity_id<span class="token punctuation">,</span>
    activity_name<span class="token punctuation">,</span>
    start_date<span class="token punctuation">,</span>
    order_count<span class="token punctuation">,</span>
    order_original_amount<span class="token punctuation">,</span>
    order_final_amount<span class="token punctuation">,</span>
    reduce_amount<span class="token punctuation">,</span>
    reduce_rate
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        activity_id<span class="token punctuation">,</span>
        activity_name<span class="token punctuation">,</span>
        date_format<span class="token punctuation">(</span>start_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span> start_date
    <span class="token keyword">from</span> dim_activity_rule_info
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
    <span class="token operator">and</span> date_format<span class="token punctuation">(</span>start_time<span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token operator">>=</span>date_add<span class="token punctuation">(</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> activity_id<span class="token punctuation">,</span>activity_name<span class="token punctuation">,</span>start_time
<span class="token punctuation">)</span>t4
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        activity_id<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_count<span class="token punctuation">)</span> order_count<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span> order_original_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_final_amount<span class="token punctuation">)</span> order_final_amount<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span> reduce_amount<span class="token punctuation">,</span>
        cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>order_reduce_amount<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span>order_original_amount<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> reduce_rate
    <span class="token keyword">from</span> dwt_activity_topic
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2020-06-14'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> activity_id
<span class="token punctuation">)</span>t5
<span class="token keyword">on</span> t4<span class="token punctuation">.</span>activity_id<span class="token operator">=</span>t5<span class="token punctuation">.</span>activity_id<span class="token punctuation">;</span>
</code></pre>
<h2 id="9-8-ADS层业务数据导入脚本"><a href="#9-8-ADS层业务数据导入脚本" class="headerlink" title="9.8 ADS层业务数据导入脚本"></a>9.8 ADS层业务数据导入脚本</h2><p>1）编写脚本<br>（1）在/home/atguigu/bin目录下创建脚本dwt_to_ads.sh</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim dwt_to_ads.sh
</code></pre>
<p>在脚本中填写如下内容</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash

APP=gmall

# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天

if [ -n "$2" ] ;then
    do_date=$2
else 
    do_date=`date -d "-1 day" +%F`
fi

ads_activity_stats="
insert overwrite table ${APP}.ads_activity_stats
select * from ${APP}.ads_activity_stats
union
select
    '$do_date' dt,
    t4.activity_id,
    activity_name,
    start_date,
    order_count,
    order_original_amount,
    order_final_amount,
    reduce_amount,
    reduce_rate
from
(
    select
        activity_id,
        activity_name,
        date_format(start_time,'yyyy-MM-dd') start_date
    from ${APP}.dim_activity_rule_info
    where dt='$do_date'
    and date_format(start_time,'yyyy-MM-dd')>=date_add('$do_date',-29)
    group by activity_id,activity_name,start_time
)t4
left join
(
    select
        activity_id,
        sum(order_count) order_count,
        sum(order_original_amount) order_original_amount,
        sum(order_final_amount) order_final_amount,
        sum(order_reduce_amount) reduce_amount,
        cast(sum(order_reduce_amount)/sum(order_original_amount)*100 as decimal(16,2)) reduce_rate
    from ${APP}.dwt_activity_topic
    where dt='$do_date'
    group by activity_id
)t5
on t4.activity_id=t5.activity_id;
"
ads_coupon_stats="
insert overwrite table ${APP}.ads_coupon_stats
select * from ${APP}.ads_coupon_stats
union
select
    '$do_date' dt,
    t1.id,
    coupon_name,
    start_date,
    rule_name,
    get_count,
    order_count,
    expire_count,
    order_original_amount,
    order_final_amount,
    reduce_amount,
    reduce_rate
from
(
    select
        id,
        coupon_name,
        date_format(start_time,'yyyy-MM-dd') start_date,
        case
            when coupon_type='3201' then concat('满',condition_amount,'元减',benefit_amount,'元')
            when coupon_type='3202' then concat('满',condition_num,'件打', (1-benefit_discount)*10,'折')
            when coupon_type='3203' then concat('减',benefit_amount,'元')
        end rule_name
    from ${APP}.dim_coupon_info
    where dt='$do_date'
    and date_format(start_time,'yyyy-MM-dd')>=date_add('$do_date',-29)
)t1
left join
(
    select
        coupon_id,
        get_count,
        order_count,
        expire_count,
        order_original_amount,
        order_final_amount,
        order_reduce_amount reduce_amount,
        cast(order_reduce_amount/order_original_amount as decimal(16,2)) reduce_rate
    from ${APP}.dwt_coupon_topic
    where dt='$do_date'
)t2
on t1.id=t2.coupon_id;
"

ads_order_by_province="
insert overwrite table ${APP}.ads_order_by_province
select * from ${APP}.ads_order_by_province
union
select
    dt,
    recent_days,
    province_id,
    province_name,
    area_code,
    iso_code,
    iso_3166_2,
    order_count,
    order_amount
from
(
    select
        '$do_date' dt,
        recent_days,
        province_id,
        sum(order_count) order_count,
        sum(order_amount) order_amount
    from
    (
        select
            recent_days,
            province_id,
            case
                when recent_days=1 then order_last_1d_count
                when recent_days=7 then order_last_7d_count
                when recent_days=30 then order_last_30d_count
            end order_count,
            case
                when recent_days=1 then order_last_1d_final_amount
                when recent_days=7 then order_last_7d_final_amount
                when recent_days=30 then order_last_30d_final_amount
            end order_amount
        from ${APP}.dwt_area_topic lateral view explode(Array(1,7,30)) tmp as recent_days
        where dt='$do_date'
    )t1
    group by recent_days,province_id
)t2
join ${APP}.dim_base_province t3
on t2.province_id=t3.id;
"

ads_order_spu_stats="
insert overwrite table ${APP}.ads_order_spu_stats
select * from ${APP}.ads_order_spu_stats
union
select
    '$do_date' dt,
    recent_days,
    spu_id,
    spu_name,
    tm_id,
    tm_name,
    category3_id,
    category3_name,
    category2_id,
    category2_name,
    category1_id,
    category1_name,
    sum(order_count),
    sum(order_amount)
from
(
    select
        recent_days,
        sku_id,
        case
            when recent_days=1 then order_last_1d_count
            when recent_days=7 then order_last_7d_count
            when recent_days=30 then order_last_30d_count
        end order_count,
        case
            when recent_days=1 then order_last_1d_final_amount
            when recent_days=7 then order_last_7d_final_amount
            when recent_days=30 then order_last_30d_final_amount
        end order_amount
    from ${APP}.dwt_sku_topic lateral view explode(Array(1,7,30)) tmp as recent_days
    where dt='$do_date'
)t1
left join
(
    select
        id,
        spu_id,
        spu_name,
        tm_id,
        tm_name,
        category3_id,
        category3_name,
        category2_id,
        category2_name,
        category1_id,
        category1_name
    from ${APP}.dim_sku_info
    where dt='$do_date'
)t2
on t1.sku_id=t2.id
group by recent_days,spu_id,spu_name,tm_id,tm_name,category3_id,category3_name,category2_id,category2_name,category1_id,category1_name;
"

ads_order_total="
insert overwrite table ${APP}.ads_order_total
select * from ${APP}.ads_order_total
union
select
    '$do_date',
    recent_days,
    sum(order_count),
    sum(order_final_amount) order_final_amount,
    sum(if(order_final_amount>0,1,0)) order_user_count
from
(
    select
        recent_days,
        user_id,
        case when recent_days=0 then order_count
             when recent_days=1 then order_last_1d_count
             when recent_days=7 then order_last_7d_count
             when recent_days=30 then order_last_30d_count
        end order_count,
        case when recent_days=0 then order_final_amount
             when recent_days=1 then order_last_1d_final_amount
             when recent_days=7 then order_last_7d_final_amount
             when recent_days=30 then order_last_30d_final_amount
        end order_final_amount
    from ${APP}.dwt_user_topic lateral view explode(Array(1,7,30)) tmp as recent_days
    where dt='$do_date'
)t1
group by recent_days;
"

ads_page_path="
insert overwrite table ${APP}.ads_page_path
select * from ${APP}.ads_page_path
union
select
    '$do_date',
    recent_days,
    source,
    target,
    count(*)
from
(
    select
        recent_days,
        concat('step-',step,':',source) source,
        concat('step-',step+1,':',target) target
    from
    (
        select
            recent_days,
            page_id source,
            lead(page_id,1,null) over (partition by recent_days,session_id order by ts) target,
            row_number() over (partition by recent_days,session_id order by ts) step
        from
        (
            select
                recent_days,
                last_page_id,
                page_id,
                ts,
                concat(mid_id,'-',last_value(if(last_page_id is null,ts,null),true) over (partition by mid_id,recent_days order by ts)) session_id
            from ${APP}.dwd_page_log lateral view explode(Array(1,7,30)) tmp as recent_days
            where dt>=date_add('$do_date',-30)
            and dt>=date_add('$do_date',-recent_days+1)
        )t2
    )t3
)t4
group by recent_days,source,target;
"

ads_repeat_purchase="
insert overwrite table ${APP}.ads_repeat_purchase
select * from ${APP}.ads_repeat_purchase
union
select
    '$do_date' dt,
    recent_days,
    tm_id,
    tm_name,
    cast(sum(if(order_count>=2,1,0))/sum(if(order_count>=1,1,0))*100 as decimal(16,2))
from
(
    select
        recent_days,
        user_id,
        tm_id,
        tm_name,
        sum(order_count) order_count
    from
    (
        select
            recent_days,
            user_id,
            sku_id,
            count(*) order_count
        from ${APP}.dwd_order_detail lateral view explode(Array(1,7,30)) tmp as recent_days
        where dt>=date_add('$do_date',-29)
        and dt>=date_add('$do_date',-recent_days+1)
        group by recent_days, user_id,sku_id
    )t1
    left join
    (
        select
            id,
            tm_id,
            tm_name
        from ${APP}.dim_sku_info
        where dt='$do_date'
    )t2
    on t1.sku_id=t2.id
    group by recent_days,user_id,tm_id,tm_name
)t3
group by recent_days,tm_id,tm_name;
"

ads_user_action="
with
tmp_page as
(
    select
        '$do_date' dt,
        recent_days,
        sum(if(array_contains(pages,'home'),1,0)) home_count,
        sum(if(array_contains(pages,'good_detail'),1,0)) good_detail_count
    from
    (
        select
            recent_days,
            mid_id,
            collect_set(page_id) pages
        from
        (
            select
                dt,
                mid_id,
                page.page_id
            from ${APP}.dws_visitor_action_daycount lateral view explode(page_stats) tmp as page
            where dt>=date_add('$do_date',-29)
            and page.page_id in('home','good_detail')
        )t1 lateral view explode(Array(1,7,30)) tmp as recent_days
        where dt>=date_add('$do_date',-recent_days+1)
        group by recent_days,mid_id
    )t2
    group by recent_days
),
tmp_cop as
(
    select
        '$do_date' dt,
        recent_days,
        sum(if(cart_count>0,1,0)) cart_count,
        sum(if(order_count>0,1,0)) order_count,
        sum(if(payment_count>0,1,0)) payment_count
    from
    (
        select
            recent_days,
            user_id,
            case
                when recent_days=1 then cart_last_1d_count
                when recent_days=7 then cart_last_7d_count
                when recent_days=30 then cart_last_30d_count
            end cart_count,
            case
                when recent_days=1 then order_last_1d_count
                when recent_days=7 then order_last_7d_count
                when recent_days=30 then order_last_30d_count
            end order_count,
            case
                when recent_days=1 then payment_last_1d_count
                when recent_days=7 then payment_last_7d_count
                when recent_days=30 then payment_last_30d_count
            end payment_count
        from ${APP}.dwt_user_topic lateral view explode(Array(1,7,30)) tmp as recent_days
        where dt='$do_date'
    )t1
    group by recent_days
)
insert overwrite table ${APP}.ads_user_action
select * from ${APP}.ads_user_action
union
select
    tmp_page.dt,
    tmp_page.recent_days,
    home_count,
    good_detail_count,
    cart_count,
    order_count,
    payment_count
from tmp_page
join tmp_cop
on tmp_page.recent_days=tmp_cop.recent_days;
"

ads_user_change="
insert overwrite table ${APP}.ads_user_change
select * from ${APP}.ads_user_change
union
select
    churn.dt,
    user_churn_count,
    user_back_count
from
(
    select
        '$do_date' dt,
        count(*) user_churn_count
    from ${APP}.dwt_user_topic
    where dt='$do_date'
    and login_date_last=date_add('$do_date',-7)
)churn
join
(
    select
        '$do_date' dt,
        count(*) user_back_count
    from
    (
        select
            user_id,
            login_date_last
        from ${APP}.dwt_user_topic
        where dt='$do_date'
        and login_date_last='$do_date'
    )t1
    join
    (
        select
            user_id,
            login_date_last login_date_previous
        from ${APP}.dwt_user_topic
        where dt=date_add('$do_date',-1)
    )t2
    on t1.user_id=t2.user_id
    where datediff(login_date_last,login_date_previous)>=8
)back
on churn.dt=back.dt;
"

ads_user_retention="
insert overwrite table ${APP}.ads_user_retention
select * from ${APP}.ads_user_retention
union
select
    '$do_date',
    login_date_first create_date,
    datediff('$do_date',login_date_first) retention_day,
    sum(if(login_date_last='$do_date',1,0)) retention_count,
    count(*) new_user_count,
    cast(sum(if(login_date_last='$do_date',1,0))/count(*)*100 as decimal(16,2)) retention_rate
from ${APP}.dwt_user_topic
where dt='$do_date'
and login_date_first>=date_add('$do_date',-7)
and login_date_first<'$do_date'
group by login_date_first;
"

ads_user_total="
insert overwrite table ${APP}.ads_user_total
select * from ${APP}.ads_user_total
union
select
    '$do_date',
    recent_days,
    sum(if(login_date_first>=recent_days_ago,1,0)) new_user_count,
    sum(if(order_date_first>=recent_days_ago,1,0)) new_order_user_count,
    sum(order_final_amount) order_final_amount,
    sum(if(order_final_amount>0,1,0)) order_user_count,
    sum(if(login_date_last>=recent_days_ago and order_final_amount=0,1,0)) no_order_user_count
from
(
    select
        recent_days,
        user_id,
        login_date_first,
        login_date_last,
        order_date_first,
        case when recent_days=0 then order_final_amount
             when recent_days=1 then order_last_1d_final_amount
             when recent_days=7 then order_last_7d_final_amount
             when recent_days=30 then order_last_30d_final_amount
        end order_final_amount,
        if(recent_days=0,'1970-01-01',date_add('$do_date',-recent_days+1)) recent_days_ago
    from ${APP}.dwt_user_topic lateral view explode(Array(0,1,7,30)) tmp as recent_days
    where dt='$do_date'
)t1
group by recent_days;
"

ads_visit_stats="
insert overwrite table ${APP}.ads_visit_stats
select * from ${APP}.ads_visit_stats
union
select
    '$do_date' dt,
    is_new,
    recent_days,
    channel,
    count(distinct(mid_id)) uv_count,
    cast(sum(duration)/1000 as bigint) duration_sec,
    cast(avg(duration)/1000 as bigint) avg_duration_sec,
    sum(page_count) page_count,
    cast(avg(page_count) as bigint) avg_page_count,
    count(*) sv_count,
    sum(if(page_count=1,1,0)) bounce_count,
    cast(sum(if(page_count=1,1,0))/count(*)*100 as decimal(16,2)) bounce_rate
from
(
    select
        session_id,
        mid_id,
        is_new,
        recent_days,
        channel,
        count(*) page_count,
        sum(during_time) duration
    from
    (
        select
            mid_id,
            channel,
            recent_days,
            is_new,
            last_page_id,
            page_id,
            during_time,
            concat(mid_id,'-',last_value(if(last_page_id is null,ts,null),true) over (partition by recent_days,mid_id order by ts)) session_id
        from
        (
            select
                mid_id,
                channel,
                last_page_id,
                page_id,
                during_time,
                ts,
                recent_days,
                if(visit_date_first>=date_add('$do_date',-recent_days+1),'1','0') is_new
            from
            (
                select
                    t1.mid_id,
                    t1.channel,
                    t1.last_page_id,
                    t1.page_id,
                    t1.during_time,
                    t1.dt,
                    t1.ts,
                    t2.visit_date_first
                from
                (
                    select
                        mid_id,
                        channel,
                        last_page_id,
                        page_id,
                        during_time,
                        dt,
                        ts
                    from ${APP}.dwd_page_log
                    where dt>=date_add('$do_date',-30)
                )t1
                left join
                (
                    select
                        mid_id,
                        visit_date_first
                    from ${APP}.dwt_visitor_topic
                    where dt='$do_date'
                )t2
                on t1.mid_id=t2.mid_id
            )t3 lateral view explode(Array(1,7,30)) tmp as recent_days
            where dt>=date_add('$do_date',-recent_days+1)
        )t4
    )t5
    group by session_id,mid_id,is_new,recent_days,channel
)t6
group by is_new,recent_days,channel;
"

case $1 in
    "ads_activity_stats" )
        hive -e "$ads_activity_stats" 
    ;;
    "ads_coupon_stats" )
        hive -e "$ads_coupon_stats"
    ;;
    "ads_order_by_province" )
        hive -e "$ads_order_by_province" 
    ;;
    "ads_order_spu_stats" )
        hive -e "$ads_order_spu_stats" 
    ;;
    "ads_order_total" )
        hive -e "$ads_order_total" 
    ;;
    "ads_page_path" )
        hive -e "$ads_page_path" 
    ;;
    "ads_repeat_purchase" )
        hive -e "$ads_repeat_purchase" 
    ;;
    "ads_user_action" )
        hive -e "$ads_user_action" 
    ;;
    "ads_user_change" )
        hive -e "$ads_user_change" 
    ;;
    "ads_user_retention" )
        hive -e "$ads_user_retention" 
    ;;
    "ads_user_total" )
        hive -e "$ads_user_total" 
    ;;
    "ads_visit_stats" )
        hive -e "$ads_visit_stats" 
    ;;
    "all" )
        hive -e "$ads_activity_stats$ads_coupon_stats$ads_order_by_province$ads_order_spu_stats$ads_order_total$ads_page_path$ads_repeat_purchase$ads_user_action$ads_user_change$ads_user_retention$ads_user_total$ads_visit_stats"
    ;;
esac
</code></pre>
<p>（2）增加脚本执行权限</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 dwt_to_ads.sh
</code></pre>
<p>2）脚本使用<br>（1）执行脚本</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ dwt_to_ads.sh all 2020-06-14   
</code></pre>
<p>（2）查看数据是否导入</p>
<h1 id="第10章-全流程调度"><a href="#第10章-全流程调度" class="headerlink" title="第10章 全流程调度"></a>第10章 全流程调度</h1><h2 id="10-1-Azkaban部署"><a href="#10-1-Azkaban部署" class="headerlink" title="10.1 Azkaban部署"></a>10.1 Azkaban部署</h2><p>详见：大数据技术之Azkaban</p>
<p><a href="https://bigworldxld.github.io/2022/02/08/undefined.html">大数据技术之Azkaban</a></p>
<h2 id="10-2-创建MySQL数据库和表"><a href="#10-2-创建MySQL数据库和表" class="headerlink" title="10.2 创建MySQL数据库和表"></a>10.2 创建MySQL数据库和表</h2><p>1）创建gmall_report数据库</p>
<img src="/2022/02/07/10237/gmall_report%E6%95%B0%E6%8D%AE%E5%BA%93.png" class title="This is an example image">

<p>注:SQL语句</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token punctuation">`</span>gmall_report<span class="token punctuation">`</span> <span class="token keyword">CHARACTER SET</span> <span class="token string">'utf8'</span> <span class="token keyword">COLLATE</span> <span class="token string">'utf8_general_ci'</span><span class="token punctuation">;</span>
</code></pre>
<p>2）创建表<br>（1）访客统计</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_visit_stats<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_visit_stats<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> <span class="token keyword">DATE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>is_new<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'新老标识,1:新,0:老'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span> <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近天数,1:最近1天,7:最近7天,30:最近30天'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>channel<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'渠道'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>uv_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'日活(访问人数)'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>duration_sec<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'页面停留总时长'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>avg_duration_sec<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>  <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'一次会话，页面停留平均时长'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>page_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'页面总浏览数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>avg_page_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'一次会话，页面平均浏览数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>sv_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'会话次数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>bounce_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'跳出数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>bounce_rate<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'跳出率'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>is_new<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>channel<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre>
<p>（2）页面路径分析</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_page_path<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_page_path<span class="token punctuation">`</span> <span class="token punctuation">(</span>      
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> <span class="token keyword">DATE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近天数,1:最近1天,7:最近7天,30:最近30天'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>source<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'跳转起始页面'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>target<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'跳转终到页面'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>path_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'跳转次数'</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>source<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>target<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>     
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 ROW_FORMAT<span class="token operator">=</span>DYNAMIC<span class="token punctuation">;</span>
</code></pre>
<p>（3）用户统计</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_user_total<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_user_total<span class="token punctuation">`</span> <span class="token punctuation">(</span>          
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> <span class="token keyword">DATE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近天数,0:累积值,1:最近1天,7:最近7天,30:最近30天'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>new_user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'新注册用户数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>new_order_user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'新增下单用户数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单总金额'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单用户数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>no_order_user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'未下单用户数(具体指活跃用户中未下单用户)'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span><span class="token punctuation">)</span>           
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre>
<p>（4）用户变动统计</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_user_change<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_user_change<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> <span class="token keyword">DATE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>user_churn_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span> <span class="token string">'流失用户数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>user_back_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span>  <span class="token keyword">COMMENT</span> <span class="token string">'回流用户数'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre>
<p>（5）用户行为漏斗分析</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_user_action<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_user_action<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> <span class="token keyword">DATE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近天数,1:最近1天,7:最近7天,30:最近30天'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>home_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'浏览首页人数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>good_detail_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'浏览商品详情页人数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>cart_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'加入购物车人数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单人数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>payment_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付人数'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 ROW_FORMAT<span class="token operator">=</span>DYNAMIC<span class="token punctuation">;</span>
</code></pre>
<p>（6）用户留存率分析</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_user_retention<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_user_retention<span class="token punctuation">`</span> <span class="token punctuation">(</span>      
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> <span class="token keyword">DATE</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>create_date<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户新增日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>retention_day<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'截至当前日期留存天数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>retention_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'留存用户数量'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>new_user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'新增用户数量'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>retention_rate<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'留存率'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>create_date<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>retention_day<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>        
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 ROW_FORMAT<span class="token operator">=</span>DYNAMIC<span class="token punctuation">;</span>
</code></pre>
<p>（7）订单统计</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_order_total<span class="token punctuation">;</span>
 <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_order_total<span class="token punctuation">`</span> <span class="token punctuation">(</span>   
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> <span class="token keyword">DATE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span> 
  <span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近天数,1:最近1天,7:最近7天,30:最近30天'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单数'</span><span class="token punctuation">,</span> 
  <span class="token punctuation">`</span>order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单金额'</span><span class="token punctuation">,</span> 
  <span class="token punctuation">`</span>order_user_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单人数'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span><span class="token punctuation">)</span>  
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 ROW_FORMAT<span class="token operator">=</span>DYNAMIC<span class="token punctuation">;</span>
</code></pre>
<p>（8）各省份订单统计</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_order_by_province<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_order_by_province<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> <span class="token keyword">DATE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近天数,1:最近1天,7:最近7天,30:最近30天'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>province_id<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>province_name<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'省份名称'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>area_code<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>iso_code<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'国际标准地区编码'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>iso_code_3166_2<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'国际标准地区编码'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单金额'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span> <span class="token punctuation">,</span><span class="token punctuation">`</span>province_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>       
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 ROW_FORMAT<span class="token operator">=</span>DYNAMIC<span class="token punctuation">;</span>
</code></pre>
<p>（9）品牌复购率</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_repeat_purchase<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_repeat_purchase<span class="token punctuation">`</span> <span class="token punctuation">(</span>         
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> <span class="token keyword">DATE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近天数,1:最近1天,7:最近7天,30:最近30天'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'品牌ID'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>tm_name<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'品牌名称'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_repeat_rate<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'复购率'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span> <span class="token punctuation">,</span><span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span><span class="token punctuation">)</span>          
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 ROW_FORMAT<span class="token operator">=</span>DYNAMIC<span class="token punctuation">;</span>
</code></pre>
<p>（10）商品统计</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_order_spu_stats<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_order_spu_stats<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> <span class="token keyword">DATE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近天数,1:最近1天,7:最近7天,30:最近30天'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品ID'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>spu_name<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品名称'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'品牌ID'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>tm_name<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'品牌名称'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>category3_id<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'三级品类ID'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>category3_name<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'三级品类名称'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>category2_id<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'二级品类ID'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>category2_name<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'二级品类名称'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>category1_id<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'一级品类ID'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>category1_name<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'一级品类名称'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单金额'</span><span class="token punctuation">,</span> 
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span><span class="token punctuation">)</span>  
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre>
<p>（11）活动统计</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_activity_stats<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_activity_stats<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> <span class="token keyword">DATE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动ID'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>activity_name<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动名称'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>start_date<span class="token punctuation">`</span> <span class="token keyword">DATE</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'开始日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与活动订单数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与活动订单原始金额'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'参与活动订单最终金额'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠金额'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>reduce_rate<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'补贴率'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span> <span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 ROW_FORMAT<span class="token operator">=</span>DYNAMIC<span class="token punctuation">;</span>
</code></pre>
<p>（12）优惠券统计</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_coupon_stats<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ads_coupon_stats<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>dt<span class="token punctuation">`</span> <span class="token keyword">DATE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>coupon_id<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券ID'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>coupon_name<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券名称'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>start_date<span class="token punctuation">`</span> <span class="token keyword">DATE</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'开始日期'</span><span class="token punctuation">,</span>  
  <span class="token punctuation">`</span>rule_name<span class="token punctuation">`</span>  <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠规则'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>get_count<span class="token punctuation">`</span>  <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'领取次数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用(下单)次数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>expire_count<span class="token punctuation">`</span>  <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'过期次数'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_original_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用优惠券订单原始金额'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>order_final_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用优惠券订单最终金额'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>reduce_amount<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠金额'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>reduce_rate<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'补贴率'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>dt<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>coupon_id<span class="token punctuation">`</span> <span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 ROW_FORMAT<span class="token operator">=</span>DYNAMIC<span class="token punctuation">;</span>
</code></pre>
<h2 id="10-3-Sqoop导出脚本"><a href="#10-3-Sqoop导出脚本" class="headerlink" title="10.3 Sqoop导出脚本"></a>10.3 Sqoop导出脚本</h2><p>1）编写Sqoop导出脚本<br>在/home/atguigu/bin目录下创建脚本hdfs_to_mysql.sh</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ vim hdfs_to_mysql.sh
</code></pre>
<p>​    在脚本中填写如下内容</p>
<pre class=" language-sh"><code class="language-sh">#!/bin/bash

hive_db_name=gmall
mysql_db_name=gmall_report

export_data() {
/opt/module/sqoop/bin/sqoop export \
--connect "jdbc:mysql://hadoop102:3306/${mysql_db_name}?useUnicode=true&characterEncoding=utf-8"  \
--username root \
--password 000000 \
--table $1 \
--num-mappers 1 \
--export-dir /warehouse/$hive_db_name/ads/$1 \
--input-fields-terminated-by "\t" \
--update-mode allowinsert \
--update-key $2 \
--input-null-string '\\N'    \
--input-null-non-string '\\N'
}

case $1 in
  "ads_activity_stats" )
    export_data "ads_activity_stats" "dt,activity_id"
  ;;

  "ads_coupon_stats" )
    export_data "ads_coupon_stats" "dt,coupon_id"
  ;;

  "ads_order_by_province" )
    export_data "ads_order_by_province" "dt,recent_days,province_id"
  ;;

  "ads_order_spu_stats" )
    export_data "ads_order_spu_stats" "dt,recent_days,spu_id"
  ;;

  "ads_order_total" )
    export_data "ads_order_total" "dt,recent_days"
  ;;

  "ads_page_path" )
    export_data "ads_page_path" "dt,recent_days,source,target"
  ;;

  "ads_repeat_purchase" )
    export_data "ads_repeat_purchase" "dt,recent_days,tm_id"
  ;;

  "ads_user_action" )
    export_data "ads_user_action" "dt,recent_days"
  ;;

  "ads_user_change" )
    export_data "ads_user_change" "dt"
  ;;

  "ads_user_retention" )
    export_data "ads_user_retention" "create_date,retention_day"
  ;;

  "ads_user_total" )
    export_data "ads_user_total" "dt,recent_days"
  ;;

  "ads_visit_stats" )
    export_data "ads_visit_stats" "dt,recent_days,is_new,channel"
  ;;
  "all" )
    export_data "ads_activity_stats" "dt,activity_id"
    export_data "ads_coupon_stats" "dt,coupon_id"
    export_data "ads_order_by_province" "dt,recent_days,province_id"
    export_data "ads_order_spu_stats" "dt,recent_days,spu_id"
    export_data "ads_order_total" "dt,recent_days"
    export_data "ads_page_path" "dt,recent_days,source,target"
    export_data "ads_repeat_purchase" "dt,recent_days,tm_id"
    export_data "ads_user_action" "dt,recent_days"
    export_data "ads_user_change" "dt"
    export_data "ads_user_retention" "create_date,retention_day"
    export_data "ads_user_total" "dt,recent_days"
    export_data "ads_visit_stats" "dt,recent_days,is_new,channel"
  ;;
esac
</code></pre>
<p> 关于导出update还是insert的问题<br>–update-mode：<br>updateonly   只更新，无法插入新数据<br>        allowinsert   允许新增<br>–update-key：允许更新的情况下，指定哪些字段匹配视为同一条数据，进行更新而不增加。多个字段用逗号分隔。<br>–input-null-string和–input-null-non-string：<br>分别表示，将字符串列和非字符串列的空串和“null”转义。<br>官网地址：<a target="_blank" rel="noopener" href="http://sqoop.apache.org/docs/1.4.6/SqoopUserGuide.html">http://sqoop.apache.org/docs/1.4.6/SqoopUserGuide.html</a><br>Sqoop will by default import NULL values as string null. Hive is however using string \N to denote NULL values and therefore predicates dealing with NULL(like IS NULL) will not work correctly. You should append parameters –null-string and –null-non-string in case of import job or –input-null-string and –input-null-non-string in case of an export job if you wish to properly preserve NULL values. Because sqoop is using those parameters in generated code, you need to properly escape value \N to \N:<br>Hive中的Null在底层是以“\N”来存储，而MySQL中的Null在底层就是Null，为了保证数据两端的一致性。在导出数据时采用–input-null-string和–input-null-non-string两个参数。导入数据时采用–null-string和–null-non-string。<br>2）执行Sqoop导出脚本</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ chmod 777 hdfs_to_mysql.sh
[atguigu@hadoop102 bin]$ hdfs_to_mysql.sh all
</code></pre>
<h2 id="10-4-全调度流程"><a href="#10-4-全调度流程" class="headerlink" title="10.4 全调度流程"></a>10.4 全调度流程</h2><h3 id="10-4-1-数据准备"><a href="#10-4-1-数据准备" class="headerlink" title="10.4.1 数据准备"></a>10.4.1 数据准备</h3><p>1）用户行为数据准备<br>（1）修改/opt/module/applog下的application.properties<br>#业务日期<br>mock.date=2020-06-15<br>注意：分发至其他需要生成数据的节点</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 applog]$ xsync application.properties
</code></pre>
<p>（2）生成数据</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 bin]$ lg.sh
</code></pre>
<p>注意：生成数据之后，记得查看HDFS数据是否存在！<br>（3）观察HDFS的/origin_data/gmall/log/topic_log/2020-06-15路径是否有数据<br>2）业务数据准备<br>（1）修改/opt/module/db_log下的application.properties</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 db_log]$ vim application.properties
</code></pre>
<p>#业务日期<br>mock.date=2020-06-15<br>（2）生成数据</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 db_log]$ java -jar gmall2020-mock-db-2020-04-01.jar
</code></pre>
<p>（3）观察SQLyog中order_infor表中operate_time中有2020-06-15日期的数据</p>
<img src="/2022/02/07/10237/order_infor%E8%A1%A8%E4%B8%ADoperate_time.png" class title="This is an example image">

<h3 id="10-4-2-编写Azkaban工作流程配置文件"><a href="#10-4-2-编写Azkaban工作流程配置文件" class="headerlink" title="10.4.2 编写Azkaban工作流程配置文件"></a>10.4.2 编写Azkaban工作流程配置文件</h3><p>1）编写azkaban.project文件，内容如下</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">azkaban-flow-version</span><span class="token punctuation">:</span> <span class="token attr-value">2.0</span>
</code></pre>
<p>2）编写gmall.flow文件，内容如下</p>
<pre class=" language-shell"><code class="language-shell">nodes:
  - name: check_ods
    type: command
    config:
     command: python check_ods.py ${dt}

  - name: check_dwd
    type: command
    config:
     command: python check_dwd.py ${dt}

  - name: check_dim
    type: command
    config:
     command: python check_dim.py ${dt}

  - name: check_notification
    type: command
    dependsOn:
         - check_ods
         - check_dwd
         - check_dim
    config:
     command: python check_notification.py ${alert} ${dt}
</code></pre>
<p>  3）将azkaban.project、gmall.flow文件压缩到一个zip文件，文件名称必须是英文。</p>
<p>4）在WebServer新建项目：<a target="_blank" rel="noopener" href="http://hadoop102:8081/index">http://hadoop102:8081/index</a></p>
<img src="/2022/02/07/10237/WebServer%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE.png" class title="This is an example image">

<p>5）给项目名称命名和添加项目描述</p>
<img src="/2022/02/07/10237/%E6%B7%BB%E5%8A%A0%E9%A1%B9%E7%9B%AE%E6%8F%8F%E8%BF%B0.png" class title="This is an example image">

<p>6）gmall.zip文件上传</p>
<img src="/2022/02/07/10237/gmall.zip%E6%96%87%E4%BB%B6.png" class title="This is an example image">

<p>7）选择上传的文件</p>


<p>8）查看任务流</p>
<img src="/2022/02/07/10237/%E6%9F%A5%E7%9C%8B%E4%BB%BB%E5%8A%A1%E6%B5%81.png" class title="This is an example image">

<p>9）详细任务流展示</p>
<img src="/2022/02/07/10237/%E4%BB%BB%E5%8A%A1%E6%B5%81%E5%B1%95%E7%A4%BA.png" class title="This is an example image">

<p>10）配置输入dt时间参数</p>


<p>11）执行成功</p>
<img src="/2022/02/07/10237/%E6%89%A7%E8%A1%8C%E6%88%90%E5%8A%9F.png" class title="This is an example image">

<p>12）在SQLyog上查看结果</p>
<img src="/2022/02/07/10237/%E6%9F%A5%E7%9C%8B%E7%BB%93%E6%9E%9C.png" class title="This is an example image">

<h3 id="10-4-3-Azkaban多Executor模式下注意事项"><a href="#10-4-3-Azkaban多Executor模式下注意事项" class="headerlink" title="10.4.3 Azkaban多Executor模式下注意事项"></a>10.4.3 Azkaban多Executor模式下注意事项</h3><p>Azkaban多Executor模式是指，在集群中多个节点部署Executor。在这种模式下， Azkaban web Server会根据策略，选取其中一个Executor去执行任务。<br>由于我们需要交给Azkaban调度的脚本，以及脚本需要的Hive，Sqoop等应用只在hadoop102部署了，为保证任务顺利执行，我们须在以下两种方案任选其一，推荐使用方案二。<br>方案一：指定特定的Executor（hadoop102）去执行任务。<br>1）在MySQL中azkaban数据库executors表中，查询hadoop102上的Executor的id。</p>
<pre class=" language-shell"><code class="language-shell">mysql> use azkaban;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> select * from executors;
+----+-----------+-------+--------+
| id | host          | port  | active |
+----+-----------+-------+--------+
|  1   | hadoop103 | 35985 |      1 |
|  2   | hadoop104 | 36363 |      1 |
|  3   | hadoop102 | 12321 |      1 |
+----+-----------+-------+--------+
3 rows in set (0.00 sec)
</code></pre>
<p>2）在执行工作流程时加入useExecutor属性，如下</p>
<img src="/2022/02/07/10237/%E5%8A%A0%E5%85%A5useExecutor%E5%B1%9E%E6%80%A7.png" class title="This is an example image">

<p>方案二：在Executor所在所有节点部署任务所需脚本和应用。<br>1）分发脚本、sqoop、spark、my_env.sh</p>
<pre class=" language-shell"><code class="language-shell">[atguigu@hadoop102 ~]$ xsync /home/atguigu/bin/
[atguigu@hadoop102 ~]$ xsync /opt/module/hive
[atguigu@hadoop102 ~]$ xsync /opt/module/sqoop
[atguigu@hadoop102 ~]$ xsync /opt/module/spark
[atguigu@hadoop102 ~]$ sudo /home/atguigu/bin/xsync /etc/profile.d/my_env.sh
</code></pre>
<p>2）分发之后，在hadoop103，hadoop104重新加载环境变量配置文件，并重启Azkaban</p>
<p><a href="https://bigworldxld.github.io/2022/02/09/undefined.html">大数据项目之尚品汇（4可视化报表Superset）</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">读序</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://bigworldxld.github.io/2022/02/07/10237.html">https://bigworldxld.github.io/2022/02/07/10237.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">读序</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/hive/">
                                    <span class="chip bg-color">hive</span>
                                </a>
                            
                                <a href="/tags/spark/">
                                    <span class="chip bg-color">spark</span>
                                </a>
                            
                                <a href="/tags/kafka/">
                                    <span class="chip bg-color">kafka</span>
                                </a>
                            
                                <a href="/tags/Azkaban/">
                                    <span class="chip bg-color">Azkaban</span>
                                </a>
                            
                                <a href="/tags/hadoop/">
                                    <span class="chip bg-color">hadoop</span>
                                </a>
                            
                                <a href="/tags/zookeeper/">
                                    <span class="chip bg-color">zookeeper</span>
                                </a>
                            
                                <a href="/tags/flume/">
                                    <span class="chip bg-color">flume</span>
                                </a>
                            
                                <a href="/tags/sqoop/">
                                    <span class="chip bg-color">sqoop</span>
                                </a>
                            
                                <a href="/tags/superset/">
                                    <span class="chip bg-color">superset</span>
                                </a>
                            
                                <a href="/tags/hbase/">
                                    <span class="chip bg-color">hbase</span>
                                </a>
                            
                                <a href="/tags/Presto/">
                                    <span class="chip bg-color">Presto</span>
                                </a>
                            
                                <a href="/tags/kylin/">
                                    <span class="chip bg-color">kylin</span>
                                </a>
                            
                                <a href="/tags/zabbix/">
                                    <span class="chip bg-color">zabbix</span>
                                </a>
                            
                                <a href="/tags/Kerberos/">
                                    <span class="chip bg-color">Kerberos</span>
                                </a>
                            
                                <a href="/tags/ranger/">
                                    <span class="chip bg-color">ranger</span>
                                </a>
                            
                                <a href="/tags/atlas/">
                                    <span class="chip bg-color">atlas</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/02/08/16820.html">
                    <div class="card-image">
                        
                        <img src="/images/Azkaban.jpg" class="responsive-img" alt="大数据技术之Azkaban">
                        
                        <span class="card-title">大数据技术之Azkaban</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-02-08
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/hadoop%E7%94%9F%E6%80%81%E5%9C%88/" class="post-category">
                                    hadoop生态圈
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Azkaban/">
                        <span class="chip bg-color">Azkaban</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/02/06/41690.html">
                    <div class="card-image">
                        
                        <img src="/images/datawarehouse.jpg" class="responsive-img" alt="大数据项目之尚品汇（2业务数据采集平台)">
                        
                        <span class="card-title">大数据项目之尚品汇（2业务数据采集平台)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-02-06
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/data-warehouse/" class="post-category">
                                    data warehouse
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/hive/">
                        <span class="chip bg-color">hive</span>
                    </a>
                    
                    <a href="/tags/spark/">
                        <span class="chip bg-color">spark</span>
                    </a>
                    
                    <a href="/tags/kafka/">
                        <span class="chip bg-color">kafka</span>
                    </a>
                    
                    <a href="/tags/Azkaban/">
                        <span class="chip bg-color">Azkaban</span>
                    </a>
                    
                    <a href="/tags/hadoop/">
                        <span class="chip bg-color">hadoop</span>
                    </a>
                    
                    <a href="/tags/zookeeper/">
                        <span class="chip bg-color">zookeeper</span>
                    </a>
                    
                    <a href="/tags/flume/">
                        <span class="chip bg-color">flume</span>
                    </a>
                    
                    <a href="/tags/sqoop/">
                        <span class="chip bg-color">sqoop</span>
                    </a>
                    
                    <a href="/tags/superset/">
                        <span class="chip bg-color">superset</span>
                    </a>
                    
                    <a href="/tags/hbase/">
                        <span class="chip bg-color">hbase</span>
                    </a>
                    
                    <a href="/tags/Presto/">
                        <span class="chip bg-color">Presto</span>
                    </a>
                    
                    <a href="/tags/kylin/">
                        <span class="chip bg-color">kylin</span>
                    </a>
                    
                    <a href="/tags/zabbix/">
                        <span class="chip bg-color">zabbix</span>
                    </a>
                    
                    <a href="/tags/Kerberos/">
                        <span class="chip bg-color">Kerberos</span>
                    </a>
                    
                    <a href="/tags/ranger/">
                        <span class="chip bg-color">ranger</span>
                    </a>
                    
                    <a href="/tags/atlas/">
                        <span class="chip bg-color">atlas</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2025</span>
            
            <a href="/about" target="_blank">读序</a>
            |&nbsp;Author&nbsp;<a href="https://bigworldxld.github.io/" target="_blank">bigworldxld</a>
            |&nbsp;Dailylife&nbsp;<a href="https://bigworldxld.github.io/duxu-dailylife/" target="_blank">blog</a>
			|&nbsp;Desktop&nbsp;<a href="https://bigworldxld.github.io/desktop/" target="_blank">desktop</a>
            <br>
			
            
            
            
                
            
           
			      
				<span id="busuanzi_container_site_pv" style='display:none'></span>
				<i class="fa fa-heart-o"></i>
			本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>

			

			
				<span id="busuanzi_container_site_uv" style='display:none'></span>
					人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.

			

			
            <br>
		


            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2021";
                        var startMonth = "12";
                        var startDate = "30";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">

    <a href="https://github.com/bigworldxld/bigworldxld.github.io" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2117376396@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2117376396" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2117376396" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>
<div class="progress-bar"></div>
<span id="sitetime"></span>
<script language = javascript >
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
		let time = new Date().toLocaleString();
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        var t1 = Date.UTC(2021, 12, 30, 00, 00, 00); //北京时间2018-2-13 00:00:00 
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond); 
        var diff = t2 - t1; var diffYears = Math.floor(diff / years); 
        var diffDays = Math.floor((diff / days) - diffYears * 365); 
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours); 
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes); 
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds); 
		document.getElementById("sitetime").innerHTML = "当前时间为"+ time +"<br/>本站已运行 " +diffYears+" 年 "+diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒"; 
    } 
    siteTime(); 
</script>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/star.js"><\/script>');
            }
        </script>
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script type="text/javascript">
    var OriginTitile = document.title,
        st;
    document.addEventListener("visibilitychange", function () {
        document.hidden ? (document.title = "๑•̀ㅂ•́) ✧看不见～看不见～", clearTimeout(st)) : (document.title =
            "(๑•̀ㅂ•́) ✧看见～", st = setTimeout(function () {
                document.title = OriginTitile
            }, 3e3))
    })
</script>

</body>

</html>
